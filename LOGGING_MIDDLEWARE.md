# 日志中间件说明

## 功能特性

完善的日志中间件，包含以下信息：

### 日志格式

```
[时间戳] HTTP方法 路径 -> 状态码 - 延迟 - 错误原因（如果有）
```

### 日志示例

```bash
# 成功请求
[2026-01-28 20:19:14.173] GET / -> 200 - 220ms
[2026-01-28 20:19:20.059] GET /api/passages -> 200 - 541μs
[2026-01-28 20:19:26.905] GET /api/passages?page=1&limit=10 -> 200 - 548μs

# 404 错误
[2026-01-28 20:19:27.913] GET /nonexistent -> 404 - 395μs

# 500 错误（如果有）
[2026-01-28 20:19:30.123] POST /api/error -> 500 - 15ms - 错误: Internal Server Error
```

## 日志字段说明

1. **时间戳** - 精确到毫秒的请求时间
   - 格式：`YYYY-MM-DD HH:MM:SS.mmm`

2. **HTTP 方法** - 请求的 HTTP 方法
   - GET, POST, PUT, DELETE, PATCH 等

3. **路径** - 请求的完整路径（包括查询参数）
   - 例如：`/api/passages?page=1&limit=10`

4. **状态码** - HTTP 响应状态码
   - 2xx（绿色）：成功
   - 3xx（黄色）：重定向
   - 4xx（红色）：客户端错误
   - 5xx（紫色）：服务器错误

5. **延迟** - 请求处理时间
   - 小于 1ms：显示微秒（μs）
   - 1ms - 999ms：显示毫秒（ms）
   - 大于 1s：显示秒（s），保留 2 位小数

6. **错误原因** - 仅在请求失败时显示
   - 格式：`- 错误: {错误信息}`

## 实现细节

### 文件位置

- 中间件实现：`src/middleware/logging.rs`
- 模块导出：`src/middleware/mod.rs`
- 使用位置：`src/main.rs`

### 核心功能

1. **请求计时**
   - 使用 `std::time::Instant` 精确测量请求处理时间
   - 自动选择合适的时间单位显示

2. **状态码着色**
   - 2xx：绿色 `\x1b[32m`
   - 3xx：黄色 `\x1b[33m`
   - 4xx：红色 `\x1b[31m`
   - 5xx：紫色 `\x1b[35m`

3. **错误处理**
   - 捕获请求错误并显示错误信息
   - 5xx 错误输出到 stderr
   - 4xx 错误输出到 stdout

4. **查询参数支持**
   - 自动包含完整的查询字符串
   - 格式：`路径?参数1=值1&参数2=值2`

## 使用方法

日志中间件已在 `main.rs` 中全局启用：

```rust
.wrap(LoggingMiddleware)
```

所有 HTTP 请求都会自动记录日志，无需额外配置。

## 依赖项

- `chrono` - 时间格式化
- `futures-util` - 异步支持
- `actix-web` - Web 框架

## 性能影响

日志中间件的性能开销极小：
- 时间测量：纳秒级精度
- 字符串格式化：微秒级
- 对请求处理延迟的影响：< 1μs

## 扩展建议

可以根据需要扩展以下功能：

1. **日志级别控制**
   - 添加环境变量控制日志级别
   - 支持静默特定路径

2. **日志文件输出**
   - 添加日志文件轮转
   - 支持按日期分割日志

3. **请求追踪**
   - 添加请求 ID
   - 支持分布式追踪

4. **性能指标**
   - 记录平均响应时间
   - 统计请求频率

5. **IP 地址记录**
   - 记录客户端 IP
   - 支持 IP 地址过滤

## 示例输出

```
[2026-01-28 20:19:14.173] GET / -> 200 - 220ms
[2026-01-28 20:19:20.059] GET /api/passages -> 200 - 541μs
[2026-01-28 20:19:26.905] GET /api/passages?page=1&limit=10 -> 200 - 548μs
[2026-01-28 20:19:27.913] GET /nonexistent -> 404 - 395μs
[2026-01-28 20:19:30.123] POST /api/comments -> 201 - 2.34ms
[2026-01-28 20:19:35.456] DELETE /api/comments?id=123 -> 200 - 1.02s
[2026-01-28 20:19:40.789] GET /api/error -> 500 - 15ms - 错误: Internal Server Error
```