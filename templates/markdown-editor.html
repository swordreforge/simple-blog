<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
<meta name="description" content="åœ¨çº¿Markdownç¼–è¾‘å™¨ - å®æ—¶é¢„è§ˆã€è¯­æ³•é«˜äº®ã€å¿«æ·é”®æ”¯æŒã€‚ä¸€ä¸ªå¼ºå¤§çš„Markdownç¼–è¾‘å·¥å…·ï¼Œæ”¯æŒä»£ç é«˜äº®ã€å›¾ç‰‡ä¸Šä¼ ã€è‡ªåŠ¨ä¿å­˜ç­‰åŠŸèƒ½ã€‚">
<title>åœ¨çº¿Markdownç¼–è¾‘å™¨</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  height: 100%;
  width: 100%;
}

body {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  min-height: -webkit-fill-available;
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
  position: relative;
  background-image: url('{{ settings.background_image | safe }}');
  background-size: {{ settings.background_size }};
  background-position: {{ settings.background_position }};
  background-repeat: {{ settings.background_repeat }};
  background-attachment: {{ settings.background_attachment }};
  overflow-x: hidden;
  --global-opacity: {{ settings.global_opacity }};
}

nav {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  position: fixed;
  top: env(safe-area-inset-top);
  right: 0;
  padding: 15px env(safe-area-inset-right) 15px env(safe-area-inset-left);
  width: 100%;
  background: var(--navbar-glass-color, rgba(255, 255, 255, 0.85));
  backdrop-filter: blur(10px) saturate(180%);
  -webkit-backdrop-filter: blur(10px) saturate(180%);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  z-index: 100;
  box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
}

nav a {
  color: var(--navbar-text-color, rgba(255, 255, 255, 0.9));
  text-decoration: none;
  padding: 4px 8px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(30px) saturate(200%);
  -webkit-backdrop-filter: blur(30px) saturate(200%);
  border-radius: 25px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* å¯¼èˆªæ æŒ‰é’®æ ·å¼ */
nav button {
  color: var(--navbar-text-color, rgba(255, 255, 255, 0.9));
  text-decoration: none;
  padding: 4px 8px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(30px) saturate(200%);
  -webkit-backdrop-filter: blur(30px) saturate(200%);
  border-radius: 25px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  cursor: pointer;
}

nav a:hover {
  color: #fff;
  background: rgba(0, 0, 0, 0);
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
}

nav a.current {
  color: #fff;
  background: rgba(255, 255, 255, 0.3);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

main {
  flex: 1;
  padding: 80px 20px 20px;
  position: relative;
  z-index: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.editor-container {
  display: flex;
  width: 100%;
  max-width: 1400px;
  height: calc(100vh - 120px);
  gap: 20px;
}

.editor-panel, .preview-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
  overflow: hidden;
}

.panel-header {
  padding: 15px 20px;
  background: rgba(0, 0, 0, 0.05);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.panel-title {
  font-weight: 600;
  color: rgba(0, 0, 0, 0.8);
  font-size: 1.1em;
}

.panel-actions {
  display: flex;
  gap: 10px;
}

.btn {
  padding: 8px 16px;
  border: 1px solid rgba(0, 0, 0, 0.2);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.9);
  color: rgba(0, 0, 0, 0.8);
  font-size: 0.9em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn:hover {
  background: rgba(0, 0, 0, 0.05);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.btn-primary {
  background: linear-gradient(135deg, #007bff, #00b894);
  color: white;
  border-color: transparent;
}

.btn-primary:hover {
  background: linear-gradient(135deg, #0056b3, #009973);
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

.btn-success {
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
  border-color: transparent;
}

.btn-success:hover {
  background: linear-gradient(135deg, #218838, #1aa179);
  box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

#markdownInput {
  flex: 1;
  padding: 20px;
  border: none;
  resize: none;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 14px;
  line-height: 1.6;
  color: rgba(0, 0, 0, 0.8);
  background: transparent;
  outline: none;
}

#previewOutput {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  background: white;
}

#previewOutput h1, #previewOutput h2, #previewOutput h3,
#previewOutput h4, #previewOutput h5, #previewOutput h6 {
  margin-top: 1.5em;
  margin-bottom: 0.5em;
  font-weight: 600;
  color: rgba(0, 0, 0, 0.9);
}

#previewOutput h1 { font-size: 2em; border-bottom: 2px solid rgba(0, 0, 0, 0.1); padding-bottom: 0.3em; }
#previewOutput h2 { font-size: 1.5em; border-bottom: 1px solid rgba(0, 0, 0, 0.1); padding-bottom: 0.3em; }
#previewOutput h3 { font-size: 1.25em; }
#previewOutput h4 { font-size: 1em; }
#previewOutput h5 { font-size: 0.875em; }
#previewOutput h6 { font-size: 0.85em; color: rgba(0, 0, 0, 0.6); }

#previewOutput p {
  margin: 1em 0;
  line-height: 1.8;
  color: rgba(0, 0, 0, 0.8);
}

#previewOutput a {
  color: #007bff;
  text-decoration: none;
}

#previewOutput a:hover {
  text-decoration: underline;
}

#previewOutput code {
  background: rgba(0, 0, 0, 0.05);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 0.9em;
}

#previewOutput pre {
  background: rgba(0, 0, 0, 0.05);
  padding: 15px;
  border-radius: 8px;
  overflow-x: auto;
  margin: 1em 0;
}

#previewOutput pre code {
  background: transparent;
  padding: 0;
}

#previewOutput blockquote {
  border-left: 4px solid #007bff;
  padding-left: 15px;
  margin: 1em 0;
  color: rgba(0, 0, 0, 0.6);
  font-style: italic;
}

#previewOutput ul, #previewOutput ol {
  margin: 1em 0;
  padding-left: 2em;
}

#previewOutput li {
  margin: 0.5em 0;
}

#previewOutput table {
  width: 100%;
  border-collapse: collapse;
  margin: 1em 0;
}

#previewOutput th, #previewOutput td {
  border: 1px solid rgba(0, 0, 0, 0.1);
  padding: 10px;
  text-align: left;
}

#previewOutput th {
  background: rgba(0, 0, 0, 0.05);
  font-weight: 600;
}

#previewOutput img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin: 1em 0;
}

#previewOutput hr {
  border: none;
  height: 2px;
  background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.1), transparent);
  margin: 2em 0;
}

/* MathJax æ ·å¼ */
mjx-container {
  font-size: 110% !important;
}

/* Mermaid å›¾è¡¨æ ·å¼ */
.mermaid {
  text-align: center;
  margin: 2em 0;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .editor-container {
    flex-direction: column;
    height: auto;
  }

  .editor-panel, .preview-panel {
    min-height: 400px;
  }

  nav {
    padding: 10px env(safe-area-inset-right) 10px env(safe-area-inset-left);
  }

  nav a {
    font-size: 0;
    margin: 0 4px;
    padding: 10px;
    min-width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
  }

  /* éšè—å¯¼èˆªæ æ–‡å­—ï¼Œåªæ˜¾ç¤ºå›¾æ ‡ */
  nav a span:not(.shortcut-hint) {
    display: none;
  }

  /* éšè—å¿«æ·é”®æç¤º */
  .shortcut-hint {
    display: none !important;
  }

  /* ç¡®ä¿å›¾æ ‡å¯è§ */
  nav a svg {
    display: block;
    font-size: initial;
  }

  /* ä¸ºæ²¡æœ‰å›¾æ ‡çš„é“¾æ¥æ·»åŠ é»˜è®¤å›¾æ ‡ */
  nav a[href="/"]::before {
    content: 'ğŸ ';
    font-size: 18px;
  }

  nav a[href="/passage"]::before {
    content: 'ğŸ“';
    font-size: 18px;
  }

  nav a[href="/collect"]::before {
    content: 'ğŸ“';
    font-size: 18px;
  }

  nav a[href="/about"]::before {
    content: 'â„¹ï¸';
    font-size: 18px;
  }

  nav a[href="/markdown-editor"]::before {
    content: 'âœï¸';
    font-size: 18px;
  }

  nav a[href="/admin"]::before {
    content: 'âš™ï¸';
    font-size: 18px;
  }
}

/* åŠ è½½æç¤º */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: rgba(0, 0, 0, 0.6);
}

.loading::after {
  content: '';
  width: 20px;
  height: 20px;
  border: 2px solid rgba(0, 0, 0, 0.1);
  border-top-color: #007bff;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-left: 10px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* å·¥å…·æ æ ·å¼ */
.toolbar {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.toolbar .btn {
  padding: 6px 12px;
  font-size: 0.85em;
}

/* ä¿å­˜æ¨¡æ€æ¡† */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
  max-width: 500px;
  width: 100%;
  padding: 30px;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-header h3 {
  font-size: 1.5em;
  color: rgba(0, 0, 0, 0.9);
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5em;
  cursor: pointer;
  color: rgba(0, 0, 0, 0.6);
  transition: color 0.3s ease;
}

.modal-close:hover {
  color: rgba(0, 0, 0, 0.9);
}

.modal-body {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group label {
  font-weight: 500;
  color: rgba(0, 0, 0, 0.8);
}

.form-group input {
  padding: 12px;
  border: 1px solid rgba(0, 0, 0, 0.2);
  border-radius: 8px;
  font-size: 1em;
  transition: border-color 0.3s ease;
}

.form-group input:focus {
  outline: none;
  border-color: #007bff;
}

.form-group input:disabled {
  background: rgba(0, 0, 0, 0.05);
  cursor: not-allowed;
}

.modal-footer {
  display: flex;
  gap: 10px;
  margin-top: 20px;
  justify-content: flex-end;
}

.modal-footer .btn {
  flex: 1;
}

/* æç¤ºä¿¡æ¯ */
.toast {
  position: fixed;
  top: 80px;
  right: 20px;
  padding: 15px 25px;
  border-radius: 10px;
  color: white;
  font-weight: 500;
  z-index: 1001;
  opacity: 0;
  transform: translateX(100px);
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.toast.show {
  opacity: 1;
  transform: translateX(0);
}

.toast.success {
  background: linear-gradient(135deg, #28a745, #20c997);
}

.toast.error {
  background: linear-gradient(135deg, #dc3545, #c82333);
}

.toast.info {
  background: linear-gradient(135deg, #007bff, #00b894);
}

/* ç®¡ç†å‘˜ä¸“ç”¨å…ƒç´  - é»˜è®¤éšè—ï¼Œåªæœ‰ç®¡ç†å‘˜å¯è§ */
.admin-only {
  display: none !important;
}

/* å¿«æ·é”®æç¤ºæ ·å¼ */
.shortcut-hint {
  position: absolute;
  bottom: -20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.75em;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.2s ease;
  pointer-events: none;
}

.btn:hover .shortcut-hint {
  opacity: 1;
}

/* å¯¼èˆªé“¾æ¥çš„å¿«æ·é”®æç¤ºæ ·å¼ */
nav a .shortcut-hint {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  margin-left: 6px;
  padding: 0 4px;
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.9);
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  position: static;
  transform: none;
  opacity: 1;
  pointer-events: none;
}
</style>

<!-- é”®ç›˜å¿«æ·é”®æ ·å¼ -->
<link rel="stylesheet" href="/css/keyboard-shortcuts.css" media="print" onload="this.media='all'">
</head>
<body>
<nav>
  <a href="/">ä¸»é¡µ<span class="shortcut-hint">1</span></a>
  <a href="/passage">æ–‡ç« <span class="shortcut-hint">2</span></a>
  <a href="/collect">å½’æ¡£<span class="shortcut-hint">3</span></a>
  <a href="/about">å…³äº<span class="shortcut-hint">4</span></a>
  <a href="/markdown-editor" class="current">Markdownç¼–è¾‘å™¨<span class="shortcut-hint">6</span></a>
</nav>

<main>
  <div class="editor-container">
    <div class="editor-panel">
      <div class="panel-header">
        <span class="panel-title">ç¼–è¾‘å™¨</span>
        <div class="panel-actions">
          <div class="toolbar">
            <button class="btn" onclick="insertMarkdown('**', '**')" title="ç²—ä½“ (Ctrl+B)">
              <strong>B</strong>
              <span class="shortcut-hint">Ctrl+B</span>
            </button>
            <button class="btn" onclick="insertMarkdown('*', '*')" title="æ–œä½“ (Ctrl+I)">
              <em>I</em>
              <span class="shortcut-hint">Ctrl+I</span>
            </button>
            <button class="btn" onclick="insertMarkdown('`', '`')" title="ä»£ç  (Ctrl+K)">
              &lt;/&gt;
              <span class="shortcut-hint">Ctrl+K</span>
            </button>
            <button class="btn" onclick="insertMarkdown('$$\n', '\n$$')" title="æ•°å­¦å…¬å¼ (Ctrl+M)">
              âˆ‘
              <span class="shortcut-hint">Ctrl+M</span>
            </button>
            <button class="btn" onclick="insertMarkdown('```mermaid\n', '\n```')" title="æµç¨‹å›¾ (Ctrl+G)">
              â—‹
              <span class="shortcut-hint">Ctrl+G</span>
            </button>
          </div>
        </div>
      </div>
      <textarea id="markdownInput" placeholder="åœ¨è¿™é‡Œè¾“å…¥Markdownå†…å®¹..."></textarea>
    </div>
    
    <div class="preview-panel">
      <div class="panel-header">
        <span class="panel-title">é¢„è§ˆ</span>
        <div class="panel-actions">
          <button class="btn btn-success" onclick="downloadMarkdown()" title="ä¸‹è½½Markdownæ–‡ä»¶ (Ctrl+D)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            ä¸‹è½½
            <span class="shortcut-hint">Ctrl+D</span>
          </button>
          <button class="btn btn-primary admin-only" onclick="showSaveModal()" title="ä¿å­˜åˆ°æ•°æ®åº“ (Ctrl+S)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
              <polyline points="17 21 17 13 7 13 7 21"></polyline>
              <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            ä¿å­˜
            <span class="shortcut-hint">Ctrl+S</span>
          </button>
        </div>
      </div>
      <div id="previewOutput"></div>
    </div>
  </div>
</main>

<!-- ä¿å­˜æ¨¡æ€æ¡† -->
<div class="modal" id="saveModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ä¿å­˜æ–‡ç« </h3>
      <button class="modal-close" onclick="hideSaveModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="saveTitle">æ–‡ç« æ ‡é¢˜</label>
        <input type="text" id="saveTitle" placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜" required>
      </div>
      <div class="form-group">
        <label for="saveCategory">åˆ†ç±»</label>
        <input type="text" id="saveCategory" placeholder="è¯·è¾“å…¥åˆ†ç±»ï¼ˆå¯é€‰ï¼‰">
      </div>
      <div class="form-group">
        <label for="saveTags">æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
        <input type="text" id="saveTags" placeholder="è¯·è¾“å…¥æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰">
      </div>
      <div class="form-group">
        <label for="saveSummary">æ‘˜è¦</label>
        <input type="text" id="saveSummary" placeholder="è¯·è¾“å…¥æ‘˜è¦ï¼ˆå¯é€‰ï¼‰">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="hideSaveModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveToDatabase()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- æç¤ºä¿¡æ¯ -->
<div class="toast" id="toast"></div>

<!-- å¼•å…¥å¿…è¦çš„åº“ -->
<!--script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"-->
<script src="/js/npm/marked@14.1.4/marked.min.js"></script>
<link rel="stylesheet" href="/css/katex.min.css">
<script src="/js/npm/katex-0.16.27/dist/katex.min.js"></script>
<script src="/js/npm/katex-0.16.27/dist/contrib/auto-render.min.js"></script>
<!--script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"-->
<script defer src="/js/npm/mermaid@11.12.2/dist/mermaid.min.js"></script>
<script defer>
// åˆå§‹åŒ– Mermaidï¼ˆåœ¨è„šæœ¬åŠ è½½æ—¶ç«‹å³æ‰§è¡Œï¼‰
if (typeof mermaid !== 'undefined') {
  mermaid.initialize({
    startOnLoad: false,
    theme: 'default',
    securityLevel: 'loose',
  });
}

// ç­‰å¾… DOM åŠ è½½å®Œæˆåæ‰§è¡Œ
document.addEventListener('DOMContentLoaded', function() {
  // è·å–DOMå…ƒç´ 
  const markdownInput = document.getElementById('markdownInput');
  const previewOutput = document.getElementById('previewOutput');
  const saveModal = document.getElementById('saveModal');
  const toast = document.getElementById('toast');

  // é…ç½® marked
  if (typeof marked !== 'undefined') {
    marked.setOptions({
      breaks: true,
      gfm: true,
      highlight: function(code, lang) {
        return code;
      }
    });

    // å®æ—¶æ¸²æŸ“
    markdownInput.addEventListener('input', debounce(renderPreview, 300));

    // æ¸²æŸ“é¢„è§ˆ
    function renderPreview() {
      const markdown = markdownInput.value;
      
      if (!markdown.trim()) {
        previewOutput.innerHTML = '<div class="loading">è¾“å…¥ Markdown å†…å®¹å¼€å§‹é¢„è§ˆ...</div>';
        return;
      }

      // ä½¿ç”¨ marked è½¬æ¢ Markdown
      const html = marked.parse(markdown);
      previewOutput.innerHTML = html;

      // å¤„ç†æ•°å­¦å…¬å¼
      if (window.renderMathInElement) {
        try {
          renderMathInElement(previewOutput, {
            delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false}
            ],
            throwOnError: false
          });
        } catch (err) {
          console.log('KaTeX error:', err);
        }
      }

      // å¤„ç† Mermaid å›¾è¡¨
      processMermaidCharts();
    }

    // å¤„ç† Mermaid å›¾è¡¨
    function processMermaidCharts() {
      const mermaidBlocks = previewOutput.querySelectorAll('pre code');
      
      mermaidBlocks.forEach((block) => {
        const code = block.textContent;
        if (code.trim().startsWith('mermaid')) {
          const mermaidCode = code.replace(/^mermaid\n/, '').trim();
          const pre = block.parentElement;
          
          // åˆ›å»ºæ–°çš„ div ç”¨äºæ¸²æŸ“å›¾è¡¨
          const mermaidDiv = document.createElement('div');
          mermaidDiv.className = 'mermaid';
          mermaidDiv.textContent = mermaidCode;
          
          // æ›¿æ¢åŸæ¥çš„ä»£ç å—
          pre.replaceWith(mermaidDiv);
        }
      });

      // é‡æ–°æ¸²æŸ“æ‰€æœ‰ mermaid å›¾è¡¨
      if (typeof mermaid !== 'undefined') {
        mermaid.run().catch((err) => console.log('Mermaid error:', err));
      }
    }

    // æ’å…¥ Markdown è¯­æ³•
    function insertMarkdown(before, after) {
      const start = markdownInput.selectionStart;
      const end = markdownInput.selectionEnd;
      const text = markdownInput.value;
      const selectedText = text.substring(start, end);
      
      const newText = text.substring(0, start) + before + selectedText + after + text.substring(end);
      markdownInput.value = newText;
      
      // è®¾ç½®å…‰æ ‡ä½ç½®
      const newCursorPos = start + before.length + selectedText.length;
      markdownInput.setSelectionRange(newCursorPos, newCursorPos);
      markdownInput.focus();
      
      // è§¦å‘æ¸²æŸ“
      renderPreview();
    }

    // é˜²æŠ–å‡½æ•°
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ä¸‹è½½ Markdown æ–‡ä»¶
    function downloadMarkdown() {
      const content = markdownInput.value;
      const title = document.getElementById('saveTitle').value || 'untitled';
      
      if (!content.trim()) {
        showToast('è¯·è¾“å…¥ Markdown å†…å®¹', 'error');
        return;
      }
      
      const blob = new Blob([content], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${title}.md`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast('ä¸‹è½½æˆåŠŸ', 'success');
    }

    // æ˜¾ç¤ºä¿å­˜æ¨¡æ€æ¡†
    function showSaveModal() {
      saveModal.classList.add('active');
    }

    // éšè—ä¿å­˜æ¨¡æ€æ¡†
    function hideSaveModal() {
      saveModal.classList.remove('active');
    }

    // ä¿å­˜åˆ°æ•°æ®åº“
    async function saveToDatabase() {
      const title = document.getElementById('saveTitle').value.trim();
      const category = document.getElementById('saveCategory').value.trim();
      const tags = document.getElementById('saveTags').value.trim();
      const summary = document.getElementById('saveSummary').value.trim();
      const content = markdownInput.value;
      
      if (!title) {
        showToast('è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜', 'error');
        return;
      }
      
      if (!content.trim()) {
        showToast('è¯·è¾“å…¥ Markdown å†…å®¹', 'error');
        return;
      }
      
      try {
        const response = await fetch('/api/markdown-editor/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            title: title,
            content: content,
            category: category,
            tags: tags,
            summary: summary,
          }),
        });
        
        const data = await response.json();
        
        if (data.success) {
          showToast('ä¿å­˜æˆåŠŸï¼', 'success');
          hideSaveModal();
          // æ¸…ç©ºè¡¨å•
          document.getElementById('saveTitle').value = '';
          document.getElementById('saveCategory').value = '';
          document.getElementById('saveTags').value = '';
          document.getElementById('saveSummary').value = '';
        } else {
          showToast(data.message || 'ä¿å­˜å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('Save error:', error);
        showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
      }
    }

    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    function showToast(message, type = 'info') {
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // æ£€æŸ¥ç”¨æˆ·æƒé™å¹¶æ˜¾ç¤º/éšè—ä¿å­˜æŒ‰é’®
    async function checkUserPermission() {
      try {
        const response = await fetch('/api/user/info');
        if (response.ok) {
          const data = await response.json();
          if (data.role === 'admin') {
            document.querySelectorAll('.admin-only').forEach(el => {
              el.style.display = 'flex';
            });
          }
        }
      } catch (error) {
        console.log('Permission check failed:', error);
      }
    }

    // åŠ è½½å¤–è§‚è®¾ç½®
    fetch('/api/settings/appearance')
      .then(response => response.json())
      .then(settings => {
        // åº”ç”¨å¯¼èˆªæ æ–‡å­—é¢œè‰²
        if (settings.navbar_text_color) {
          document.documentElement.style.setProperty('--navbar-text-color', settings.navbar_text_color);
        }

        // å“åº”å¼åŠ è½½èƒŒæ™¯å›¾ç‰‡
        function applyBackgroundImage() {
          const isMobile = window.innerWidth <= 768;
          const backgroundImage = isMobile && settings.mobile_background_image ? settings.mobile_background_image : settings.background_image;
          if (backgroundImage) {
            document.body.style.backgroundImage = `url('${backgroundImage}')`;
          }
        }

        // åˆå§‹åº”ç”¨
        applyBackgroundImage();

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', applyBackgroundImage);
      })
      .catch(error => {
        console.error('åŠ è½½å¤–è§‚è®¾ç½®å¤±è´¥:', error);
      });

    // æ£€æŸ¥ç”¨æˆ·æƒé™
    checkUserPermission();
    
    // åˆå§‹æ¸²æŸ“
    renderPreview();
    
    // æ·»åŠ ç¤ºä¾‹å†…å®¹
    if (!markdownInput.value.trim()) {
      markdownInput.value = `# åœ¨çº¿ Markdown ç¼–è¾‘å™¨

è¿™æ˜¯ä¸€ä¸ªæ”¯æŒå®æ—¶é¢„è§ˆçš„ Markdown ç¼–è¾‘å™¨ï¼Œæ”¯æŒæ•°å­¦å…¬å¼å’Œæµç¨‹å›¾ã€‚

## åŠŸèƒ½ç‰¹æ€§

- **å®æ—¶é¢„è§ˆ**ï¼šè¾“å…¥æ—¶å³æ—¶æ¸²æŸ“
- **æ•°å­¦å…¬å¼**ï¼šæ”¯æŒ LaTeX æ•°å­¦å…¬å¼
- **æµç¨‹å›¾**ï¼šæ”¯æŒ Mermaid å›¾è¡¨
- **ä»£ç é«˜äº®**ï¼šæ”¯æŒä»£ç å—è¯­æ³•é«˜äº®
- **ä¸‹è½½åŠŸèƒ½**ï¼šå¯ä»¥ä¸‹è½½ Markdown æ–‡ä»¶
- **ä¿å­˜åŠŸèƒ½**ï¼šç®¡ç†å‘˜å¯ä»¥ä¿å­˜åˆ°æ•°æ®åº“

## æ•°å­¦å…¬å¼ç¤ºä¾‹

è¡Œå†…å…¬å¼ï¼š$E = mc^2$

å—çº§å…¬å¼ï¼š
$$
\\\\int_{-\\\\infty}^{\\\\infty} e^{-x^2} dx = \\\\sqrt{\\\\pi}
$$

## æµç¨‹å›¾ç¤ºä¾‹

\`\`\`mermaid
graph TD
    A[å¼€å§‹] --> B{åˆ¤æ–­}
    B -->|æ˜¯| C[ç»§ç»­]
    B -->|å¦| D[ç»“æŸ]
    C --> B
\`\`\`

## ä»£ç ç¤ºä¾‹

\`\`\`javascript
function hello() {
    console.log('Hello, World!');
}
\`\`\`

## è¡¨æ ¼ç¤ºä¾‹

| åˆ—1 | åˆ—2 | åˆ—3 |
|-----|-----|-----|
| A   | B   | C   |
| D   | E   | F   |

å¼€å§‹æ‚¨çš„åˆ›ä½œå§ï¼
`;
      renderPreview();
    }

    // å¯¼èˆªå¿«æ·é”®é…ç½®ï¼ˆä»…åœ¨æœªèšç„¦è¾“å…¥æ¡†æ—¶è§¦å‘ï¼‰
    const navigationShortcuts = {
      '1': { url: '/', label: 'ä¸»é¡µ' },
      '2': { url: '/passage', label: 'æ–‡ç« ' },
      '3': { url: '/collect', label: 'å½’æ¡£' },
      '4': { url: '/about', label: 'å…³äº' },
      '6': { url: '/markdown-editor', label: 'ç¼–è¾‘å™¨' },
      'l': { action: 'openModal', modalId: 'loginModal', label: 'ç™»å½•' }
    };

    // å…¨å±€å¿«æ·é”®ç›‘å¬
    document.addEventListener('keydown', (e) => {
      // å¦‚æœæ˜¯ Ctrl/Cmd ç»„åˆé”®ï¼Œä¸å¤„ç†å¯¼èˆªå¿«æ·é”®
      if (e.ctrlKey || e.metaKey) return;

      // æ£€æŸ¥æ˜¯å¦åœ¨è¾“å…¥æ¡†ä¸­
      const activeElement = document.activeElement;
      if (activeElement && (
        activeElement.tagName === 'INPUT' ||
        activeElement.tagName === 'TEXTAREA' ||
        activeElement.isContentEditable
      )) {
        return;
      }

      const key = e.key;
      const shortcut = navigationShortcuts[key];

      if (shortcut) {
        e.preventDefault();

        if (shortcut.url) {
          if (window.location.pathname !== shortcut.url) {
            console.log(`å¯¼èˆªåˆ°: ${shortcut.url}`);
            window.location.href = shortcut.url;
          } else {
            console.log(`å·²åœ¨ç›®æ ‡é¡µé¢: ${shortcut.url}`);
          }
        } else if (shortcut.action === 'openModal') {
          const modal = document.getElementById(shortcut.modalId);
          if (modal) {
            modal.classList.add('active');
            showToast(`å·²æ‰“å¼€: ${shortcut.label}`, 'success');
          }
        }
      }
    });

    // ç¼–è¾‘å™¨ä¸“ç”¨å¿«æ·é”®
    markdownInput.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + B: ç²—ä½“
      if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
        e.preventDefault();
        insertMarkdown('**', '**');
        return;
      }

      // Ctrl/Cmd + I: æ–œä½“
      if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
        e.preventDefault();
        insertMarkdown('*', '*');
        return;
      }

      // Ctrl/Cmd + K: ä»£ç 
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        insertMarkdown('`', '`');
        return;
      }

      // Ctrl/Cmd + M: æ•°å­¦å…¬å¼
      if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
        e.preventDefault();
        insertMarkdown('$$\n', '\n$$');
        return;
      }

      // Ctrl/Cmd + G: æµç¨‹å›¾
      if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
        e.preventDefault();
        insertMarkdown('```mermaid\n', '\n```');
        return;
      }

      // Tab: æ’å…¥2ä¸ªç©ºæ ¼
      if (e.key === 'Tab') {
        e.preventDefault();
        insertMarkdown('  ', '');
        return;
      }
    });
  }
});
</script>
