class PassageFocusMode{constructor(){this.focusMode=!1,this.currentPanel="left",this.selectedIndex=0,this.items=[],this.articleItems=[],this.articleScrollPosition=0,this.init()}init(){document.addEventListener("keydown",e=>this.handleKeyPress(e))}handleKeyPress(e){var t=document.getElementById("imageViewer"),s=document.getElementById("codeViewer");t&&t.classList.contains("active")||s&&s.classList.contains("active")||(t=document.activeElement)&&("INPUT"===t.tagName||"TEXTAREA"===t.tagName||t.isContentEditable)||("i"!==e.key||this.focusMode?"q"===e.key&&this.focusMode?(e.preventDefault(),this.exitFocusMode()):this.focusMode&&("Escape"===e.key?(e.preventDefault(),this.temporarilyExitFocusMode()):("ArrowLeft"===e.key?(e.preventDefault(),this.switchPanel("left")):"ArrowRight"===e.key&&(e.preventDefault(),this.switchPanel("right")),"left"===this.currentPanel?this.handleLeftPanel(e):this.handleRightPanel(e))):(e.preventDefault(),this.enterFocusMode()))}enterFocusMode(){this.focusMode=!0,this.currentPanel="left",this.selectedIndex=0,this.articleScrollPosition=0,document.body.classList.add("focus-mode"),this.collectLeftPanelItems(),this.collectRightPanelItems(),this.updateSelection(),this.showToast("已进入文本聚焦模式 (按 q 退出)")}exitFocusMode(){this.focusMode=!1,document.body.classList.remove("focus-mode"),document.body.classList.remove("focus-mode-left"),document.body.classList.remove("focus-mode-right"),this.clearSelection(),this.showToast("已退出文本聚焦模式")}temporarilyExitFocusMode(){document.body.classList.remove("focus-mode"),document.body.classList.remove("focus-mode-left"),document.body.classList.remove("focus-mode-right"),this.clearSelection(),this.showToast("聚焦模式已暂停 (按 i 重新进入)");const t=e=>{"i"===e.key&&(e.preventDefault(),document.removeEventListener("keydown",t),this.enterFocusMode())};document.addEventListener("keydown",t)}switchPanel(e){this.currentPanel=e,this.selectedIndex=0,"left"===e?(document.body.classList.add("focus-mode-left"),document.body.classList.remove("focus-mode-right"),this.collectLeftPanelItems()):(document.body.classList.add("focus-mode-right"),document.body.classList.remove("focus-mode-left"),this.collectRightPanelItems()),this.updateSelection()}collectLeftPanelItems(){this.items=[],document.querySelectorAll(".file-item, .folder-header").forEach((e,t)=>{this.items.push({element:e,type:e.classList.contains("folder-header")?"folder":"file"})})}collectRightPanelItems(){this.articleItems=[];var e,t=document.querySelector(".article-content");t&&(e=t.querySelectorAll("h2, h3, h4, h5, h6"),t=t.querySelectorAll("p"),e.forEach(e=>{this.articleItems.push({element:e,type:"heading"})}),t.forEach(e=>{this.articleItems.push({element:e,type:"paragraph"})}))}handleLeftPanel(e){"ArrowDown"===e.key?(e.preventDefault(),this.selectedIndex<this.items.length-1&&(this.selectedIndex++,this.updateSelection())):"ArrowUp"===e.key?(e.preventDefault(),0<this.selectedIndex&&(this.selectedIndex--,this.updateSelection())):"Enter"===e.key?(e.preventDefault(),this.activateLeftItem()):"u"===e.key&&(e.preventDefault(),this.toggleFolder())}handleRightPanel(e){"ArrowDown"===e.key?(e.preventDefault(),this.scrollArticle("down")):"ArrowUp"===e.key?(e.preventDefault(),this.scrollArticle("up")):"Enter"===e.key&&(e.preventDefault(),this.showToast("文章浏览模式"))}updateSelection(){var e;this.clearSelection(),"left"===this.currentPanel&&this.items[this.selectedIndex]?((e=this.items[this.selectedIndex]).element.classList.add("focus-selected"),e.element.scrollIntoView({behavior:"smooth",block:"nearest"})):"right"===this.currentPanel&&this.articleItems[this.selectedIndex]&&((e=this.articleItems[this.selectedIndex]).element.classList.add("focus-selected"),e.element.scrollIntoView({behavior:"smooth",block:"center"}))}clearSelection(){document.querySelectorAll(".focus-selected").forEach(e=>{e.classList.remove("focus-selected")})}activateLeftItem(){var e;this.items[this.selectedIndex]&&("folder"===(e=this.items[this.selectedIndex]).type?this.toggleFolder():"file"===e.type&&(e.element.click(),this.switchPanel("right")))}toggleFolder(){var e;this.items[this.selectedIndex]&&"folder"===(e=this.items[this.selectedIndex]).type&&(e=e.element.closest(".folder"))&&(e.classList.toggle("open"),setTimeout(()=>{this.collectLeftPanelItems(),this.updateSelection()},100))}scrollArticle(e){var t=document.querySelector(".article-container");t&&("down"===e?t.scrollTop+=200:"up"===e&&(t.scrollTop-=200))}showToast(e){const t=document.createElement("div");t.className="focus-mode-toast",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.classList.add("show")},10),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>t.remove(),300)},2e3)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.passageFocusMode=new PassageFocusMode}):window.passageFocusMode=new PassageFocusMode;
