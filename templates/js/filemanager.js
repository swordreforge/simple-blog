const FileManager={currentPath:"img",currentRoot:"img",selectedFile:null,filesToUpload:[],getAuthHeader(){return"Bearer "+this.getCookie("auth_token")},getCookie(e){e=("; "+document.cookie).split(`; ${e}=`);return 2===e.length?e.pop().split(";").shift():""},init(){this.bindEvents(),this.loadFiles()},bindEvents(){document.getElementById("backBtn").addEventListener("click",()=>this.goBack()),document.getElementById("uploadBtn").addEventListener("click",()=>this.openUploadModal()),document.getElementById("createDirBtn").addEventListener("click",()=>this.openCreateDirModal()),document.querySelectorAll(".fm-root-btn").forEach(e=>{e.addEventListener("click",e=>{e=e.currentTarget.dataset.path;this.switchRoot(e)})}),document.querySelectorAll(".modal-close, .fm-modal-close-btn, .fm-modal-close").forEach(e=>{e.addEventListener("click",e=>{e=e.target.closest(".modal")||e.target.closest(".fm-modal");e&&this.closeModal(e)})});const t=document.getElementById("uploadArea"),a=document.getElementById("fileInput");t&&a?(t.addEventListener("click",e=>{e.stopPropagation(),e.preventDefault(),a.click()}),a.addEventListener("change",e=>{e.stopPropagation(),this.handleFileSelect(e)}),t.addEventListener("dragover",e=>{e.preventDefault(),e.stopPropagation(),t.classList.add("dragover")}),t.addEventListener("dragleave",e=>{e.preventDefault(),e.stopPropagation(),t.classList.remove("dragover")}),t.addEventListener("drop",e=>{e.preventDefault(),e.stopPropagation(),t.classList.remove("dragover"),this.handleFileDrop(e)})):console.error("ä¸Šä¼ åŒºåŸŸæˆ–æ–‡ä»¶è¾“å…¥æ¡†æœªæ‰¾åˆ°"),document.getElementById("confirmUploadBtn").addEventListener("click",()=>this.uploadFiles()),document.getElementById("confirmCreateDirBtn").addEventListener("click",()=>this.createDirectory()),document.getElementById("confirmRenameBtn").addEventListener("click",()=>this.renameFile()),document.getElementById("confirmDeleteBtn").addEventListener("click",()=>this.deleteFile()),document.addEventListener("click",e=>{e.target.closest(".context-menu")||e.target.closest(".file-item")||this.hideContextMenu()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(this.hideContextMenu(),document.querySelectorAll(".modal.active, .fm-modal.active").forEach(e=>{this.closeModal(e)}))})},async loadFiles(){if("attachments"===this.currentRoot)await this.loadAttachments();else try{var e=await(await fetch("/api/files?path="+encodeURIComponent(this.currentPath),{headers:{Authorization:this.getAuthHeader()}})).json();e.success?(this.renderFiles(e.data.files),this.updateBreadcrumb(e.data.current_path),this.updateBackButton(e.data.parent_path),this.updateFileCount(e.data.files.length)):this.showToast(e.message,"error")}catch(e){console.error("åŠ è½½æ–‡ä»¶å¤±è´¥:",e),this.showToast("åŠ è½½æ–‡ä»¶å¤±è´¥","error")}},async loadAttachments(){try{var e=await(await fetch("/api/admin/attachments",{headers:{Authorization:this.getAuthHeader()}})).json();e.success?(this.currentAttachments=e.data,this.renderAttachments(e.data),this.updateBreadcrumb("/attachments"),this.updateBackButton(null),this.updateFileCount(e.total)):this.showToast(e.message,"error")}catch(e){console.error("åŠ è½½é™„ä»¶å¤±è´¥:",e),this.showToast("åŠ è½½é™„ä»¶å¤±è´¥","error")}},renderAttachments(e){var t=document.getElementById("fileGrid"),a=document.getElementById("emptyState");0===e.length?(t.innerHTML="",a.style.display="flex"):(a.style.display="none",t.innerHTML=e.map(e=>this.createAttachmentItem(e)).join(""),t.querySelectorAll(".file-item").forEach(a=>{a.addEventListener("click",e=>{e.stopPropagation();var t=a.dataset.id;this.showAttachmentMenu(t,e)})}))},createAttachmentItem(e){var t={public:"ğŸŒ",private:"ğŸ”’",protected:"ğŸ›¡ï¸"}[e.visibility]||"ğŸŒ",a={public:"å…¬å¼€",private:"ç§å¯†",protected:"å—ä¿æŠ¤"}[e.visibility]||"å…¬å¼€",o=e.show_in_passage?'<span class="badge badge-success">æ˜¾ç¤º</span>':'<span class="badge badge-secondary">éšè—</span>';return`
      <div class="file-item" data-id="${e.id}">
        <div class="file-icon">${this.getFileIcon(e.file_type)}</div>
        <div class="file-info">
          <div class="file-name">${e.file_name}</div>
          <div class="file-meta">
            <span>${t} ${a}</span>
            ${o}
            <span>${this.formatFileSize(e.file_size)}</span>
          </div>
        </div>
      </div>
    `},showAttachmentMenu(a,e){var t=this.currentAttachments?.find(e=>e.id===parseInt(a));if(t){const o=document.createElement("div");o.className="context-menu",o.style.position="absolute",o.style.left=e.clientX+"px",o.style.top=e.clientY+"px",o.innerHTML=`
      <div class="context-menu-item" data-action="toggle-visibility">
        <span>åˆ‡æ¢å¯è§æ€§</span>
        <span class="context-menu-icon">${"public"===t.visibility?"ğŸ”’":"ğŸŒ"}</span>
      </div>
      <div class="context-menu-item" data-action="toggle-show">
        <span>${t.show_in_passage?"åœ¨æ–‡ç« ä¸­éšè—":"åœ¨æ–‡ç« ä¸­æ˜¾ç¤º"}</span>
        <span class="context-menu-icon">${t.show_in_passage?"ğŸ‘ï¸â€ğŸ—¨ï¸":"ğŸ‘ï¸"}</span>
      </div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item context-menu-danger" data-action="delete">
        <span>åˆ é™¤é™„ä»¶</span>
        <span class="context-menu-icon">ğŸ—‘ï¸</span>
      </div>
    `,document.body.appendChild(o),o.querySelectorAll(".context-menu-item").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation();e=t.dataset.action;this.handleAttachmentAction(a,e),o.remove()})}),setTimeout(()=>{document.addEventListener("click",function e(){o.remove(),document.removeEventListener("click",e)})},0)}},async handleAttachmentAction(e,t){switch(t){case"toggle-visibility":await this.toggleAttachmentVisibility(e);break;case"toggle-show":await this.toggleAttachmentShow(e);break;case"delete":await this.deleteAttachment(e)}},async toggleAttachmentVisibility(t){var e=this.currentAttachments?.find(e=>e.id===parseInt(t));if(e){e="public"===e.visibility?"private":"public";try{var a=await(await fetch("/api/admin/attachments/"+t,{method:"PATCH",headers:{Authorization:this.getAuthHeader(),"Content-Type":"application/json"},body:JSON.stringify({visibility:e})})).json();a.success?(this.showToast("æ›´æ–°æˆåŠŸ","success"),this.loadAttachments()):this.showToast(a.message,"error")}catch(e){console.error("æ›´æ–°é™„ä»¶å¤±è´¥:",e),this.showToast("æ›´æ–°é™„ä»¶å¤±è´¥","error")}}},async toggleAttachmentShow(t){var e=this.currentAttachments?.find(e=>e.id===parseInt(t));if(e)try{var a=await(await fetch("/api/admin/attachments?id="+t,{method:"PATCH",headers:{Authorization:this.getAuthHeader(),"Content-Type":"application/json"},body:JSON.stringify({show_in_passage:!e.show_in_passage})})).json();a.success?(this.showToast("æ›´æ–°æˆåŠŸ","success"),this.loadAttachments()):this.showToast(a.message,"error")}catch(e){console.error("æ›´æ–°é™„ä»¶å¤±è´¥:",e),this.showToast("æ›´æ–°é™„ä»¶å¤±è´¥","error")}},async deleteAttachment(e){if(confirm("ç¡®å®šè¦åˆ é™¤æ­¤é™„ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚"))try{var t=await(await fetch("/api/admin/attachments/"+e,{method:"DELETE",headers:{Authorization:this.getAuthHeader()}})).json();t.success?(this.showToast("åˆ é™¤æˆåŠŸ","success"),this.loadAttachments()):this.showToast(t.message,"error")}catch(e){console.error("åˆ é™¤é™„ä»¶å¤±è´¥:",e),this.showToast("åˆ é™¤é™„ä»¶å¤±è´¥","error")}},formatFileSize:function(e){var t;return 0===e?"0 B":(t=Math.floor(Math.log(e)/Math.log(1024)),parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB"][t])},getFileIcon(e){return{image:"ğŸ–¼ï¸",video:"ğŸ¬",audio:"ğŸµ",document:"ğŸ“„",archive:"ğŸ“¦"}[e]||"ğŸ“"},renderFiles(e){var t=document.getElementById("fileGrid"),a=document.getElementById("emptyState");0===e.length?(t.innerHTML="",a.style.display="flex"):(a.style.display="none",a=[...e].sort((e,t)=>e.is_dir&&!t.is_dir?-1:!e.is_dir&&t.is_dir?1:e.name.localeCompare(t.name)),t.innerHTML=a.map(e=>this.createFileItem(e)).join(""),t.querySelectorAll(".file-item").forEach(o=>{o.addEventListener("click",e=>{e.stopPropagation();e=o.dataset.path;"true"===o.dataset.isDir?this.navigateTo(e):e.toLowerCase().endsWith(".md")?this.previewMarkdownFile(e):this.openFile(e)}),o.addEventListener("contextmenu",e=>{e.preventDefault();var t=o.dataset.path,a="true"===o.dataset.isDir;this.showContextMenu(e,t,a)})}))},createFileItem(e){let t="ğŸ“„",a="";e.is_dir?(t="ğŸ“",a="directory"):[".jpg",".jpeg",".png",".gif",".webp",".bmp",".svg",".ico",".tiff",".tif"].includes(e.extension)?(t=`<img src="/${e.path}" alt="${e.name}" onerror="this.parentElement.innerHTML='ğŸ–¼ï¸'">`,a="image"):[".mp3",".flac",".wav",".ogg",".m4a",".aac",".wma",".opus",".ape"].includes(e.extension)?(t="ğŸµ",a="audio"):[".mp4",".webm",".mkv",".avi",".mov",".wmv",".flv",".m4v",".3gp"].includes(e.extension)?(t="ğŸ¬",a="video"):[".pdf",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".txt"].includes(e.extension)?(t="ğŸ“„",a="document"):".md"===e.extension&&(t="ğŸ“",a="markdown");var o=this.formatFileSize(e.size);return`
      <div class="file-item ${a}" data-path="${e.path}" data-is-dir="${e.is_dir}">
        <div class="file-icon">${t}</div>
        <div class="file-name">${e.name}</div>
        <div class="file-meta">${e.is_dir?"æ–‡ä»¶å¤¹":o}</div>
      </div>
    `},updateBreadcrumb(e){document.getElementById("currentPath").textContent=e||"/"},updateBackButton(e){document.getElementById("backBtn").disabled=!e},updateFileCount(e){document.getElementById("fileCount").textContent=e+" ä¸ªé¡¹ç›®"},switchRoot(t){this.currentRoot=t,this.currentPath=t,document.querySelectorAll(".fm-root-btn").forEach(e=>{e.classList.toggle("fm-root-btn-active",e.dataset.path===t)}),this.loadFiles()},navigateTo(e){this.currentPath=e,this.loadFiles()},goBack(){var e=this.getParentPath(this.currentPath);e&&this.navigateTo(e)},getParentPath(e){return e===this.currentRoot?null:((e=e.split("/")).pop(),e.join("/")||this.currentRoot)},async openFile(e){var t=e.split(".").pop().toLowerCase(),a=e.split("/").pop();if("md"===t)this.previewMarkdownFile(e);else if([".jpg",".jpeg",".png",".gif",".webp",".bmp",".svg",".ico",".tiff",".tif"].includes("."+t))this.openImagePreview(e,a);else if([".mp3",".flac",".wav",".ogg",".m4a",".aac",".wma"].includes("."+t))this.openAudioPreview(e,a);else if([".mp4",".webm",".mkv",".avi",".mov",".wmv",".flv"].includes("."+t))this.openVideoPreview(e,a);else if([".pdf",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".txt"].includes("."+t))this.openDocumentPreview(e,a,t);else try{var o,i,s,n,d=await fetch("/api/files/download?path="+encodeURIComponent(e),{headers:{Authorization:this.getAuthHeader()}});d.ok?(i=await d.blob(),s=window.URL.createObjectURL(i),(n=document.createElement("a")).href=s,n.download=a,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(s)):(o=await d.json(),this.showToast(o.message||"ä¸‹è½½å¤±è´¥","error"))}catch(e){console.error("ä¸‹è½½å¤±è´¥:",e),this.showToast("ä¸‹è½½å¤±è´¥","error")}},openImagePreview(e,t){e="/"+e;const a=document.createElement("div");a.className="fm-modal preview-modal",a.innerHTML=`
      <div class="fm-modal-content preview-content">
        <div class="fm-modal-header">
          <h3>${t}</h3>
          <button class="fm-modal-close">&times;</button>
        </div>
        <div class="fm-modal-body preview-body">
          <img src="${e}" alt="${t}" class="preview-image">
        </div>
      </div>
    `,document.body.appendChild(a);e=a.querySelector(".fm-modal-close");const o=()=>{document.body.removeChild(a)},i=(e.addEventListener("click",o),a.addEventListener("click",e=>{e.target===a&&o()}),e=>{"Escape"===e.key&&(o(),document.removeEventListener("keydown",i))});document.addEventListener("keydown",i),a.classList.add("active")},openAudioPreview(e,t){var a="/"+e;const o=document.createElement("div");o.className="fm-modal preview-modal",o.innerHTML=`
      <div class="fm-modal-content preview-content audio-preview">
        <div class="fm-modal-header">
          <h3>${t}</h3>
          <button class="fm-modal-close">&times;</button>
        </div>
        <div class="fm-modal-body preview-body">
          <div class="audio-icon">ğŸµ</div>
          <audio controls autoplay class="preview-audio">
            <source src="${a}" type="audio/${e.split(".").pop()}">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
          </audio>
        </div>
      </div>
    `,document.body.appendChild(o);t=o.querySelector(".fm-modal-close");const i=()=>{var e=o.querySelector("audio");e&&e.pause(),document.body.removeChild(o)},s=(t.addEventListener("click",i),o.addEventListener("click",e=>{e.target===o&&i()}),e=>{"Escape"===e.key&&(i(),document.removeEventListener("keydown",s))});document.addEventListener("keydown",s),o.classList.add("active")},openVideoPreview(e,t){var a="/"+e;const o=document.createElement("div");o.className="fm-modal preview-modal",o.innerHTML=`
      <div class="fm-modal-content preview-content video-preview">
        <div class="fm-modal-header">
          <h3>${t}</h3>
          <button class="fm-modal-close">&times;</button>
        </div>
        <div class="fm-modal-body preview-body">
          <video controls autoplay class="preview-video">
            <source src="${a}" type="video/${e.split(".").pop()}">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
          </video>
        </div>
      </div>
    `,document.body.appendChild(o);t=o.querySelector(".fm-modal-close");const i=()=>{var e=o.querySelector("video");e&&(e.pause(),e.currentTime=0),document.body.removeChild(o)},s=(t.addEventListener("click",i),o.addEventListener("click",e=>{e.target===o&&i()}),e=>{"Escape"===e.key&&(i(),document.removeEventListener("keydown",s))});document.addEventListener("keydown",s),requestAnimationFrame(()=>{o.classList.add("active")})},async openDocumentPreview(e,t,a){var o="/"+e;const i=document.createElement("div");i.className="fm-modal preview-modal";let s="",n="document-preview";switch(a){case"pdf":s=`
          <embed src="${o}" type="application/pdf" class="preview-embed" />
        `,n="pdf-preview";break;case"txt":s=`
          <iframe src="${o}" class="preview-iframe"></iframe>
        `,n="txt-preview";break;case"doc":case"docx":case"xls":case"xlsx":case"ppt":case"pptx":s=`
          <iframe src="https://docs.google.com/viewer?url=${encodeURIComponent(window.location.origin+"/"+e)}&embedded=true" class="preview-iframe"></iframe>
        `,n="office-preview";break;default:s=`
          <div class="preview-placeholder">
            <div class="placeholder-icon">ğŸ“„</div>
            <p>æ­¤æ–‡ä»¶ç±»å‹æš‚ä¸æ”¯æŒåœ¨çº¿é¢„è§ˆ</p>
            <button class="fm-btn fm-btn-primary" onclick="FileManager.downloadFile('${e}')">ä¸‹è½½æ–‡ä»¶</button>
          </div>
        `}i.innerHTML=`
      <div class="fm-modal-content preview-content ${n}">
        <div class="fm-modal-header">
          <h3>${t}</h3>
          <button class="fm-modal-close">&times;</button>
        </div>
        <div class="fm-modal-body preview-body">
          ${s}
        </div>
        <div class="fm-modal-footer">
          <button class="fm-btn fm-btn-secondary fm-modal-close-btn">å…³é—­</button>
          <button class="fm-btn fm-btn-primary" onclick="FileManager.downloadFile('${e}')">ä¸‹è½½æ–‡ä»¶</button>
        </div>
      </div>
    `,document.body.appendChild(i);a=i.querySelector(".fm-modal-close");const d=()=>{document.body.removeChild(i)},r=(a.addEventListener("click",d),i.addEventListener("click",e=>{e.target===i&&d()}),i.querySelectorAll(".fm-modal-close-btn").forEach(e=>{e.addEventListener("click",d)}),e=>{"Escape"===e.key&&(d(),document.removeEventListener("keydown",r))});document.addEventListener("keydown",r),i.classList.add("active")},async previewMarkdownFile(e){var t;window.MarkdownPreviewModal?this.openMarkdownPreview(e):((t=document.createElement("script")).src="/js/markdown-preview-modal.js",t.onload=()=>{this.openMarkdownPreview(e)},t.onerror=()=>{this.showToast("é¢„è§ˆç»„ä»¶åŠ è½½å¤±è´¥","error")},document.head.appendChild(t))},openMarkdownPreview(e){let t=e;if(t.startsWith("/")){var a=t.indexOf("/markdown/");if(-1===a)return console.error("æ— æ•ˆçš„ Markdown è·¯å¾„:",e),void this.showToast("æ— æ•ˆçš„ Markdown è·¯å¾„","error");t=t.substring(a+10)}else{if(!t.startsWith("markdown/"))return console.error("æ— æ•ˆçš„ Markdown è·¯å¾„:",e),void this.showToast("æ— æ•ˆçš„ Markdown è·¯å¾„","error");t=t.substring(9)}t&&"/"!==t&&""!==t.trim()?(console.log("Markdown é¢„è§ˆè·¯å¾„:",t),window.MarkdownPreviewModal?window.MarkdownPreviewModal.open(t):this.showToast("é¢„è§ˆåŠŸèƒ½ä¸å¯ç”¨","error")):(console.error("æå–åçš„ Markdown è·¯å¾„æ— æ•ˆ:",t),this.showToast("æ— æ•ˆçš„ Markdown è·¯å¾„","error"))},async downloadFile(e){try{var t,a,o,i,s,n=await fetch("/api/files/download?path="+encodeURIComponent(e),{headers:{Authorization:this.getAuthHeader()}});n.ok?(a=e.split("/").pop(),o=await n.blob(),i=window.URL.createObjectURL(o),(s=document.createElement("a")).href=i,s.download=a,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(i)):(t=await n.json(),this.showToast(t.message||"ä¸‹è½½å¤±è´¥","error"))}catch(e){console.error("ä¸‹è½½å¤±è´¥:",e),this.showToast("ä¸‹è½½å¤±è´¥","error")}},showContextMenu(e,t,a){this.selectedFile={path:t,isDir:a};var o=document.getElementById("contextMenu");o.style.left=e.pageX+"px",o.style.top=e.pageY+"px",o.classList.add("active");const i=t.toLowerCase().endsWith(".md");e=o.querySelectorAll(".context-menu-item");e.forEach(e=>{var t=e.dataset.action;e.style.display=("download"!==t||!a)&&("preview"!==t||i&&!a)?"flex":"none"}),e.forEach(e=>{e.onclick=()=>{this.handleContextAction(e.dataset.action),this.hideContextMenu()}})},hideContextMenu(){document.getElementById("contextMenu").classList.remove("active")},handleContextAction(e){if(this.selectedFile)switch(e){case"open":this.selectedFile.isDir?this.navigateTo(this.selectedFile.path):this.openFile(this.selectedFile.path);break;case"preview":this.previewMarkdownFile(this.selectedFile.path);break;case"download":this.downloadFile(this.selectedFile.path);break;case"rename":this.openRenameModal();break;case"delete":this.openDeleteModal()}},openUploadModal(){this.filesToUpload=[],this.updateUploadList(),document.getElementById("uploadModal").classList.add("active")},handleFileSelect(e){var t=Array.from(e.target.files);this.addFilesToUpload(t),e.target.value=""},handleFileDrop(e){e=Array.from(e.dataTransfer.files);this.addFilesToUpload(e)},addFilesToUpload(e){e.forEach(t=>{this.filesToUpload.find(e=>e.name===t.name)||this.filesToUpload.push(t)}),this.updateUploadList()},updateUploadList(){var e=document.getElementById("uploadList"),t=document.getElementById("confirmUploadBtn");0===this.filesToUpload.length?(e.innerHTML="",t.disabled=!0):(t.disabled=!1,e.innerHTML=this.filesToUpload.map((e,t)=>`
      <div class="upload-item">
        <div class="upload-item-name">${e.name}</div>
        <div class="upload-item-size">${this.formatFileSize(e.size)}</div>
        <button class="upload-item-remove" onclick="FileManager.removeFileFromUpload(${t})">âœ•</button>
      </div>
    `).join(""))},removeFileFromUpload(e){this.filesToUpload.splice(e,1),this.updateUploadList()},async uploadFiles(){if(0!==this.filesToUpload.length){var a=document.getElementById("confirmUploadBtn");a.disabled=!0,a.textContent="ä¸Šä¼ ä¸­...";let e=0,t=0;for(const s of this.filesToUpload)try{var o=new FormData;o.append("file",s);var i=await(await fetch("/api/files?path="+encodeURIComponent(this.currentPath),{method:"POST",headers:{Authorization:this.getAuthHeader()},body:o})).json();i.success?e++:(t++,console.error("ä¸Šä¼ å¤±è´¥:",i.message))}catch(e){console.error("ä¸Šä¼ å¤±è´¥:",e),t++}this.closeModal(document.getElementById("uploadModal")),this.loadFiles(),0<e&&0===t?this.showToast(`æˆåŠŸä¸Šä¼  ${e} ä¸ªæ–‡ä»¶`,"success"):0<e?this.showToast(`æˆåŠŸä¸Šä¼  ${e} ä¸ªæ–‡ä»¶ï¼Œå¤±è´¥ ${t} ä¸ª`,"warning"):this.showToast("ä¸Šä¼ å¤±è´¥","error"),a.disabled=!1,a.textContent="ä¸Šä¼ "}},openCreateDirModal(){document.getElementById("dirNameInput").value="",document.getElementById("createDirModal").classList.add("active"),setTimeout(()=>{document.getElementById("dirNameInput").focus()},100)},async createDirectory(){var e=document.getElementById("dirNameInput").value.trim();if(e)try{var t=await(await fetch("/api/files/create-dir",{method:"POST",headers:{"Content-Type":"application/json",Authorization:this.getAuthHeader()},body:JSON.stringify({path:this.currentPath,dir_name:e})})).json();t.success?(this.showToast("æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ","success"),this.closeModal(document.getElementById("createDirModal")),this.loadFiles()):this.showToast(t.message,"error")}catch(e){console.error("åˆ›å»ºç›®å½•å¤±è´¥:",e),this.showToast("åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥","error")}else this.showToast("è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°","warning")},openRenameModal(){var e;this.selectedFile&&(e=this.selectedFile.path.split("/").pop(),document.getElementById("renameInput").value=e,document.getElementById("renameModal").classList.add("active"),setTimeout(()=>{document.getElementById("renameInput").focus(),document.getElementById("renameInput").select()},100))},async renameFile(){if(this.selectedFile){var e=document.getElementById("renameInput").value.trim();if(e)try{var t=await(await fetch("/api/files",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:this.getAuthHeader()},body:JSON.stringify({old_path:this.selectedFile.path,new_name:e})})).json();t.success?(this.showToast("é‡å‘½åæˆåŠŸ","success"),this.closeModal(document.getElementById("renameModal")),this.loadFiles()):this.showToast(t.message,"error")}catch(e){console.error("é‡å‘½åå¤±è´¥:",e),this.showToast("é‡å‘½åå¤±è´¥","error")}else this.showToast("è¯·è¾“å…¥æ–°åç§°","warning")}},openDeleteModal(){var e;this.selectedFile&&(e=this.selectedFile.path.split("/").pop(),document.getElementById("deleteFileName").textContent=e,document.getElementById("deleteModal").classList.add("active"))},async deleteFile(){if(this.selectedFile)try{var e=await(await fetch("/api/files?path="+encodeURIComponent(this.selectedFile.path),{method:"DELETE",headers:{Authorization:this.getAuthHeader()}})).json();e.success?(this.showToast("åˆ é™¤æˆåŠŸ","success"),this.closeModal(document.getElementById("deleteModal")),this.loadFiles()):this.showToast(e.message,"error")}catch(e){console.error("åˆ é™¤å¤±è´¥:",e),this.showToast("åˆ é™¤å¤±è´¥","error")}},closeModal(e){e.classList.remove("active"),e.classList.add("closing"),setTimeout(()=>{e.classList.remove("closing")},300)},showToast(e,t="success"){const a=document.getElementById("toast");a.textContent=e,a.className=`toast ${t} active`,setTimeout(()=>{a.classList.remove("active")},3e3)}};document.addEventListener("DOMContentLoaded",()=>{FileManager.init()});
