const AuthManager={isLoggedIn:!1,currentUser:null,token:null,eccEncryptor:null,init(){this.checkLoginStatus(),this.setupEventListeners(),this.updateUI(),this.initECCEncryption()},async initECCEncryption(){try{var t=checkCryptoSupport();if(t.supported)this.eccEncryptor=new ECCEncryptor,await this.eccEncryptor.init(),console.log("ECC encryption initialized successfully");else{let e="Web Crypto API not supported, falling back to plain text";"insecure_context"===t.reason&&(e+=` (${t.protocol}://${t.hostname} is not a secure context - requires HTTPS or localhost)`),void console.warn(e)}}catch(e){console.error("Failed to initialize ECC encryption:",e),this.eccEncryptor=null}},checkLoginStatus(){var e=localStorage.getItem("auth_token"),t=localStorage.getItem("auth_user");e&&t?(this.isLoggedIn=!0,this.token=e,this.currentUser=JSON.parse(t)):(this.isLoggedIn=!1,this.token=null,this.currentUser=null)},setupEventListeners(){var e=document.getElementById("loginBtn"),e=(e&&e.addEventListener("click",()=>this.openLoginModal()),document.getElementById("loginForm")),e=(e&&e.addEventListener("submit",e=>this.handleLogin(e)),document.querySelector('.modal-close[data-modal="loginModal"]'));e&&e.addEventListener("click",()=>this.closeLoginModal());const t=document.getElementById("loginModal");t&&t.addEventListener("click",e=>{e.target===t&&this.closeLoginModal()});e=document.getElementById("openRegisterModal"),e&&e.addEventListener("click",e=>{e.preventDefault(),this.closeLoginModal(),this.openRegisterModal()}),e=document.getElementById("registerForm"),e&&e.addEventListener("submit",e=>this.handleRegister(e)),e=document.querySelector('.modal-close[data-modal="registerModal"]');e&&e.addEventListener("click",()=>this.closeRegisterModal());const n=document.getElementById("registerModal");n&&n.addEventListener("click",e=>{e.target===n&&this.closeRegisterModal()});e=document.getElementById("openLoginModal"),e&&e.addEventListener("click",e=>{e.preventDefault(),this.closeRegisterModal(),this.openLoginModal()}),e=document.querySelector('.modal-close[data-modal="userCenterModal"]');e&&e.addEventListener("click",()=>this.closeUserCenterModal());const o=document.getElementById("userCenterModal");o&&o.addEventListener("click",e=>{e.target===o&&this.closeUserCenterModal()});e=document.getElementById("logoutBtn"),e&&e.addEventListener("click",()=>this.handleLogout()),e=document.getElementById("userCenterToggle");e&&e.addEventListener("click",()=>this.openUserCenterModal()),document.addEventListener("keydown",e=>{"Escape"===e.key&&(this.closeLoginModal(),this.closeRegisterModal(),this.closeUserCenterModal())})},openLoginModal(){var e=document.getElementById("loginModal");e&&(e.classList.add("active"),document.body.style.overflow="hidden",setTimeout(()=>{var e=document.getElementById("loginUsername");e&&e.focus()},100))},closeLoginModal(){const t=document.getElementById("loginModal");t&&(t.classList.add("closing"),setTimeout(()=>{t.classList.remove("active","closing"),document.body.style.overflow="";var e=document.getElementById("loginForm"),e=(e&&e.reset(),document.getElementById("loginError"));e&&(e.textContent="",e.style.display="none")},300))},openUserCenterModal(){var e,t=document.getElementById("userCenterModal");t&&((e=document.getElementById("userCenterUsername"))&&this.currentUser&&(e.textContent=this.currentUser.username),t.classList.add("active"),document.body.style.overflow="hidden")},closeUserCenterModal(){const e=document.getElementById("userCenterModal");e&&(e.classList.add("closing"),setTimeout(()=>{e.classList.remove("active","closing"),document.body.style.overflow=""},300))},openRegisterModal(){var e=document.getElementById("registerModal");e&&(e.classList.add("active"),document.body.style.overflow="hidden",setTimeout(()=>{var e=document.getElementById("registerUsername");e&&e.focus()},100))},closeRegisterModal(){const t=document.getElementById("registerModal");t&&(t.classList.add("closing"),setTimeout(()=>{t.classList.remove("active","closing"),document.body.style.overflow="";var e=document.getElementById("registerForm"),e=(e&&e.reset(),document.getElementById("registerError"));e&&(e.textContent="",e.style.display="none")},300))},async handleLogin(t){t.preventDefault();var t=document.getElementById("loginUsername"),n=document.getElementById("loginPassword"),o=document.getElementById("loginError"),e=document.getElementById("loginSubmitBtn");if(t&&n){t=t.value.trim(),n=n.value.trim();if(t&&n){e&&(e.disabled=!0,e.textContent="登录中...");try{let e={username:t,password:n};if(this.eccEncryptor&&this.eccEncryptor.isReady())try{var s=await this.eccEncryptor.encrypt(n);e={username:t,encrypted_password:s.encrypted,session_id:s.sessionId,client_public_key:s.clientPublicKey,algorithm:s.algorithm}}catch(e){console.warn("ECC encryption failed, falling back to plain text:",e)}var i=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await i.json();i.ok&&r.success?(localStorage.setItem("auth_token",r.token),localStorage.setItem("auth_user",JSON.stringify(r.user)),this.isLoggedIn=!0,this.token=r.token,this.currentUser=r.user,this.updateUI(),this.closeLoginModal(),this.openUserCenterModal(),this.showNotification("登录成功！","success")):o&&(o.textContent=r.message||"登录失败，请检查用户名和密码",o.style.display="block")}catch(e){console.error("登录错误:",e),o&&(o.textContent="网络错误，请稍后重试",o.style.display="block")}finally{e&&(e.disabled=!1,e.textContent="登录")}}else o&&(o.textContent="请输入用户名和密码",o.style.display="block")}},async handleRegister(t){t.preventDefault();var t=document.getElementById("registerUsername"),n=document.getElementById("registerEmail"),e=document.getElementById("registerPassword"),o=document.getElementById("registerError"),s=document.getElementById("registerSubmitBtn");if(t&&n&&e){const l=t.value.trim();t=n.value.trim(),n=e.value.trim();if(l&&t&&n){s&&(s.disabled=!0,s.textContent="注册中...");try{let e={username:l,email:t,password:n};if(this.eccEncryptor&&this.eccEncryptor.isReady())try{var i=await this.eccEncryptor.encrypt(n);e={username:l,email:t,encrypted_password:i.encrypted,session_id:i.sessionId,client_public_key:i.clientPublicKey,algorithm:i.algorithm}}catch(e){console.warn("ECC encryption failed, falling back to plain text:",e)}var r=await fetch("/api/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),a=await r.json();r.ok&&a.success?(this.closeRegisterModal(),this.showNotification("注册成功！请登录","success"),setTimeout(()=>{this.openLoginModal();var e=document.getElementById("loginUsername");e&&(e.value=l)},500)):o&&(o.textContent=a.message||"注册失败，请稍后重试",o.style.display="block")}catch(e){console.error("注册错误:",e),o&&(o.textContent="网络错误，请稍后重试",o.style.display="block")}finally{s&&(s.disabled=!1,s.textContent="注册")}}else o&&(o.textContent="请填写所有必填字段",o.style.display="block")}},async handleLogout(){try{var e=this.getToken();e&&await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e}})}catch(e){console.error("退出登录请求失败:",e)}finally{localStorage.removeItem("auth_token"),localStorage.removeItem("auth_user"),document.cookie="auth_token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;",this.isLoggedIn=!1,this.token=null,this.currentUser=null,this.updateUI(),this.closeUserCenterModal(),this.showNotification("已退出登录","info")}},toggleUserCenter(){this.openUserCenterModal()},updateUI(){var e=document.getElementById("loginBtn"),t=document.getElementById("userCenter"),n=document.getElementById("userCenterToggle"),o=document.getElementById("usernameDisplay"),s=document.getElementById("userCenterUsername"),i=document.querySelectorAll(".admin-only");this.isLoggedIn&&this.currentUser?(e&&(e.style.display="none"),t&&(t.style.display="block"),n&&(n.style.display="flex"),o&&(o.textContent=this.currentUser.username),s&&(s.textContent=this.currentUser.username),i.forEach(e=>{"admin"===this.currentUser.role?"A"!==e.tagName||e.classList.contains("user-center-item")?e.classList.contains("user-center-item")?e.style.setProperty("display","flex","important"):e.style.setProperty("display","block","important"):e.style.setProperty("display","inline-block","important"):e.style.setProperty("display","none","important")})):(e&&(e.style.display="flex"),t&&(t.style.display="none"),n&&(n.style.display="none"),s&&(s.textContent="用户名"),i.forEach(e=>{e.style.display="none"}))},showNotification(e,t="info"){const n=document.createElement("div");n.className="notification notification-"+t,n.textContent=e,n.style.cssText=`
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background: ${"success"===t?"#00b894":"error"===t?"#e74c3c":"#007bff"};
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 10000;
      animation: slideInRight 0.3s ease;
      font-weight: 500;
    `,document.getElementById("notification-styles")||((e=document.createElement("style")).id="notification-styles",e.textContent=`
        @keyframes slideInRight {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        @keyframes slideOutRight {
          from {
            transform: translateX(0);
            opacity: 1;
          }
          to {
            transform: translateX(100%);
            opacity: 0;
          }
        }
      `,document.head.appendChild(e)),document.body.appendChild(n),setTimeout(()=>{n.style.animation="slideOutRight 0.3s ease",setTimeout(()=>{n.remove()},300)},3e3)},getToken(){return this.token},getCurrentUser(){return this.currentUser},isAuthenticated(){return this.isLoggedIn},async authenticatedFetch(e,t={}){var n=this.getToken();if(!n)throw new Error("未登录");n={...t.headers,Authorization:"Bearer "+n},e=await fetch(e,{...t,headers:n});if(401===e.status)throw this.handleLogout(),new Error("登录已过期，请重新登录");return e}};document.addEventListener("DOMContentLoaded",()=>{AuthManager.init()}),window.AuthManager=AuthManager;
