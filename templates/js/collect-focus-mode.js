class CollectFocusMode{constructor(){this.focusMode=!1,this.currentLevel="main",this.mainIndex=0,this.subIndex=0,this.mainItems=[],this.subItems=[],this.init()}init(){document.addEventListener("keydown",e=>this.handleKeyPress(e))}handleKeyPress(e){var t=document.activeElement;t&&("INPUT"===t.tagName||"TEXTAREA"===t.tagName||t.isContentEditable)||("i"!==e.key||this.focusMode?"q"===e.key&&this.focusMode?(e.preventDefault(),this.exitFocusMode()):this.focusMode&&("Escape"===e.key?(e.preventDefault(),"sub"===this.currentLevel?this.returnToMain():this.temporarilyExitFocusMode()):"main"===this.currentLevel?this.handleMainLevel(e):this.handleSubLevel(e)):(e.preventDefault(),this.enterFocusMode()))}enterFocusMode(){this.focusMode=!0,this.currentLevel="main",this.mainIndex=0,this.subIndex=0,document.body.classList.add("collect-focus-mode"),this.collectMainItems(),this.updateSelection(),this.showToast("已进入归档聚焦模式 (按 q 退出)")}exitFocusMode(){this.focusMode=!1,document.body.classList.remove("collect-focus-mode"),document.body.classList.remove("collect-focus-mode-main"),document.body.classList.remove("collect-focus-mode-sub"),this.clearSelection(),this.showToast("已退出归档聚焦模式")}temporarilyExitFocusMode(){document.body.classList.remove("collect-focus-mode"),document.body.classList.remove("collect-focus-mode-main"),document.body.classList.remove("collect-focus-mode-sub"),this.clearSelection(),this.showToast("聚焦模式已暂停 (按 i 重新进入)");const t=e=>{"i"===e.key&&(e.preventDefault(),document.removeEventListener("keydown",t),this.enterFocusMode())};document.addEventListener("keydown",t)}collectMainItems(){this.mainItems=[];var e=document.querySelector(".archive-filter");e&&this.mainItems.push({element:e,type:"filter",title:"筛选归档"});document.querySelectorAll(".document-card").forEach(e=>{this.mainItems.push({element:e,type:"article",title:e.querySelector(".document-title")?.textContent||"文章"})});e=document.querySelector(".timeline-container"),e&&this.mainItems.push({element:e,type:"timeline",title:"文章时间线"}),e=document.querySelector(".tags-container");e&&this.mainItems.push({element:e,type:"tags",title:"标签云"})}collectSubItems(e){this.subItems=[],"filter"===e.type?e.element.querySelectorAll(".filter-btn").forEach(e=>{this.subItems.push({element:e,type:"filter-btn",title:e.textContent})}):"article"===e.type?e.element.querySelectorAll(".tag").forEach(e=>{this.subItems.push({element:e,type:"tag",title:e.textContent})}):"timeline"===e.type?e.element.querySelectorAll(".timeline-year").forEach(e=>{this.subItems.push({element:e,type:"year",title:e.textContent})}):"tags"===e.type&&e.element.querySelectorAll(".cloud-tag").forEach(e=>{this.subItems.push({element:e,type:"cloud-tag",title:e.textContent})})}handleMainLevel(e){"ArrowDown"===e.key?(e.preventDefault(),this.mainIndex<this.mainItems.length-1&&(this.mainIndex++,this.updateSelection())):"ArrowUp"===e.key?(e.preventDefault(),0<this.mainIndex&&(this.mainIndex--,this.updateSelection())):"ArrowRight"===e.key?(e.preventDefault(),this.mainIndex<this.mainItems.length-1&&(this.mainIndex++,this.updateSelection())):"ArrowLeft"===e.key?(e.preventDefault(),0<this.mainIndex&&(this.mainIndex--,this.updateSelection())):"Enter"===e.key&&(e.preventDefault(),this.enterSubLevel())}handleSubLevel(e){"ArrowDown"===e.key?(e.preventDefault(),this.subIndex<this.subItems.length-1&&(this.subIndex++,this.updateSelection())):"ArrowUp"===e.key?(e.preventDefault(),0<this.subIndex&&(this.subIndex--,this.updateSelection())):"ArrowRight"===e.key?(e.preventDefault(),this.subIndex<this.subItems.length-1&&(this.subIndex++,this.updateSelection())):"ArrowLeft"===e.key?(e.preventDefault(),0<this.subIndex&&(this.subIndex--,this.updateSelection())):"Enter"===e.key&&(e.preventDefault(),this.activateSubItem())}enterSubLevel(){var e,t;this.mainItems[this.mainIndex]&&("article"===(e=this.mainItems[this.mainIndex]).type?(t=e.element.querySelector(".document-link"))&&(window.location.href=t.href):(this.collectSubItems(e),0===this.subItems.length?e.element.click():(this.currentLevel="sub",this.subIndex=0,document.body.classList.add("collect-focus-mode-sub"),document.body.classList.remove("collect-focus-mode-main"),this.updateSelection(),this.showToast(`进入 ${e.title} 子菜单`))))}returnToMain(){this.currentLevel="main",this.subIndex=0,document.body.classList.add("collect-focus-mode-main"),document.body.classList.remove("collect-focus-mode-sub"),this.updateSelection(),this.showToast("返回主菜单")}activateSubItem(){this.subItems[this.subIndex]&&this.subItems[this.subIndex].element.click()}updateSelection(){var e;this.clearSelection(),"main"===this.currentLevel&&this.mainItems[this.mainIndex]?((e=this.mainItems[this.mainIndex]).element.classList.add("collect-focus-selected"),e.element.scrollIntoView({behavior:"smooth",block:"center"})):"sub"===this.currentLevel&&this.subItems[this.subIndex]&&((e=this.subItems[this.subIndex]).element.classList.add("collect-focus-selected"),e.element.scrollIntoView({behavior:"smooth",block:"center"}))}clearSelection(){document.querySelectorAll(".collect-focus-selected").forEach(e=>{e.classList.remove("collect-focus-selected")})}showToast(e){const t=document.createElement("div");t.className="collect-focus-toast",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.classList.add("show")},10),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>t.remove(),300)},2e3)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.collectFocusMode=new CollectFocusMode}):window.collectFocusMode=new CollectFocusMode;
