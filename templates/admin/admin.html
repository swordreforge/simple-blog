<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
<title>{{ title }} - ÁÆ°ÁêÜÂëò</title>
<style>
:root {
  --navbar-glass-color: {{ settings.navbar_glass_color }};
  --card-glass-color: {{ settings.card_glass_color }};
  --footer-glass-color: {{ settings.footer_glass_color }};
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

a {
  color: rgba(255, 255, 255, 0.9);
  text-decoration: none;
}

a:hover {
  color: #fff;
}

html, body {
  height: 100%;
  width: 100%;
  overflow-x: hidden;
}

body {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  min-height: -webkit-fill-available;
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
  position: relative;
  background-image: url('{{ settings.background_image | safe }}');
  background-size: {{ settings.background_size }};
  background-position: {{ settings.background_position }};
  background-repeat: {{ settings.background_repeat }};
  background-attachment: {{ settings.background_attachment }};
  --global-opacity: {{ settings.global_opacity }};
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(5px);
  z-index: -1;
}

/* ÂØºËà™Ê†èÊ†∑Âºè */
nav {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  position: fixed;
  top: env(safe-area-inset-top);
  right: 0;
  padding: 15px env(safe-area-inset-right) 15px env(safe-area-inset-left);
  width: 100%;
  background: var(--navbar-glass-color, rgba(255, 255, 255, 0.85));
  backdrop-filter: blur(10px) saturate(180%);
  -webkit-backdrop-filter: blur(10px) saturate(180%);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  z-index: 100;
  transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
              opacity 0.4s ease;
  transform: translateY(0);
  opacity: 1;
}

nav.hidden {
  transform: translateY(-100%);
  opacity: 0;
}

nav a {
  color: var(--navbar-text-color, rgba(255, 255, 255, 0.9));
  text-decoration: none;
  margin: 0 15px;
  font-weight: 500;
  transition: all 0.3s ease;
  position: relative;
  padding: 8px 16px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 25px;
}

nav a:hover {
  color: #fff;
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

nav a::after {
  display: none;
}

nav a.current {
  color: #fff;
  background: rgba(255, 255, 255, 0.3);
  border-color: rgba(255, 255, 255, 0.6);
}

/* ÁôªÂΩïÊåâÈíÆÊ†∑Âºè */
#loginBtn {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--navbar-text-color, rgba(255, 255, 255, 0.9));
  text-decoration: none;
  margin: 0 15px;
  font-weight: 500;
  transition: all 0.3s ease;
  padding: 8px 16px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 25px;
  cursor: pointer;
}

#loginBtn:hover {
  color: #fff;
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

/* ‰∏™‰∫∫‰∏≠ÂøÉÊ†∑Âºè */
#userCenterToggle {
  display: none;
  align-items: center;
  gap: 8px;
  color: var(--navbar-text-color, rgba(255, 255, 255, 0.9));
  text-decoration: none;
  margin: 0 15px;
  font-weight: 500;
  transition: all 0.3s ease;
  padding: 8px 16px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 25px;
  cursor: pointer;
}

#userCenterToggle:hover {
  color: #fff;
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #333;
  font-weight: bold;
  font-size: 14px;
}

/* ‰∏™‰∫∫‰∏≠ÂøÉ‰∏ãÊãâËèúÂçï */
#userCenter {
  display: none;
  position: fixed;
  top: calc(env(safe-area-inset-top) + 70px);
  left: 20px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  z-index: 101;
  min-width: 200px;
  overflow: hidden;
  animation: slideDown 0.3s ease;
}

#userCenter.active {
  display: block;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.user-center-header {
  padding: 20px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.user-center-header h3 {
  font-size: 1.2em;
  margin-bottom: 5px;
}

.user-center-header p {
  font-size: 0.9em;
  opacity: 0.7;
  color: rgba(255, 255, 255, 0.9);
}

.user-center-menu {
  padding: 10px 0;
}

.user-center-menu a {
  display: block;
  padding: 12px 20px;
  color: #333;
  text-decoration: none;
  transition: all 0.3s ease;
  background: transparent;
  border: none;
  border-radius: 0;
  text-shadow: none;
  margin: 0;
}

.user-center-menu a:hover {
  background: rgba(0, 123, 255, 0.1);
  color: #007bff;
  transform: none;
  box-shadow: none;
}

.user-center-menu .divider {
  height: 1px;
  background: rgba(0, 0, 0, 0.1);
  margin: 10px 20px;
}

#logoutBtn {
  display: block;
  padding: 12px 20px;
  color: #e74c3c;
  text-decoration: none;
  transition: all 0.3s ease;
  background: transparent;
  border: none;
  border-radius: 0;
  text-shadow: none;
  margin: 0;
  cursor: pointer;
  width: 100%;
  text-align: left;
  font-size: 1em;
}

#logoutBtn:hover {
  background: rgba(231, 76, 60, 0.1);
  color: #c0392b;
  transform: none;
  box-shadow: none;
}

/* ‰∏ªÂÜÖÂÆπÂå∫Âüü */
main {
  flex: 1;
  padding: 120px 20px 60px;
  position: relative;
  z-index: 1;
}

.title-container {
  position: relative;
  display: inline-block;
  margin: 30px 0 40px;
  text-align: center;
  width: 100%;
}

.h1 {
  text-align: center;
  color: #222;
  font-size: 3.5em;
  font-weight: 800;
  text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.1), 
               0 0 15px rgba(255, 255, 255, 0.8);
  letter-spacing: 1.5px;
  line-height: 1.1;
  position: relative;
  padding-bottom: 20px;
  font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
  display: inline-block;
}

.h1::after {
  content: '';
  position: absolute;
  right: -15px;
  top: 50%;
  transform: translateY(-50%);
  width: 8px;
  height: 1.2em;
  background-color: #222;
  opacity: 0.9;
  box-shadow: 0 0 8px rgba(0, 123, 255, 0.7);
  animation: blink 1s step-end infinite;
  border-radius: 2px;
}

.title-container::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 150px;
  height: 4px;
  background: rgba(255, 255, 255, 0.5);
  border-radius: 3px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

@keyframes blink {
  0%, 50% {
    opacity: 1;
  }
  51%, 100% {
    opacity: 0;
  }
}

/* ÁÆ°ÁêÜÂëò‰ª™Ë°®ÊùøÂÆπÂô® */
.admin-container {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 30px;
}

/* Ê¨¢ËøéÂç°Áâá */
.welcome-card {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 30px;
  border-radius: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

.welcome-text h2 {
  color: #222;
  font-size: 2em;
  margin-bottom: 10px;
}

.welcome-text p {
  color: #666;
  font-size: 1.1em;
}

.admin-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  color: #333;
  font-size: 2em;
  font-weight: bold;
}

.admin-avatar .avatar-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

/* ‰ª™Ë°®ÊùøÁΩëÊ†º */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 25px;
}

/* ÁªüËÆ°Âç°Áâá */
.stat-card {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 25px;
  border-radius: 15px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.stat-card:hover {
  transform: translateY(-5px);
  border-color: rgba(255, 255, 255, 0.5);
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: rgba(255, 255, 255, 0.5);
}

.stat-card:nth-child(2)::before {
  background: rgba(255, 255, 255, 0.5);
}

.stat-card:nth-child(3)::before {
  background: rgba(255, 255, 255, 0.5);
}

.stat-card:nth-child(4)::before {
  background: rgba(255, 255, 255, 0.5);
}

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* ÁªüËÆ°ÂàÜÊûê */
.analytics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 25px;
  margin-top: 25px;
}

.analytics-card {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 25px;
  border-radius: 15px;
  transition: all 0.3s ease;
}

.analytics-card:hover {
  transform: translateY(-3px);
  border-color: rgba(255, 255, 255, 0.5);
}

.analytics-card.full-width {
  grid-column: 1 / -1;
}

.analytics-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.analytics-header h4 {
  margin: 0;
  font-size: 1.2em;
  color: rgba(255, 255, 255, 0.95);
}

.analytics-content {
  min-height: 200px;
}

.analytics-content table {
  width: 100%;
  border-collapse: collapse;
}

.analytics-content table th,
.analytics-content table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.analytics-content table th {
  color: rgba(255, 255, 255, 0.8);
  font-weight: 600;
  font-size: 0.9em;
}

.analytics-content table td {
  color: rgba(255, 255, 255, 0.9);
  font-size: 0.95em;
}

.analytics-content table tr:hover {
  background: rgba(255, 255, 255, 0.05);
}

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.stat-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  background: rgba(0, 123, 255, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5em;
  color: #007bff;
}

.stat-card:nth-child(2) .stat-icon {
  background: rgba(0, 184, 148, 0.1);
  color: #00b894;
}

.stat-card:nth-child(3) .stat-icon {
  background: rgba(108, 92, 231, 0.1);
  color: #6c5ce7;
}

.stat-card:nth-child(4) .stat-icon {
  background: rgba(253, 126, 20, 0.1);
  color: #fd7e14;
}

.stat-title {
  font-size: 1.1em;
  color: #666;
  font-weight: 500;
}

.stat-value {
  font-size: 2.5em;
  font-weight: 700;
  color: #222;
  line-height: 1;
  margin-bottom: 10px;
}

.stat-change {
  display: flex;
  align-items: center;
  font-size: 0.9em;
}

.stat-change.positive {
  color: #00b894;
}

.stat-change.negative {
  color: #e74c3c;
}

.stat-change.neutral {
  color: #6c757d;
}

/* ÁÆ°ÁêÜÈù¢Êùø */
.admin-panel {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 20px;
  overflow: hidden;
  margin-top: 20px;
}

.panel-header {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  padding: 20px 30px;
  color: #333;
}

.panel-header h2 {
  font-size: 1.8em;
  font-weight: 600;
}

/* Ê†áÁ≠æÈ°µÂØºËà™ */
.tab-nav {
  display: flex;
  background: rgba(255, 255, 255, 0.9);
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  flex-wrap: wrap;
}

.tab-btn {
  padding: 18px 30px;
  background: transparent;
  border: none;
  font-size: 1.1em;
  font-weight: 500;
  color: #666;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.tab-btn:hover {
  color: #007bff;
  background: rgba(0, 123, 255, 0.05);
}

.tab-btn.active {
  color: #007bff;
  font-weight: 600;
}

.tab-btn.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background: rgba(255, 255, 255, 0.6);
}

/* Âø´ÈÄüÊìç‰ΩúÊåâÈíÆ */
.quick-actions {
  display: flex;
  gap: 15px;
  padding: 10px 30px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
}

.action-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  border-radius: 8px;
  font-size: 1em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.action-btn:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

.action-btn.secondary {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.action-btn.secondary:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

/* Ê†áÁ≠æÈ°µÂÜÖÂÆπ */
.tab-content {
  padding: 30px;
}

.tab-pane {
  display: none;
}

.tab-pane.active {
  display: block;
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Ë°®Ê†ºÊ†∑Âºè */
.data-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

.data-table th {
  text-align: left;
  padding: 15px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  color: rgba(255, 255, 255, 0.9);
  font-weight: 600;
  border-bottom: 2px solid rgba(255, 255, 255, 0.3);
}

.data-table td {
  padding: 15px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.data-table tr:hover {
  background: rgba(255, 255, 255, 0.2);
}

.data-table tr.selected {
  background: rgba(0, 123, 255, 0.15);
}

/* ÊâπÈáèÊìç‰ΩúÊåâÈíÆÊ†è */
.batch-actions-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 15px;
  padding: 15px 20px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  animation: slideDown 0.3s ease;
}

.batch-actions-info {
  display: flex;
  align-items: center;
  gap: 10px;
  color: rgba(255, 255, 255, 0.9);
  font-weight: 500;
}

.batch-actions-info svg {
  width: 20px;
  height: 20px;
  color: #007bff;
}

.batch-actions-buttons {
  display: flex;
  gap: 10px;
}

/* Â§çÈÄâÊ°ÜÊ†∑Âºè */
.select-all-checkbox,
.article-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #007bff;
  transition: all 0.3s ease;
}

.select-all-checkbox:hover,
.article-checkbox:hover {
  transform: scale(1.1);
}

.data-table th:first-child,
.data-table td:first-child {
  width: 50px;
  text-align: center;
  padding: 15px 10px;
}

.data-table .status {
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 0.85em;
  font-weight: 500;
}

.status.published {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.status.draft {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.status.pending {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.status.scheduled {
  background: rgba(255, 193, 7, 0.2);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 193, 7, 0.4);
  color: rgba(255, 193, 7, 0.9);
  font-size: 0.85em;
  margin-left: 5px;
}

/* ÂèØËßÅÊÄßÊ†áÁ≠æ */
.visibility {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 0.85em;
  font-weight: 500;
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
}

.visibility-public {
  background: rgba(0, 184, 148, 0.2);
  border: 1px solid rgba(0, 184, 148, 0.4);
  color: rgba(0, 184, 148, 0.9);
}

.visibility-private {
  background: rgba(253, 203, 110, 0.2);
  border: 1px solid rgba(253, 203, 110, 0.4);
  color: rgba(253, 203, 110, 0.9);
}

/* Êìç‰ΩúÊåâÈíÆ */
.action-buttons {
  display: flex;
  gap: 8px;
}

.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 0.9em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-sm {
  padding: 5px 12px;
  font-size: 0.85em;
}

.btn-edit {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.btn-edit:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
}

.btn-delete {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.btn-delete:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
}

.btn-view {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.btn-view:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
}

.btn-upload {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.btn-upload:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
}

/* ÊåâÈíÆÁªÑ */
.btn-group {
  display: flex;
  gap: 15px;
  margin-top: 30px;
}

/* ÂàÜÈ°µÁªÑ‰ª∂ */
.pagination-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 20px;
  padding: 15px 20px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
}

.pagination-info {
  color: #333;
  font-size: 0.95em;
}

.pagination-controls {
  display: flex;
  align-items: center;
  gap: 10px;
}

.pagination-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  border-radius: 8px;
  font-size: 0.9em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.pagination-btn:hover:not(:disabled) {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

.pagination-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.pagination-pages {
  display: flex;
  gap: 5px;
}

.pagination-page {
  min-width: 36px;
  height: 36px;
  padding: 0 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  border-radius: 8px;
  font-size: 0.9em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.pagination-page:hover:not(.active):not(.ellipsis) {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
}

.pagination-page.active {
  background: rgba(255, 255, 255, 0.35);
  border-color: rgba(255, 255, 255, 0.7);
  font-weight: 600;
}

.pagination-page.ellipsis {
  background: transparent;
  border: none;
  cursor: default;
  color: rgba(255, 255, 255, 0.9);
}

.btn-primary {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  padding: 12px 30px;
  border-radius: 8px;
  font-size: 1em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-primary:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.btn-primary:disabled:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.3);
  transform: none;
}

.btn-danger {
  background: rgba(231, 76, 60, 0.2);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(231, 76, 60, 0.4);
  color: rgba(255, 255, 255, 0.95);
  padding: 12px 30px;
  border-radius: 8px;
  font-size: 1em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(231, 76, 60, 0.2);
}

.btn-danger:hover {
  background: rgba(231, 76, 60, 0.35);
  border-color: rgba(231, 76, 60, 0.6);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
}

.btn-danger:active {
  transform: translateY(0);
  box-shadow: 0 2px 10px rgba(231, 76, 60, 0.2);
}

.btn-danger:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.btn-danger:disabled:hover {
  background: rgba(231, 76, 60, 0.2);
  border-color: rgba(231, 76, 60, 0.4);
  transform: none;
  box-shadow: none;
}

.btn-secondary {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  padding: 12px 30px;
  border-radius: 8px;
  font-size: 1em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-secondary:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

/* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 20px;
  max-width: 800px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideIn 0.3s ease;
  position: relative;
}

@keyframes slideIn {
  from { transform: translateY(-50px) scale(0.9); opacity: 0; }
  to { transform: translateY(0) scale(1); opacity: 1; }
}

@keyframes slideOutFade {
  from { transform: translateY(0) scale(1); opacity: 1; }
  to { transform: translateY(-50px) scale(0.9); opacity: 0; }
}

.modal.closing .modal-content {
  animation: slideOutFade 0.3s ease forwards;
}

.modal-header {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  padding: 20px 30px;
  color: rgba(255, 255, 255, 0.9);
  border-radius: 20px 20px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  font-size: 1.5em;
  font-weight: 600;
}

.modal-close {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  font-size: 1.5em;
  cursor: pointer;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.modal-close:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: rotate(90deg);
}

.modal-body {
  padding: 30px;
}

/* Ë°®ÂçïÊ†∑Âºè */
.form-group {
  margin-bottom: 25px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 12px 15px;
  border: 1px solid rgba(255, 255, 255, 0.5);
  border-radius: 8px;
  font-size: 1em;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(30px) saturate(200%);
  -webkit-backdrop-filter: blur(30px) saturate(200%);
  color: #333;
  transition: all 0.3s ease;
}

.form-control:focus {
  outline: none;
  border-color: #007bff;
  background: rgba(255, 255, 255, 0.2);
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
}

textarea.form-control {
  min-height: 150px;
  resize: vertical;
}

/* ‰∏ä‰º†Âå∫Âüü */
.upload-area {
  border: 2px dashed rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  padding: 40px 20px;
  text-align: center;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 20px;
}

.upload-area:hover {
  border-color: rgba(255, 255, 255, 0.5);
  background: rgba(0, 0, 0, 0);
}

.upload-area.dragover {
  border-color: rgba(255, 255, 255, 0.7);
  background: rgba(255, 255, 255, 0.35);
}

.upload-icon {
  font-size: 3em;
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 15px;
}

.upload-text h4 {
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 10px;
}

.upload-text p {
  color: rgba(255, 255, 255, 0.7);
  font-size: 0.95em;
}

.upload-preview {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-top: 20px;
}

.upload-item {
  position: relative;
  width: 120px;
  height: 120px;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.upload-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.upload-remove {
  position: absolute;
  top: 5px;
  right: 5px;
  width: 25px;
  height: 25px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  border-radius: 50%;
  font-size: 0.8em;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.upload-remove:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
}

/* Ê†áÁ≠æÈÄâÊã©Âô® */
.tag-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}

.tag-option {
  padding: 8px 16px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 20px;
  color: rgba(255, 255, 255, 0.9);
  font-size: 0.9em;
  cursor: pointer;
  transition: all 0.3s ease;
}

.tag-option:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
}

.tag-option.selected {
  background: rgba(255, 255, 255, 0.35);
  color: rgba(255, 255, 255, 0.9);
  border-color: rgba(255, 255, 255, 0.7);
}

.tag-option.selected::after {
  content: '‚úì';
  position: absolute;
  right: 8px;
  font-size: 0.8em;
  color: #fff;
  font-weight: bold;
  margin-left: 8px;
}

.tag-input-container {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.tag-input {
  flex: 1;
}

/* ÂàÜÁ±ªÈÄâÊã©Âô®Ê†∑ÂºèÔºàÊ®°‰ªøÊ†áÁ≠æÈÄâÊã©Âô®Ôºâ */
.category-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}

.category-option {
  padding: 8px 16px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 20px;
  color: rgba(255, 255, 255, 0.9);
  font-size: 0.9em;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  position: relative;
  overflow: hidden;
}

.category-option:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.category-option.selected {
  background: linear-gradient(135deg, rgba(0, 123, 255, 0.4), rgba(0, 184, 148, 0.4));
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  color: #fff;
  border-color: rgba(0, 123, 255, 0.8);
  font-weight: 600;
  box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
  transform: translateY(-2px);
}

.category-option.selected::before {
  content: '‚úì';
  position: absolute;
  right: 8px;
  font-size: 0.8em;
  color: #fff;
  font-weight: bold;
}

.category-input-container {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.category-input {
  flex: 1;
}

/* È°µËÑö */
footer {
  text-align: center;
  padding: 30px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-top: 1px solid rgba(255, 255, 255, 0.3);
  margin-top: auto;
  position: relative;
  z-index: 1;
}

footer p {
  color: #666;
  font-size: 1.1em;
  margin-top: 10px;
}

/* ÊªöÂä®ÊåáÁ§∫Âô® */
.scroll-indicator {
  position: fixed;
  top: calc(env(safe-area-inset-top) + 70px);
  right: 20px;
  width: 4px;
  height: 60px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 2px;
  z-index: 99;
  overflow: hidden;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.scroll-indicator.active {
  opacity: 1;
}

.scroll-progress {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 0%;
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-radius: 2px;
  transition: height 0.1s ease;
}

/* Èü≥‰πêÊãñÊãΩ‰∏ä‰º†Âå∫ÂüüÊ†∑Âºè */
.music-drop-zone {
  border: 2px dashed rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  padding: 50px 30px;
  text-align: center;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 20px;
  position: relative;
}

.music-drop-zone:hover {
  border-color: rgba(255, 255, 255, 0.5);
  background: rgba(255, 255, 255, 0.05);
  transform: translateY(-2px);
}

.music-drop-zone.dragover {
  border-color: rgba(255, 255, 255, 0.7);
  background: rgba(255, 255, 255, 0.15);
  transform: scale(1.02);
}

.drop-zone-content {
  pointer-events: none;
}

.drop-zone-icon {
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 20px;
  transition: all 0.3s ease;
}

.music-drop-zone:hover .drop-zone-icon {
  transform: translateY(-5px);
}

.music-drop-zone h4 {
  color: rgba(255, 255, 255, 0.9);
  font-size: 1.3em;
  margin-bottom: 10px;
  font-weight: 600;
}

.music-drop-zone p {
  color: rgba(255, 255, 255, 0.7);
  font-size: 0.95em;
  margin: 5px 0;
}

.browse-link {
  color: rgba(255, 255, 255, 0.9);
  text-decoration: underline;
  cursor: pointer;
  font-weight: 500;
}

.browse-link:hover {
  color: #fff;
}

.upload-hint {
  font-size: 0.85em;
  color: rgba(255, 255, 255, 0.5);
  margin-top: 15px;
}

.hidden-input {
  display: none;
}

/* Èü≥‰πê‰∏ä‰º†ÂàóË°®Ê†∑Âºè */
.music-upload-list {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 20px;
}

.upload-list-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: rgba(255, 255, 255, 0.05);
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.upload-list-title {
  color: rgba(255, 255, 255, 0.9);
  font-weight: 600;
  font-size: 1.1em;
}

.clear-upload-btn {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  padding: 6px 16px;
  border-radius: 6px;
  font-size: 0.9em;
  cursor: pointer;
  transition: all 0.3s ease;
}

.clear-upload-btn:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-1px);
}

.upload-items {
  max-height: 400px;
  overflow-y: auto;
  padding: 10px;
}

.upload-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 8px;
  margin-bottom: 10px;
  transition: all 0.3s ease;
}

.upload-item:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: rgba(255, 255, 255, 0.3);
}

.upload-item-icon {
  width: 50px;
  height: 50px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  color: rgba(255, 255, 255, 0.9);
  font-size: 1.5em;
}

.upload-item-info {
  flex: 1;
  min-width: 0;
}

.upload-item-name {
  color: rgba(255, 255, 255, 0.9);
  font-weight: 500;
  margin-bottom: 5px;
  word-break: break-all;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.upload-item-meta {
  display: flex;
  gap: 15px;
  font-size: 0.85em;
  color: rgba(255, 255, 255, 0.6);
}

.upload-item-progress {
  width: 150px;
  flex-shrink: 0;
}

.progress-bar {
  height: 6px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 5px;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.8));
  border-radius: 3px;
  transition: width 0.3s ease;
  width: 0%;
}

.progress-text {
  font-size: 0.8em;
  color: rgba(255, 255, 255, 0.7);
  text-align: right;
}

.upload-item-status {
  font-size: 0.85em;
  padding: 4px 10px;
  border-radius: 12px;
  font-weight: 500;
  flex-shrink: 0;
}

.upload-item-status.pending {
  background: rgba(255, 255, 255, 0.1);
  color: rgba(255, 255, 255, 0.8);
}

.upload-item-status.uploading {
  background: rgba(0, 123, 255, 0.2);
  color: #007bff;
}

.upload-item-status.success {
  background: rgba(0, 184, 148, 0.2);
  color: #00b894;
}

.upload-item-status.error {
  background: rgba(231, 76, 60, 0.2);
  color: #e74c3c;
}

.upload-item-action {
  flex-shrink: 0;
}

.remove-upload-btn {
  width: 32px;
  height: 32px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 6px;
  color: rgba(255, 255, 255, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 1.1em;
}

.remove-upload-btn:hover {
  background: rgba(231, 76, 60, 0.3);
  border-color: rgba(231, 76, 60, 0.5);
  color: #e74c3c;
}

.remove-upload-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.upload-actions {
  display: flex;
  gap: 15px;
  padding: 15px 20px;
  background: rgba(255, 255, 255, 0.05);
  border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.upload-actions .btn-primary,
.upload-actions .btn-secondary {
  flex: 1;
}

/* ÊªöÂä®Êù°Ê†∑Âºè */
.upload-items::-webkit-scrollbar {
  width: 6px;
}

.upload-items::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 3px;
}

.upload-items::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 3px;
}

.upload-items::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* Èü≥‰πêÂ∞ÅÈù¢‰∏ä‰º†Ê†∑Âºè */
.upload-item-cover {
  width: 60px;
  height: 60px;
  flex-shrink: 0;
  position: relative;
}

.cover-preview {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.1);
  border: 2px dashed rgba(255, 255, 255, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  overflow: hidden;
  position: relative;
}

.cover-preview:hover {
  border-color: rgba(255, 255, 255, 0.6);
  background: rgba(255, 255, 255, 0.15);
}

.cover-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 6px;
}

.cover-preview.has-cover {
  border-style: solid;
}

.cover-preview .cover-placeholder {
  color: rgba(255, 255, 255, 0.5);
  font-size: 1.5em;
}

.cover-preview .cover-upload-hint {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 0.8em;
  opacity: 0;
  transition: opacity 0.3s ease;
  border-radius: 6px;
  text-align: center;
  padding: 5px;
}

.cover-preview:hover .cover-upload-hint {
  opacity: 1;
}

.cover-input {
  display: none;
}

.cover-remove-btn {
  position: absolute;
  top: -8px;
  right: -8px;
  width: 20px;
  height: 20px;
  background: rgba(231, 76, 60, 0.9);
  border: 2px solid white;
  border-radius: 50%;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 12px;
  font-weight: bold;
  opacity: 0;
  transition: all 0.3s ease;
  z-index: 10;
}

.cover-preview.has-cover:hover .cover-remove-btn {
  opacity: 1;
}

.cover-remove-btn:hover {
  background: rgba(231, 76, 60, 1);
  transform: scale(1.1);
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 1024px) {
  .dashboard-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .modal-content {
    max-width: 90%;
  }
}

@media (max-width: 768px) {
  .h1 {
    font-size: 2.5em;
  }
  
  .welcome-card {
    flex-direction: column;
    text-align: center;
    gap: 20px;
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
  
  .tab-nav, .quick-actions {
    flex-wrap: wrap;
  }
  
  .tab-btn {
    flex: 1;
    min-width: 120px;
    text-align: center;
    padding: 15px 10px;
  }
  
  .data-table {
    display: block;
    overflow-x: auto;
  }
  
  .action-buttons {
    flex-wrap: wrap;
  }
  
  nav {
    padding: 12px 15px;
  }
  

  nav a, nav button {
    font-size: 0;
    margin: 0 4px;
    padding: 10px;
    min-width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
  }

  /* ÈöêËóèÂØºËà™Ê†èÊñáÂ≠óÔºåÂè™ÊòæÁ§∫ÂõæÊ†á */
  nav a span:not(.shortcut-hint),
  nav button span:not(.shortcut-hint),
  #loginBtn span:not(:has(svg)) {
    display: none;
  }

  /* ÈöêËóèÂø´Êç∑ÈîÆÊèêÁ§∫ */
  .shortcut-hint {
    display: none !important;
  }

  /* Á°Æ‰øùÂõæÊ†áÂèØËßÅ */
  nav a svg,
  nav button svg {
    display: block;
    font-size: initial;
  }

  /* ‰∏∫Ê≤°ÊúâÂõæÊ†áÁöÑÈìæÊé•Ê∑ªÂä†ÈªòËÆ§ÂõæÊ†á */
  nav a[href="/"]::before {
    content: 'üè†';
    font-size: 18px;
  }

  nav a[href="/passage"]::before {
    content: 'üìù';
    font-size: 18px;
  }

  nav a[href="/collect"]::before {
    content: 'üìÅ';
    font-size: 18px;
  }

  nav a[href="/about"]::before {
    content: '‚ÑπÔ∏è';
    font-size: 18px;
  }

  nav a[href="/markdown-editor"]::before {
    content: '‚úèÔ∏è';
    font-size: 18px;
  }

  nav a[href="/admin"]::before {
    content: '‚öôÔ∏è';
    font-size: 18px;
  }

  /* ÁôªÂΩïÊåâÈíÆÂõæÊ†á */
  #loginBtn svg {
    width: 20px;
    height: 20px;
  }
  .modal-content {
    max-width: 95%;
    margin: 10px;
  }
  
  .modal-body {
    padding: 20px;
  }
}

@media (max-width: 480px) {
  main {
    padding: 100px 15px 40px;
  }

  .tab-content {
    padding: 20px;
  }

  .btn-group, .tag-input-container {
    flex-direction: column;
  }

  .btn-primary, .btn-secondary {
    width: 100%;
  }
}

/* ËÆæÁΩÆÁõ∏ÂÖ≥Ê†∑Âºè */
.settings-section {
  margin-bottom: 30px;
}

.settings-section h4 {
  font-size: 1.3em;
  color: #333;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 2px solid rgba(255, 255, 255, 0.3);
}

.settings-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.settings-grid .form-group {
  margin-bottom: 0;
}

input[type="range"].form-control {
  width: 100%;
  padding: 10px 0;
  background: transparent;
}

input[type="range"] {
  -webkit-appearance: none;
  appearance: none;
  width: 100%;
  height: 8px;
  background: rgba(255, 255, 255, 0.3);
  border-radius: 4px;
  outline: none;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  background: rgba(255, 255, 255, 0.6);
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.3s ease;
}

input[type="range"]::-webkit-slider-thumb:hover {
  background: rgba(255, 255, 255, 0.9);
  transform: scale(1.1);
}

input[type="range"]::-moz-range-thumb {
  width: 20px;
  height: 20px;
  background: rgba(255, 255, 255, 0.6);
  border-radius: 50%;
  cursor: pointer;
  border: none;
  transition: all 0.3s ease;
}

input[type="range"]::-moz-range-thumb:hover {
  background: rgba(255, 255, 255, 0.9);
  transform: scale(1.1);
}

.settings-preview {
  margin-top: 30px;
  padding: 20px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.settings-preview h5 {
  font-size: 1.1em;
  color: #333;
  margin-bottom: 15px;
}

.preview-box {
  min-height: 150px;
  padding: 30px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: rgba(255, 255, 255, 0.9);
  font-size: 1.1em;
  text-align: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.preview-box::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: url('/img/test.webp');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed;
  z-index: -1;
}

.preview-box p {
  position: relative;
  z-index: 1;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

/* Toast ÈÄöÁü•Ê†∑Âºè */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-width: 400px;
  width: 100%;
}

.toast {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  display: flex;
  align-items: center;
  gap: 12px;
  animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
  min-width: 280px;
  max-width: 100%;
}

.toast.success {
  border-left: 4px solid #10b981;
}

.toast.error {
  border-left: 4px solid #ef4444;
}

.toast.warning {
  border-left: 4px solid #f59e0b;
}

.toast-icon {
  font-size: 24px;
  flex-shrink: 0;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.toast-message {
  flex: 1;
  color: #1f2937;
  font-size: 14px;
  line-height: 1.4;
  word-wrap: break-word;
}

.toast-close {
  background: none;
  border: none;
  color: #9ca3af;
  cursor: pointer;
  font-size: 18px;
  padding: 0;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.2s ease;
  flex-shrink: 0;
}

.toast-close:hover {
  color: #4b5563;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes fadeOut {
  from {
    opacity: 1;
  }
  to {
    opacity: 0;
  }
}

@media (max-width: 768px) {
  .toast-container {
    top: 10px;
    right: 10px;
    left: 10px;
    max-width: none;
  }

  .toast {
    padding: 14px 16px;
    min-width: auto;
  }

  .toast-message {
    font-size: 13px;
  }
}

/* Êñá‰ª∂ÁÆ°ÁêÜÂô®Ê†∑Âºè */
.fm-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.fm-header h3 {
  margin: 0;
  color: #333;
}

.fm-actions {
  display: flex;
  gap: 10px;
}

.fm-container {
  display: flex;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 15px;
  overflow: hidden;
  height: 600px;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.fm-sidebar {
  width: 280px;
  background: rgba(248, 249, 250, 0.95);
  border-right: 1px solid rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
}

.fm-sidebar-header {
  padding: 15px 20px;
  background: rgba(0, 0, 0, 0.02);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  font-weight: 600;
  color: #333;
}

.fm-tree {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

.fm-tree-item {
  padding: 8px 12px;
  cursor: pointer;
  border-radius: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s ease;
  color: #555;
  font-size: 0.95em;
}

.fm-tree-item:hover {
  background: rgba(0, 123, 255, 0.1);
  color: #007bff;
}

.fm-tree-item.active {
  background: rgba(0, 123, 255, 0.15);
  color: #007bff;
  font-weight: 500;
}

.fm-tree-item .fm-tree-icon {
  font-size: 1.1em;
}

.fm-tree-children {
  margin-left: 20px;
  display: none;
}

.fm-tree-children.expanded {
  display: block;
}

.fm-main {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.fm-toolbar {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 12px 20px;
  background: rgba(0, 0, 0, 0.02);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.fm-tool-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid rgba(0, 0, 0, 0.15);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 1.2em;
  color: #555;
}

.fm-tool-btn:hover:not(:disabled) {
  background: rgba(0, 123, 255, 0.1);
  border-color: rgba(0, 123, 255, 0.3);
  color: #007bff;
}

.fm-tool-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.fm-breadcrumb {
  flex: 1;
  font-size: 0.95em;
  color: #555;
  font-weight: 500;
}

.fm-info {
  font-size: 0.9em;
  color: #888;
}

.fm-file-list {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 15px;
  align-content: start;
}

.fm-file-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 15px 10px;
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.fm-file-item:hover {
  background: rgba(0, 123, 255, 0.05);
  border-color: rgba(0, 123, 255, 0.3);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.fm-file-icon {
  font-size: 3em;
  margin-bottom: 8px;
}

.fm-file-icon img {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 6px;
}

.fm-file-name {
  font-size: 0.9em;
  color: #333;
  text-align: center;
  word-break: break-all;
  line-height: 1.3;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.fm-file-meta {
  font-size: 0.8em;
  color: #888;
  margin-top: 5px;
}

.fm-empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #888;
}

.fm-empty-icon {
  font-size: 4em;
  margin-bottom: 15px;
  opacity: 0.5;
}

.fm-context-menu {
  position: fixed;
  background: rgba(255, 255, 255, 0.98);
  border: 1px solid rgba(0, 0, 0, 0.15);
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  min-width: 180px;
  display: none;
}

.fm-context-menu.active {
  display: block;
}

.fm-context-menu-item {
  padding: 10px 15px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: all 0.2s ease;
  color: #333;
  font-size: 0.95em;
}

.fm-context-menu-item:hover {
  background: rgba(0, 123, 255, 0.1);
  color: #007bff;
}

.fm-context-menu-item.danger {
  color: #e74c3c;
}

.fm-context-menu-item.danger:hover {
  background: rgba(231, 76, 60, 0.1);
}

.fm-context-menu-divider {
  height: 1px;
  background: rgba(0, 0, 0, 0.1);
  margin: 5px 0;
}

@media (max-width: 1024px) {
  .fm-container {
    flex-direction: column;
    height: auto;
  }
  
  .fm-sidebar {
    width: 100%;
    max-height: 200px;
  }
  
  .fm-main {
    min-height: 400px;
  }
}

/* ÈôÑ‰ª∂ÁÆ°ÁêÜÊ†∑Âºè */
.am-header {
  margin-bottom: 20px;
}

.am-header h3 {
  margin: 0 0 10px 0;
  color: #333;
}

.am-header p {
  margin: 0;
  color: #666;
  font-size: 0.95em;
}

.am-filter-section {
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.am-filter-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  align-items: end;
}

.am-filter-row .form-group {
  margin-bottom: 0;
}

.am-filter-row label {
  display: block;
  margin-bottom: 5px;
  font-size: 0.9em;
  font-weight: 500;
  color: #555;
}

.am-stats {
  display: flex;
  gap: 20px;
  padding: 15px 20px;
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.am-stat-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.95em;
}

.am-stat-label {
  color: #666;
}

.am-stat-value {
  font-weight: 600;
  color: #333;
}

.am-list-container {
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 20px;
}

.am-list-container table {
  margin: 0;
  border-collapse: collapse;
  width: 100%;
}

.am-list-container thead {
  background: rgba(0, 123, 255, 0.1);
}

.am-list-container th {
  padding: 12px 15px;
  text-align: left;
  font-weight: 600;
  color: #333;
  font-size: 0.9em;
  border-bottom: 2px solid rgba(0, 123, 255, 0.2);
}

.am-list-container td {
  padding: 12px 15px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  vertical-align: middle;
}

.am-list-container tr:hover {
  background: rgba(0, 123, 255, 0.05);
}

.am-list-container tr.selected {
  background: rgba(0, 123, 255, 0.15);
}

.am-list-container input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.am-empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #888;
}

.am-empty-icon {
  font-size: 4em;
  margin-bottom: 15px;
  opacity: 0.5;
}

.am-empty-state p {
  font-size: 1.1em;
  margin-bottom: 20px;
}

.am-batch-actions {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px 20px;
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(0, 123, 255, 0.3);
  border-radius: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
  animation: slideDown 0.3s ease;
}

.am-batch-actions strong {
  color: #007bff;
  font-size: 1.1em;
}

/* ‰∏ä‰º†Ê®°ÊÄÅÊ°ÜÊ†∑ÂºèÂ¢ûÂº∫ */
.upload-area {
  border: 2px dashed rgba(0, 123, 255, 0.3);
  border-radius: 12px;
  padding: 40px 20px;
  text-align: center;
  background: rgba(0, 123, 255, 0.02);
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 20px;
}

.upload-area:hover {
  border-color: rgba(0, 123, 255, 0.6);
  background: rgba(0, 123, 255, 0.05);
}

.upload-area.dragover {
  border-color: rgba(0, 123, 255, 0.8);
  background: rgba(0, 123, 255, 0.1);
  transform: scale(1.02);
}

.upload-icon {
  font-size: 3em;
  color: #007bff;
  margin-bottom: 15px;
}

.upload-text h4 {
  color: #333;
  margin-bottom: 8px;
  font-size: 1.1em;
}

.upload-text p {
  color: #666;
  font-size: 0.9em;
}

.upload-preview {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-top: 20px;
  min-height: 0;
}

.upload-item {
  position: relative;
  width: 120px;
  height: 120px;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border: 2px solid rgba(0, 123, 255, 0.2);
  transition: all 0.3s ease;
}

.upload-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  border-color: rgba(0, 123, 255, 0.4);
}

.upload-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.upload-remove {
  position: absolute;
  top: 5px;
  right: 5px;
  width: 28px;
  height: 28px;
  background: rgba(231, 76, 60, 0.9);
  color: white;
  border-radius: 50%;
  font-size: 1.2em;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  border: 2px solid white;
  z-index: 10;
}

.upload-remove:hover {
  background: rgba(231, 76, 60, 1);
  transform: scale(1.1);
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .am-filter-row {
    grid-template-columns: 1fr;
  }

  .am-stats {
    flex-direction: column;
    gap: 10px;
  }

  .am-list-container {
    overflow-x: auto;
  }

  .am-list-container table {
    min-width: 800px;
  }

  .am-batch-actions {
    flex-direction: column;
    align-items: stretch;
  }

  .am-batch-actions button {
    width: 100%;
  }

  /* ÈöêËóèÂø´Êç∑ÈîÆÊåâÈíÆ */
  .shortcuts-help-btn {
    display: none !important;
  }

  /* ÈöêËóèÂø´Êç∑ÈîÆÊèêÁ§∫ */
  .shortcut-hint {
    display: none !important;
  }
}

/* ÁÆ°ÁêÜÂëòËÅöÁÑ¶Ê®°ÂºèÊ†∑Âºè */
body.admin-focus-mode {
  outline: 3px solid rgba(255, 183, 122, 0.8);
  outline-offset: -3px;
  transition: outline 0.3s ease;
}

body.admin-focus-mode::before {
  background: rgba(255, 183, 122, 0.15);
  transition: background 0.3s ease;
}

/* ËÅöÁÑ¶Ê®°Âºè‰∏ãÊ†áÁ≠æÈ°µÈ´ò‰∫Æ */
body.admin-focus-mode .tab-btn.active {
  background: rgba(255, 183, 122, 0.35);
  border-color: rgba(255, 183, 122, 0.8);
  color: rgba(255, 255, 255, 0.95);
  box-shadow: 0 0 15px rgba(255, 183, 122, 0.3);
}

body.admin-focus-mode .tab-btn:hover {
  background: rgba(255, 183, 122, 0.2);
  border-color: rgba(255, 183, 122, 0.6);
}

/* ËÅöÁÑ¶Ê®°Âºè‰∏ãÈÄâ‰∏≠Ë°åÈ´ò‰∫Æ */
body.admin-focus-mode .data-table tr.selected {
  background: rgba(255, 183, 122, 0.15);
  border-left: 4px solid rgba(255, 183, 122, 0.8);
  transition: all 0.2s ease;
}

body.admin-focus-mode .data-table tr.selected td {
  color: rgba(255, 255, 255, 0.95);
  font-weight: 500;
}

body.admin-focus-mode .data-table tr:hover {
  background: rgba(255, 183, 122, 0.2);
}

/* ÈùûËÅöÁÑ¶Ê®°Âºè‰∏ãÈÄâ‰∏≠Ë°åÊ†∑Âºè */
.data-table tr.selected {
  background: rgba(255, 183, 122, 0.1);
  border-left: 3px solid rgba(255, 183, 122, 0.6);
  transition: all 0.2s ease;
}

/* Âø´Êç∑ÈîÆÊèêÁ§∫Ê†áÁ≠æ */
.shortcut-hint {
  display: inline-block;
  margin-left: 8px;
  padding: 2px 8px;
  background: rgba(255, 183, 122, 0.25);
  border: 1px solid rgba(255, 183, 122, 0.5);
  border-radius: 4px;
  font-size: 0.75em;
  font-weight: 600;
  color: rgba(255, 183, 122, 0.95);
  transition: all 0.3s ease;
}

.shortcut-hint:hover {
  background: rgba(255, 183, 122, 0.35);
  border-color: rgba(255, 183, 122, 0.7);
}

/* ÁÆ°ÁêÜÂëòÈ°µÈù¢Âø´Êç∑ÈîÆÂ∏ÆÂä©ÊåâÈíÆ */
#adminShortcutsHelpBtn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  margin-left: 15px;
  background: rgba(0, 0, 0, 0.05);
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 20px;
  color: #666;
  font-size: 0.9em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

#adminShortcutsHelpBtn:hover {
  color: #007bff;
  background: rgba(0, 123, 255, 0.05);
  border-color: rgba(0, 123, 255, 0.2);
  transform: translateY(-1px);
}

#adminShortcutsHelpBtn svg {
  width: 16px;
  height: 16px;
}

/* ËÅöÁÑ¶Ê®°ÂºèÊèêÁ§∫ */
.focus-mode-indicator {
  position: fixed;
  top: calc(env(safe-area-inset-top) + 80px);
  right: 20px;
  padding: 10px 20px;
  background: rgba(255, 183, 122, 0.9);
  color: #fff;
  border-radius: 25px;
  font-size: 0.9em;
  font-weight: 600;
  z-index: 999;
  box-shadow: 0 4px 15px rgba(255, 183, 122, 0.4);
  animation: slideInRight 0.3s ease;
  display: none;
}

body.admin-focus-mode .focus-mode-indicator {
  display: block;
}

@keyframes slideInRight {
  from {
    transform: translateX(100px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* ËÅöÁÑ¶Ê®°Âºè‰∏ãÁöÑÊåâÈíÆÈ´ò‰∫Æ */
body.admin-focus-mode .action-btn:hover,
body.admin-focus-mode .btn-primary:hover,
body.admin-focus-mode .btn-secondary:hover {
  border-color: rgba(255, 183, 122, 0.7);
  box-shadow: 0 0 10px rgba(255, 183, 122, 0.3);
}

/* ËÅöÁÑ¶Ê®°Âºè‰∏ãÁöÑËæìÂÖ•Ê°Ü */
body.admin-focus-mode .form-control:focus {
  border-color: rgba(255, 183, 122, 0.8);
  box-shadow: 0 0 0 3px rgba(255, 183, 122, 0.2);
}

/* ËÅöÁÑ¶Ê®°Âºè‰∏ãÁöÑÊ®°ÊÄÅÊ°Ü */
body.admin-focus-mode .modal.active {
  border-color: rgba(255, 183, 122, 0.6);
}

body.admin-focus-mode .modal-header {
  border-bottom-color: rgba(255, 183, 122, 0.3);
}

/* Âø´Êç∑ÈîÆÂ∏ÆÂä©Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
.shortcuts-help-modal .modal-body kbd {
  background: rgba(255, 183, 122, 0.2);
  border: 1px solid rgba(255, 183, 122, 0.5);
  border-radius: 4px;
  padding: 2px 8px;
  font-family: monospace;
  font-size: 0.9em;
  color: rgba(255, 183, 122, 0.95);
  display: inline-block;
  min-width: 24px;
  text-align: center;
}

.shortcuts-help-modal .modal-body h4 {
  color: rgba(255, 183, 122, 0.9);
  margin-top: 20px;
  margin-bottom: 10px;
  font-size: 1.1em;
}

.shortcuts-help-modal .modal-body ul {
  list-style: none;
  padding: 0;
}

.shortcuts-help-modal .modal-body li {
  padding: 5px 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Toast ÊèêÁ§∫Ê†∑Âºè */
.toast-container {
  position: fixed;
  top: calc(env(safe-area-inset-top) + 80px);
  left: 50%;
  transform: translateX(-50%);
  z-index: 10000;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.toast {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 25px;
  color: rgba(255, 255, 255, 0.95);
  font-size: 0.95em;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  animation: slideInDown 0.3s ease;
  min-width: 200px;
}

.toast.success {
  border-color: rgba(0, 184, 148, 0.6);
}

.toast.error {
  border-color: rgba(231, 76, 60, 0.6);
}

.toast.warning {
  border-color: rgba(253, 203, 110, 0.6);
}

.toast.info {
  border-color: rgba(0, 123, 255, 0.6);
}

.toast-icon {
  font-size: 1.2em;
  font-weight: bold;
}

.toast-message {
  flex: 1;
}

.toast-close {
  background: transparent;
  border: none;
  color: rgba(255, 255, 255, 0.7);
  font-size: 1.2em;
  cursor: pointer;
  padding: 0;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.toast-close:hover {
  color: rgba(255, 255, 255, 0.9);
}

.toast.closing {
  animation: slideOutUp 0.3s ease forwards;
}

@keyframes slideInDown {
  from {
    transform: translateY(-20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes slideOutUp {
  from {
    transform: translateY(0);
    opacity: 1;
  }
  to {
    transform: translateY(-20px);
    opacity: 0;
  }
}

/* ÊåâÈíÆÁÑ¶ÁÇπÊ†∑Âºè */
.btn-primary:focus,
.btn-secondary:focus,
.action-btn:focus,
.btn-danger:focus {
  outline: none;
  border-color: rgba(255, 183, 122, 0.8);
  box-shadow: 0 0 0 3px rgba(255, 183, 122, 0.3);
}

/* Ê®°ÊÄÅÊ°Ü‰∏≠ÁöÑÊåâÈíÆÁÑ¶ÁÇπÊ†∑Âºè */
.modal .btn-primary:focus,
.modal .btn-secondary:focus {
  background: rgba(255, 183, 122, 0.2);
  border-color: rgba(255, 183, 122, 0.8);
  box-shadow: 0 0 0 3px rgba(255, 183, 122, 0.3);
}
</style>

<!-- ÈîÆÁõòÂø´Êç∑ÈîÆÊ†∑Âºè -->
<link rel="stylesheet" href="/css/keyboard-shortcuts.css">
</head>
<body>
<div class="toast-container" id="toastContainer"></div>

<nav id="mainNav">
  <a href="/">‰∏ªÈ°µ</a>
  <a href="/passage">ÊñáÁ´†</a>
  <a href="/collect">ÂΩíÊ°£</a>
  <a href="/about">ÂÖ≥‰∫é</a>
  <a href="/markdown-editor">ÁºñËæëÂô®<span class="shortcut-hint">6</span></a>
  <a class="navbtn current" href="/admin">ÁÆ°ÁêÜÂëòËÆæÁΩÆ</a>
  <button id="loginBtn">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
      <polyline points="10 17 15 12 10 7"></polyline>
      <line x1="15" y1="12" x2="3" y2="12"></line>
    </svg>
    ÁôªÂΩï
  </button>
</nav>

<div class="scroll-indicator" id="scrollIndicator">
  <div class="scroll-progress" id="scrollProgress"></div>
</div>

<main>
  <div class="title-container">
    <h1 class="h1" id="main-title">ÁÆ°ÁêÜÂëòÊéßÂà∂Âè∞</h1>
  </div>
  
  <div class="admin-container">
    <!-- Ê¨¢ËøéÂç°Áâá -->
    <div class="welcome-card">
      <div class="welcome-text">
        <h2>Ê¨¢ËøéÂõûÊù•ÔºåÁÆ°ÁêÜÂëò</h2>
      </div>
      <div class="admin-avatar">AD</div>
    </div>
    
    <!-- ÁªüËÆ°Âç°Áâá -->
    <div class="dashboard-grid">
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-title">ÊÄªÊñáÁ´†Êï∞</div>
          <div class="stat-icon">üìù</div>
        </div>
        <div class="stat-value" id="totalArticles">0</div>
        <div class="stat-change positive">Êú¨ÊúàÊñ∞Â¢û</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-title">ÊÄªÁî®Êà∑Êï∞</div>
          <div class="stat-icon">üë•</div>
        </div>
        <div class="stat-value" id="totalUsers">0</div>
        <div class="stat-change positive">Êú¨Âë®Êñ∞Â¢û</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-title">‰ªäÊó•ËÆøÈóÆÈáè</div>
          <div class="stat-icon">üìä</div>
        </div>
        <div class="stat-value" id="todayVisits">0</div>
        <div class="stat-change">ËæÉÊò®Êó•</div>
      </div>
    </div>
    
    <!-- ÁÆ°ÁêÜÈù¢Êùø -->
    <div class="admin-panel">
      <div class="panel-header">
        <h2>ÁÆ°ÁêÜÊéßÂà∂Âè∞</h2>
      </div>
      
      <!-- Âø´ÈÄüÊìç‰ΩúÊåâÈíÆ -->
      <div class="quick-actions">
        <button class="action-btn" id="uploadArticleBtn">
          <span>üì§</span> ‰∏ä‰º†ÊñáÁ´†
        </button>
        <button class="action-btn" id="newArticleBtn">
          <span>üìù</span> Êñ∞Âª∫ÊñáÁ´†
        </button>
      </div>
      
      <!-- Ê†áÁ≠æÈ°µÂØºËà™ -->
      <div class="tab-nav">
        <button class="tab-btn active" data-tab="articles">ÊñáÁ´†ÁÆ°ÁêÜ<span class="shortcut-hint">1</span></button>
        <button class="tab-btn" data-tab="users">Áî®Êà∑ÁÆ°ÁêÜ<span class="shortcut-hint">2</span></button>
        <button class="tab-btn" data-tab="comments">ËØÑËÆ∫ÁÆ°ÁêÜ<span class="shortcut-hint">3</span></button>
        <button class="tab-btn" data-tab="categories">ÂàÜÁ±ªÁÆ°ÁêÜ<span class="shortcut-hint">4</span></button>
        <button class="tab-btn" data-tab="tags">Ê†áÁ≠æÁÆ°ÁêÜ<span class="shortcut-hint">5</span></button>
        <button class="tab-btn" data-tab="analytics">ÁªüËÆ°ÂàÜÊûê<span class="shortcut-hint">6</span></button>
        <button class="tab-btn" data-tab="about">ÂÖ≥‰∫éÈ°µÈù¢<span class="shortcut-hint">7</span></button>
        <button class="tab-btn" data-tab="filemanager">Êñá‰ª∂ÁÆ°ÁêÜ<span class="shortcut-hint">8</span></button>
        <button class="tab-btn" data-tab="attachments">ÈôÑ‰ª∂ÁÆ°ÁêÜ<span class="shortcut-hint">9</span></button>
        <button class="tab-btn" data-tab="settings">Á≥ªÁªüËÆæÁΩÆ<span class="shortcut-hint">0</span></button>
        <button class="shortcuts-help-btn" id="adminShortcutsHelpBtn" title="Âø´Êç∑ÈîÆÂ∏ÆÂä©">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
          Âø´Êç∑ÈîÆ
        </button>
      </div>
      
      <!-- Ê†áÁ≠æÈ°µÂÜÖÂÆπ -->
      <div class="tab-content">
        <!-- ÊñáÁ´†ÁÆ°ÁêÜ -->
        <div class="tab-pane active" id="articles">
          <h3>ÊñáÁ´†ÁÆ°ÁêÜ</h3>
          <p>ÁÆ°ÁêÜÂ∑≤ÂèëÂ∏ÉÁöÑÊñáÁ´†ÔºåÂèØ‰ª•ÁºñËæë„ÄÅÂà†Èô§ÊàñÊõ¥ÊîπÁä∂ÊÄÅ„ÄÇ</p>

          <!-- ÊâπÈáèÊìç‰ΩúÊåâÈíÆÊ†è -->
          <div class="batch-actions-bar" id="batchActionsBar" style="display: none;">
            <div class="batch-actions-info">
              <span id="selectedCount">Â∑≤ÈÄâÊã© 0 ÁØáÊñáÁ´†</span>
            </div>
            <div class="batch-actions-buttons">
              <button class="btn btn-danger btn-sm" id="batchDeleteBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                ÊâπÈáèÂà†Èô§
              </button>
              <button class="btn btn-secondary btn-sm" id="clearSelectionBtn">ÂèñÊ∂àÈÄâÊã©</button>
            </div>
          </div>

          <table class="data-table" id="articles">
            <thead>
              <tr>
                <th style="width: 50px;">
                  <input type="checkbox" id="selectAllCheckbox" class="select-all-checkbox">
                </th>
                <th>Ê†áÈ¢ò</th>
                <th>‰ΩúËÄÖ</th>
                <th>Êó•Êúü</th>
                <th>Áä∂ÊÄÅ</th>
                <th>ÂèØËßÅÊÄß</th>
                <th>Êìç‰Ωú</th>
              </tr>
            </thead>
            <tbody id="articlesTableBody">
              <!-- Êï∞ÊçÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
            </tbody>
          </table>

          <!-- ÂàÜÈ°µÁªÑ‰ª∂ -->
          <div class="pagination-container" id="paginationContainer" style="display: none;">
            <div class="pagination-info">
              <span id="paginationInfo">ÊòæÁ§∫ 1-10 Êù°ÔºåÂÖ± 0 Êù°</span>
            </div>
            <div class="pagination-controls">
              <button class="pagination-btn" id="prevPageBtn" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                ‰∏ä‰∏ÄÈ°µ
              </button>
              <div class="pagination-pages" id="paginationPages">
                <!-- È°µÁ†ÅÊåâÈíÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
              </div>
              <button class="pagination-btn" id="nextPageBtn" disabled>
                ‰∏ã‰∏ÄÈ°µ
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            </div>
          </div>

          <div class="btn-group">
            <button class="btn-secondary">ÂØºÂá∫Êï∞ÊçÆ</button>
            <button class="btn-primary" id="refreshArticlesBtn">Âà∑Êñ∞ÂàóË°®</button>
          </div>
        </div>
        
        <!-- Áî®Êà∑ÁÆ°ÁêÜ -->
        <div class="tab-pane" id="users">
          <h3>Áî®Êà∑ÁÆ°ÁêÜ</h3>
          <p>ÁÆ°ÁêÜÊ≥®ÂÜåÁî®Êà∑ÔºåÂèØ‰ª•Êü•ÁúãÁî®Êà∑‰ø°ÊÅØ„ÄÅË∞ÉÊï¥ÊùÉÈôêÊàñÂà†Èô§Áî®Êà∑„ÄÇ</p>

          <!-- ÊâπÈáèÊìç‰ΩúÊåâÈíÆÊ†è -->
          <div class="batch-actions-bar" id="userBatchActionsBar" style="display: none;">
            <div class="batch-actions-info">
              <span id="userSelectedCount">Â∑≤ÈÄâÊã© 0 ‰∏™Áî®Êà∑</span>
            </div>
            <div class="batch-actions-buttons">
              <button class="btn btn-danger btn-sm" id="batchDeleteUsersBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                ÊâπÈáèÂà†Èô§
              </button>
              <button class="btn btn-secondary btn-sm" id="clearUserSelectionBtn">ÂèñÊ∂àÈÄâÊã©</button>
            </div>
          </div>

          <table class="data-table" id="users">
            <thead>
              <tr>
                <th style="width: 50px;">
                  <input type="checkbox" id="selectAllUsersCheckbox" class="select-all-checkbox">
                </th>
                <th>Áî®Êà∑Âêç</th>
                <th>ÈÇÆÁÆ±</th>
                <th>Ê≥®ÂÜåÊó∂Èó¥</th>
                <th>ËßíËâ≤</th>
                <th>Áä∂ÊÄÅ</th>
                <th>Êìç‰Ωú</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <!-- Êï∞ÊçÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
            </tbody>
          </table>

          <!-- Áî®Êà∑ÂàÜÈ°µÁªÑ‰ª∂ -->
          <div class="pagination-container" id="userPaginationContainer" style="display: none;">
            <div class="pagination-info">
              <span id="userPaginationInfo">ÊòæÁ§∫ 1-10 Êù°ÔºåÂÖ± 0 Êù°</span>
            </div>
            <div class="pagination-controls">
              <button class="pagination-btn" id="prevUserPageBtn" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                ‰∏ä‰∏ÄÈ°µ
              </button>
              <div class="pagination-pages" id="userPaginationPages">
                <!-- È°µÁ†ÅÊåâÈíÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
              </div>
              <button class="pagination-btn" id="nextUserPageBtn" disabled>
                ‰∏ã‰∏ÄÈ°µ
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            </div>
          </div>

          <div class="btn-group">
            <button class="btn-secondary">ÂØºÂá∫Áî®Êà∑ÂàóË°®</button>
            <button class="btn-primary" id="addUserBtn">Ê∑ªÂä†Êñ∞Áî®Êà∑</button>
          </div>
        </div>
        
        <!-- ËØÑËÆ∫ÁÆ°ÁêÜ -->
        <div class="tab-pane" id="comments">
          <h3>ËØÑËÆ∫ÁÆ°ÁêÜ</h3>
          <p>ÁÆ°ÁêÜÊñáÁ´†ËØÑËÆ∫ÔºåÂèØ‰ª•ÂÆ°Ê†∏„ÄÅÁºñËæëÊàñÂà†Èô§ËØÑËÆ∫„ÄÇ</p>

          <table class="data-table" id="comments">
            <thead>
              <tr>
                <th style="width: 50px;">
                  <input type="checkbox" id="selectAllComments" class="select-all-checkbox">
                </th>
                <th>ÂÜÖÂÆπ</th>
                <th>ÊñáÁ´†</th>
                <th>Áî®Êà∑</th>
                <th>Êó∂Èó¥</th>
                <th>Êìç‰Ωú</th>
              </tr>
            </thead>
            <tbody id="commentsTableBody">
              <!-- Êï∞ÊçÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
            </tbody>
          </table>

          <!-- ËØÑËÆ∫ÂàÜÈ°µÁªÑ‰ª∂ -->
          <div class="pagination-container" id="commentsPaginationContainer" style="display: none;">
            <div class="pagination-info">
              <span id="commentsPaginationInfo">ÊòæÁ§∫ 1-10 Êù°ÔºåÂÖ± 0 Êù°</span>
            </div>
            <div class="pagination-controls">
              <button class="pagination-btn" id="prevCommentsPageBtn" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                ‰∏ä‰∏ÄÈ°µ
              </button>
              <div class="pagination-pages" id="commentsPaginationPages">
                <!-- È°µÁ†ÅÊåâÈíÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
              </div>
              <button class="pagination-btn" id="nextCommentsPageBtn" disabled>
                ‰∏ã‰∏ÄÈ°µ
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            </div>
          </div>

          <div class="btn-group">
            <button class="btn-danger" id="batchDeleteCommentsBtn" style="display: none;">ÊâπÈáèÂà†Èô§</button>
            <button class="btn-secondary">ÊâπÈáèÂÆ°Ê†∏</button>
            <button class="btn-primary" id="refreshCommentsBtn">Âà∑Êñ∞ËØÑËÆ∫</button>
          </div>
        </div>

        <!-- ÂàÜÁ±ªÁÆ°ÁêÜ -->
        <div class="tab-pane" id="categories">
          <h3>ÂàÜÁ±ªÁÆ°ÁêÜ</h3>
          <p>ÁÆ°ÁêÜÊñáÁ´†ÂàÜÁ±ªÔºåÂèØ‰ª•ÂàõÂª∫„ÄÅÁºñËæë„ÄÅÂà†Èô§ÂàÜÁ±ª„ÄÇ</p>

          <div class="quick-actions">
            <button class="btn-danger" id="batchDeleteCategoriesBtn" style="display: none;">ÊâπÈáèÂà†Èô§</button>
            <button class="btn-primary" id="addCategoryBtn">Ê∑ªÂä†ÂàÜÁ±ª</button>
            <button class="btn-secondary" id="refreshCategoriesBtn">Âà∑Êñ∞</button>
          </div>

          <table class="data-table" id="categories">
            <thead>
              <tr>
                <th style="width: 50px;">
                  <input type="checkbox" id="selectAllCategories" class="select-all-checkbox">
                </th>
                <th>ÊéíÂ∫è</th>
                <th>ÂõæÊ†á</th>
                <th>ÂêçÁß∞</th>
                <th>ÊèèËø∞</th>
                <th>Áä∂ÊÄÅ</th>
                <th>Êìç‰Ωú</th>
              </tr>
            </thead>
            <tbody id="categoriesTableBody">
              <!-- Êï∞ÊçÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
            </tbody>
          </table>
        </div>

        <!-- Ê†áÁ≠æÁÆ°ÁêÜ -->
        <div class="tab-pane" id="tags">
          <h3>Ê†áÁ≠æÁÆ°ÁêÜ</h3>
          <p>ÁÆ°ÁêÜÊñáÁ´†Ê†áÁ≠æÔºåÂèØ‰ª•ÂàõÂª∫„ÄÅÁºñËæë„ÄÅÂà†Èô§Ê†áÁ≠æ„ÄÇ</p>

          <div class="quick-actions">
            <button class="btn-danger" id="batchDeleteTagsBtn" style="display: none;">ÊâπÈáèÂà†Èô§</button>
            <button class="btn-primary" id="addTagBtn">Ê∑ªÂä†Ê†áÁ≠æ</button>
            <button class="btn-secondary" id="refreshTagsBtn">Âà∑Êñ∞</button>
          </div>

          <div class="form-group" style="margin-top: 20px;">
            <label for="tagCategoryFilter">Á≠õÈÄâÂàÜÁ±ª</label>
            <select id="tagCategoryFilter" class="form-control">
              <option value="">ÂÖ®ÈÉ®Ê†áÁ≠æ</option>
            </select>
          </div>

          <table class="data-table" id="tags" style="margin-top: 15px;">
            <thead>
              <tr>
                <th style="width: 50px;">
                  <input type="checkbox" id="selectAllTags" class="select-all-checkbox">
                </th>
                <th>ÊéíÂ∫è</th>
                <th>È¢úËâ≤</th>
                <th>ÂêçÁß∞</th>
                <th>ÊèèËø∞</th>
                <th>ÊâÄÂ±ûÂàÜÁ±ª</th>
                <th>Áä∂ÊÄÅ</th>
                <th>Êìç‰Ωú</th>
              </tr>
            </thead>
            <tbody id="tagsTableBody">
              <!-- Êï∞ÊçÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
            </tbody>
          </table>
        </div>

        <!-- ÂÖ≥‰∫éÈ°µÈù¢ -->
        <div class="tab-pane" id="about">
          <h3>ÂÖ≥‰∫éÈ°µÈù¢ÁÆ°ÁêÜ</h3>
          <p>ÁÆ°ÁêÜÂÖ≥‰∫éÈ°µÈù¢ÁöÑ‰∏ªÂç°ÁâáÂíåÊ¨°Âç°ÁâáÂÜÖÂÆπ„ÄÇ</p>

          <div class="quick-actions">
            <button class="btn-primary" id="addMainCardBtn">Ê∑ªÂä†‰∏ªÂç°Áâá</button>
            <button class="btn-secondary" id="refreshAboutCardsBtn">Âà∑Êñ∞</button>
          </div>

          <!-- ‰∏ªÂç°ÁâáÂàóË°® -->
          <div style="margin-top: 30px;">
            <h4>‰∏ªÂç°ÁâáÂàóË°®</h4>
            <table class="data-table" id="mainCards">
              <thead>
                <tr>
                  <th>ÊéíÂ∫è</th>
                  <th>ÂõæÊ†á</th>
                  <th>Ê†áÈ¢ò</th>
                  <th>Â∏ÉÂ±ÄÁ±ªÂûã</th>
                  <th>Ê¨°Âç°ÁâáÊï∞</th>
                  <th>Áä∂ÊÄÅ</th>
                  <th>Êìç‰Ωú</th>
                </tr>
              </thead>
              <tbody id="mainCardsTableBody">
                <!-- Êï∞ÊçÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
              </tbody>
            </table>
          </div>

          <!-- Ê¨°Âç°ÁâáÂàóË°® -->
          <div style="margin-top: 30px;">
            <h4>Ê¨°Âç°ÁâáÂàóË°®</h4>
            <div class="form-group">
              <label for="subCardMainCardFilter">ÈÄâÊã©‰∏ªÂç°Áâá</label>
              <select id="subCardMainCardFilter" class="form-control">
                <option value="">ÂÖ®ÈÉ®‰∏ªÂç°Áâá</option>
              </select>
            </div>
            <button class="btn-primary" id="addSubCardBtn" style="margin-top: 10px;">Ê∑ªÂä†Ê¨°Âç°Áâá</button>
            <table class="data-table" id="subCards" style="margin-top: 15px;">
              <thead>
                <tr>
                  <th>ÊéíÂ∫è</th>
                  <th>ÂõæÊ†á</th>
                  <th>Ê†áÈ¢ò</th>
                  <th>ÊèèËø∞</th>
                  <th>ÈìæÊé•</th>
                  <th>Áä∂ÊÄÅ</th>
                  <th>Êìç‰Ωú</th>
                </tr>
              </thead>
              <tbody id="subCardsTableBody">
                <!-- Êï∞ÊçÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Êñá‰ª∂ÁÆ°ÁêÜ -->
        <div class="tab-pane" id="filemanager">
          <div class="fm-header">
            <h3>Êñá‰ª∂ÁÆ°ÁêÜ</h3>
            <div class="fm-actions">
              <button class="btn-primary" id="fmUploadBtn">
                <span style="margin-right: 5px;">‚Üë</span>‰∏ä‰º†Êñá‰ª∂
              </button>
              <button class="btn-secondary" id="fmCreateDirBtn">
                <span style="margin-right: 5px;">+</span>Êñ∞Âª∫Êñá‰ª∂Â§π
              </button>
            </div>
          </div>

          <div class="fm-container">
            <!-- Â∑¶‰æßÁõÆÂΩïÊ†ë -->
            <div class="fm-sidebar">
              <div class="fm-sidebar-header">
                <span>ÁõÆÂΩïÁªìÊûÑ</span>
              </div>
              <div class="fm-tree" id="fmTree">
                <!-- ÁõÆÂΩïÊ†ëÂ∞ÜÈÄöËøá JavaScript Âä®ÊÄÅÁîüÊàê -->
              </div>
            </div>

            <!-- Âè≥‰æßÊñá‰ª∂ÂàóË°® -->
            <div class="fm-main">
              <div class="fm-toolbar">
                <button class="fm-tool-btn" id="fmBackBtn" disabled>
                  <span>‚Üê</span>
                </button>
                <div class="fm-breadcrumb" id="fmBreadcrumb">img</div>
                <div class="fm-info" id="fmInfo">0 ‰∏™È°πÁõÆ</div>
              </div>

              <div class="fm-file-list" id="fmFileList">
                <!-- Êñá‰ª∂ÂàóË°®Â∞ÜÈÄöËøá JavaScript Âä®ÊÄÅÁîüÊàê -->
              </div>

              <div class="fm-empty-state" id="fmEmptyState" style="display: none;">
                <div class="fm-empty-icon">üì≠</div>
                <p>Ê≠§Êñá‰ª∂Â§π‰∏∫Á©∫</p>
              </div>
            </div>
          </div>
        </div>

        <!-- ÁªüËÆ°ÂàÜÊûê -->
        <div class="tab-pane" id="analytics">
          <h3>üìä ÁªüËÆ°ÂàÜÊûê</h3>
          <p>Êü•ÁúãÊñáÁ´†ÈòÖËØªÁªüËÆ°„ÄÅÁÉ≠Èó®ÂàÜÊûêÂíåËÆøÈóÆÊù•Ê∫êÊï∞ÊçÆ„ÄÇ</p>

          <!-- ÁªüËÆ°ÂõæË°®Âå∫Âüü -->
          <div class="analytics-grid">
            <!-- ÁÉ≠Èó®ÊñáÁ´† -->
            <div class="analytics-card">
              <div class="analytics-header">
                <h4>üî• ÁÉ≠Èó®ÊñáÁ´†</h4>
                <select id="mostViewedLimit" class="form-control" style="width: 100px; padding: 5px;">
                  <option value="5">Ââç5ÁØá</option>
                  <option value="10" selected>Ââç10ÁØá</option>
                  <option value="20">Ââç20ÁØá</option>
                </select>
              </div>
              <div class="analytics-content">
                <table class="data-table" id="mostViewedTable">
                  <thead>
                    <tr>
                      <th>ÊéíÂêç</th>
                      <th>ÊñáÁ´†Ê†áÈ¢ò</th>
                      <th>‰ΩúËÄÖ</th>
                      <th>ÈòÖËØªÊ¨°Êï∞</th>
                    </tr>
                  </thead>
                  <tbody id="mostViewedTableBody">
                    <tr><td colspan="4" style="text-align: center;">Âä†ËΩΩ‰∏≠...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- ËÆøÈóÆÊù•Ê∫ê -->
            <div class="analytics-card">
              <div class="analytics-header">
                <h4>üåç ËÆøÈóÆÊù•Ê∫êÔºàÊåâÂõΩÂÆ∂Ôºâ</h4>
                <select id="viewSourcesDays" class="form-control" style="width: 100px; padding: 5px;">
                  <option value="7">Ëøë7Â§©</option>
                  <option value="30" selected>Ëøë30Â§©</option>
                  <option value="90">Ëøë90Â§©</option>
                </select>
              </div>
              <div class="analytics-content">
                <table class="data-table" id="viewSourcesTable">
                  <thead>
                    <tr>
                      <th>ÊéíÂêç</th>
                      <th>ÂõΩÂÆ∂/Âú∞Âå∫</th>
                      <th>ËÆøÈóÆÊ¨°Êï∞</th>
                    </tr>
                  </thead>
                  <tbody id="viewSourcesTableBody">
                    <tr><td colspan="3" style="text-align: center;">Âä†ËΩΩ‰∏≠...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- ËÆøÈóÆÊù•Ê∫êÔºàÊåâÂüéÂ∏ÇÔºâ -->
            <div class="analytics-card">
              <div class="analytics-header">
                <h4>üèôÔ∏è ËÆøÈóÆÊù•Ê∫êÔºàÊåâÂüéÂ∏ÇÔºâ</h4>
                <select id="viewByCityDays" class="form-control" style="width: 100px; padding: 5px;">
                  <option value="7">Ëøë7Â§©</option>
                  <option value="30" selected>Ëøë30Â§©</option>
                  <option value="90">Ëøë90Â§©</option>
                </select>
              </div>
              <div class="analytics-content">
                <table class="data-table" id="viewByCityTable">
                  <thead>
                    <tr>
                      <th>ÊéíÂêç</th>
                      <th>ÂüéÂ∏Ç</th>
                      <th>Âú∞Âå∫</th>
                      <th>ËÆøÈóÆÊ¨°Êï∞</th>
                    </tr>
                  </thead>
                  <tbody id="viewByCityTableBody">
                    <tr><td colspan="4" style="text-align: center;">Âä†ËΩΩ‰∏≠...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- ËÆøÈóÆÊù•Ê∫êÔºàÊåâIPÔºâ -->
            <div class="analytics-card full-width">
              <div class="analytics-header">
                <h4>üñ•Ô∏è ËÆøÈóÆÊù•Ê∫êÔºàÊåâIPÔºâ</h4>
                <select id="viewByIPDays" class="form-control" style="width: 100px; padding: 5px;">
                  <option value="7">Ëøë7Â§©</option>
                  <option value="30" selected>Ëøë30Â§©</option>
                  <option value="90">Ëøë90Â§©</option>
                </select>
              </div>
              <div class="analytics-content">
                <table class="data-table" id="viewByIPTable">
                  <thead>
                    <tr>
                      <th>ÊéíÂêç</th>
                      <th>IPÂú∞ÂùÄ</th>
                      <th>ÂõΩÂÆ∂</th>
                      <th>ÂüéÂ∏Ç</th>
                      <th>Âú∞Âå∫</th>
                      <th>ËÆøÈóÆÊ¨°Êï∞</th>
                      <th>È¶ñÊ¨°ËÆøÈóÆ</th>
                      <th>ÊúÄÂêéËÆøÈóÆ</th>
                    </tr>
                  </thead>
                  <tbody id="viewByIPTableBody">
                    <tr><td colspan="8" style="text-align: center;">Âä†ËΩΩ‰∏≠...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- ÈòÖËØªË∂ãÂäø -->
            <div class="analytics-card full-width">
              <div class="analytics-header">
                <h4>üìà ÈòÖËØªË∂ãÂäø</h4>
                <select id="viewTrendDays" class="form-control" style="width: 100px; padding: 5px;">
                  <option value="7">Ëøë7Â§©</option>
                  <option value="30" selected>Ëøë30Â§©</option>
                  <option value="90">Ëøë90Â§©</option>
                </select>
              </div>
              <div class="analytics-content">
                <canvas id="viewTrendChart" style="width: 100%; height: 300px;"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- ÈôÑ‰ª∂ÁÆ°ÁêÜ -->
        <div class="tab-pane" id="attachments">
          <div class="am-header">
            <h3>üìé ÈôÑ‰ª∂ÁÆ°ÁêÜ</h3>
            <p>ÁÆ°ÁêÜÊâÄÊúâ‰∏ä‰º†ÁöÑÈôÑ‰ª∂ÔºåÊîØÊåÅ‰∏ä‰º†„ÄÅÊü•Áúã„ÄÅ‰∏ãËΩΩ„ÄÅÂà†Èô§ÂíåÊùÉÈôêËÆæÁΩÆ„ÄÇ</p>
          </div>

          <!-- Êìç‰ΩúÊ†è -->
          <div class="quick-actions">
            <button class="btn-primary" id="amUploadBtn">
              <span style="margin-right: 5px;">üì§</span>‰∏ä‰º†ÈôÑ‰ª∂
            </button>
            <button class="btn-secondary" id="amRefreshBtn">
              <span style="margin-right: 5px;">üîÑ</span>Âà∑Êñ∞ÂàóË°®
            </button>
          </div>

          <!-- Á≠õÈÄâÂå∫Âüü -->
          <div class="am-filter-section">
            <div class="am-filter-row">
              <div class="form-group" style="margin-bottom: 0;">
                <label for="amFileTypeFilter">Êñá‰ª∂Á±ªÂûã</label>
                <select id="amFileTypeFilter" class="form-control">
                  <option value="">ÂÖ®ÈÉ®Á±ªÂûã</option>
                  <option value="image">ÂõæÁâá</option>
                  <option value="document">ÊñáÊ°£</option>
                  <option value="video">ËßÜÈ¢ë</option>
                  <option value="audio">Èü≥È¢ë</option>
                  <option value="archive">ÂéãÁº©ÂåÖ</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label for="amVisibilityFilter">ÂèØËßÅÊÄß</label>
                <select id="amVisibilityFilter" class="form-control">
                  <option value="">ÂÖ®ÈÉ®</option>
                  <option value="public">ÂÖ¨ÂºÄ</option>
                  <option value="private">ÁßÅÂØÜ</option>
                  <option value="protected">Âèó‰øùÊä§</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label for="amPassageFilter">ÂÖ≥ËÅîÊñáÁ´†</label>
                <select id="amPassageFilter" class="form-control">
                  <option value="">ÂÖ®ÈÉ®ÊñáÁ´†</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label for="amSearchInput">ÊêúÁ¥¢</label>
                <input type="text" id="amSearchInput" class="form-control" placeholder="ÊêúÁ¥¢Êñá‰ª∂Âêç...">
              </div>
            </div>
          </div>

          <!-- ÁªüËÆ°‰ø°ÊÅØ -->
          <div class="am-stats">
            <div class="am-stat-item">
              <span class="am-stat-label">ÊÄªÈôÑ‰ª∂Êï∞:</span>
              <span class="am-stat-value" id="amTotalCount">0</span>
            </div>
            <div class="am-stat-item">
              <span class="am-stat-label">ÊÄªÂ§ßÂ∞è:</span>
              <span class="am-stat-value" id="amTotalSize">0 KB</span>
            </div>
            <div class="am-stat-item">
              <span class="am-stat-label">ÂõæÁâá:</span>
              <span class="am-stat-value" id="amImageCount">0</span>
            </div>
            <div class="am-stat-item">
              <span class="am-stat-label">ÊñáÊ°£:</span>
              <span class="am-stat-value" id="amDocumentCount">0</span>
            </div>
          </div>

          <!-- ÈôÑ‰ª∂ÂàóË°® -->
          <div class="am-list-container">
            <table class="data-table" id="attachmentsTable">
              <thead>
                <tr>
                  <th width="40">
                    <input type="checkbox" id="amSelectAll">
                  </th>
                  <th width="60">È¢ÑËßà</th>
                  <th>Êñá‰ª∂Âêç</th>
                  <th>Á±ªÂûã</th>
                  <th>Â§ßÂ∞è</th>
                  <th>ÂèØËßÅÊÄß</th>
                  <th>ÂÖ≥ËÅîÊñáÁ´†</th>
                  <th>‰∏ä‰º†Êó∂Èó¥</th>
                  <th width="150">Êìç‰Ωú</th>
                </tr>
              </thead>
              <tbody id="attachmentsTableBody">
                <tr>
                  <td colspan="9" style="text-align: center; padding: 40px;">
                    <div class="am-empty-state">
                      <div class="am-empty-icon">üì≠</div>
                      <p>ÊöÇÊó†ÈôÑ‰ª∂</p>
                      <button class="btn-primary" id="amEmptyUploadBtn" style="margin-top: 15px;">
                        ‰∏ä‰º†Á¨¨‰∏Ä‰∏™ÈôÑ‰ª∂
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- ÂàÜÈ°µÁªÑ‰ª∂ -->
          <div class="pagination-container" id="amPaginationContainer" style="display: none;">
            <div class="pagination-info">
              <span id="amPaginationInfo">ÊòæÁ§∫ 1-10 Êù°ÔºåÂÖ± 0 Êù°</span>
            </div>
            <div class="pagination-controls">
              <button class="pagination-btn" id="amPrevPageBtn" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                ‰∏ä‰∏ÄÈ°µ
              </button>
              <div class="pagination-pages" id="amPaginationPages">
                <!-- È°µÁ†ÅÊåâÈíÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
              </div>
              <button class="pagination-btn" id="amNextPageBtn" disabled>
                ‰∏ã‰∏ÄÈ°µ
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            </div>
          </div>

          <!-- ÊâπÈáèÊìç‰Ωú -->
          <div class="am-batch-actions" id="amBatchActions" style="display: none;">
            <span style="margin-right: 15px;">Â∑≤ÈÄâÊã© <strong id="amSelectedCount">0</strong> È°π</span>
            <button class="btn-danger" id="amBatchDeleteBtn">
              <span style="margin-right: 5px;">üóëÔ∏è</span>ÊâπÈáèÂà†Èô§
            </button>
            <button class="btn-secondary" id="amBatchSetPublicBtn">
              ËÆæ‰∏∫ÂÖ¨ÂºÄ
            </button>
            <button class="btn-secondary" id="amBatchSetPrivateBtn">
              ËÆæ‰∏∫ÁßÅÂØÜ
            </button>
            <button class="btn-secondary" id="amCancelSelectionBtn">
              ÂèñÊ∂àÈÄâÊã©
            </button>
          </div>
        </div>

        <!-- Á≥ªÁªüËÆæÁΩÆ -->
        <div class="tab-pane" id="settings">
          <h3>Á≥ªÁªüËÆæÁΩÆ</h3>
          <p>ÈÖçÁΩÆÁΩëÁ´ôÂèÇÊï∞ÂíåÂäüËÉΩËÆæÁΩÆ„ÄÇ</p>

          <!-- Â§ñËßÇËÆæÁΩÆ -->
          <div class="settings-section">
            <h4>üé® Â§ñËßÇËÆæÁΩÆ</h4>
            <div class="settings-grid">
              <div class="form-group">
                <label for="backgroundImage">ËÉåÊôØÂõæÁâáË∑ØÂæÑ</label>
                <input type="text" id="backgroundImage" class="form-control" placeholder="/img/test.webp">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ÊîØÊåÅÁõ∏ÂØπË∑ØÂæÑÊàñÁªùÂØπURLÔºàÊ°åÈù¢Á´ØÔºâ</p>
              </div>

              <div class="form-group">
                <label for="mobileBackgroundImage">ÁßªÂä®Á´ØËÉåÊôØÂõæÁâáË∑ØÂæÑ</label>
                <input type="text" id="mobileBackgroundImage" class="form-control" placeholder="/img/mobile-test.webp">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ÁßªÂä®Á´Ø‰∏ìÁî®ËÉåÊôØÂõæÁâáÔºàÁïôÁ©∫Âàô‰ΩøÁî®Ê°åÈù¢Á´ØËÉåÊôØÔºâ</p>
              </div>

              <div class="form-group">
                <label for="globalOpacity">ÂÖ®Â±ÄÈÄèÊòéÂ∫¶ (0-1)</label>
                <input type="range" id="globalOpacity" class="form-control" min="0" max="1" step="0.05" value="0.15">
                <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.85em; color: #666;">
                  <span>0 (‰∏çÈÄèÊòé)</span>
                  <span id="opacityValue">0.15</span>
                  <span>1 (ÂÆåÂÖ®ÈÄèÊòé)</span>
                </div>
              </div>

              <div class="form-group">
                <label for="backgroundSize">ËÉåÊôØÂ∞∫ÂØ∏</label>
                <select id="backgroundSize" class="form-control">
                  <option value="cover">cover (Ë¶ÜÁõñ)</option>
                  <option value="contain">contain (ÂåÖÂê´)</option>
                  <option value="auto">auto (Ëá™Âä®)</option>
                  <option value="100% 100%">100% 100% (Êãâ‰º∏)</option>
                </select>
              </div>

              <div class="form-group">
                <label for="backgroundPosition">ËÉåÊôØ‰ΩçÁΩÆ</label>
                <select id="backgroundPosition" class="form-control">
                  <option value="center">center (Â±Ö‰∏≠)</option>
                  <option value="top">top (È°∂ÈÉ®)</option>
                  <option value="bottom">bottom (Â∫ïÈÉ®)</option>
                  <option value="left">left (Â∑¶‰æß)</option>
                  <option value="right">right (Âè≥‰æß)</option>
                  <option value="top left">top left (Â∑¶‰∏ä)</option>
                  <option value="top right">top right (Âè≥‰∏ä)</option>
                  <option value="bottom left">bottom left (Â∑¶‰∏ã)</option>
                  <option value="bottom right">bottom right (Âè≥‰∏ã)</option>
                </select>
              </div>

              <div class="form-group">
                <label for="backgroundRepeat">ËÉåÊôØÈáçÂ§ç</label>
                <select id="backgroundRepeat" class="form-control">
                  <option value="no-repeat">no-repeat (‰∏çÈáçÂ§ç)</option>
                  <option value="repeat">repeat (ÈáçÂ§ç)</option>
                  <option value="repeat-x">repeat-x (Ê∞¥Âπ≥ÈáçÂ§ç)</option>
                  <option value="repeat-y">repeat-y (ÂûÇÁõ¥ÈáçÂ§ç)</option>
                </select>
              </div>

              <div class="form-group">
                <label for="backgroundAttachment">ËÉåÊôØÊªöÂä®</label>
                <select id="backgroundAttachment" class="form-control">
                  <option value="fixed">fixed (Âõ∫ÂÆö)</option>
                  <option value="scroll">scroll (ÊªöÂä®)</option>
                  <option value="local">local (Êú¨Âú∞)</option>
                </select>
              </div>

              <div class="form-group">
                <label for="blurAmount">ËÉåÊôØÊ®°Á≥äÁ®ãÂ∫¶</label>
                <input type="text" id="blurAmount" class="form-control" placeholder="20px">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">‰æãÂ¶Ç: 0px, 10px, 20px</p>
              </div>

              <div class="form-group">
                <label for="saturateAmount">ËÉåÊôØÈ•±ÂíåÂ∫¶</label>
                <input type="text" id="saturateAmount" class="form-control" placeholder="180%">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">‰æãÂ¶Ç: 100%, 150%, 200%</p>
              </div>
            </div>

            <!-- È¢ÑËßàÂå∫Âüü -->
            <div class="settings-preview">
              <h5>ÊïàÊûúÈ¢ÑËßà</h5>
              <div id="previewBox" class="preview-box">
                <p>ËøôÊòØÈ¢ÑËßàÊïàÊûúÂå∫Âüü</p>
              </div>
            </div>

            <!-- ÊöóËâ≤Ê®°Âºè -->
            <div class="form-group">
              <label for="darkModeEnabled">
                <input type="checkbox" id="darkModeEnabled" style="margin-right: 8px;">
                ÂêØÁî®ÊöóËâ≤Ê®°Âºè
              </label>
              <p style="font-size: 0.85em; color: #666; margin-top: 5px;">‰∏∫Êï¥‰∏™ÁΩëÁ´ôÂêØÁî®ÊöóËâ≤‰∏ªÈ¢òÔºåÂáèÂ∞ëÁúºÈÉ®Áñ≤Âä≥</p>
            </div>

            <!-- ÊØõÁéªÁíÉÈ¢úËâ≤ËÆæÁΩÆ -->
            <div class="form-group">
              <label for="navbarGlassColor">ÂØºËà™Ê†èÊØõÁéªÁíÉÈ¢úËâ≤</label>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="color" id="navbarGlassColorPicker" class="color-picker" style="width: 50px; height: 40px; border: none; cursor: pointer;">
                <input type="text" id="navbarGlassColor" class="form-control" placeholder="rgba(255, 255, 255, 0.85)">
              </div>
              <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ÂØºËà™Ê†èËÉåÊôØÊØõÁéªÁíÉÊïàÊûúÈ¢úËâ≤ÔºàÊîØÊåÅ rgba Ê†ºÂºèÔºâ</p>
            </div>

            <div class="form-group">
              <label for="navbarTextColor">ÂØºËà™Ê†èÊñáÂ≠óÈ¢úËâ≤</label>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="color" id="navbarTextColorPicker" class="color-picker" style="width: 50px; height: 40px; border: none; cursor: pointer;">
                <input type="text" id="navbarTextColor" class="form-control" placeholder="#333333">
              </div>
              <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ÂØºËà™Ê†èÊñáÂ≠óÈ¢úËâ≤ÔºàÊîØÊåÅ hex„ÄÅrgb Ê†ºÂºèÔºâ</p>
            </div>

            <div class="form-group">
              <label for="cardGlassColor">È°µÈù¢Âç°ÁâáÊØõÁéªÁíÉÈ¢úËâ≤</label>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="color" id="cardGlassColorPicker" class="color-picker" style="width: 50px; height: 40px; border: none; cursor: pointer;">
                <input type="text" id="cardGlassColor" class="form-control" placeholder="rgba(255, 255, 255, 0.75)">
              </div>
              <p style="font-size: 0.85em; color: #666; margin-top: 5px;">È°µÈù¢Âç°ÁâáËÉåÊôØÊØõÁéªÁíÉÊïàÊûúÈ¢úËâ≤ÔºàÊîØÊåÅ rgba Ê†ºÂºèÔºâ</p>
            </div>

            <div class="form-group">
              <label for="footerGlassColor">Â∫ïÊ†èÊØõÁéªÁíÉÈ¢úËâ≤</label>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="color" id="footerGlassColorPicker" class="color-picker" style="width: 50px; height: 40px; border: none; cursor: pointer;">
                <input type="text" id="footerGlassColor" class="form-control" placeholder="rgba(255, 255, 255, 0.9)">
              </div>
              <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Â∫ïÊ†èËÉåÊôØÊØõÁéªÁíÉÊïàÊûúÈ¢úËâ≤ÔºàÊîØÊåÅ rgba Ê†ºÂºèÔºâ</p>
            </div>

            <div class="form-group">
              <label for="floatingTextEnabled">
                <input type="checkbox" id="floatingTextEnabled" style="margin-right: 8px;">
                ÂêØÁî®È£òÂ≠óÊïàÊûú
              </label>
              <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Âú®ÊñáÁ´†È°µÈù¢ÊòæÁ§∫È£òÂä®ÁöÑÊñáÂ≠óÊïàÊûú</p>
            </div>

            <div class="form-group">
              <label for="floatingTexts">È£òÂ≠óÊñáÊú¨ÔºàÁî®ÈÄóÂè∑ÂàÜÈöîÔºâ</label>
              <textarea id="floatingTexts" class="form-control" rows="3" placeholder="perfect, good, excellent, extraordinary, legend"></textarea>
              <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Ëá™ÂÆö‰πâÈ£òÂ≠óÊïàÊûúÊòæÁ§∫ÁöÑÊñáÊú¨ÔºåÂ§ö‰∏™ÊñáÊú¨Áî®ÈÄóÂè∑ÂàÜÈöî</p>
            </div>
          </div>

          <!-- Èü≥‰πêËÆæÁΩÆ -->
          <div class="settings-section">
            <h4>üéµ Èü≥‰πêËÆæÁΩÆ</h4>
            <div class="settings-grid">
              <div class="form-group">
                <label for="musicEnabled">
                  <input type="checkbox" id="musicEnabled" style="margin-right: 8px;">
                  ÂêØÁî®Èü≥‰πêÊí≠ÊîæÂô®
                </label>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Âú®È°µÈù¢ÊòæÁ§∫Èü≥‰πêÊí≠ÊîæÂô®Êéß‰ª∂</p>
              </div>

              <div class="form-group">
                <label for="musicAutoPlay">
                  <input type="checkbox" id="musicAutoPlay" style="margin-right: 8px;">
                  Ëá™Âä®Êí≠Êîæ
                </label>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">È°µÈù¢Âä†ËΩΩÊó∂Ëá™Âä®Êí≠ÊîæÈü≥‰πê</p>
              </div>

              <div class="form-group">
                <label for="musicControlSize">Êéß‰ª∂Â§ßÂ∞è</label>
                <select id="musicControlSize" class="form-control">
                  <option value="small">Â∞è</option>
                  <option value="medium">‰∏≠</option>
                  <option value="large">Â§ß</option>
                </select>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Èü≥‰πêÊí≠ÊîæÂô®Êéß‰ª∂ÁöÑÂ§ßÂ∞è</p>
              </div>

              <div class="form-group">
                <label for="musicPlayerColor">Êí≠ÊîæÂô®È¢úËâ≤</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                  <input type="color" id="musicPlayerColorPicker" class="color-picker" style="width: 50px; height: 40px; border: none; cursor: pointer;">
                  <input type="text" id="musicPlayerColor" class="form-control" placeholder="rgba(66, 133, 244, 0.9)">
                </div>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Èü≥‰πêÊí≠ÊîæÂô®È¢úËâ≤ÔºàÊîØÊåÅ rgba Ê†ºÂºèÔºâ</p>
              </div>

              <div class="form-group">
                <label for="musicPosition">ÊòæÁ§∫‰ΩçÁΩÆ</label>
                <select id="musicPosition" class="form-control">
                  <option value="top-left">Â∑¶‰∏äËßí</option>
                  <option value="top-right">Âè≥‰∏äËßí</option>
                  <option value="bottom-left">Â∑¶‰∏ãËßí</option>
                  <option value="bottom-right">Âè≥‰∏ãËßí</option>
                </select>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Èü≥‰πêÊí≠ÊîæÂô®Âú®È°µÈù¢‰∏≠ÁöÑÊòæÁ§∫‰ΩçÁΩÆ</p>
              </div>

              <div class="form-group">
                <label for="musicCustomCSS">Ëá™ÂÆö‰πâ CSS Ê†∑Âºè</label>
                <textarea id="musicCustomCSS" class="form-control" rows="4" placeholder="/* Ëá™ÂÆö‰πâÈü≥‰πêÊí≠ÊîæÂô®Ê†∑Âºè */"></textarea>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">‰∏∫Èü≥‰πêÊí≠ÊîæÂô®Ê∑ªÂä†Ëá™ÂÆö‰πâ CSS Ê†∑Âºè</p>
              </div>
            </div>

            <!-- Èü≥‰πêÊñá‰ª∂ÁÆ°ÁêÜ -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(0, 0, 0, 0.1);">
              <h5>üìÅ Èü≥‰πêÊñá‰ª∂ÁÆ°ÁêÜ</h5>

              <!-- ÊãñÊãΩ‰∏ä‰º†Âå∫Âüü -->
              <div id="musicDropZone" class="music-drop-zone">
                <div class="drop-zone-content">
                  <div class="drop-zone-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="17 8 12 3 7 8"></polyline>
                      <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                  </div>
                  <h4>ÊãñÊãΩÈü≥È¢ëÊñá‰ª∂Âà∞Ê≠§Â§Ñ‰∏ä‰º†</h4>
                  <p>ÊàñËÄÖ <span class="browse-link">ÁÇπÂáªÈÄâÊã©Êñá‰ª∂</span></p>
                  <p class="upload-hint">ÊîØÊåÅ MP3„ÄÅWAV„ÄÅOGG„ÄÅM4A Á≠âÈü≥È¢ëÊ†ºÂºèÔºåÊîØÊåÅÊâπÈáè‰∏ä‰º†</p>
                </div>
                <input type="file" id="musicFileUpload" accept="audio/*" multiple class="hidden-input">
              </div>

              <!-- ‰∏ä‰º†Êñá‰ª∂ÂàóË°® -->
              <div id="musicUploadList" class="music-upload-list" style="display: none;">
                <div class="upload-list-header">
                  <div class="upload-list-title">‰∏ä‰º†ÈòüÂàó</div>
                  <button class="clear-upload-btn" id="clearUploadBtn">Ê∏ÖÁ©∫ÂàóË°®</button>
                </div>
                <div id="musicUploadItems" class="upload-items"></div>
                <div class="upload-actions">
                  <button class="btn-primary" id="uploadAllMusicBtn">ÂºÄÂßã‰∏ä‰º†</button>
                  <button class="btn-secondary" id="cancelUploadBtn">ÂèñÊ∂à‰∏ä‰º†</button>
                </div>
              </div>

              <!-- Â∞ÅÈù¢‰∏ä‰º†ÊèêÁ§∫ -->
              <div style="margin-top: 15px; padding: 12px 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.15);">
                <p style="font-size: 0.9em; color: rgba(255, 255, 255, 0.8); margin: 0;">
                  üí° <strong>ÊèêÁ§∫Ôºö</strong>ÂèØ‰ª•Âú®‰∏ä‰º†ÈòüÂàó‰∏≠‰∏∫ÊØè‰∏™Èü≥‰πêÊñá‰ª∂ÂçïÁã¨Ê∑ªÂä†Â∞ÅÈù¢ÂõæÁâáÔºàÊîØÊåÅ JPG„ÄÅPNG„ÄÅGIF„ÄÅWebP Ê†ºÂºèÔºâ
                </p>
              </div>

              <!-- Èü≥‰πêÊí≠ÊîæÂàóË°® -->
              <div style="margin-top: 20px;">
                <h5>üéº Êí≠ÊîæÂàóË°®</h5>
                <div id="musicPlaylistContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 8px; padding: 10px;">
                  <div style="text-align: center; color: #999; padding: 20px;">ÊöÇÊó†Èü≥‰πêÊñá‰ª∂</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Ê®°ÊùøËÆæÁΩÆ -->
          <div class="settings-section">
            <h4>üìù Ê®°ÊùøËÆæÁΩÆ</h4>
            <div class="settings-grid">
              <div class="form-group">
                <label for="templateName">‰∏™‰∫∫‰∏ªÈ°µÊ†áÈ¢ò</label>
                <input type="text" id="templateName" class="form-control" placeholder="Ê¨¢ËøéÊù•Âà∞ÊàëÁöÑÂçöÂÆ¢">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ÊòæÁ§∫Âú®È¶ñÈ°µÁöÑÊ†áÈ¢òÊñáÂ≠ó</p>
              </div>

              <div class="form-group">
                <label for="templateGreting">Ê¨¢ËøéËØ≠</label>
                <textarea id="templateGreting" class="form-control" rows="3" placeholder="ËøôÊòØ‰∏Ä‰∏™‰ΩøÁî® Go ËØ≠Ë®ÄÊûÑÂª∫ÁöÑ‰∏™‰∫∫ÂçöÂÆ¢Á≥ªÁªü..."></textarea>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ÊòæÁ§∫Âú®È¶ñÈ°µÁöÑÊ¨¢ËøéÊñáÂ≠ó</p>
              </div>

              <div class="form-group">
                <label for="templateYear">Âπ¥‰ªΩ</label>
                <input type="text" id="templateYear" class="form-control" placeholder="2026">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Áî®‰∫éÁâàÊùÉ‰ø°ÊÅØ</p>
              </div>

              <div class="form-group">
                <label for="templateFoodes">È°µËÑö‰ø°ÊÅØ</label>
                <input type="text" id="templateFoodes" class="form-control" placeholder="ÊàëÁöÑÂçöÂÆ¢">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ÊòæÁ§∫Âú®È°µËÑöÁöÑ‰ø°ÊÅØ</p>
              </div>

              <div class="form-group">
                <label for="globalAvatar">ÂÖ®Â±ÄÂ§¥ÂÉèË∑ØÂæÑ</label>
                <input type="text" id="globalAvatar" class="form-control" placeholder="/img/avatar.webp">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ÂÖ®Â±ÄÁî®Êà∑Â§¥ÂÉèÂõæÁâáË∑ØÂæÑÔºàÊîØÊåÅÁõ∏ÂØπË∑ØÂæÑÊàñÁªùÂØπURLÔºâ</p>
              </div>
            </div>
          </div>

          <!-- ÊñáÁ´†Ê†áÈ¢òËÆæÁΩÆ -->
          <div class="settings-section">
            <h4>üìÑ ÊñáÁ´†Ê†áÈ¢òËÆæÁΩÆ</h4>
            <div class="settings-grid">
              <div class="form-group">
                <label for="templateArticleTitle">
                  <input type="checkbox" id="templateArticleTitle" style="margin-right: 8px;">
                  ÊòæÁ§∫ÊñáÁ´†Ê†áÈ¢ò
                </label>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ÊòØÂê¶Âú®ÊñáÁ´†È°µÈù¢ÊòæÁ§∫Ê†áÈ¢ò</p>
              </div>

              <div class="form-group">
                <label for="templateArticleTitlePrefix">ÊñáÁ´†Ê†áÈ¢òÂâçÁºÄ</label>
                <input type="text" id="templateArticleTitlePrefix" class="form-control" placeholder="ÊñáÁ´†">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ÊòæÁ§∫Âú®ÊñáÁ´†Ê†áÈ¢òÂâçÁöÑÊñáÂ≠óÔºàÂ¶ÇÔºöÊñáÁ´†„ÄÅÈòÖËØªÁ≠âÔºâ</p>
              </div>
            </div>
          </div>

          <!-- ÂàáÊç¢ÁïåÈù¢ÊèêÁ§∫ËÆæÁΩÆ -->
          <div class="settings-section">
            <h4>üí° ÂàáÊç¢ÁïåÈù¢ÊèêÁ§∫ËÆæÁΩÆ</h4>
            <div class="settings-grid">
              <div class="form-group">
                <label for="templateSwitchNotice">
                  <input type="checkbox" id="templateSwitchNotice" style="margin-right: 8px;">
                  ÊòæÁ§∫ÂàáÊç¢Ê†áÁ≠æÈ°µÊèêÁ§∫
                </label>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Áî®Êà∑ÂàáÊç¢Âà∞ÂÖ∂‰ªñÊ†áÁ≠æÈ°µÊó∂ÔºåÂú®Ê†áÁ≠æÈ°µÊ†áÈ¢òÊòæÁ§∫ÊèêÁ§∫ÊñáÂ≠ó</p>
              </div>

              <div class="form-group">
                <label for="templateSwitchNoticeText">ÊèêÁ§∫ÊñáÂ≠ó</label>
                <input type="text" id="templateSwitchNoticeText" class="form-control" placeholder="ÂõûÊù•ÁªßÁª≠ÈòÖËØª">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ÂàáÊç¢Ê†áÁ≠æÈ°µÊó∂Âú®Ê†áÈ¢òÊ†èÊòæÁ§∫ÁöÑÊñáÂ≠óÔºàÂ¶ÇÔºöÂõûÊù•ÁªßÁª≠ÈòÖËØª„ÄÅÂà´ÂøòËÆ∞ÂõûÊù•Âì¶Á≠âÔºâ</p>
              </div>
            </div>
          </div>

          <!-- Â§ñÈÉ®ÈìæÊé•ËÆæÁΩÆ -->
          <div class="settings-section">
            <h4>üîó Â§ñÈÉ®ÈìæÊé•ËÆæÁΩÆ</h4>
            <div class="settings-grid">
              <div class="form-group">
                <label for="externalLinkWarning">
                  <input type="checkbox" id="externalLinkWarning" style="margin-right: 8px;">
                  ÂêØÁî®Â§ñÈÉ®ÈìæÊé•Ë∑≥ËΩ¨Ë≠¶Âëä
                </label>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Áî®Êà∑ÁÇπÂáªÂ§ñÈÉ®ÈìæÊé•Êó∂ÔºåÊòæÁ§∫Ë≠¶ÂëäÊèêÁ§∫</p>
              </div>

              <div class="form-group">
                <label for="externalLinkWhitelist">ÁôΩÂêçÂçïÂüüÂêç</label>
                <input type="text" id="externalLinkWhitelist" class="form-control" placeholder="github.com,gitee.com,stackoverflow.com">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">‰∏çÈúÄË¶ÅË≠¶ÂëäÁöÑÂüüÂêçÔºåÁî®ÈÄóÂè∑ÂàÜÈöîÔºàÂ¶ÇÔºögithub.com,gitee.comÔºâ</p>
              </div>

              <div class="form-group">
                <label for="externalLinkWarningText">Ë≠¶ÂëäÊèêÁ§∫ÊñáÂ≠ó</label>
                <input type="text" id="externalLinkWarningText" class="form-control" placeholder="ÊÇ®Âç≥Â∞ÜÁ¶ªÂºÄÊú¨Á´ôÔºåÂâçÂæÄÂ§ñÈÉ®ÈìæÊé•">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Â§ñÈÉ®ÈìæÊé•Ë≠¶ÂëäÊèêÁ§∫ÊñáÂ≠ó</p>
              </div>

              <div class="form-group">
                <label for="live2dEnabled">
                  <input type="checkbox" id="live2dEnabled" style="margin-right: 8px;">
                  ÂêØÁî® Live2D ÁúãÊùøÂ®ò
                </label>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Âú®È°µÈù¢ÊòæÁ§∫ Live2D ÁúãÊùøÂ®ò</p>
              </div>
            </div>
          </div>

          <!-- Live2D ËØ¶ÁªÜÈÖçÁΩÆ -->
          <div id="live2dConfig" class="settings-section" style="display: none;">
            <div class="settings-grid">
              <div class="form-group">
                <label>ÊòæÁ§∫È°µÈù¢</label>
                <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 5px;">
                  <label style="display: flex; align-items: center;">
                    <input type="checkbox" id="live2dShowOnIndex" style="margin-right: 6px;">
                    È¶ñÈ°µ
                  </label>
                  <label style="display: flex; align-items: center;">
                    <input type="checkbox" id="live2dShowOnPassage" style="margin-right: 6px;">
                    ÊñáÁ´†È°µ
                  </label>
                  <label style="display: flex; align-items: center;">
                    <input type="checkbox" id="live2dShowOnCollect" style="margin-right: 6px;">
                    ÂΩíÊ°£È°µ
                  </label>
                  <label style="display: flex; align-items: center;">
                    <input type="checkbox" id="live2dShowOnAbout" style="margin-right: 6px;">
                    ÂÖ≥‰∫éÈ°µ
                  </label>
                  <label style="display: flex; align-items: center;">
                    <input type="checkbox" id="live2dShowOnAdmin" style="margin-right: 6px;">
                    ÁÆ°ÁêÜÈ°µ
                  </label>
                </div>
              </div>

              <div class="form-group">
                <label for="live2dPosition">ÊòæÁ§∫‰ΩçÁΩÆ</label>
                <select id="live2dPosition" class="form-control">
                  <option value="right">Âè≥‰∏ãËßí</option>
                  <option value="left">Â∑¶‰∏ãËßí</option>
                </select>
              </div>

              <div class="form-group">
                <label for="live2dModelId">Ê®°Âûã ID</label>
                <input type="text" id="live2dModelId" class="form-control" placeholder="1">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">CDN Ê®°ÂûãÁöÑ IDÔºàÂ¶ÇÔºö1, 2, 3 Á≠âÔºâ</p>
              </div>

              <div class="form-group">
                <label for="live2dModelPath">Ëá™ÂÆö‰πâÊ®°ÂûãË∑ØÂæÑ</label>
                <input type="text" id="live2dModelPath" class="form-control" placeholder="/live2d/model/">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ÁïôÁ©∫Âàô‰ΩøÁî® CDN Ê®°Âûã„ÄÇÂ°´ÂÜôÊó∂‰ΩøÁî®Áõ∏ÂØπË∑ØÂæÑÔºàÂ¶ÇÔºö/live2d/model/Ôºâ</p>
              </div>

              <div class="form-group">
                <label for="live2dCDNPath">CDN Ë∑ØÂæÑ</label>
                <input type="text" id="live2dCDNPath" class="form-control" placeholder="https://unpkg.com/live2d-widget-model@1.0.5/">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">CDN Ê®°ÂûãÁöÑÂü∫Á°ÄË∑ØÂæÑ</p>
              </div>

              <div class="form-group">
                <label for="live2dWidth">ÂÆΩÂ∫¶</label>
                <input type="text" id="live2dWidth" class="form-control" placeholder="280px">
              </div>

              <div class="form-group">
                <label for="live2dHeight">È´òÂ∫¶</label>
                <input type="text" id="live2dHeight" class="form-control" placeholder="250px">
              </div>
            </div>
          </div>

          <!-- ËµûÂä©ËÆæÁΩÆ -->
          <div class="settings-section">
            <h4>üí∞ ËµûÂä©ËÆæÁΩÆ</h4>
            <div class="settings-grid">
              <div class="form-group">
                <label for="sponsorEnabled">
                  <input type="checkbox" id="sponsorEnabled" style="margin-right: 8px;">
                  ÂêØÁî®ËµûÂä©ÂäüËÉΩ
                </label>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">Âú®ÊñáÁ´†Êú´Â∞æÊòæÁ§∫ËµûÂä©ÊåâÈíÆ</p>
              </div>

              <div class="form-group">
                <label for="sponsorTitle">ËµûÂä©Ê†áÈ¢ò</label>
                <input type="text" id="sponsorTitle" class="form-control" placeholder="ÊÑüË∞¢ÊÇ®ÁöÑÊîØÊåÅ">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ËµûÂä©Ê®°ÊÄÅÊ°ÜÁöÑÊ†áÈ¢ò</p>
              </div>

              <div class="form-group">
                <label for="sponsorImage">ËµûÂä©ÂõæÁâáË∑ØÂæÑ</label>
                <input type="text" id="sponsorImage" class="form-control" placeholder="/img/avatar.webp">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ËµûÂä©‰∫åÁª¥Á†ÅÂõæÁâáÁöÑË∑ØÂæÑ</p>
              </div>

              <div class="form-group">
                <label for="sponsorDescription">ËµûÂä©ÊèèËø∞</label>
                <textarea id="sponsorDescription" class="form-control" rows="3" placeholder="Â¶ÇÊûúÊÇ®ËßâÂæóËøô‰∏™ÂçöÂÆ¢ÂØπÊÇ®ÊúâÂ∏ÆÂä©ÔºåÊ¨¢ËøéËµûÂä©ÊîØÊåÅÔºÅ"></textarea>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ËµûÂä©ËØ¥ÊòéÊñáÂ≠ó</p>
              </div>

              <div class="form-group">
                <label for="sponsorButtonText">ËµûÂä©ÊåâÈíÆÊñáÂ≠ó</label>
                <input type="text" id="sponsorButtonText" class="form-control" placeholder="‚ù§Ô∏è ËµûÂä©ÊîØÊåÅ">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ÊòæÁ§∫Âú®ÊñáÁ´†‰∏≠ÁöÑËµûÂä©ÊåâÈíÆÊñáÂ≠ó</p>
              </div>
            </div>
          </div>

          <div class="btn-group">
            <button class="btn-secondary" id="resetSettingsBtn">ÈáçÁΩÆ‰∏∫ÈªòËÆ§</button>
            <button class="btn-primary" id="saveMusicSettingsBtn">‰øùÂ≠òÈü≥‰πêËÆæÁΩÆ</button>
            <button class="btn-primary" id="saveSettingsBtn">‰øùÂ≠òÂ§ñËßÇËÆæÁΩÆ</button>
            <button class="btn-primary" id="saveTemplateSettingsBtn">‰øùÂ≠òÊ®°ÊùøËÆæÁΩÆ</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- ‰∏ä‰º†ÊñáÁ´†Ê®°ÊÄÅÊ°Ü -->
<div class="modal" id="uploadModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‰∏ä‰º†ÊñáÁ´†</h3>
      <button class="modal-close" data-modal="uploadModal">√ó</button>
    </div>
    <div class="modal-body">
      <form id="uploadForm">
        <div class="form-group">
          <label for="uploadTitle">ÊñáÁ´†Ê†áÈ¢ò <span style="color: #e74c3c;">*</span></label>
          <input type="text" id="uploadTitle" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÊñáÁ´†Ê†áÈ¢ò" required>
        </div>

        <div class="form-group">
          <label for="uploadAuthor">‰ΩúËÄÖ <span style="color: #e74c3c;">*</span></label>
          <input type="text" id="uploadAuthor" class="form-control" value="ÁÆ°ÁêÜÂëò">
        </div>
        
        <div class="form-group">
          <label>ÂèëÂ∏ÉÊó•ÊúüÔºà‰ªÖÂØπMarkdownÊñá‰ª∂ÊúâÊïàÔºâ</label>
          <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
              <input type="number" id="uploadYear" class="form-control" placeholder="Âπ¥" min="2020" max="2030">
            </div>
            <div style="flex: 1;">
              <input type="number" id="uploadMonth" class="form-control" placeholder="Êúà" min="1" max="12">
            </div>
            <div style="flex: 1;">
              <input type="number" id="uploadDay" class="form-control" placeholder="Êó•" min="1" max="31">
            </div>
          </div>
          <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ÁïôÁ©∫Âàô‰ΩøÁî®ÂΩìÂâçÊó•Êúü</p>
        </div>
        
        <div class="form-group">
          <label for="uploadCategory">ÂàÜÁ±ª</label>
          <div class="category-selector" id="uploadCategorySelector">
            <!-- ÂàÜÁ±ªÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
          </div>
          <div class="category-input-container">
            <input type="text" class="form-control category-input" id="uploadCategoryInput" placeholder="Ê∑ªÂä†Ëá™ÂÆö‰πâÂàÜÁ±ª">
            <button type="button" class="btn-secondary" id="addUploadCategoryBtn">Ê∑ªÂä†</button>
          </div>
          <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ÈÄâÊã©ÊñáÁ´†ÊâÄÂ±ûÂàÜÁ±ªÔºåÊàñËæìÂÖ•Êñ∞ÂàÜÁ±ªÂêçÁß∞ÔºàÂèØÈÄâÔºâ</p>
        </div>
        
        <div class="form-group">
          <label>Ê†áÁ≠æ</label>
          <div class="tag-selector" id="uploadTagSelector">
            <!-- Ê†áÁ≠æÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
          </div>
          <div class="tag-input-container">
            <input type="text" class="form-control tag-input" id="uploadTagInput" placeholder="Ê∑ªÂä†Ëá™ÂÆö‰πâÊ†áÁ≠æ">
            <button type="button" class="btn-secondary" id="addUploadTagBtn">Ê∑ªÂä†</button>
          </div>
        </div>
        
        <div class="form-group">
          <label for="uploadContent">ÊñáÁ´†ÂÜÖÂÆπ <span style="color: #e74c3c;">*</span></label>
          <textarea id="uploadContent" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÊñáÁ´†ÂÜÖÂÆπÔºàÊîØÊåÅMarkdownÊ†ºÂºèÔºâ" rows="10"></textarea>
          <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ËæìÂÖ•ÊñáÁ´†ÂÜÖÂÆπÊàñ‰∏ä‰º†MarkdownÊñá‰ª∂ÔºàËá≥Â∞ëÊèê‰æõ‰∏ÄÁßçÔºâ</p>
        </div>
        
        <div class="form-group">
          <label>‰∏ä‰º†ÈôÑ‰ª∂</label>
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">
              <h4>ÁÇπÂáªÊàñÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§Ñ</h4>
              <p>ÊîØÊåÅÂõæÁâá„ÄÅÊñáÊ°£„ÄÅÂéãÁº©ÂåÖÁ≠âÊñá‰ª∂Ê†ºÂºèÔºåÂçï‰∏™Êñá‰ª∂ÊúÄÂ§ß10MB</p>
            </div>
            <input type="file" id="fileInput" multiple style="display: none;">
          </div>
          <div class="upload-preview" id="uploadPreview"></div>
        </div>
        
        <div class="form-group">
          <label for="uploadStatus">ÂèëÂ∏ÉÁä∂ÊÄÅ</label>
          <select id="uploadStatus" class="form-control">
            <option value="draft">ËçâÁ®ø</option>
            <option value="pending">ÂæÖÂÆ°Ê†∏</option>
            <option value="published">Á´ãÂç≥ÂèëÂ∏É</option>
          </select>
        </div>
        
        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="uploadModal">ÂèñÊ∂à</button>
          <button type="submit" class="btn-primary">‰∏ä‰º†ÊñáÁ´†</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Êñ∞Âª∫ÊñáÁ´†Ê®°ÊÄÅÊ°Ü -->
<div class="modal" id="articleModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Êñ∞Âª∫ÊñáÁ´†</h3>
      <button class="modal-close" data-modal="articleModal">√ó</button>
    </div>
    <div class="modal-body">
      <form id="articleForm">
        <div class="form-group">
          <label for="articleTitle">ÊñáÁ´†Ê†áÈ¢ò <span style="color: #e74c3c;">*</span></label>
          <input type="text" id="articleTitle" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÊñáÁ´†Ê†áÈ¢ò" required>
        </div>

        <div class="form-group">
          <label for="articleAuthor">‰ΩúËÄÖ <span style="color: #e74c3c;">*</span></label>
          <input type="text" id="articleAuthor" class="form-control" value="ÁÆ°ÁêÜÂëò">
        </div>
        
        <div class="form-group">
          <label for="articleCategory">ÂàÜÁ±ª</label>
          <select id="articleCategory" class="form-control">
            <!-- ÂàÜÁ±ªÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
          </select>
        </div>

        <div class="form-group">
          <label>Ê†áÁ≠æ</label>
          <div id="articleTagSelector" class="tag-selector">
            <!-- Ê†áÁ≠æÈÄâÈ°πÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
          </div>
          <input type="hidden" id="articleTags" name="tags">
        </div>

        <div class="form-group">
          <label for="articleCoverImage">Â∞ÅÈù¢ÂõæÁâáË∑ØÂæÑ</label>
          <input type="text" id="articleCoverImage" class="form-control" placeholder="/img/xxx.webpÔºàÈúÄË¶ÅÈ¢ÑÂÖà‰∏ä‰º†ÂõæÁâáÊñá‰ª∂Ôºâ" value="/img/passage-cover2.webp">
          <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ËØ∑ËæìÂÖ•ÂõæÁâáÁöÑÁõ∏ÂØπË∑ØÂæÑÔºåÈªòËÆ§‰ΩøÁî® /img/passage-cover2.webp</p>
        </div>

        <div class="form-group">
          <label for="articleContent">ÊñáÁ´†ÂÜÖÂÆπ <span style="color: #e74c3c;">*</span></label>
          <textarea id="articleContent" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÊñáÁ´†ÂÜÖÂÆπÔºàÊîØÊåÅMarkdownÊ†ºÂºèÔºâ" rows="15"></textarea>
        </div>
        
        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="articleModal">ÂèñÊ∂à</button>
          <button type="submit" class="btn-primary">‰øùÂ≠òÊñáÁ´†</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ÁºñËæëÊñáÁ´†Ê®°ÊÄÅÊ°Ü -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ÁºñËæëÊñáÁ´†</h3>
      <button class="modal-close" data-modal="editModal">√ó</button>
    </div>
    <div class="modal-body">
      <form id="editForm">
        <div class="form-group">
          <label for="editTitle">ÊñáÁ´†Ê†áÈ¢ò <span style="color: #e74c3c;">*</span></label>
          <input type="text" id="editTitle" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÊñáÁ´†Ê†áÈ¢ò" required>
        </div>

        <div class="form-group">
          <label for="editAuthor">‰ΩúËÄÖ <span style="color: #e74c3c;">*</span></label>
          <input type="text" id="editAuthor" class="form-control" placeholder="ËØ∑ËæìÂÖ•‰ΩúËÄÖ">
        </div>

        <div class="form-group">
          <label for="editShowTitle">
            <input type="checkbox" id="editShowTitle" checked>
            ÊòæÁ§∫Ê†áÈ¢òÔºàÈò≤Ê≠¢Âá∫Áé∞‰∏§Ê¨°Ê†áÈ¢òÔºâ
          </label>
          <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ÂèñÊ∂àÂãæÈÄâÂêéÔºåÊñáÁ´†ÂÜÖÂÆπÂ∞Ü‰∏çÊòæÁ§∫Ê†áÈ¢òÔºåÈÄÇÁî®‰∫éÊ†áÈ¢òÂ∑≤Âú®ÂÜÖÂÆπ‰∏≠ÂåÖÂê´ÁöÑÊÉÖÂÜµ</p>
        </div>

        <div class="form-group">
          <label for="editCategory">ÂàÜÁ±ª</label>
          <select id="editCategory" class="form-control">
            <option value="">Âä†ËΩΩ‰∏≠...</option>
          </select>
        </div>

        <div class="form-group">
          <label>Ê†áÁ≠æ</label>
          <div id="editTagSelector" class="tag-selector">
            <!-- Ê†áÁ≠æÈÄâÈ°πÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
          </div>
          <input type="hidden" id="editTags" name="tags">
        </div>

        <div class="form-group">
          <label for="editStatus">ÊñáÁ´†Áä∂ÊÄÅ</label>
          <select id="editStatus" class="form-control">
            <option value="draft">ËçâÁ®ø</option>
            <option value="published">Â∑≤ÂèëÂ∏É</option>
            <option value="pending">ÂæÖÂÆ°Ê†∏</option>
          </select>
          <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
            ËçâÁ®øÔºö‰ªÖÁÆ°ÁêÜÂëòÂèØËßÅ<br>
            Â∑≤ÂèëÂ∏ÉÔºöÂÖ¨ÂºÄÂèØËßÅÔºàÂ¶ÇÊûúÂèØËßÅÊÄß‰∏∫ÂÖ¨ÂºÄÔºâ
          </p>
        </div>

        <div class="form-group">
          <label for="editVisibility">ÂèØËßÅÊÄß</label>
          <select id="editVisibility" class="form-control">
            <option value="public">ÂÖ¨ÂºÄ</option>
            <option value="private">ÁßÅÂØÜ</option>
          </select>
          <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
            ÂÖ¨ÂºÄÔºöÊâÄÊúâÁî®Êà∑ÂèØËßÅ<br>
            ÁßÅÂØÜÔºö‰ªÖÁÆ°ÁêÜÂëòÂèØËßÅ
          </p>
        </div>

        <div class="form-group">
          <label for="editIsScheduled">
            <input type="checkbox" id="editIsScheduled">
            ÂÆöÊó∂ÂèëÂ∏É
          </label>
          <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
            ÂãæÈÄâÂêéÔºåÊñáÁ´†Â∞ÜÂú®ÊåáÂÆöÊó∂Èó¥Ëá™Âä®ÂèëÂ∏É
          </p>
        </div>

        <div class="form-group" id="editPublishedAtGroup" style="display: none;">
          <label for="editPublishedAt">ÂèëÂ∏ÉÊó∂Èó¥</label>
          <input type="datetime-local" id="editPublishedAt" class="form-control">
          <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
            ËÆæÁΩÆÊñáÁ´†ÁöÑÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥
          </p>
        </div>

        <div class="form-group">
          <label for="editCoverImage">Â∞ÅÈù¢ÂõæÁâáË∑ØÂæÑ</label>
          <input type="text" id="editCoverImage" class="form-control" placeholder="/img/xxx.webpÔºàÈúÄË¶ÅÈ¢ÑÂÖà‰∏ä‰º†ÂõæÁâáÊñá‰ª∂Ôºâ">
          <p style="font-size: 0.85em; color: #666; margin-top: 5px;">ÁïôÁ©∫Âàô‰∏ç‰øÆÊîπÂéüÊúâÂ∞ÅÈù¢Ë∑ØÂæÑ</p>
        </div>

        <div class="form-group">
          <label for="editContent">ÊñáÁ´†ÂÜÖÂÆπ <span style="color: #e74c3c;">*</span></label>
          <textarea id="editContent" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÊñáÁ´†ÂÜÖÂÆπÔºàÊîØÊåÅMarkdownÊ†ºÂºèÔºâ" rows="15"></textarea>
        </div>
        
        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="editModal">ÂèñÊ∂à</button>
          <button type="submit" class="btn-primary">‰øùÂ≠ò‰øÆÊîπ</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Ê∑ªÂä†Áî®Êà∑Ê®°ÊÄÅÊ°Ü -->
<div class="modal" id="userModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Ê∑ªÂä†Áî®Êà∑</h3>
      <button class="modal-close" data-modal="userModal">√ó</button>
    </div>
    <div class="modal-body">
      <form id="userForm">
        <div class="form-group">
          <label for="userName">Áî®Êà∑Âêç</label>
          <input type="text" id="userName" class="form-control" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç" required>
        </div>

        <div class="form-group">
          <label for="userEmail">ÈÇÆÁÆ±</label>
          <input type="email" id="userEmail" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±Âú∞ÂùÄ" required>
        </div>

        <div class="form-group">
          <label for="userPassword">ÂØÜÁ†Å</label>
          <input type="password" id="userPassword" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" required>
        </div>

        <div class="form-group">
          <label for="userRole">ËßíËâ≤</label>
          <select id="userRole" class="form-control">
            <option value="user">ÊôÆÈÄöÁî®Êà∑</option>
            <option value="editor">ÁºñËæë</option>
            <option value="admin">ÁÆ°ÁêÜÂëò</option>
          </select>
        </div>

        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="userModal">ÂèñÊ∂à</button>
          <button type="submit" class="btn-primary">ÂàõÂª∫Áî®Êà∑</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ÁºñËæëÁî®Êà∑Ê®°ÊÄÅÊ°Ü -->
<div class="modal" id="editUserModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ÁºñËæëÁî®Êà∑</h3>
      <button class="modal-close" data-modal="editUserModal">√ó</button>
    </div>
    <div class="modal-body">
      <form id="editUserForm">
        <div class="form-group">
          <label for="editUserName">Áî®Êà∑Âêç</label>
          <input type="text" id="editUserName" class="form-control" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç" required>
        </div>

        <div class="form-group">
          <label for="editUserEmail">ÈÇÆÁÆ±</label>
          <input type="email" id="editUserEmail" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±Âú∞ÂùÄ" required>
        </div>

        <div class="form-group">
          <label for="editUserPassword">ÂØÜÁ†Å</label>
          <input type="password" id="editUserPassword" class="form-control" placeholder="ÁïôÁ©∫Âàô‰∏ç‰øÆÊîπÂØÜÁ†Å">
        </div>

        <div class="form-group">
          <label for="editUserRole">ËßíËâ≤</label>
          <select id="editUserRole" class="form-control">
            <option value="user">ÊôÆÈÄöÁî®Êà∑</option>
            <option value="editor">ÁºñËæë</option>
            <option value="admin">ÁÆ°ÁêÜÂëò</option>
          </select>
        </div>

        <div class="form-group">
          <label for="editUserStatus">Áä∂ÊÄÅ</label>
          <select id="editUserStatus" class="form-control">
            <option value="active">Ê≠£Â∏∏</option>
            <option value="restricted">ÂèóÈôê</option>
            <option value="banned">Á¶ÅÁî®</option>
          </select>
        </div>

        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="editUserModal">ÂèñÊ∂à</button>
          <button type="submit" class="btn-primary">‰øùÂ≠ò‰øÆÊîπ</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ÊñáÁ´†ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
<div class="modal" id="viewArticleModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ÊñáÁ´†ËØ¶ÊÉÖ</h3>
      <button class="modal-close" data-modal="viewArticleModal">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>ÊñáÁ´†ID</label>
        <div id="viewArticleId" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>Ê†áÈ¢ò</label>
        <div id="viewArticleTitle" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>‰ΩúËÄÖ</label>
        <div id="viewArticleAuthor" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>Áä∂ÊÄÅ</label>
        <div id="viewArticleStatus" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>ÂàõÂª∫Êó∂Èó¥</label>
        <div id="viewArticleDate" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>ÂÜÖÂÆπ</label>
        <div id="viewArticleContent" class="form-control" style="background: rgba(0,0,0,0.03); min-height: 200px; white-space: pre-wrap;"></div>
      </div>
      <div class="btn-group">
        <button type="button" class="btn-secondary" data-modal="viewArticleModal">ÂÖ≥Èó≠</button>
      </div>
    </div>
  </div>
</div>

<!-- ‰∏ä‰º†ÈôÑ‰ª∂Ê®°ÊÄÅÊ°Ü -->
<div class="modal" id="uploadAttachmentModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‰∏ä‰º†ÈôÑ‰ª∂</h3>
      <button class="modal-close" data-modal="uploadAttachmentModal">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>ÊñáÁ´†ID</label>
        <div id="uploadAttachmentArticleId" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>ÈÄâÊã©Êñá‰ª∂</label>
        <input type="file" id="attachmentFile" class="form-control" accept=".svg,.bmp,.pdf,.docx,.mp4,.mp3,.flac,.zip,.tar,.7z,.gz,.tar.gz">
        <small style="color: rgba(255,255,255,0.6); display: block; margin-top: 5px;">
          ÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûãÔºöSVG, BMP, PDF, DOCX, MP4, MP3, FLAC, ZIP, TAR, 7Z, GZ, TAR.GZ
        </small>
      </div>
      <div id="uploadAttachmentProgress" style="display: none; margin-top: 15px;">
        <div style="background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden;">
          <div id="uploadAttachmentProgressBar" style="width: 0%; height: 20px; background: #007bff; transition: width 0.3s;"></div>
        </div>
        <div id="uploadAttachmentStatus" style="margin-top: 5px; font-size: 0.9em;"></div>
      </div>
      <div id="uploadAttachmentResult" style="display: none; margin-top: 15px;">
        <div style="background: rgba(0,184,148,0.1); border: 1px solid rgba(0,184,148,0.3); border-radius: 8px; padding: 15px;">
          <div style="color: #00b894; font-weight: 500;">‰∏ä‰º†ÊàêÂäüÔºÅ</div>
          <div id="uploadAttachmentFileInfo" style="margin-top: 10px; font-size: 0.9em;"></div>
        </div>
      </div>
      <div class="btn-group">
        <button type="button" class="btn-primary" id="uploadAttachmentBtn">‰∏ä‰º†</button>
        <button type="button" class="btn-secondary" data-modal="uploadAttachmentModal">ÂèñÊ∂à</button>
      </div>
    </div>
  </div>
</div>

<!-- Áî®Êà∑ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
<div class="modal" id="viewUserModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Áî®Êà∑ËØ¶ÊÉÖ</h3>
      <button class="modal-close" data-modal="viewUserModal">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Áî®Êà∑ID</label>
        <div id="viewUserId" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>Áî®Êà∑Âêç</label>
        <div id="viewUserName" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>ÈÇÆÁÆ±</label>
        <div id="viewUserEmail" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>ËßíËâ≤</label>
        <div id="viewUserRole" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>Áä∂ÊÄÅ</label>
        <div id="viewUserStatus" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>Ê≥®ÂÜåÊó∂Èó¥</label>
        <div id="viewUserDate" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="btn-group">
        <button type="button" class="btn-secondary" data-modal="viewUserModal">ÂÖ≥Èó≠</button>
      </div>
    </div>
  </div>
</div>

<!-- ËØÑËÆ∫ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
<div class="modal" id="viewCommentModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ËØÑËÆ∫ËØ¶ÊÉÖ</h3>
      <button class="modal-close" data-modal="viewCommentModal">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>ËØÑËÆ∫ID</label>
        <div id="viewCommentId" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>ËØÑËÆ∫ÂÜÖÂÆπ</label>
        <div id="viewCommentContent" class="form-control" style="background: rgba(0,0,0,0.03); min-height: 100px; white-space: pre-wrap;"></div>
      </div>
      <div class="form-group">
        <label>ÊâÄÂ±ûÊñáÁ´†</label>
        <div id="viewCommentArticle" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>ËØÑËÆ∫Áî®Êà∑</label>
        <div id="viewCommentUser" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>Áä∂ÊÄÅ</label>
        <div id="viewCommentStatus" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>ËØÑËÆ∫Êó∂Èó¥</label>
        <div id="viewCommentDate" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="btn-group">
        <button type="button" class="btn-secondary" data-modal="viewCommentModal">ÂÖ≥Èó≠</button>
      </div>
    </div>
  </div>
</div>

<!-- Ê∑ªÂä†/ÁºñËæëÂàÜÁ±ªÊ®°ÊÄÅÊ°Ü -->
<div class="modal" id="categoryModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="categoryModalTitle">Ê∑ªÂä†ÂàÜÁ±ª</h3>
      <button class="modal-close" data-modal="categoryModal">√ó</button>
    </div>
    <div class="modal-body">
      <form id="categoryForm">
        <div class="form-group">
          <label for="categoryName">ÂàÜÁ±ªÂêçÁß∞</label>
          <input type="text" id="categoryName" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÂàÜÁ±ªÂêçÁß∞" required>
        </div>
        <div class="form-group">
          <label for="categoryDescription">ÊèèËø∞</label>
          <textarea id="categoryDescription" class="form-control" rows="3" placeholder="ËØ∑ËæìÂÖ•ÂàÜÁ±ªÊèèËø∞"></textarea>
        </div>
        <div class="form-group">
          <label for="categoryIcon">ÂõæÊ†á</label>
          <input type="text" id="categoryIcon" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÂõæÊ†áÔºàemojiÊàñÂõæÊ†áÁ±ªÂêçÔºâ">
        </div>
        <div class="form-group">
          <label for="categorySortOrder">ÊéíÂ∫è</label>
          <input type="number" id="categorySortOrder" class="form-control" placeholder="0" min="0" value="0">
        </div>
        <div class="form-group">
          <label for="categoryEnabled">
            <input type="checkbox" id="categoryEnabled" checked>
            ÂêØÁî®
          </label>
        </div>
        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="categoryModal">ÂèñÊ∂à</button>
          <button type="submit" class="btn-primary">‰øùÂ≠ò</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Ê∑ªÂä†/ÁºñËæëÊ†áÁ≠æÊ®°ÊÄÅÊ°Ü -->
<div class="modal" id="tagModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="tagModalTitle">Ê∑ªÂä†Ê†áÁ≠æ</h3>
      <button class="modal-close" data-modal="tagModal">√ó</button>
    </div>
    <div class="modal-body">
      <form id="tagForm">
        <div class="form-group">
          <label for="tagName">Ê†áÁ≠æÂêçÁß∞</label>
          <input type="text" id="tagName" class="form-control" placeholder="ËØ∑ËæìÂÖ•Ê†áÁ≠æÂêçÁß∞" required>
        </div>
        <div class="form-group">
          <label for="tagDescription">ÊèèËø∞</label>
          <textarea id="tagDescription" class="form-control" rows="3" placeholder="ËØ∑ËæìÂÖ•Ê†áÁ≠æÊèèËø∞"></textarea>
        </div>
        <div class="form-group">
          <label for="tagColor">È¢úËâ≤</label>
          <input type="color" id="tagColor" class="form-control" value="#007bff">
        </div>
        <div class="form-group">
          <label for="tagCategory">ÊâÄÂ±ûÂàÜÁ±ª</label>
          <select id="tagCategory" class="form-control">
            <option value="0">Êó†ÂàÜÁ±ª</option>
          </select>
        </div>
        <div class="form-group">
          <label for="tagSortOrder">ÊéíÂ∫è</label>
          <input type="number" id="tagSortOrder" class="form-control" placeholder="0" min="0" value="0">
        </div>
        <div class="form-group">
          <label for="tagEnabled">
            <input type="checkbox" id="tagEnabled" checked>
            ÂêØÁî®
          </label>
        </div>
        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="tagModal">ÂèñÊ∂à</button>
          <button type="submit" class="btn-primary">‰øùÂ≠ò</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Á°ÆËÆ§Âà†Èô§Ê®°ÊÄÅÊ°Ü -->
<div class="modal" id="confirmModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Á°ÆËÆ§Êìç‰Ωú</h3>
      <button class="modal-close" data-modal="confirmModal">√ó</button>
    </div>
    <div class="modal-body">
      <p id="confirmMessage">Á°ÆÂÆöË¶ÅÊâßË°åÊ≠§Êìç‰ΩúÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ</p>
      <div class="btn-group">
        <button type="button" class="btn-secondary" data-modal="confirmModal">ÂèñÊ∂à</button>
        <button type="button" class="btn-primary" id="confirmAction">Á°ÆËÆ§</button>
      </div>
    </div>
  </div>
</div>

<!-- ÁºñËæë‰∏ªÂç°ÁâáÊ®°ÊÄÅÊ°Ü -->
<div class="modal" id="mainCardModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="mainCardModalTitle">ÁºñËæë‰∏ªÂç°Áâá</h3>
      <button class="modal-close" data-modal="mainCardModal">√ó</button>
    </div>
    <div class="modal-body">
      <form id="mainCardForm">
        <input type="hidden" id="mainCardId">
        <div class="form-group">
          <label for="mainCardTitle">Ê†áÈ¢ò</label>
          <input type="text" id="mainCardTitle" class="form-control" placeholder="ËØ∑ËæìÂÖ•‰∏ªÂç°ÁâáÊ†áÈ¢ò" required>
        </div>
        <div class="form-group">
          <label for="mainCardIcon">ÂõæÊ†á</label>
          <input type="text" id="mainCardIcon" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÂõæÊ†áÔºàÂ¶ÇÔºöüìöÔºâ">
        </div>
        <div class="form-group">
          <label for="mainCardLayoutType">Â∏ÉÂ±ÄÁ±ªÂûã</label>
          <select id="mainCardLayoutType" class="form-control">
            <option value="grid">ÁΩëÊ†ºÂ∏ÉÂ±Ä</option>
            <option value="flex">ÂºπÊÄßÂ∏ÉÂ±Ä</option>
            <option value="team">Âõ¢ÈòüÂ∏ÉÂ±Ä</option>
          </select>
        </div>
        <div class="form-group">
          <label for="mainCardCustomCss">Ëá™ÂÆö‰πâCSS</label>
          <textarea id="mainCardCustomCss" class="form-control" rows="3" placeholder="ÂèØÈÄâÔºöËæìÂÖ•Ëá™ÂÆö‰πâCSSÊ†∑Âºè"></textarea>
        </div>
        <div class="form-group">
          <label for="mainCardSortOrder">ÊéíÂ∫è</label>
          <input type="number" id="mainCardSortOrder" class="form-control" placeholder="0" min="0" value="0">
        </div>
        <div class="form-group">
          <label for="mainCardEnabled">
            <input type="checkbox" id="mainCardEnabled" checked>
            ÂêØÁî®
          </label>
        </div>
        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="mainCardModal">ÂèñÊ∂à</button>
          <button type="submit" class="btn-primary">‰øùÂ≠ò</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ÁºñËæëÊ¨°Âç°ÁâáÊ®°ÊÄÅÊ°Ü -->
<div class="modal" id="subCardModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="subCardModalTitle">ÁºñËæëÊ¨°Âç°Áâá</h3>
      <button class="modal-close" data-modal="subCardModal">√ó</button>
    </div>
    <div class="modal-body">
      <form id="subCardForm">
        <input type="hidden" id="subCardId">
        <div class="form-group">
          <label for="subCardMainCardId">ÊâÄÂ±û‰∏ªÂç°Áâá</label>
          <select id="subCardMainCardId" class="form-control" required>
            <option value="">ËØ∑ÈÄâÊã©‰∏ªÂç°Áâá</option>
          </select>
        </div>
        <div class="form-group">
          <label for="subCardTitle">Ê†áÈ¢ò</label>
          <input type="text" id="subCardTitle" class="form-control" placeholder="ËØ∑ËæìÂÖ•Ê¨°Âç°ÁâáÊ†áÈ¢ò" required>
        </div>
        <div class="form-group">
          <label for="subCardDescription">ÊèèËø∞</label>
          <textarea id="subCardDescription" class="form-control" rows="3" placeholder="ËØ∑ËæìÂÖ•ÊèèËø∞"></textarea>
        </div>
        <div class="form-group">
          <label for="subCardIcon">ÂõæÊ†á</label>
          <input type="text" id="subCardIcon" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÂõæÊ†áÔºàÂ¶ÇÔºö‚≠êÔºâ">
        </div>
        <div class="form-group">
          <label for="subCardLinkUrl">ÈìæÊé•URL</label>
          <input type="text" id="subCardLinkUrl" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÈìæÊé•URLÔºàÂèØÈÄâÔºâ">
        </div>
        <div class="form-group">
          <label for="subCardCustomCss">Ëá™ÂÆö‰πâCSS</label>
          <textarea id="subCardCustomCss" class="form-control" rows="3" placeholder="ÂèØÈÄâÔºöËæìÂÖ•Ëá™ÂÆö‰πâCSSÊ†∑Âºè"></textarea>
        </div>
        <div class="form-group">
          <label for="subCardSortOrder">ÊéíÂ∫è</label>
          <input type="number" id="subCardSortOrder" class="form-control" placeholder="0" min="0" value="0">
        </div>
        <div class="form-group">
          <label for="subCardEnabled">
            <input type="checkbox" id="subCardEnabled" checked>
            ÂêØÁî®
          </label>
        </div>
        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="subCardModal">ÂèñÊ∂à</button>
          <button type="submit" class="btn-primary">‰øùÂ≠ò</button>
        </div>
      </form>
    </div>
  </div>
</div>

<footer>
  <div>&copy; {{ year }} {{ foodes }}</div>
</footer>

<script>
// Toast ÈÄöÁü•Á≥ªÁªü
function showToast(message, type = 'success') {
  const container = document.getElementById('toastContainer');
  if (!container) {
    console.error('Toast container not found');
    return;
  }

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;

  let icon = '';
  switch (type) {
    case 'success':
      icon = '‚≠ï';
      break;
    case 'error':
      icon = '‚ùå';
      break;
    case 'warning':
      icon = '‚ö†Ô∏è';
      break;
    default:
      icon = '‚≠ï';
  }

  toast.innerHTML = `
    <div class="toast-icon">${icon}</div>
    <div class="toast-message">${message}</div>
    <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
  `;

  container.appendChild(toast);

  // 3ÁßíÂêéËá™Âä®ÁßªÈô§
  setTimeout(() => {
    if (toast.parentElement) {
      toast.remove();
    }
  }, 3000);
}

// Ëé∑ÂèñÂàÜÁ±ªÂàóË°®
async function fetchCategories() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/admin/categories', {
      headers: headers
    });
    const result = await response.json();

    if (result.success && result.data) {
      return result.data;
    } else {
      console.error('Ëé∑ÂèñÂàÜÁ±ªÂàóË°®Â§±Ë¥•:', result.message);
      return [];
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÂàÜÁ±ªÂàóË°®Â§±Ë¥•:', error);
    return [];
  }
}

// Ëé∑ÂèñÊ†áÁ≠æÂàóË°®
async function fetchTags(categoryID = null) {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    let url = '/api/admin/tags';
    if (categoryID !== null && categoryID !== '') {
      url += `?category_id=${categoryID}`;
    }

    const response = await fetch(url, {
      headers: headers
    });
    const result = await response.json();

    if (result.success && result.data) {
      return result.data;
    } else {
      console.error('Ëé∑ÂèñÊ†áÁ≠æÂàóË°®Â§±Ë¥•:', result.message);
      return [];
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÊ†áÁ≠æÂàóË°®Â§±Ë¥•:', error);
    return [];
  }
}

// Êõ¥Êñ∞ÂàÜÁ±ªË°®Ê†º
function updateCategoriesTable(categories) {
  const tbody = document.querySelector('#categories tbody');
  if (!tbody) return;

  tbody.innerHTML = '';

  if (categories.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
          <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
          <div>ÊöÇÊó†ÂàÜÁ±ª</div>
        </td>
      </tr>
    `;
    return;
  }

  categories.forEach(category => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>
        <input type="checkbox" class="category-checkbox" data-id="${category.id}">
      </td>
      <td>${category.sort_order}</td>
      <td>${category.icon || ''}</td>
      <td>${category.name}</td>
      <td>${category.description || '-'}</td>
      <td><span style="color: ${category.is_enabled ? '#00b894' : '#e74c3c'};">${category.is_enabled ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}</span></td>
      <td class="action-buttons">
        <button class="btn btn-sm btn-edit" data-action="edit-category" data-id="${category.id}">ÁºñËæë</button>
        <button class="btn btn-sm btn-delete" data-action="delete-category" data-id="${category.id}">Âà†Èô§</button>
      </td>
    `;
    tbody.appendChild(row);
  });

  // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂
  bindActionButtons();
  bindCategoryCheckboxes();
}

// Êõ¥Êñ∞Ê†áÁ≠æË°®Ê†º
function updateTagsTable(tags) {
  const tbody = document.querySelector('#tags tbody');
  if (!tbody) return;

  tbody.innerHTML = '';

  if (tags.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
          <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
          <div>ÊöÇÊó†Ê†áÁ≠æ</div>
        </td>
      </tr>
    `;
    return;
  }

  tags.forEach(tag => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>
        <input type="checkbox" class="tag-checkbox" data-id="${tag.id}">
      </td>
      <td>${tag.sort_order}</td>
      <td><span style="display: inline-block; width: 20px; height: 20px; background-color: ${tag.color}; border-radius: 4px;"></span></td>
      <td>${tag.name}</td>
      <td>${tag.description || '-'}</td>
      <td>${tag.category_id === 0 ? 'Êó†ÂàÜÁ±ª' : tag.category_id}</td>
      <td><span style="color: ${tag.is_enabled ? '#00b894' : '#e74c3c'};">${tag.is_enabled ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}</span></td>
      <td class="action-buttons">
        <button class="btn btn-sm btn-edit" data-action="edit-tag" data-id="${tag.id}">ÁºñËæë</button>
        <button class="btn btn-sm btn-delete" data-action="delete-tag" data-id="${tag.id}">Âà†Èô§</button>
      </td>
    `;
    tbody.appendChild(row);
  });

  // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂
  bindActionButtons();
  bindTagCheckboxes();
}

// Âä†ËΩΩÂàÜÁ±ªÂíåÊ†áÁ≠æÊï∞ÊçÆ
async function loadCategoriesAndTags() {
  // Âä†ËΩΩÂàÜÁ±ªÊï∞ÊçÆ
  const categories = await fetchCategories();
  updateCategoriesTable(categories);

  // Â°´ÂÖÖÂàÜÁ±ªÁ≠õÈÄâ‰∏ãÊãâÊ°Ü
  const tagCategoryFilter = document.getElementById('tagCategoryFilter');
  if (tagCategoryFilter) {
    tagCategoryFilter.innerHTML = '<option value="">ÂÖ®ÈÉ®Ê†áÁ≠æ</option>';
    categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category.id;
      option.textContent = category.name;
      tagCategoryFilter.appendChild(option);
    });
  }

  // Â°´ÂÖÖÊ†áÁ≠æÂàÜÁ±ª‰∏ãÊãâÊ°Ü
  const tagCategorySelect = document.getElementById('tagCategory');
  if (tagCategorySelect) {
    tagCategorySelect.innerHTML = '<option value="0">Êó†ÂàÜÁ±ª</option>';
    categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category.id;
      option.textContent = category.name;
      tagCategorySelect.appendChild(option);
    });
  }

  // Âä†ËΩΩÊ†áÁ≠æÊï∞ÊçÆ
  const tags = await fetchTags();
  updateTagsTable(tags);
}

// Â°´ÂÖÖÂàÜÁ±ª‰∏ãÊãâÊ°Ü
async function populateCategorySelect(selectId, selectedValue = '') {
  const select = document.getElementById(selectId);
  if (!select) return;

  // Ëé∑ÂèñÂàÜÁ±ªÂàóË°®
  const categories = await fetchCategories();

  // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
  select.innerHTML = '';

  // Ê∑ªÂä†ÈªòËÆ§ÈÄâÈ°π
  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = 'Êú™ÂàÜÁ±ª';
  if (selectedValue === '' || selectedValue === 'Êú™ÂàÜÁ±ª') {
    defaultOption.selected = true;
  }
  select.appendChild(defaultOption);

  if (categories.length > 0) {
    // Ê∑ªÂä†ÂàÜÁ±ªÈÄâÈ°π
    categories.forEach(category => {
      const option = document.createElement('option');
      // ‰ΩøÁî®ÂàÜÁ±ªÂêçÁß∞‰Ωú‰∏∫ÂÄº
      option.value = category.name;
      option.textContent = category.name;
      // Â¶ÇÊûúÊúâÂõæÊ†áÔºåÂú®ÊñáÊú¨ÂâçÊ∑ªÂä†ÂõæÊ†á
      if (category.icon) {
        option.textContent = `${category.icon} ${category.name}`;
      }
      if (category.name === selectedValue) {
        option.selected = true;
      }
      select.appendChild(option);
    });
  }
}

// Ëé∑ÂèñÊ†áÁ≠æÂàóË°®
async function fetchTags() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/admin/tags', {
      headers: headers
    });
    const result = await response.json();

    if (result.success && result.data) {
      return result.data;
    }
    return [];
  } catch (error) {
    console.error('Ëé∑ÂèñÊ†áÁ≠æÂàóË°®Â§±Ë¥•:', error);
    return [];
  }
}

// Â°´ÂÖÖÊ†áÁ≠æÈÄâÊã©Âô®
async function populateTagSelector(selectedTags = []) {
  const selector = document.getElementById('editTagSelector');
  if (!selector) return;

  // Ëé∑ÂèñÊ†áÁ≠æÂàóË°®
  const tags = await fetchTags();

  // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
  selector.innerHTML = '';

  if (tags.length === 0) {
    selector.innerHTML = '<div style="color: #999; font-size: 0.9em;">ÊöÇÊó†Ê†áÁ≠æ</div>';
    return;
  }

  // Ê∑ªÂä†Ê†áÁ≠æÈÄâÈ°π
  tags.forEach(tag => {
    if (!tag.is_enabled) return; // Âè™ÊòæÁ§∫ÂêØÁî®ÁöÑÊ†áÁ≠æ

    const tagOption = document.createElement('div');
    tagOption.className = 'tag-option';
    tagOption.dataset.tagId = tag.id;
    tagOption.dataset.tagName = tag.name;
    tagOption.innerHTML = `
      <span style="display: inline-block; width: 12px; height: 12px; background-color: ${tag.color}; border-radius: 2px; margin-right: 6px;"></span>
      ${tag.name}
    `;

    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÈÄâ‰∏≠
    if (selectedTags.includes(tag.name)) {
      tagOption.classList.add('selected');
    }

    // ÁÇπÂáªÂàáÊç¢ÈÄâ‰∏≠Áä∂ÊÄÅ
    tagOption.addEventListener('click', function() {
      this.classList.toggle('selected');
      updateSelectedTags();
    });

    selector.appendChild(tagOption);
  });

  // ÂàùÂßãÂåñÈÄâ‰∏≠ÁöÑÊ†áÁ≠æ - Á°Æ‰øù‰ΩøÁî®‰º†ÂÖ•ÁöÑ selectedTags
  const tagsInput = document.getElementById('editTags');
  if (tagsInput) {
    tagsInput.value = JSON.stringify(selectedTags);
  }
}

// Êõ¥Êñ∞ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æ
function updateSelectedTags() {
  const selectedTags = [];
  document.querySelectorAll('#editTagSelector .tag-option.selected').forEach(option => {
    selectedTags.push(option.dataset.tagName);
  });

  // Êõ¥Êñ∞ÈöêËóèÁöÑËæìÂÖ•Ê°Ü
  const tagsInput = document.getElementById('editTags');
  if (tagsInput) {
    tagsInput.value = JSON.stringify(selectedTags);
  }
}

// Â°´ÂÖÖÊñ∞Âª∫ÊñáÁ´†ÁöÑÊ†áÁ≠æÈÄâÊã©Âô®
async function populateTagSelectorForNewArticle() {
  const selector = document.getElementById('articleTagSelector');
  if (!selector) return;

  // Ëé∑ÂèñÊ†áÁ≠æÂàóË°®
  const tags = await fetchTags();

  // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
  selector.innerHTML = '';

  if (tags.length === 0) {
    selector.innerHTML = '<div style="color: #999; font-size: 0.9em;">ÊöÇÊó†Ê†áÁ≠æ</div>';
    return;
  }

  // Ê∑ªÂä†Ê†áÁ≠æÈÄâÈ°π
  tags.forEach(tag => {
    if (!tag.is_enabled) return; // Âè™ÊòæÁ§∫ÂêØÁî®ÁöÑÊ†áÁ≠æ

    const tagOption = document.createElement('div');
    tagOption.className = 'tag-option';
    tagOption.dataset.tagId = tag.id;
    tagOption.dataset.tagName = tag.name;
    tagOption.innerHTML = `
      <span style="display: inline-block; width: 12px; height: 12px; background-color: ${tag.color}; border-radius: 2px; margin-right: 6px;"></span>
      ${tag.name}
    `;

    // ÁÇπÂáªÂàáÊç¢ÈÄâ‰∏≠Áä∂ÊÄÅ
    tagOption.addEventListener('click', function() {
      this.classList.toggle('selected');
      updateSelectedTagsForNewArticle();
    });

    selector.appendChild(tagOption);
  });

  // ÂàùÂßãÂåñÈÄâ‰∏≠ÁöÑÊ†áÁ≠æ
  updateSelectedTagsForNewArticle();
}

// Êõ¥Êñ∞Âª∫ÊñáÁ´†ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æ
function updateSelectedTagsForNewArticle() {
  const selectedTags = [];
  document.querySelectorAll('#articleTagSelector .tag-option.selected').forEach(option => {
    selectedTags.push(option.dataset.tagName);
  });

  // Êõ¥Êñ∞ÈöêËóèÁöÑËæìÂÖ•Ê°Ü
  const tagsInput = document.getElementById('articleTags');
  if (tagsInput) {
    tagsInput.value = JSON.stringify(selectedTags);
  }
}

// Â°´ÂÖÖ‰∏ä‰º†ÊñáÁ´†Ê®°ÊÄÅÊ°ÜÁöÑÊ†áÁ≠æÈÄâÊã©Âô®
async function populateTagSelectorForUpload() {
  const selector = document.getElementById('uploadTagSelector');
  if (!selector) return;

  // Ëé∑ÂèñÊ†áÁ≠æÂàóË°®
  const tags = await fetchTags();

  // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
  selector.innerHTML = '';

  if (tags.length === 0) {
    selector.innerHTML = '<div style="color: #999; font-size: 0.9em;">ÊöÇÊó†Ê†áÁ≠æ</div>';
    return;
  }

  // Ê∑ªÂä†Ê†áÁ≠æÈÄâÈ°π
  tags.forEach(tag => {
    if (!tag.is_enabled) return; // Âè™ÊòæÁ§∫ÂêØÁî®ÁöÑÊ†áÁ≠æ

    const tagOption = document.createElement('div');
    tagOption.className = 'tag-option';
    tagOption.dataset.tagId = tag.id;
    tagOption.dataset.tagName = tag.name;
    tagOption.innerHTML = `
      <span style="display: inline-block; width: 12px; height: 12px; background-color: ${tag.color}; border-radius: 2px; margin-right: 6px;"></span>
      ${tag.name}
    `;

    // ÁÇπÂáªÂàáÊç¢ÈÄâ‰∏≠Áä∂ÊÄÅ
    tagOption.addEventListener('click', function() {
      this.classList.toggle('selected');
    });

    selector.appendChild(tagOption);
  });
}

// Â°´ÂÖÖ‰∏ä‰º†ÊñáÁ´†Ê®°ÊÄÅÊ°ÜÁöÑÂàÜÁ±ªÈÄâÊã©Âô®
async function populateCategorySelectorForUpload() {
  const selector = document.getElementById('uploadCategorySelector');
  if (!selector) return;

  // Ëé∑ÂèñÂàÜÁ±ªÂàóË°®
  const categories = await fetchCategories();

  // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
  selector.innerHTML = '';

  if (categories.length === 0) {
    selector.innerHTML = '<div style="color: #999; font-size: 0.9em;">ÊöÇÊó†ÂàÜÁ±ª</div>';
    return;
  }

  // Ê∑ªÂä†ÂàÜÁ±ªÈÄâÈ°π
  categories.forEach(category => {
    if (!category.is_enabled) return; // Âè™ÊòæÁ§∫ÂêØÁî®ÁöÑÂàÜÁ±ª

    const categoryOption = document.createElement('div');
    categoryOption.className = 'category-option';
    categoryOption.dataset.categoryId = category.id;
    categoryOption.dataset.categoryName = category.name;
    categoryOption.innerHTML = `
      <span style="display: inline-block; width: 12px; height: 12px; background-color: #007bff; border-radius: 2px; margin-right: 6px;"></span>
      ${category.name}
    `;

    // ÁÇπÂáªÂàáÊç¢ÈÄâ‰∏≠Áä∂ÊÄÅÔºàÂàÜÁ±ªÊòØÂçïÈÄâÁöÑÔºå‰ΩÜÂèØ‰ª•ÂèñÊ∂àÈÄâ‰∏≠Ôºâ
    categoryOption.addEventListener('click', function() {
      // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂ∑≤ÈÄâ‰∏≠ÁöÑÂàÜÁ±ªÔºåÂèñÊ∂àÈÄâ‰∏≠
      if (this.classList.contains('selected')) {
        this.classList.remove('selected');
        return;
      }

      // Âê¶ÂàôÔºåÁßªÈô§ÂÖ∂‰ªñÂàÜÁ±ªÁöÑÈÄâ‰∏≠Áä∂ÊÄÅÔºåÈÄâ‰∏≠ÂΩìÂâçÂàÜÁ±ª
      selector.querySelectorAll('.category-option').forEach(cat => {
        cat.classList.remove('selected');
      });
      this.classList.add('selected');
    });

    selector.appendChild(categoryOption);
  });
}

// Â°´ÂÖÖÊñ∞Âª∫ÊñáÁ´†Ê®°ÊÄÅÊ°ÜÁöÑÂàÜÁ±ªÈÄâÊã©Âô®
async function populateCategorySelectorForNewArticle() {
  const selector = document.getElementById('articleCategory');
  if (!selector) return;

  // Ëé∑ÂèñÂàÜÁ±ªÂàóË°®
  const categories = await fetchCategories();

  // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
  selector.innerHTML = '';

  if (categories.length === 0) {
    const option = document.createElement('option');
    option.value = '';
    option.textContent = 'ÊöÇÊó†ÂàÜÁ±ª';
    selector.appendChild(option);
    return;
  }

  // Ê∑ªÂä†ÂàÜÁ±ªÈÄâÈ°π
  categories.forEach(category => {
    const option = document.createElement('option');
    option.value = category.name;
    option.textContent = category.name;
    selector.appendChild(option);
  });
}

// ‰ªéÂêéÁ´ØAPIËé∑ÂèñÊï∞ÊçÆ
async function fetchAdminData(page = 1, limit = 10, userPage = 1, userLimit = 10, commentsPage = 1, commentsLimit = 10) {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    // Ëé∑ÂèñÊñáÁ´†Êï∞ÊçÆÔºàÂ∏¶ÂàÜÈ°µÔºâ
    const passagesResponse = await fetch(`/api/admin/passages?page=${page}&limit=${limit}`, {
      headers: headers
    });
    const passagesResult = await passagesResponse.json();

    if (passagesResult.success && passagesResult.data) {
      if (passagesResult.data.length > 0) {
        updateArticlesTable(passagesResult.data);
        const totalArticles = passagesResult.pagination?.total || passagesResult.data.length;
        updateStatCard('totalArticles', totalArticles);
        // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØ
        updatePagination(passagesResult.pagination);
      } else {
        showEmptyState('articlesTableBody', 'ÊöÇÊó†ÊñáÁ´†');
        updateStatCard('totalArticles', 0);
        // ÈöêËóèÂàÜÈ°µ
        hidePagination();
      }
    } else {
      showEmptyState('articlesTableBody', 'ÊöÇÊó†ÊñáÁ´†');
      updateStatCard('totalArticles', 0);
      hidePagination();
    }

    // Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆÔºàÂ∏¶ÂàÜÈ°µÔºâ
    const usersResponse = await fetch(`/api/admin/users?page=${userPage}&limit=${userLimit}`, {
      headers: headers
    });
    const usersResult = await usersResponse.json();

    if (usersResult.success && usersResult.data) {
      if (usersResult.data.length > 0) {
        updateUsersTable(usersResult.data);
        const totalUsers = usersResult.pagination?.total || usersResult.data.length;
        updateStatCard('totalUsers', totalUsers);
        // Êõ¥Êñ∞Áî®Êà∑ÂàÜÈ°µ‰ø°ÊÅØ
        updateUserPagination(usersResult.pagination);
      } else {
        showEmptyState('usersTableBody', 'ÊöÇÊó†Áî®Êà∑', 7);
        updateStatCard('totalUsers', 0);
        // ÈöêËóèÁî®Êà∑ÂàÜÈ°µ
        hideUserPagination();
      }
    } else {
      showEmptyState('usersTableBody', 'ÊöÇÊó†Áî®Êà∑', 7);
      updateStatCard('totalUsers', 0);
      hideUserPagination();
    }

    // Ëé∑ÂèñËØÑËÆ∫Êï∞ÊçÆÔºàÂ∏¶ÂàÜÈ°µÔºâ
    const commentsResponse = await fetch(`/api/admin/comments?page=${commentsPage}&limit=${commentsLimit}`, {
      headers: headers
    });
    const commentsResult = await commentsResponse.json();

    if (commentsResult.success && commentsResult.data) {
      if (commentsResult.data.length > 0) {
        updateCommentsTable(commentsResult.data);
        // Êõ¥Êñ∞ËØÑËÆ∫ÂàÜÈ°µ‰ø°ÊÅØ
        updateCommentsPagination(commentsResult.pagination);
      } else {
        showEmptyState('commentsTableBody', 'ÊöÇÊó†ËØÑËÆ∫', 6);
        // ÈöêËóèËØÑËÆ∫ÂàÜÈ°µ
        hideCommentsPagination();
      }
    } else {
      showEmptyState('commentsTableBody', 'ÊöÇÊó†ËØÑËÆ∫', 6);
      hideCommentsPagination();
    }

    // Ëé∑ÂèñÁªüËÆ°Êï∞ÊçÆ
    const statsResponse = await fetch('/api/admin/stats', {
      headers: headers
    });
    const statsResult = await statsResponse.json();

    console.log('ÁªüËÆ°Êï∞ÊçÆÂìçÂ∫î:', statsResult);

    if (statsResult.success && statsResult.data) {
      updateStatCard('todayVisits', statsResult.data.today_visits || 0);

      // Êõ¥Êñ∞‰ªäÊó•ËÆøÈóÆÈáèÂØπÊØî‰ø°ÊÅØ
      const todayVisitsCard = document.querySelector('#todayVisits').closest('.stat-card');
      const changeElement = todayVisitsCard.querySelector('.stat-change');
      if (changeElement && statsResult.data.yesterday_visits !== undefined) {
        const yesterdayVisits = statsResult.data.yesterday_visits;
        const changePercent = statsResult.data.visits_change_percent || 0;
        const trend = statsResult.data.visits_trend || 'stable';

        if (trend === 'up') {
          changeElement.className = 'stat-change positive';
          changeElement.textContent = `ËæÉÊò®Êó• +${changePercent.toFixed(1)}%`;
        } else if (trend === 'down') {
          changeElement.className = 'stat-change negative';
          changeElement.textContent = `ËæÉÊò®Êó• ${changePercent.toFixed(1)}%`;
        } else {
          changeElement.className = 'stat-change neutral';
          changeElement.textContent = 'ËæÉÊò®Êó•ÊåÅÂπ≥';
        }
      }
    } else {
      console.error('Ëé∑ÂèñÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•:', statsResult);
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÁÆ°ÁêÜÊï∞ÊçÆÂ§±Ë¥•:', error);
  }
}

// ÊòæÁ§∫Á©∫Áä∂ÊÄÅ
function showEmptyState(tableId, message, colspan = 6) {
  const tbody = document.querySelector(`#${tableId}`);
  if (!tbody) return;

  const token = localStorage.getItem('auth_token');
  let displayMessage = message;

  if (!token) {
    displayMessage = 'ËØ∑ÂÖàÁôªÂΩï‰ª•Êü•ÁúãÊï∞ÊçÆ';
  }

  tbody.innerHTML = `
    <tr>
      <td colspan="${colspan}" style="text-align: center; padding: 40px; color: #999;">
        <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
        <div>${displayMessage}</div>
        ${!token ? '<div style="margin-top: 10px; font-size: 0.9em;"><a href="#loginModal" onclick="document.getElementById(\'loginBtn\').click(); return false;" style="color: #007bff; text-decoration: none;">ÁÇπÂáªÁôªÂΩï</a></div>' : ''}
      </td>
    </tr>
  `;
}

// ÂàÜÈ°µÁõ∏ÂÖ≥ÂèòÈáè
let currentPage = 1;
let currentLimit = 10;
let totalPages = 1;

// Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØ
function updatePagination(pagination) {
  if (!pagination) {
    hidePagination();
    return;
  }

  const page = parseInt(pagination.page) || 1;
  const limit = parseInt(pagination.limit) || 10;
  const total = parseInt(pagination.total) || 0;

  currentPage = page;
  currentLimit = limit;
  totalPages = Math.ceil(total / limit);

  // ÊòæÁ§∫ÂàÜÈ°µÂÆπÂô®
  const paginationContainer = document.getElementById('paginationContainer');
  if (paginationContainer) {
    paginationContainer.style.display = 'flex';
  }

  // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØÊñáÊú¨
  const start = (page - 1) * limit + 1;
  const end = Math.min(page * limit, total);
  const paginationInfo = document.getElementById('paginationInfo');
  if (paginationInfo) {
    paginationInfo.textContent = `ÊòæÁ§∫ ${start}-${end} Êù°ÔºåÂÖ± ${total} Êù°`;
  }

  // Êõ¥Êñ∞‰∏ä‰∏ÄÈ°µ/‰∏ã‰∏ÄÈ°µÊåâÈíÆÁä∂ÊÄÅ
  const prevBtn = document.getElementById('prevPageBtn');
  const nextBtn = document.getElementById('nextPageBtn');
  if (prevBtn) prevBtn.disabled = page <= 1;
  if (nextBtn) nextBtn.disabled = page >= totalPages;

  // ÁîüÊàêÈ°µÁ†ÅÊåâÈíÆ
  generatePageButtons(page, totalPages);
}

// ÈöêËóèÂàÜÈ°µ
function hidePagination() {
  const paginationContainer = document.getElementById('paginationContainer');
  if (paginationContainer) {
    paginationContainer.style.display = 'none';
  }
}

// ÁîüÊàêÈ°µÁ†ÅÊåâÈíÆ
function generatePageButtons(currentPage, totalPages) {
  const pagesContainer = document.getElementById('paginationPages');
  if (!pagesContainer) return;

  pagesContainer.innerHTML = '';

  // ËÆ°ÁÆóÊòæÁ§∫ÁöÑÈ°µÁ†ÅËåÉÂõ¥
  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, currentPage + 2);

  // Á°Æ‰øùËá≥Â∞ëÊòæÁ§∫5‰∏™È°µÁ†ÅÔºàÂ¶ÇÊûúÊúâË∂≥Â§üÂ§öÁöÑÈ°µÔºâ
  if (endPage - startPage < 4) {
    if (startPage === 1) {
      endPage = Math.min(totalPages, 5);
    } else if (endPage === totalPages) {
      startPage = Math.max(1, totalPages - 4);
    }
  }

  // Ê∑ªÂä†Á¨¨‰∏ÄÈ°µ
  if (startPage > 1) {
    addPageButton(1, pagesContainer);
    if (startPage > 2) {
      addEllipsis(pagesContainer);
    }
  }

  // Ê∑ªÂä†È°µÁ†ÅÊåâÈíÆ
  for (let i = startPage; i <= endPage; i++) {
    addPageButton(i, pagesContainer, i === currentPage);
  }

  // Ê∑ªÂä†ÊúÄÂêé‰∏ÄÈ°µ
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      addEllipsis(pagesContainer);
    }
    addPageButton(totalPages, pagesContainer);
  }
}

// Ê∑ªÂä†È°µÁ†ÅÊåâÈíÆ
function addPageButton(page, container, isActive = false) {
  const button = document.createElement('button');
  button.className = `pagination-page ${isActive ? 'active' : ''}`;
  button.textContent = page;
  button.addEventListener('click', () => {
    if (page !== currentPage) {
      fetchAdminData(page, currentLimit);
    }
  });
  container.appendChild(button);
}

// Ê∑ªÂä†ÁúÅÁï•Âè∑
function addEllipsis(container) {
  const ellipsis = document.createElement('span');
  ellipsis.className = 'pagination-page ellipsis';
  ellipsis.textContent = '...';
  container.appendChild(ellipsis);
}

// ÂàáÊç¢Âà∞‰∏ä‰∏ÄÈ°µ
function goToPrevPage() {
  if (currentPage > 1) {
    fetchAdminData(currentPage - 1, currentLimit);
  }
}

// ÂàáÊç¢Âà∞‰∏ã‰∏ÄÈ°µ
function goToNextPage() {
  if (currentPage < totalPages) {
    fetchAdminData(currentPage + 1, currentLimit);
  }
}

// Ëß£ÊûêJWT tokenËé∑ÂèñÁî®Êà∑Âêç
function getUsernameFromToken() {
  const token = localStorage.getItem('auth_token');
  if (!token) {
    return 'ÁÆ°ÁêÜÂëò';
  }

  try {
    // JWT tokenÁî±‰∏âÈÉ®ÂàÜÁªÑÊàêÔºöheader.payload.signature
    const parts = token.split('.');
    if (parts.length !== 3) {
      return 'ÁÆ°ÁêÜÂëò';
    }

    // Ëß£Á†ÅpayloadÈÉ®ÂàÜÔºàbase64urlÁºñÁ†ÅÔºâ
    const payload = parts[1];
    // Â∞Übase64urlËΩ¨Êç¢‰∏∫base64
    const base64 = payload.replace(/-/g, '+').replace(/_/g, '/');
    // Ëß£Á†Åbase64
    const decoded = atob(base64);
    // Ëß£ÊûêJSON
    const claims = JSON.parse(decoded);

    return claims.username || 'ÁÆ°ÁêÜÂëò';
  } catch (error) {
    console.error('Ëß£ÊûêtokenÂ§±Ë¥•:', error);
    return 'ÁÆ°ÁêÜÂëò';
  }
}

// Êõ¥Êñ∞Ê¨¢Ëøé‰ø°ÊÅØ
async function updateWelcomeMessage() {
  const username = getUsernameFromToken();
  const welcomeTitle = document.querySelector('.welcome-text h2');
  if (welcomeTitle) {
    welcomeTitle.textContent = `Ê¨¢ËøéÂõûÊù•Ôºå${username}`;
  }

  // Ëé∑ÂèñÂÖ®Â±ÄÂ§¥ÂÉèËÆæÁΩÆ
  let avatarPath = '/img/avatar.webp';
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/settings/template', {
      method: 'GET',
      headers: headers
    });

    if (response.ok) {
      const settings = await response.json();
      if (settings.global_avatar) {
        avatarPath = settings.global_avatar;
      }
    }
  } catch (error) {
    console.error('Ëé∑ÂèñÂÖ®Â±ÄÂ§¥ÂÉèËÆæÁΩÆÂ§±Ë¥•:', error);
  }

  // Êõ¥Êñ∞Â§¥ÂÉè‰∏∫ÂõæÁâá
  const avatar = document.querySelector('.admin-avatar');
  if (avatar) {
    avatar.innerHTML = `<img src="${avatarPath}" alt="${username}" class="avatar-image">`;
  }
}

// ÁªëÂÆöÂàÜÈ°µÊåâÈíÆ‰∫ã‰ª∂
document.addEventListener('DOMContentLoaded', function() {
  // Êõ¥Êñ∞Ê¨¢Ëøé‰ø°ÊÅØ
  updateWelcomeMessage();

  const prevBtn = document.getElementById('prevPageBtn');
  const nextBtn = document.getElementById('nextPageBtn');
  const refreshBtn = document.getElementById('refreshArticlesBtn');

  if (prevBtn) {
    prevBtn.addEventListener('click', goToPrevPage);
  }
  if (nextBtn) {
    nextBtn.addEventListener('click', goToNextPage);
  }
  if (refreshBtn) {
    refreshBtn.addEventListener('click', () => {
      fetchAdminData(currentPage, currentLimit);
    });
  }

  // Áî®Êà∑ÂàÜÈ°µÊåâÈíÆ
  const prevUserBtn = document.getElementById('prevUserPageBtn');
  const nextUserBtn = document.getElementById('nextUserPageBtn');

  if (prevUserBtn) {
    prevUserBtn.addEventListener('click', goToPrevUserPage);
  }
  if (nextUserBtn) {
    nextUserBtn.addEventListener('click', goToNextUserPage);
  }

  // ËØÑËÆ∫ÂàÜÈ°µÊåâÈíÆ
  const prevCommentsBtn = document.getElementById('prevCommentsPageBtn');
  const nextCommentsBtn = document.getElementById('nextCommentsPageBtn');
  const refreshCommentsBtn = document.getElementById('refreshCommentsBtn');

  if (prevCommentsBtn) {
    prevCommentsBtn.addEventListener('click', goToPrevCommentsPage);
  }
  if (nextCommentsBtn) {
    nextCommentsBtn.addEventListener('click', goToNextCommentsPage);
  }
  if (refreshCommentsBtn) {
    refreshCommentsBtn.addEventListener('click', () => {
      fetchAdminData(currentPage, currentLimit, currentUserPage, currentUserLimit, currentCommentsPage, currentCommentsLimit);
    });
  }

  // ÊâπÈáèÂà†Èô§ËØÑËÆ∫ÊåâÈíÆ
  const batchDeleteCommentsBtn = document.getElementById('batchDeleteCommentsBtn');
  if (batchDeleteCommentsBtn) {
    batchDeleteCommentsBtn.addEventListener('click', batchDeleteComments);
  }

  // ÂàÜÁ±ªÁÆ°ÁêÜÊåâÈíÆ
  const addCategoryBtn = document.getElementById('addCategoryBtn');
  const refreshCategoriesBtn = document.getElementById('refreshCategoriesBtn');

  if (addCategoryBtn) {
    addCategoryBtn.addEventListener('click', () => {
      document.getElementById('categoryModalTitle').textContent = 'Ê∑ªÂä†ÂàÜÁ±ª';
      document.getElementById('categoryForm').reset();
      delete document.getElementById('categoryForm').dataset.categoryId;
      openModal('categoryModal');
    });
  }
  if (refreshCategoriesBtn) {
    refreshCategoriesBtn.addEventListener('click', loadCategoriesAndTags);
  }

  // ÊâπÈáèÂà†Èô§ÂàÜÁ±ªÊåâÈíÆ
  const batchDeleteCategoriesBtn = document.getElementById('batchDeleteCategoriesBtn');
  if (batchDeleteCategoriesBtn) {
    batchDeleteCategoriesBtn.addEventListener('click', batchDeleteCategories);
  }

  // Ê†áÁ≠æÁÆ°ÁêÜÊåâÈíÆ
  const addTagBtn = document.getElementById('addTagBtn');
  const refreshTagsBtn = document.getElementById('refreshTagsBtn');
  const tagCategoryFilter = document.getElementById('tagCategoryFilter');

  if (addTagBtn) {
    addTagBtn.addEventListener('click', async () => {
      await loadCategoriesAndTags();
      document.getElementById('tagModalTitle').textContent = 'Ê∑ªÂä†Ê†áÁ≠æ';
      document.getElementById('tagForm').reset();
      delete document.getElementById('tagForm').dataset.tagId;
      openModal('tagModal');
    });
  }
  if (refreshTagsBtn) {
    refreshTagsBtn.addEventListener('click', loadCategoriesAndTags);
  }

  // ÊâπÈáèÂà†Èô§Ê†áÁ≠æÊåâÈíÆ
  const batchDeleteTagsBtn = document.getElementById('batchDeleteTagsBtn');
  if (batchDeleteTagsBtn) {
    batchDeleteTagsBtn.addEventListener('click', batchDeleteTags);
  }

  if (tagCategoryFilter) {
    tagCategoryFilter.addEventListener('change', async function() {
      const categoryID = this.value;
      const tags = await fetchTags(categoryID);
      updateTagsTable(tags);
    });
  }
});

// Áî®Êà∑ÂàÜÈ°µÁõ∏ÂÖ≥ÂèòÈáè
let currentUserPage = 1;
let currentUserLimit = 10;
let totalUserPages = 1;

// Êõ¥Êñ∞Áî®Êà∑ÂàÜÈ°µ‰ø°ÊÅØ
function updateUserPagination(pagination) {
  if (!pagination) {
    hideUserPagination();
    return;
  }

  const page = parseInt(pagination.page) || 1;
  const limit = parseInt(pagination.limit) || 10;
  const total = parseInt(pagination.total) || 0;

  currentUserPage = page;
  currentUserLimit = limit;
  totalUserPages = Math.ceil(total / limit);

  // ÊòæÁ§∫ÂàÜÈ°µÂÆπÂô®
  const paginationContainer = document.getElementById('userPaginationContainer');
  if (paginationContainer) {
    paginationContainer.style.display = 'flex';
  }

  // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØÊñáÊú¨
  const start = (page - 1) * limit + 1;
  const end = Math.min(page * limit, total);
  const paginationInfo = document.getElementById('userPaginationInfo');
  if (paginationInfo) {
    paginationInfo.textContent = `ÊòæÁ§∫ ${start}-${end} Êù°ÔºåÂÖ± ${total} Êù°`;
  }

  // Êõ¥Êñ∞‰∏ä‰∏ÄÈ°µ/‰∏ã‰∏ÄÈ°µÊåâÈíÆÁä∂ÊÄÅ
  const prevBtn = document.getElementById('prevUserPageBtn');
  const nextBtn = document.getElementById('nextUserPageBtn');
  if (prevBtn) prevBtn.disabled = page <= 1;
  if (nextBtn) nextBtn.disabled = page >= totalUserPages;

  // ÁîüÊàêÈ°µÁ†ÅÊåâÈíÆ
  generateUserPageButtons(page, totalUserPages);
}

// ÈöêËóèÁî®Êà∑ÂàÜÈ°µ
function hideUserPagination() {
  const paginationContainer = document.getElementById('userPaginationContainer');
  if (paginationContainer) {
    paginationContainer.style.display = 'none';
  }
}

// ÁîüÊàêÁî®Êà∑È°µÁ†ÅÊåâÈíÆ
function generateUserPageButtons(currentPage, totalPages) {
  const pagesContainer = document.getElementById('userPaginationPages');
  if (!pagesContainer) return;

  pagesContainer.innerHTML = '';

  // ËÆ°ÁÆóÊòæÁ§∫ÁöÑÈ°µÁ†ÅËåÉÂõ¥
  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, currentPage + 2);

  // Á°Æ‰øùËá≥Â∞ëÊòæÁ§∫5‰∏™È°µÁ†ÅÔºàÂ¶ÇÊûúÊúâË∂≥Â§üÂ§öÁöÑÈ°µÔºâ
  if (endPage - startPage < 4) {
    if (startPage === 1) {
      endPage = Math.min(totalPages, 5);
    } else if (endPage === totalPages) {
      startPage = Math.max(1, totalPages - 4);
    }
  }

  // Ê∑ªÂä†Á¨¨‰∏ÄÈ°µ
  if (startPage > 1) {
    addUserPageButton(1, pagesContainer);
    if (startPage > 2) {
      addUserEllipsis(pagesContainer);
    }
  }

  // Ê∑ªÂä†È°µÁ†ÅÊåâÈíÆ
  for (let i = startPage; i <= endPage; i++) {
    addUserPageButton(i, pagesContainer, i === currentPage);
  }

  // Ê∑ªÂä†ÊúÄÂêé‰∏ÄÈ°µ
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      addUserEllipsis(pagesContainer);
    }
    addUserPageButton(totalPages, pagesContainer);
  }
}

// Ê∑ªÂä†Áî®Êà∑È°µÁ†ÅÊåâÈíÆ
function addUserPageButton(page, container, isActive = false) {
  const button = document.createElement('button');
  button.className = `pagination-page ${isActive ? 'active' : ''}`;
  button.textContent = page;
  button.addEventListener('click', () => {
    if (page !== currentUserPage) {
      fetchAdminData(currentPage, currentLimit, page, currentUserLimit);
    }
  });
  container.appendChild(button);
}

// Ê∑ªÂä†Áî®Êà∑ÁúÅÁï•Âè∑
function addUserEllipsis(container) {
  const ellipsis = document.createElement('span');
  ellipsis.className = 'pagination-page ellipsis';
  ellipsis.textContent = '...';
  container.appendChild(ellipsis);
}

// ÂàáÊç¢Âà∞Áî®Êà∑‰∏ä‰∏ÄÈ°µ
function goToPrevUserPage() {
  if (currentUserPage > 1) {
    fetchAdminData(currentPage, currentLimit, currentUserPage - 1, currentUserLimit);
  }
}

// ÂàáÊç¢Âà∞Áî®Êà∑‰∏ã‰∏ÄÈ°µ
function goToNextUserPage() {
  if (currentUserPage < totalUserPages) {
    fetchAdminData(currentPage, currentLimit, currentUserPage + 1, currentUserLimit);
  }
}

// ËØÑËÆ∫ÂàÜÈ°µÁõ∏ÂÖ≥ÂèòÈáè
let currentCommentsPage = 1;
let currentCommentsLimit = 10;
let totalCommentsPages = 1;

// Êõ¥Êñ∞ËØÑËÆ∫Ë°®Ê†º
function updateCommentsTable(comments) {
  const tbody = document.querySelector('#comments tbody');
  if (!tbody) return;

  tbody.innerHTML = '';

  comments.forEach(comment => {
    const row = document.createElement('tr');

    // ÁîüÊàê identicon Â§¥ÂÉè
    const avatarUrl = generateAdminIdenticon(comment.username || 'anonymous', 24);

    row.innerHTML = `
      <td>
        <input type="checkbox" class="comment-checkbox" data-id="${comment.id}">
      </td>
      <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${comment.content}</td>
      <td>${comment.passage_uuid}</td>
      <td>
        <div style="display: flex; align-items: center; gap: 8px;">
          <img src="${avatarUrl}" alt="${comment.username || 'ÂåøÂêçÁî®Êà∑'}" style="width: 24px; height: 24px; border-radius: 50%;"/>
          <span>${comment.username}</span>
        </div>
      </td>
      <td>${comment.created_at}</td>
      <td class="action-buttons">
        <button class="btn btn-sm btn-delete" data-action="delete-comment" data-id="${comment.id}">Âà†Èô§</button>
      </td>
    `;
    tbody.appendChild(row);
  });

  // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂
  bindActionButtons();
  bindCommentCheckboxes();
}

// ÁîüÊàêÁÆ°ÁêÜÂëòÈù¢ÊùøÁöÑ identicon Â§¥ÂÉè
function generateAdminIdenticon(username, size = 24) {
  const hash = simpleAdminHash(username);
  const hue = hash % 360;
  const saturation = 65 + (hash % 15);
  const lightness = 55 + (hash % 10);
  const bgColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
  const textColor = `hsl(${hue}, ${saturation}%, ${lightness - 25}%)`;
  
  const svgSize = 5;
  let svgContent = '';
  
  for (let y = 0; y < svgSize; y++) {
    for (let x = 0; x < Math.ceil(svgSize / 2); x++) {
      const index = y * svgSize + x;
      const bit = (hash >> index) & 1;
      
      if (bit) {
        svgContent += `<rect x="${x}" y="${y}" width="1" height="1" fill="${bgColor}"/>`;
        svgContent += `<rect x="${svgSize - 1 - x}" y="${y}" width="1" height="1" fill="${bgColor}"/>`;
      }
    }
  }
  
  const initial = username ? username.charAt(0).toUpperCase() : '?';
  
  const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${svgSize} ${svgSize}" width="${size}" height="${size}">
      <rect width="${svgSize}" height="${svgSize}" fill="#f0f0f0"/>
      ${svgContent}
      <text x="${svgSize / 2}" y="${svgSize / 2 + 0.35}" 
            text-anchor="middle" 
            font-size="${svgSize * 0.5}" 
            font-weight="bold" 
            fill="${textColor}"
            font-family="system-ui, -apple-system, sans-serif">${initial}</text>
    </svg>
  `;
  
  return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
}

// ÁÆÄÂçïÂìàÂ∏åÂáΩÊï∞ÔºàÁÆ°ÁêÜÂëòÈù¢ÊùøÔºâ
function simpleAdminHash(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
    return Math.abs(hash);
  }
  
  // ÁªëÂÆöËØÑËÆ∫Â§çÈÄâÊ°Ü‰∫ã‰ª∂
  function bindCommentCheckboxes() {
    const selectAllCheckbox = document.getElementById('selectAllComments');
    const commentCheckboxes = document.querySelectorAll('.comment-checkbox');
  
    // ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâ
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function() {
        commentCheckboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
          const row = checkbox.closest('tr');
          if (row) {
            if (this.checked) {
              row.classList.add('selected');
            } else {
              row.classList.remove('selected');
            }
          }
        });
        updateBatchDeleteButton();
      });
    }
  
    // Âçï‰∏™Â§çÈÄâÊ°Ü‰∫ã‰ª∂
    commentCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const row = this.closest('tr');
        if (row) {
          if (this.checked) {
            row.classList.add('selected');
          } else {
            row.classList.remove('selected');
          }
        }
        updateBatchDeleteButton();
        updateSelectAllCheckbox();
      });
    });
  }
  
  // Êõ¥Êñ∞ÊâπÈáèÂà†Èô§ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
  function updateBatchDeleteButton() {
    const selectedCount = document.querySelectorAll('.comment-checkbox:checked').length;
    const batchDeleteBtn = document.getElementById('batchDeleteCommentsBtn');
  
    if (batchDeleteBtn) {
      if (selectedCount > 0) {
        batchDeleteBtn.style.display = 'inline-block';
        batchDeleteBtn.textContent = `ÊâπÈáèÂà†Èô§ (${selectedCount})`;
      } else {
        batchDeleteBtn.style.display = 'none';
      }
    }
  }
  
  // Êõ¥Êñ∞ÂÖ®ÈÄâÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
  function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAllComments');
    const commentCheckboxes = document.querySelectorAll('.comment-checkbox');
  
    if (selectAllCheckbox && commentCheckboxes.length > 0) {
      const allChecked = Array.from(commentCheckboxes).every(checkbox => checkbox.checked);
      const someChecked = Array.from(commentCheckboxes).some(checkbox => checkbox.checked);
  
      selectAllCheckbox.checked = allChecked;
      selectAllCheckbox.indeterminate = someChecked && !allChecked;
    }
  }
  
  // Ê∏ÖÈô§ËØÑËÆ∫ÈÄâÊã©
  function clearCommentSelection() {
    const selectAllCheckbox = document.getElementById('selectAllComments');
    const commentCheckboxes = document.querySelectorAll('.comment-checkbox');
  
    if (selectAllCheckbox) {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = false;
    }
  
    commentCheckboxes.forEach(checkbox => {
      checkbox.checked = false;
      const row = checkbox.closest('tr');
      if (row) {
        row.classList.remove('selected');
      }
    });
  
    updateBatchDeleteButton();
  }
  
  // ÊâπÈáèÂà†Èô§ËØÑËÆ∫
  async function batchDeleteComments() {
    const selectedCheckboxes = document.querySelectorAll('.comment-checkbox:checked');
    const ids = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));

    if (ids.length === 0) {
      showToast('ËØ∑ÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑËØÑËÆ∫', 'warning');
      return;
    }

    // ‰ΩøÁî®Áªü‰∏ÄÁ°ÆËÆ§Ê®°ÊÄÅÊ°Ü
    currentAction = 'batch-delete-comments';
    currentItemId = ids.join(',');
    document.getElementById('confirmMessage').textContent = `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${ids.length} Êù°ËØÑËÆ∫ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`;
    openModal('confirmModal');
  }

  // ÁªëÂÆöÂàÜÁ±ªÂ§çÈÄâÊ°Ü‰∫ã‰ª∂
  function bindCategoryCheckboxes() {
    const selectAllCheckbox = document.getElementById('selectAllCategories');
    const categoryCheckboxes = document.querySelectorAll('.category-checkbox');

    // ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâ
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function() {
        categoryCheckboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
          const row = checkbox.closest('tr');
          if (row) {
            if (this.checked) {
              row.classList.add('selected');
            } else {
              row.classList.remove('selected');
            }
          }
        });
        updateBatchDeleteCategoriesButton();
      });
    }

    // Âçï‰∏™Â§çÈÄâÊ°Ü‰∫ã‰ª∂
    categoryCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const row = this.closest('tr');
        if (row) {
          if (this.checked) {
            row.classList.add('selected');
          } else {
            row.classList.remove('selected');
          }
        }
        updateBatchDeleteCategoriesButton();
        updateSelectAllCategoriesCheckbox();
      });
    });
  }

  // Êõ¥Êñ∞ÊâπÈáèÂà†Èô§ÂàÜÁ±ªÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
  function updateBatchDeleteCategoriesButton() {
    const selectedCount = document.querySelectorAll('.category-checkbox:checked').length;
    const batchDeleteBtn = document.getElementById('batchDeleteCategoriesBtn');

    if (batchDeleteBtn) {
      if (selectedCount > 0) {
        batchDeleteBtn.style.display = 'inline-block';
        batchDeleteBtn.textContent = `ÊâπÈáèÂà†Èô§ (${selectedCount})`;
      } else {
        batchDeleteBtn.style.display = 'none';
      }
    }
  }

  // Êõ¥Êñ∞ÂÖ®ÈÄâÂàÜÁ±ªÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
  function updateSelectAllCategoriesCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAllCategories');
    const categoryCheckboxes = document.querySelectorAll('.category-checkbox');

    if (selectAllCheckbox && categoryCheckboxes.length > 0) {
      const allChecked = Array.from(categoryCheckboxes).every(checkbox => checkbox.checked);
      const someChecked = Array.from(categoryCheckboxes).some(checkbox => checkbox.checked);

      selectAllCheckbox.checked = allChecked;
      selectAllCheckbox.indeterminate = someChecked && !allChecked;
    }
  }

  // Ê∏ÖÈô§ÂàÜÁ±ªÈÄâÊã©
  function clearCategorySelection() {
    const selectAllCheckbox = document.getElementById('selectAllCategories');
    const categoryCheckboxes = document.querySelectorAll('.category-checkbox');

    if (selectAllCheckbox) {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = false;
    }

    categoryCheckboxes.forEach(checkbox => {
      checkbox.checked = false;
      const row = checkbox.closest('tr');
      if (row) {
        row.classList.remove('selected');
      }
    });

    updateBatchDeleteCategoriesButton();
  }

  // ÊâπÈáèÂà†Èô§ÂàÜÁ±ª
  async function batchDeleteCategories() {
    const selectedCheckboxes = document.querySelectorAll('.category-checkbox:checked');
    const ids = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));

    if (ids.length === 0) {
      showToast('ËØ∑ÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÂàÜÁ±ª', 'warning');
      return;
    }

    // ‰ΩøÁî®Áªü‰∏ÄÁ°ÆËÆ§Ê®°ÊÄÅÊ°Ü
    currentAction = 'batch-delete-categories';
    currentItemId = ids.join(',');
    document.getElementById('confirmMessage').textContent = `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${ids.length} ‰∏™ÂàÜÁ±ªÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`;
    openModal('confirmModal');
  }

  // ÁªëÂÆöÊ†áÁ≠æÂ§çÈÄâÊ°Ü‰∫ã‰ª∂
  function bindTagCheckboxes() {
    const selectAllCheckbox = document.getElementById('selectAllTags');
    const tagCheckboxes = document.querySelectorAll('.tag-checkbox');

    // ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâ
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function() {
        tagCheckboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
          const row = checkbox.closest('tr');
          if (row) {
            if (this.checked) {
              row.classList.add('selected');
            } else {
              row.classList.remove('selected');
            }
          }
        });
        updateBatchDeleteTagsButton();
      });
    }

    // Âçï‰∏™Â§çÈÄâÊ°Ü‰∫ã‰ª∂
    tagCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const row = this.closest('tr');
        if (row) {
          if (this.checked) {
            row.classList.add('selected');
          } else {
            row.classList.remove('selected');
          }
        }
        updateBatchDeleteTagsButton();
        updateSelectAllTagsCheckbox();
      });
    });
  }

  // Êõ¥Êñ∞ÊâπÈáèÂà†Èô§Ê†áÁ≠æÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
  function updateBatchDeleteTagsButton() {
    const selectedCount = document.querySelectorAll('.tag-checkbox:checked').length;
    const batchDeleteBtn = document.getElementById('batchDeleteTagsBtn');

    if (batchDeleteBtn) {
      if (selectedCount > 0) {
        batchDeleteBtn.style.display = 'inline-block';
        batchDeleteBtn.textContent = `ÊâπÈáèÂà†Èô§ (${selectedCount})`;
      } else {
        batchDeleteBtn.style.display = 'none';
      }
    }
  }

  // Êõ¥Êñ∞ÂÖ®ÈÄâÊ†áÁ≠æÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
  function updateSelectAllTagsCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAllTags');
    const tagCheckboxes = document.querySelectorAll('.tag-checkbox');

    if (selectAllCheckbox && tagCheckboxes.length > 0) {
      const allChecked = Array.from(tagCheckboxes).every(checkbox => checkbox.checked);
      const someChecked = Array.from(tagCheckboxes).some(checkbox => checkbox.checked);

      selectAllCheckbox.checked = allChecked;
      selectAllCheckbox.indeterminate = someChecked && !allChecked;
    }
  }

  // Ê∏ÖÈô§Ê†áÁ≠æÈÄâÊã©
  function clearTagSelection() {
    const selectAllCheckbox = document.getElementById('selectAllTags');
    const tagCheckboxes = document.querySelectorAll('.tag-checkbox');

    if (selectAllCheckbox) {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = false;
    }

    tagCheckboxes.forEach(checkbox => {
      checkbox.checked = false;
      const row = checkbox.closest('tr');
      if (row) {
        row.classList.remove('selected');
      }
    });

    updateBatchDeleteTagsButton();
  }

  // ÊâπÈáèÂà†Èô§Ê†áÁ≠æ
  async function batchDeleteTags() {
    const selectedCheckboxes = document.querySelectorAll('.tag-checkbox:checked');
    const ids = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));

    if (ids.length === 0) {
      showToast('ËØ∑ÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÊ†áÁ≠æ', 'warning');
      return;
    }

    // ‰ΩøÁî®Áªü‰∏ÄÁ°ÆËÆ§Ê®°ÊÄÅÊ°Ü
    currentAction = 'batch-delete-tags';
    currentItemId = ids.join(',');
    document.getElementById('confirmMessage').textContent = `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${ids.length} ‰∏™Ê†áÁ≠æÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`;
    openModal('confirmModal');
  }

// Êõ¥Êñ∞ËØÑËÆ∫ÂàÜÈ°µ‰ø°ÊÅØ
function updateCommentsPagination(pagination) {
  if (!pagination) {
    hideCommentsPagination();
    return;
  }

  const page = parseInt(pagination.page) || 1;
  const limit = parseInt(pagination.limit) || 10;
  const total = parseInt(pagination.total) || 0;

  currentCommentsPage = page;
  currentCommentsLimit = limit;
  totalCommentsPages = Math.ceil(total / limit);

  // ÊòæÁ§∫ÂàÜÈ°µÂÆπÂô®
  const paginationContainer = document.getElementById('commentsPaginationContainer');
  if (paginationContainer) {
    paginationContainer.style.display = 'flex';
  }

  // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØÊñáÊú¨
  const start = (page - 1) * limit + 1;
  const end = Math.min(page * limit, total);
  const paginationInfo = document.getElementById('commentsPaginationInfo');
  if (paginationInfo) {
    paginationInfo.textContent = `ÊòæÁ§∫ ${start}-${end} Êù°ÔºåÂÖ± ${total} Êù°`;
  }

  // Êõ¥Êñ∞‰∏ä‰∏ÄÈ°µ/‰∏ã‰∏ÄÈ°µÊåâÈíÆÁä∂ÊÄÅ
  const prevBtn = document.getElementById('prevCommentsPageBtn');
  const nextBtn = document.getElementById('nextCommentsPageBtn');
  if (prevBtn) prevBtn.disabled = page <= 1;
  if (nextBtn) nextBtn.disabled = page >= totalCommentsPages;

  // ÁîüÊàêÈ°µÁ†ÅÊåâÈíÆ
  generateCommentsPageButtons(page, totalCommentsPages);
}

// ÈöêËóèËØÑËÆ∫ÂàÜÈ°µ
function hideCommentsPagination() {
  const paginationContainer = document.getElementById('commentsPaginationContainer');
  if (paginationContainer) {
    paginationContainer.style.display = 'none';
  }
}

// ÁîüÊàêËØÑËÆ∫È°µÁ†ÅÊåâÈíÆ
function generateCommentsPageButtons(currentPage, totalPages) {
  const pagesContainer = document.getElementById('commentsPaginationPages');
  if (!pagesContainer) return;

  pagesContainer.innerHTML = '';

  // ËÆ°ÁÆóÊòæÁ§∫ÁöÑÈ°µÁ†ÅËåÉÂõ¥
  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, currentPage + 2);

  // Á°Æ‰øùËá≥Â∞ëÊòæÁ§∫5‰∏™È°µÁ†ÅÔºàÂ¶ÇÊûúÊúâË∂≥Â§üÂ§öÁöÑÈ°µÔºâ
  if (endPage - startPage < 4) {
    if (startPage === 1) {
      endPage = Math.min(totalPages, 5);
    } else if (endPage === totalPages) {
      startPage = Math.max(1, totalPages - 4);
    }
  }

  // Ê∑ªÂä†Á¨¨‰∏ÄÈ°µ
  if (startPage > 1) {
    addCommentsPageButton(1, pagesContainer);
    if (startPage > 2) {
      addCommentsEllipsis(pagesContainer);
    }
  }

  // Ê∑ªÂä†È°µÁ†ÅÊåâÈíÆ
  for (let i = startPage; i <= endPage; i++) {
    addCommentsPageButton(i, pagesContainer, i === currentPage);
  }

  // Ê∑ªÂä†ÊúÄÂêé‰∏ÄÈ°µ
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      addCommentsEllipsis(pagesContainer);
    }
    addCommentsPageButton(totalPages, pagesContainer);
  }
}

// Ê∑ªÂä†ËØÑËÆ∫È°µÁ†ÅÊåâÈíÆ
function addCommentsPageButton(page, container, isActive = false) {
  const button = document.createElement('button');
  button.className = `pagination-page ${isActive ? 'active' : ''}`;
  button.textContent = page;
  button.addEventListener('click', () => {
    if (page !== currentCommentsPage) {
      fetchAdminData(currentPage, currentLimit, currentUserPage, currentUserLimit, page, currentCommentsLimit);
    }
  });
  container.appendChild(button);
}

// Ê∑ªÂä†ËØÑËÆ∫ÁúÅÁï•Âè∑
function addCommentsEllipsis(container) {
  const ellipsis = document.createElement('span');
  ellipsis.className = 'pagination-page ellipsis';
  ellipsis.textContent = '...';
  container.appendChild(ellipsis);
}

// ÂàáÊç¢Âà∞ËØÑËÆ∫‰∏ä‰∏ÄÈ°µ
function goToPrevCommentsPage() {
  if (currentCommentsPage > 1) {
    fetchAdminData(currentPage, currentLimit, currentUserPage, currentUserLimit, currentCommentsPage - 1, currentCommentsLimit);
  }
}

// ÂàáÊç¢Âà∞ËØÑËÆ∫‰∏ã‰∏ÄÈ°µ
function goToNextCommentsPage() {
  if (currentCommentsPage < totalCommentsPages) {
    fetchAdminData(currentPage, currentLimit, currentUserPage, currentUserLimit, currentCommentsPage + 1, currentCommentsLimit);
  }
}

// Êõ¥Êñ∞ÊñáÁ´†Ë°®Ê†º
function updateArticlesTable(articles) {
  const tbody = document.querySelector('#articles tbody');
  if (!tbody) return;

  tbody.innerHTML = '';

  articles.forEach(article => {
    const row = document.createElement('tr');
    row.dataset.articleId = article.id;

    // ÊûÑÂª∫Áä∂ÊÄÅÊ†áÁ≠æ
    let statusBadge = `<span class="status ${article.status || 'published'}">${getStatusText(article.status || 'published')}</span>`;

    // Â¶ÇÊûúÊòØÂÆöÊó∂ÂèëÂ∏ÉÔºåÊ∑ªÂä†ÂÆöÊó∂Ê†áËØÜ
    if (article.is_scheduled) {
      statusBadge += ` <span class="status scheduled" title="ÂÆöÊó∂ÂèëÂ∏É">‚è∞ ${article.published_at ? formatDate(article.published_at) : 'Êú™ËÆæÁΩÆ'}</span>`;
    }

    // ÊûÑÂª∫ÂèØËßÅÊÄßÊ†áÁ≠æ
    const visibility = article.visibility || 'public';
    const visibilityText = visibility === 'public' ? 'ÂÖ¨ÂºÄ' : 'ÁßÅÂØÜ';
    const visibilityClass = visibility === 'public' ? 'visibility-public' : 'visibility-private';

    row.innerHTML = `
      <td>
        <input type="checkbox" class="article-checkbox" data-id="${article.id}">
      </td>
      <td>${article.title}</td>
      <td>ÁÆ°ÁêÜÂëò</td>
      <td>${formatDate(article.created_at) || '2024-01-01'}</td>
      <td>${statusBadge}</td>
      <td><span class="visibility ${visibilityClass}">${visibilityText}</span></td>
      <td class="action-buttons">
        <button class="btn btn-sm btn-view" data-action="view" data-id="${article.id}">Êü•Áúã</button>
        <button class="btn btn-sm btn-edit" data-action="edit" data-id="${article.id}">ÁºñËæë</button>
        <button class="btn btn-sm btn-upload" data-action="upload" data-id="${article.id}">‰∏ä‰º†ÈôÑ‰ª∂</button>
        <button class="btn btn-sm btn-delete" data-action="delete" data-id="${article.id}">Âà†Èô§</button>
      </td>
    `;

    // Ë°åÁÇπÂáªÈÄâ‰∏≠ÂäüËÉΩ
    row.addEventListener('click', (e) => {
      // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊìç‰ΩúÊåâÈíÆÊàñÂ§çÈÄâÊ°ÜÔºå‰∏çËß¶ÂèëË°åÈÄâ‰∏≠
      if (e.target.closest('.action-buttons') || e.target.classList.contains('article-checkbox')) {
        return;
      }
      const checkbox = row.querySelector('.article-checkbox');
      checkbox.checked = !checkbox.checked;
      row.classList.toggle('selected', checkbox.checked);
      updateBatchActionsBar();
    });

    // Â§çÈÄâÊ°ÜÂèòÂåñ‰∫ã‰ª∂
    const checkbox = row.querySelector('.article-checkbox');
    checkbox.addEventListener('change', (e) => {
      row.classList.toggle('selected', e.target.checked);
      updateBatchActionsBar();
    });

    tbody.appendChild(row);
  });

  // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂
  bindActionButtons();
  
  // ÁªëÂÆöÊâπÈáèÊìç‰Ωú‰∫ã‰ª∂
  bindBatchActionEvents();
}

// ÊâπÈáèÊìç‰ΩúÁõ∏ÂÖ≥ÂáΩÊï∞

// ÁªëÂÆöÊâπÈáèÊìç‰Ωú‰∫ã‰ª∂
function bindBatchActionEvents() {
  const selectAllCheckbox = document.getElementById('selectAllCheckbox');
  const batchDeleteBtn = document.getElementById('batchDeleteBtn');
  const clearSelectionBtn = document.getElementById('clearSelectionBtn');

  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', (e) => {
      const checkboxes = document.querySelectorAll('.article-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = e.target.checked;
        const row = checkbox.closest('tr');
        if (row) {
          row.classList.toggle('selected', e.target.checked);
        }
      });
      updateBatchActionsBar();
    });
  }

  if (batchDeleteBtn) {
    batchDeleteBtn.addEventListener('click', batchDeleteArticles);
  }

  if (clearSelectionBtn) {
    clearSelectionBtn.addEventListener('click', clearSelection);
  }
}

// Êõ¥Êñ∞ÊâπÈáèÊìç‰ΩúÊåâÈíÆÊ†è
function updateBatchActionsBar() {
  const selectedCheckboxes = document.querySelectorAll('.article-checkbox:checked');
  const batchActionsBar = document.getElementById('batchActionsBar');
  const selectedCount = document.getElementById('selectedCount');
  const selectAllCheckbox = document.getElementById('selectAllCheckbox');

  const count = selectedCheckboxes.length;

  if (count > 0) {
    batchActionsBar.style.display = 'flex';
    selectedCount.textContent = `Â∑≤ÈÄâÊã© ${count} ÁØáÊñáÁ´†`;
  } else {
    batchActionsBar.style.display = 'none';
  }

  // Êõ¥Êñ∞ÂÖ®ÈÄâÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
  if (selectAllCheckbox) {
    const allCheckboxes = document.querySelectorAll('.article-checkbox');
    if (allCheckboxes.length > 0 && count === allCheckboxes.length) {
      selectAllCheckbox.checked = true;
      selectAllCheckbox.indeterminate = false;
    } else if (count > 0) {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = true;
    } else {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = false;
    }
  }
}

// ÊâπÈáèÂà†Èô§ÊñáÁ´†
async function batchDeleteArticles() {
  const selectedCheckboxes = document.querySelectorAll('.article-checkbox:checked');
  const ids = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));

  if (ids.length === 0) {
    showToast('ËØ∑ÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÊñáÁ´†', 'warning');
    return;
  }

  // ‰ΩøÁî®Áªü‰∏ÄÁöÑÁ°ÆËÆ§Ê®°ÊÄÅÊ°Ü
  currentAction = 'batch-delete-articles';
  currentItemId = ids.join(',');
  document.getElementById('confirmMessage').textContent = `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${ids.length} ÁØáÊñáÁ´†ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`;
  openModal('confirmModal');
}

// Ê∏ÖÈô§ÈÄâÊã©
function clearSelection() {
  const checkboxes = document.querySelectorAll('.article-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = false;
    const row = checkbox.closest('tr');
    if (row) {
      row.classList.remove('selected');
    }
  });

  const selectAllCheckbox = document.getElementById('selectAllCheckbox');
  if (selectAllCheckbox) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
  }

  updateBatchActionsBar();
}

// Áî®Êà∑ÊâπÈáèÊìç‰ΩúÁõ∏ÂÖ≥ÂáΩÊï∞

// ÁªëÂÆöÁî®Êà∑ÊâπÈáèÊìç‰Ωú‰∫ã‰ª∂
function bindUserBatchActionEvents() {
  const selectAllCheckbox = document.getElementById('selectAllUsersCheckbox');
  const batchDeleteBtn = document.getElementById('batchDeleteUsersBtn');
  const clearSelectionBtn = document.getElementById('clearUserSelectionBtn');

  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', (e) => {
      const checkboxes = document.querySelectorAll('.user-checkbox:not(:disabled)');
      checkboxes.forEach(checkbox => {
        checkbox.checked = e.target.checked;
        const row = checkbox.closest('tr');
        if (row) {
          row.classList.toggle('selected', e.target.checked);
        }
      });
      updateUserBatchActionsBar();
    });
  }

  if (batchDeleteBtn) {
    batchDeleteBtn.addEventListener('click', batchDeleteUsers);
  }

  if (clearSelectionBtn) {
    clearSelectionBtn.addEventListener('click', clearUserSelection);
  }
}

// Êõ¥Êñ∞Áî®Êà∑ÊâπÈáèÊìç‰ΩúÊåâÈíÆÊ†è
function updateUserBatchActionsBar() {
  const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
  const batchActionsBar = document.getElementById('userBatchActionsBar');
  const selectedCount = document.getElementById('userSelectedCount');
  const selectAllCheckbox = document.getElementById('selectAllUsersCheckbox');

  const count = selectedCheckboxes.length;

  if (count > 0) {
    batchActionsBar.style.display = 'flex';
    selectedCount.textContent = `Â∑≤ÈÄâÊã© ${count} ‰∏™Áî®Êà∑`;
  } else {
    batchActionsBar.style.display = 'none';
  }

  // Êõ¥Êñ∞ÂÖ®ÈÄâÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
  if (selectAllCheckbox) {
    const allCheckboxes = document.querySelectorAll('.user-checkbox:not(:disabled)');
    if (allCheckboxes.length > 0 && count === allCheckboxes.length) {
      selectAllCheckbox.checked = true;
      selectAllCheckbox.indeterminate = false;
    } else if (count > 0) {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = true;
    } else {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = false;
    }
  }
}

// ÊâπÈáèÂà†Èô§Áî®Êà∑
async function batchDeleteUsers() {
  const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
  const ids = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));

  if (ids.length === 0) {
    showToast('ËØ∑ÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÁî®Êà∑', 'warning');
    return;
  }

  // ‰ΩøÁî®Áªü‰∏ÄÁ°ÆËÆ§Ê®°ÊÄÅÊ°Ü
  currentAction = 'batch-delete-users';
  currentItemId = ids.join(',');
  document.getElementById('confirmMessage').textContent = `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${ids.length} ‰∏™Áî®Êà∑ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`;
  openModal('confirmModal');
}

// Ê∏ÖÈô§Áî®Êà∑ÈÄâÊã©
function clearUserSelection() {
  const checkboxes = document.querySelectorAll('.user-checkbox');
  checkboxes.forEach(checkbox => {
    checkbox.checked = false;
    const row = checkbox.closest('tr');
    if (row) {
      row.classList.remove('selected');
    }
  });

  const selectAllCheckbox = document.getElementById('selectAllUsersCheckbox');
  if (selectAllCheckbox) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
  }

  updateUserBatchActionsBar();
}

// Ê†ºÂºèÂåñÊó•Êúü
function formatDate(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  });
}

// Êõ¥Êñ∞Áî®Êà∑Ë°®Ê†º
function updateUsersTable(users) {
  const tbody = document.querySelector('#users tbody');
  if (!tbody) return;

  tbody.innerHTML = '';

  users.forEach(user => {
    const row = document.createElement('tr');
    row.dataset.userId = user.id;

    const roleText = user.role === 'admin' ? 'ÁÆ°ÁêÜÂëò' : (user.role === 'editor' ? 'ÁºñËæë' : 'ÊôÆÈÄöÁî®Êà∑');
    const statusText = user.status === 'active' ? 'Ê≠£Â∏∏' : (user.status === 'restricted' ? 'ÂèóÈôê' : 'Á¶ÅÁî®');
    const statusColor = user.status === 'active' ? '#00b894' : (user.status === 'restricted' ? '#fdcb6e' : '#e74c3c');

    row.innerHTML = `
      <td>
        <input type="checkbox" class="user-checkbox" data-id="${user.id}" ${user.role === 'admin' ? 'disabled' : ''}>
      </td>
      <td>${user.username}</td>
      <td>${user.email}</td>
      <td>${user.created_at || '2024-01-01'}</td>
      <td>${roleText}</td>
      <td><span style="color:${statusColor};">${statusText}</span></td>
      <td class="action-buttons">
        <button class="btn btn-sm btn-view" data-action="view-user" data-id="${user.id}">ËØ¶ÊÉÖ</button>
        <button class="btn btn-sm btn-edit" data-action="edit-user" data-id="${user.id}">ÁºñËæë</button>
        ${user.role !== 'admin' ? `<button class="btn btn-sm btn-delete" data-action="delete-user" data-id="${user.id}">Âà†Èô§</button>` : ''}
      </td>
    `;

    // Ë°åÁÇπÂáªÈÄâ‰∏≠ÂäüËÉΩ
    row.addEventListener('click', (e) => {
      // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊìç‰ΩúÊåâÈíÆÊàñÂ§çÈÄâÊ°ÜÔºå‰∏çËß¶ÂèëË°åÈÄâ‰∏≠
      if (e.target.closest('.action-buttons') || e.target.classList.contains('user-checkbox')) {
        return;
      }
      const checkbox = row.querySelector('.user-checkbox');
      if (!checkbox.disabled) {
        checkbox.checked = !checkbox.checked;
        row.classList.toggle('selected', checkbox.checked);
        updateUserBatchActionsBar();
      }
    });

    // Â§çÈÄâÊ°ÜÂèòÂåñ‰∫ã‰ª∂
    const checkbox = row.querySelector('.user-checkbox');
    checkbox.addEventListener('change', (e) => {
      row.classList.toggle('selected', e.target.checked);
      updateUserBatchActionsBar();
    });

    tbody.appendChild(row);
  });

  // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂
  bindActionButtons();
  
  // ÁªëÂÆöÁî®Êà∑ÊâπÈáèÊìç‰Ωú‰∫ã‰ª∂
  bindUserBatchActionEvents();
}

// Êõ¥Êñ∞ÁªüËÆ°Âç°Áâá
function updateStatCard(id, value) {
  const element = document.getElementById(id);
  if (element) {
    element.textContent = value;
  }
}

// Ëé∑ÂèñËÆ§ËØÅÂ§¥ÔºàÂÖ®Â±ÄÂáΩÊï∞Ôºâ
function getAuthHeaders() {
  const token = localStorage.getItem('auth_token');
  return token ? { 'Authorization': `Bearer ${token}` } : {};
}

// ÁªüËÆ°ÂàÜÊûêÁõ∏ÂÖ≥ÂáΩÊï∞
let viewTrendChart = null;

// Âä†ËΩΩÁÉ≠Èó®ÊñáÁ´†
async function loadMostViewedArticles() {
  const limit = document.getElementById('mostViewedLimit')?.value || 10;
  const tbody = document.getElementById('mostViewedTableBody');
  
  if (!tbody) return;
  
  tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Âä†ËΩΩ‰∏≠...</td></tr>';
  
  try {
    const response = await fetch(`/api/admin/analytics?action=most-viewed&limit=${limit}`, {
      headers: getAuthHeaders()
    });
    const result = await response.json();
    
    if (result.success && result.data) {
      if (result.data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">ÊöÇÊó†Êï∞ÊçÆ</td></tr>';
        return;
      }
      
      tbody.innerHTML = result.data.map((article, index) => `
        <tr>
          <td>${index + 1}</td>
          <td>${article.title}</td>
          <td>${article.author}</td>
          <td>${article.view_count}</td>
        </tr>
      `).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Âä†ËΩΩÂ§±Ë¥•</td></tr>';
    }
  } catch (error) {
    console.error('Âä†ËΩΩÁÉ≠Èó®ÊñáÁ´†Â§±Ë¥•:', error);
    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Âä†ËΩΩÂ§±Ë¥•</td></tr>';
  }
}

// Âä†ËΩΩËÆøÈóÆÊù•Ê∫ê
async function loadViewSources() {
  const days = document.getElementById('viewSourcesDays')?.value || 30;
  const tbody = document.getElementById('viewSourcesTableBody');
  
  if (!tbody) return;
  
  tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Âä†ËΩΩ‰∏≠...</td></tr>';
  
  try {
    const response = await fetch(`/api/admin/analytics?action=view-sources&days=${days}`, {
      headers: getAuthHeaders()
    });
    const result = await response.json();
    
    if (result.success && result.data) {
      if (result.data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">ÊöÇÊó†Êï∞ÊçÆ</td></tr>';
        return;
      }
      
      tbody.innerHTML = result.data.map((source, index) => `
        <tr>
          <td>${index + 1}</td>
          <td>${source.country === 'unknown' ? 'Êú™Áü•' : source.country}</td>
          <td>${source.count}</td>
        </tr>
      `).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Âä†ËΩΩÂ§±Ë¥•</td></tr>';
    }
  } catch (error) {
    console.error('Âä†ËΩΩËÆøÈóÆÊù•Ê∫êÂ§±Ë¥•:', error);
    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Âä†ËΩΩÂ§±Ë¥•</td></tr>';
  }
}

// Âä†ËΩΩËÆøÈóÆÊù•Ê∫êÔºàÊåâÂüéÂ∏ÇÔºâ
async function loadViewByCity() {
  const days = document.getElementById('viewByCityDays')?.value || 30;
  const tbody = document.getElementById('viewByCityTableBody');
  
  if (!tbody) return;
  
  tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Âä†ËΩΩ‰∏≠...</td></tr>';
  
  try {
    const response = await fetch(`/api/admin/analytics?action=view-by-city&days=${days}`, {
      headers: getAuthHeaders()
    });
    const result = await response.json();
    
    if (result.success && result.data) {
      if (result.data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">ÊöÇÊó†Êï∞ÊçÆ</td></tr>';
        return;
      }
      
      tbody.innerHTML = result.data.map((city, index) => `
        <tr>
          <td>${index + 1}</td>
          <td>${city.city === 'unknown' ? 'Êú™Áü•' : city.city}</td>
          <td>${city.country === 'unknown' ? 'Êú™Áü•' : city.country}</td>
          <td>${city.count}</td>
        </tr>
      `).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Âä†ËΩΩÂ§±Ë¥•</td></tr>';
    }
  } catch (error) {
    console.error('Âä†ËΩΩÂüéÂ∏ÇÁªüËÆ°Â§±Ë¥•:', error);
    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Âä†ËΩΩÂ§±Ë¥•</td></tr>';
  }
}

// Âä†ËΩΩËÆøÈóÆÊù•Ê∫êÔºàÊåâIPÔºâ
async function loadViewByIP() {
  const days = document.getElementById('viewByIPDays')?.value || 30;
  const tbody = document.getElementById('viewByIPTableBody');
  
  if (!tbody) return;
  
  tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Âä†ËΩΩ‰∏≠...</td></tr>';
  
  try {
    const response = await fetch(`/api/admin/analytics?action=view-by-ip&days=${days}`, {
      headers: getAuthHeaders()
    });
    const result = await response.json();
    
    if (result.success && result.data) {
      if (result.data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">ÊöÇÊó†Êï∞ÊçÆ</td></tr>';
        return;
      }
      
      tbody.innerHTML = result.data.map((ipData, index) => `
        <tr>
          <td>${index + 1}</td>
          <td>${ipData.ip}</td>
          <td>${ipData.country === 'unknown' ? 'Êú™Áü•' : (ipData.country || '-')}</td>
          <td>${ipData.city === 'unknown' ? 'Êú™Áü•' : (ipData.city || '-')}</td>
          <td>${ipData.region === 'unknown' ? 'Êú™Áü•' : (ipData.region || '-')}</td>
          <td>${ipData.count}</td>
          <td>${ipData.firstVisit}</td>
          <td>${ipData.lastVisit}</td>
        </tr>
      `).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Âä†ËΩΩÂ§±Ë¥•</td></tr>';
    }
  } catch (error) {
    console.error('Âä†ËΩΩIPÁªüËÆ°Â§±Ë¥•:', error);
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Âä†ËΩΩÂ§±Ë¥•</td></tr>';
  }
}

// Âä†ËΩΩÈòÖËØªË∂ãÂäø
async function loadViewTrend() {
  const days = document.getElementById('viewTrendDays')?.value || 30;
  const canvas = document.getElementById('viewTrendChart');
  
  if (!canvas) return;
  
  try {
    const response = await fetch(`/api/admin/analytics?action=view-trend&days=${days}`, {
      headers: getAuthHeaders()
    });
    const result = await response.json();
    
    if (result.success && result.data) {
      drawViewTrendChart(result.data);
    }
  } catch (error) {
    console.error('Âä†ËΩΩÈòÖËØªË∂ãÂäøÂ§±Ë¥•:', error);
  }
}

// ÁªòÂà∂ÈòÖËØªË∂ãÂäøÂõæË°®
function drawViewTrendChart(data) {
  const canvas = document.getElementById('viewTrendChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  // Ê∏ÖÁ©∫ÁîªÂ∏É
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  if (!data || data.length === 0) {
    ctx.font = '16px Arial';
    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
    ctx.textAlign = 'center';
    ctx.fillText('ÊöÇÊó†Êï∞ÊçÆ', canvas.width / 2, canvas.height / 2);
    return;
  }
  
  const padding = 50;
  const chartWidth = canvas.width - padding * 2;
  const chartHeight = canvas.height - padding * 2;
  
  // ÊâæÂá∫ÊúÄÂ§ßÂÄº
  const maxCount = Math.max(...data.map(d => d.count));
  
  // ÁªòÂà∂ÂùêÊ†áËΩ¥
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padding, padding);
  ctx.lineTo(padding, canvas.height - padding);
  ctx.lineTo(canvas.width - padding, canvas.height - padding);
  ctx.stroke();
  
  // ÁªòÂà∂Êï∞ÊçÆÁÇπÂíåËøûÁ∫ø
  const stepX = chartWidth / (data.length - 1 || 1);
  
  ctx.beginPath();
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
  ctx.lineWidth = 2;
  
  data.forEach((point, index) => {
    const x = padding + index * stepX;
    const y = canvas.height - padding - (point.count / maxCount) * chartHeight;
    
    if (index === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
  });
  ctx.stroke();
  
  // ÁªòÂà∂Êï∞ÊçÆÁÇπ
  data.forEach((point, index) => {
    const x = padding + index * stepX;
    const y = canvas.height - padding - (point.count / maxCount) * chartHeight;

    ctx.beginPath();
    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
    ctx.arc(x, y, 4, 0, Math.PI * 2);
    ctx.fill();

    // ÊòæÁ§∫Êï∞ÂÄº
    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(point.count, x, y - 10);

    // ÊòæÁ§∫Êó•ÊúüÔºàÊ∑ªÂä†ÂÆâÂÖ®Ê£ÄÊü•Ôºâ
    ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
    ctx.font = '10px Arial';
    if (point.date && typeof point.date === 'string') {
      ctx.fillText(point.date.substring(5), x, canvas.height - padding + 15);
    }
  });
}

// ÂàùÂßãÂåñÁªüËÆ°ÂàÜÊûê
function initAnalytics() {
  // ÁªëÂÆöÁÉ≠Èó®ÊñáÁ´†‰∏ãÊãâÊ°Ü
  const mostViewedLimit = document.getElementById('mostViewedLimit');
  if (mostViewedLimit) {
    mostViewedLimit.addEventListener('change', loadMostViewedArticles);
  }
  
  // ÁªëÂÆöËÆøÈóÆÊù•Ê∫ê‰∏ãÊãâÊ°Ü
  const viewSourcesDays = document.getElementById('viewSourcesDays');
  if (viewSourcesDays) {
    viewSourcesDays.addEventListener('change', loadViewSources);
  }
  
  // ÁªëÂÆöËÆøÈóÆÊù•Ê∫êÔºàÊåâÂüéÂ∏ÇÔºâ‰∏ãÊãâÊ°Ü
  const viewByCityDays = document.getElementById('viewByCityDays');
  if (viewByCityDays) {
    viewByCityDays.addEventListener('change', loadViewByCity);
  }
  
  // ÁªëÂÆöËÆøÈóÆÊù•Ê∫êÔºàÊåâIPÔºâ‰∏ãÊãâÊ°Ü
  const viewByIPDays = document.getElementById('viewByIPDays');
  if (viewByIPDays) {
    viewByIPDays.addEventListener('change', loadViewByIP);
  }
  
  // ÁªëÂÆöÈòÖËØªË∂ãÂäø‰∏ãÊãâÊ°Ü
  const viewTrendDays = document.getElementById('viewTrendDays');
  if (viewTrendDays) {
    viewTrendDays.addEventListener('change', loadViewTrend);
  }
  
  // ÂàùÂßãÂä†ËΩΩÊï∞ÊçÆ
  loadMostViewedArticles();
  loadViewSources();
  loadViewByCity();
  loadViewByIP();
  loadViewTrend();
}

// Ëé∑ÂèñÁä∂ÊÄÅÊñáÊú¨
function getStatusText(status) {
  const statusMap = {
    'published': 'Â∑≤ÂèëÂ∏É',
    'draft': 'ËçâÁ®ø',
    'pending': 'ÂæÖÂÆ°Ê†∏'
  };
  return statusMap[status] || status;
}

// ÁªëÂÆöÊìç‰ΩúÊåâÈíÆ‰∫ã‰ª∂
function bindActionButtons() {
  document.querySelectorAll('.action-buttons button').forEach(button => {
    // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
    const newButton = button.cloneNode(true);
    button.parentNode.replaceChild(newButton, button);
    
    newButton.addEventListener('click', async function() {
      const action = this.getAttribute('data-action');
      const itemId = this.getAttribute('data-id');
      
      if (action === 'delete' || action === 'delete-comment' || action === 'delete-user' || action === 'delete-category') {
        currentAction = action;
        currentItemId = itemId;

        let message = '';
        if (action === 'delete') {
          message = `Á°ÆÂÆöË¶ÅÂà†Èô§ÊñáÁ´† #${itemId} ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`;
        } else if (action === 'delete-comment') {
          message = `Á°ÆÂÆöË¶ÅÂà†Èô§ËØÑËÆ∫ #${itemId} ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`;
        } else if (action === 'delete-user') {
          message = `Á°ÆÂÆöË¶ÅÂà†Èô§Áî®Êà∑ #${itemId} ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`;
        } else if (action === 'delete-category') {
          message = `Á°ÆÂÆöË¶ÅÂà†Èô§ÂàÜÁ±ª #${itemId} ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`;
        }

        document.getElementById('confirmMessage').textContent = message;
        openModal('confirmModal');
      } else if (action === 'edit') {
              // ‰ªéÂêéÁ´ØËé∑ÂèñÊñáÁ´†ËØ¶ÊÉÖ
              try {
                const token = localStorage.getItem('auth_token');
      
                const headers = {
                  'Content-Type': 'application/json'
                };
                if (token) {
                  headers['Authorization'] = `Bearer ${token}`;
                }
      
                const response = await fetch(`/api/admin/passages?id=${itemId}`, {
                  headers: headers
                });
                const result = await response.json();
      
                if (result.success && result.data) {
                  // ÂÖàÂ°´ÂÖÖÂàÜÁ±ª‰∏ãÊãâÊ°Ü
                  await populateCategorySelect('editCategory', result.data.category || '');

                  // Â°´ÂÖÖÁºñËæëË°®Âçï
                  document.getElementById('editTitle').value = result.data.title || '';
                  document.getElementById('editAuthor').value = result.data.author || 'ÁÆ°ÁêÜÂëò';
                  // ‰ºòÂÖà‰ΩøÁî®ÂéüÂßã Markdown ÂÜÖÂÆπÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî® HTML ÂÜÖÂÆπ
                  document.getElementById('editContent').value = result.data.original_content || result.data.content || '';
                  document.getElementById('editShowTitle').checked = result.data.show_title !== false;
                  // Â°´ÂÖÖÂ∞ÅÈù¢Ë∑ØÂæÑ
                  document.getElementById('editCoverImage').value = result.data.cover_image || '';

                  // Â°´ÂÖÖÁä∂ÊÄÅÂíåÂèØËßÅÊÄß
                  document.getElementById('editStatus').value = result.data.status || 'published';
                  document.getElementById('editVisibility').value = result.data.visibility || 'public';

                  // Â°´ÂÖÖÂÆöÊó∂ÂèëÂ∏ÉÈÄâÈ°π
                  const isScheduled = result.data.is_scheduled || false;
                  document.getElementById('editIsScheduled').checked = isScheduled;

                  // ÊòæÁ§∫/ÈöêËóèÂèëÂ∏ÉÊó∂Èó¥ËæìÂÖ•Ê°Ü
                  const publishedAtGroup = document.getElementById('editPublishedAtGroup');
                  if (isScheduled) {
                    publishedAtGroup.style.display = 'block';
                    // Â°´ÂÖÖÂèëÂ∏ÉÊó∂Èó¥
                    if (result.data.published_at) {
                      const publishedDate = new Date(result.data.published_at);
                      // ËΩ¨Êç¢‰∏∫ datetime-local Ê†ºÂºè (YYYY-MM-DDTHH:mm)
                      const localDateTime = new Date(publishedDate.getTime() - publishedDate.getTimezoneOffset() * 60000)
                        .toISOString()
                        .slice(0, 16);
                      document.getElementById('editPublishedAt').value = localDateTime;
                    }
                  } else {
                    publishedAtGroup.style.display = 'none';
                    document.getElementById('editPublishedAt').value = '';
                  }

                  // Ëß£ÊûêÂπ∂Â°´ÂÖÖÊ†áÁ≠æ
                  let selectedTags = [];
                  if (result.data.tags) {
                    const tagsValue = result.data.tags;
                    // Â¶ÇÊûúÊòØÊï∞ÁªÑÔºåÁõ¥Êé•‰ΩøÁî®
                    if (Array.isArray(tagsValue)) {
                      selectedTags = tagsValue;
                    } else if (typeof tagsValue === 'string') {
                      // Â¶ÇÊûúÊòØÂ≠óÁ¨¶‰∏≤ÔºåÂ∞ùËØïËß£Êûê‰∏∫JSONÊï∞ÁªÑ
                      try {
                        const parsed = JSON.parse(tagsValue);
                        if (Array.isArray(parsed)) {
                          selectedTags = parsed;
                        } else {
                          // Ëß£ÊûêÁªìÊûú‰∏çÊòØÊï∞ÁªÑÔºåÊåâÈÄóÂè∑ÂàÜÂâ≤
                          selectedTags = tagsValue.split(',').map(t => t.trim()).filter(t => t);
                        }
                      } catch (e) {
                        // JSONËß£ÊûêÂ§±Ë¥•ÔºåÊåâÈÄóÂè∑ÂàÜÂâ≤
                        selectedTags = tagsValue.split(',').map(t => t.trim()).filter(t => t);
                      }
                    }
                  }
                  await populateTagSelector(selectedTags);

                  // ‰øùÂ≠òÂΩìÂâçÁºñËæëÁöÑÊñáÁ´†ID
                  document.getElementById('editForm').dataset.articleId = itemId;

                  openModal('editModal');
                } else {
                  showToast('Ëé∑ÂèñÊñáÁ´†ËØ¶ÊÉÖÂ§±Ë¥•Ôºö' + (result.message || 'Êú™Áü•ÈîôËØØ'), 'error');
                }
              } catch (error) {
                console.error('Ëé∑ÂèñÊñáÁ´†ËØ¶ÊÉÖÂ§±Ë¥•:', error);
                showToast('Ëé∑ÂèñÊñáÁ´†ËØ¶ÊÉÖÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
              }
            } else if (action === 'upload') {
        // ÊâìÂºÄ‰∏ä‰º†ÈôÑ‰ª∂Ê®°ÊÄÅÊ°Ü
        document.getElementById('uploadAttachmentArticleId').textContent = '#' + itemId;
        document.getElementById('uploadAttachmentArticleId').dataset.articleId = itemId;
        document.getElementById('attachmentFile').value = '';
        document.getElementById('uploadAttachmentProgress').style.display = 'none';
        document.getElementById('uploadAttachmentResult').style.display = 'none';
        openModal('uploadAttachmentModal');
      } else if (action === 'view') {
        // ‰ªéÂêéÁ´ØËé∑ÂèñÊñáÁ´†ËØ¶ÊÉÖÂπ∂ÊòæÁ§∫
        try {
          const token = localStorage.getItem('auth_token');
          const headers = {
            'Content-Type': 'application/json'
          };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }

          const response = await fetch(`/api/admin/passages?id=${itemId}`, {
            headers: headers
          });
          const result = await response.json();

          if (result.success && result.data) {
            // Â°´ÂÖÖËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
            document.getElementById('viewArticleId').textContent = '#' + result.data.id;
            document.getElementById('viewArticleTitle').textContent = result.data.title || '';
            document.getElementById('viewArticleAuthor').textContent = result.data.author || 'ÁÆ°ÁêÜÂëò';
            document.getElementById('viewArticleStatus').textContent = getStatusText(result.data.status || 'published');
            document.getElementById('viewArticleDate').textContent = result.data.created_at || '';
            document.getElementById('viewArticleContent').textContent = result.data.content || '';
            
            openModal('viewArticleModal');
          } else {
            showToast('Ëé∑ÂèñÊñáÁ´†ËØ¶ÊÉÖÂ§±Ë¥•Ôºö' + (result.message || 'Êú™Áü•ÈîôËØØ'), 'error');
          }
        } catch (error) {
          console.error('Ëé∑ÂèñÊñáÁ´†ËØ¶ÊÉÖÂ§±Ë¥•:', error);
          showToast('Ëé∑ÂèñÊñáÁ´†ËØ¶ÊÉÖÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
        }
      } else if (action === 'edit-user') {
        // ‰ªéÂêéÁ´ØËé∑ÂèñÁî®Êà∑ËØ¶ÊÉÖ
        try {
          const token = localStorage.getItem('auth_token');
          const headers = {
            'Content-Type': 'application/json'
          };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }

          const response = await fetch(`/api/admin/users?id=${itemId}`, {
            headers: headers
          });
          const result = await response.json();

          if (result.success && result.data && result.data.length > 0) {
            const userData = result.data[0];
            // Â°´ÂÖÖÁºñËæëË°®Âçï
            document.getElementById('editUserName').value = userData.username || '';
            document.getElementById('editUserEmail').value = userData.email || '';
            document.getElementById('editUserRole').value = userData.role || 'user';
            document.getElementById('editUserStatus').value = userData.status || 'active';
            document.getElementById('editUserPassword').value = ''; // ÂØÜÁ†ÅÁïôÁ©∫

            // ‰øùÂ≠òÂΩìÂâçÁºñËæëÁöÑÁî®Êà∑ID
            document.getElementById('editUserForm').dataset.userId = itemId;

            openModal('editUserModal');
          } else {
            showToast('Ëé∑ÂèñÁî®Êà∑ËØ¶ÊÉÖÂ§±Ë¥•Ôºö' + (result.message || 'Êú™Áü•ÈîôËØØ'), 'error');
          }
        } catch (error) {
          console.error('Ëé∑ÂèñÁî®Êà∑ËØ¶ÊÉÖÂ§±Ë¥•:', error);
          showToast('Ëé∑ÂèñÁî®Êà∑ËØ¶ÊÉÖÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
        }
      } else if (action === 'view-user') {
        // ‰ªéÂêéÁ´ØËé∑ÂèñÁî®Êà∑ËØ¶ÊÉÖÂπ∂ÊòæÁ§∫
        try {
          const token = localStorage.getItem('auth_token');
          const headers = {
            'Content-Type': 'application/json'
          };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }

          const response = await fetch(`/api/admin/users?id=${itemId}`, {
            headers: headers
          });
          const result = await response.json();

          if (result.success && result.data && result.data.length > 0) {
            const userData = result.data[0];
            // Â°´ÂÖÖËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
            document.getElementById('viewUserId').textContent = '#' + userData.id;
            document.getElementById('viewUserName').textContent = userData.username || '';
            document.getElementById('viewUserEmail').textContent = userData.email || '';
            document.getElementById('viewUserRole').textContent = userData.role || 'ÊôÆÈÄöÁî®Êà∑';
            document.getElementById('viewUserStatus').textContent = userData.status || 'Ê≠£Â∏∏';
            document.getElementById('viewUserDate').textContent = userData.created_at || '';
            
            openModal('viewUserModal');
          } else {
            showToast('Ëé∑ÂèñÁî®Êà∑ËØ¶ÊÉÖÂ§±Ë¥•Ôºö' + (result.message || 'Êú™Áü•ÈîôËØØ'), 'error');
          }
        } catch (error) {
          console.error('Ëé∑ÂèñÁî®Êà∑ËØ¶ÊÉÖÂ§±Ë¥•:', error);
          showToast('Ëé∑ÂèñÁî®Êà∑ËØ¶ÊÉÖÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
        }
      } else if (action === 'edit-comment') {
        alert(`ÁºñËæëËØÑËÆ∫ #${itemId}`);
      } else if (action === 'view-comment') {
        // Êü•ÊâæËØÑËÆ∫Ë°åÂπ∂ÊèêÂèñÊï∞ÊçÆ
        const row = this.closest('tr');
        const cells = row.querySelectorAll('td');
        
        if (cells.length >= 6) {
          // Â°´ÂÖÖËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
          document.getElementById('viewCommentId').textContent = cells[0].textContent;
          document.getElementById('viewCommentContent').textContent = cells[1].textContent;
          document.getElementById('viewCommentArticle').textContent = cells[2].textContent;
          document.getElementById('viewCommentUser').textContent = cells[3].textContent;
          document.getElementById('viewCommentDate').textContent = cells[4].textContent;
          document.getElementById('viewCommentStatus').textContent = cells[5].textContent.trim();
          
          openModal('viewCommentModal');
        } else {
          alert('Êü•ÁúãËØÑËÆ∫ #${itemId} ÁöÑËØ¶ÁªÜ‰ø°ÊÅØ');
        }
      } else if (action === 'delete-tag') {
        currentAction = action;
        currentItemId = itemId;
        document.getElementById('confirmMessage').textContent = `Á°ÆÂÆöË¶ÅÂà†Èô§Ê†áÁ≠æ #${itemId} ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`;
        openModal('confirmModal');
      } else if (action === 'edit-tag') {
        // ‰ªéÂêéÁ´ØËé∑ÂèñÊ†áÁ≠æËØ¶ÊÉÖ
        try {
          const token = localStorage.getItem('auth_token');
          const headers = {
            'Content-Type': 'application/json'
          };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }

          const response = await fetch(`/api/admin/tags?id=${itemId}`, {
            headers: headers
          });
          const result = await response.json();

          if (result.success && result.data) {
            // Â°´ÂÖÖÁºñËæëË°®Âçï
            document.getElementById('tagModalTitle').textContent = 'ÁºñËæëÊ†áÁ≠æ';
            document.getElementById('tagName').value = result.data.name || '';
            document.getElementById('tagDescription').value = result.data.description || '';
            document.getElementById('tagColor').value = result.data.color || '#007bff';
            document.getElementById('tagCategory').value = result.data.category_id || 0;
            document.getElementById('tagSortOrder').value = result.data.sort_order || 0;
            document.getElementById('tagEnabled').checked = result.data.is_enabled;

            // ‰øùÂ≠òÂΩìÂâçÁºñËæëÁöÑÊ†áÁ≠æID
            document.getElementById('tagForm').dataset.tagId = itemId;

            openModal('tagModal');
          } else {
            showToast('Ëé∑ÂèñÊ†áÁ≠æËØ¶ÊÉÖÂ§±Ë¥•Ôºö' + (result.message || 'Êú™Áü•ÈîôËØØ'), 'error');
          }
        } catch (error) {
          console.error('Ëé∑ÂèñÊ†áÁ≠æËØ¶ÊÉÖÂ§±Ë¥•:', error);
          showToast('Ëé∑ÂèñÊ†áÁ≠æËØ¶ÊÉÖÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
        }
      } else if (action === 'edit-category') {
        // ‰ªéÂêéÁ´ØËé∑ÂèñÂàÜÁ±ªËØ¶ÊÉÖ
        try {
          const token = localStorage.getItem('auth_token');
          const headers = {
            'Content-Type': 'application/json'
          };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }

          const response = await fetch(`/api/admin/categories?id=${itemId}`, {
            headers: headers
          });
          const result = await response.json();

          if (result.success && result.data) {
            // Â°´ÂÖÖÁºñËæëË°®Âçï
            document.getElementById('categoryModalTitle').textContent = 'ÁºñËæëÂàÜÁ±ª';
            document.getElementById('categoryName').value = result.data.name || '';
            document.getElementById('categoryDescription').value = result.data.description || '';
            document.getElementById('categoryIcon').value = result.data.icon || '';
            document.getElementById('categorySortOrder').value = result.data.sort_order || 0;
            document.getElementById('categoryEnabled').checked = result.data.is_enabled;

            // ‰øùÂ≠òÂΩìÂâçÁºñËæëÁöÑÂàÜÁ±ªID
            document.getElementById('categoryForm').dataset.categoryId = itemId;

            openModal('categoryModal');
          } else {
            showToast('Ëé∑ÂèñÂàÜÁ±ªËØ¶ÊÉÖÂ§±Ë¥•Ôºö' + (result.message || 'Êú™Áü•ÈîôËØØ'), 'error');
          }
        } catch (error) {
          console.error('Ëé∑ÂèñÂàÜÁ±ªËØ¶ÊÉÖÂ§±Ë¥•:', error);
          showToast('Ëé∑ÂèñÂàÜÁ±ªËØ¶ÊÉÖÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
        }
      }
    });
  });
}

// ÂØºËà™Ê†èÊªöÂä®ÈöêËóè/ÊòæÁ§∫ÈÄªËæë
let lastScrollTop = 0;
let isNavHidden = false;
const nav = document.getElementById('mainNav');
const scrollIndicator = document.getElementById('scrollIndicator');
const scrollProgress = document.getElementById('scrollProgress');

// ÂàùÂßãÁä∂ÊÄÅ - Âú®È°∂ÈÉ®
nav.classList.add('scrolled-top');

// ÁõëÂê¨ÊªöÂä®‰∫ã‰ª∂
window.addEventListener('scroll', function() {
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
  const scrollPercent = (scrollTop / scrollHeight) * 100;

  // Êõ¥Êñ∞ÊªöÂä®ÊåáÁ§∫Âô®
  if (scrollTop > 100) {
    scrollIndicator.classList.add('active');
    scrollProgress.style.height = `${scrollPercent}%`;
  } else {
    scrollIndicator.classList.remove('active');
  }

  // Ê£ÄÊµãÊªöÂä®ÊñπÂêë
  if (scrollTop > lastScrollTop && scrollTop > 50) {
    // Âêë‰∏ãÊªöÂä®‰∏î‰∏çÂú®È°∂ÈÉ® - ÈöêËóèÂØºËà™Ê†è
    if (!isNavHidden) {
      nav.classList.add('hidden');
      isNavHidden = true;
    }
  } else if (scrollTop < lastScrollTop || scrollTop <= 50) {
    // Âêë‰∏äÊªöÂä®ÊàñÊé•ËøëÈ°∂ÈÉ® - ÊòæÁ§∫ÂØºËà™Ê†è
    if (isNavHidden) {
      nav.classList.remove('hidden');
      isNavHidden = false;
    }

    // Êõ¥Êñ∞ÂØºËà™Ê†èÊ†∑Âºè
    if (scrollTop === 0) {
      nav.classList.add('scrolled-top');
      nav.classList.remove('scrolled');
    } else {
      nav.classList.remove('scrolled-top');
      nav.classList.add('scrolled');
    }
  }

  lastScrollTop = scrollTop;
}, { passive: true });

// È°µÈù¢Âä†ËΩΩÂêéÊ∑ªÂä†Âä®Áîª
window.addEventListener('load', function() {
  document.body.style.opacity = '0';
  document.body.style.transition = 'opacity 0.5s ease';

  setTimeout(() => {
    document.body.style.opacity = '1';
  }, 100);

  // ÂàùÂßãÂåñÁ©∫Áä∂ÊÄÅ
  showEmptyState('articlesTableBody', 'ÊöÇÊó†ÊñáÁ´†', 6);
  showEmptyState('usersTableBody', 'ÊöÇÊó†Áî®Êà∑', 7);
  showEmptyState('commentsTableBody', 'ÊöÇÊó†ËØÑËÆ∫', 6);

  // ‰ªéÂêéÁ´ØËé∑ÂèñÊï∞ÊçÆ
  fetchAdminData();

  // Âä†ËΩΩÂàÜÁ±ªÂíåÊ†áÁ≠æÊï∞ÊçÆ
  loadCategoriesAndTags();

  // ‰∏∫Âç°ÁâáÊ∑ªÂä†Âª∂ËøüÂä®Áîª
  const cards = document.querySelectorAll('.stat-card');
  cards.forEach((card, index) => {
    card.style.opacity = '0';
    card.style.transform = 'translateY(20px)';
    card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
    
    setTimeout(() => {
      card.style.opacity = '1';
      card.style.transform = 'translateY(0)';
    }, 200 + (index * 50));
  });
});

// Èº†Ê†áÊÇ¨ÂÅúÊó∂ÊöÇÂÅúÂÖâÊ†áÈó™ÁÉÅ
const mainTitle = document.getElementById('main-title');
if (mainTitle) {
  mainTitle.addEventListener('mouseenter', function() {
    this.style.animationPlayState = 'paused';
  });
  
  mainTitle.addEventListener('mouseleave', function() {
    this.style.animationPlayState = 'running';
  });
}

// Ê†áÁ≠æÈ°µÂàáÊç¢ÂäüËÉΩ
document.querySelectorAll('.tab-btn').forEach(button => {
  button.addEventListener('click', async function() {
    // ÁßªÈô§ÊâÄÊúâÊåâÈíÆÁöÑactiveÁ±ª
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });

    // ‰∏∫ÂΩìÂâçÊåâÈíÆÊ∑ªÂä†activeÁ±ª
    this.classList.add('active');

    // ÈöêËóèÊâÄÊúâÊ†áÁ≠æÈ°µ
    document.querySelectorAll('.tab-pane').forEach(pane => {
      pane.classList.remove('active');
    });

    // ÊòæÁ§∫ÂØπÂ∫îÁöÑÊ†áÁ≠æÈ°µ
    const tabId = this.getAttribute('data-tab');
    const targetPane = document.getElementById(tabId);
    if (targetPane) {
      targetPane.classList.add('active');

      // Â¶ÇÊûúÂàáÊç¢Âà∞Ê†áÁ≠æÁÆ°ÁêÜÊ†áÁ≠æÈ°µÔºåÂä†ËΩΩÊï∞ÊçÆ
      if (tabId === 'tags') {
        await loadCategoriesAndTags();
      }

      // Â¶ÇÊûúÂàáÊç¢Âà∞ÁªüËÆ°ÂàÜÊûêÊ†áÁ≠æÈ°µÔºåÂàùÂßãÂåñÁªüËÆ°ÂõæË°®
      if (tabId === 'analytics') {
        initAnalytics();
      }

      // Â¶ÇÊûúÂàáÊç¢Âà∞ÈôÑ‰ª∂ÁÆ°ÁêÜÊ†áÁ≠æÈ°µÔºåÂä†ËΩΩÈôÑ‰ª∂ÂàóË°®
      if (tabId === 'attachments') {
        await loadAttachments();
      }
    }
  });
});

// Ê®°ÊÄÅÊ°ÜÁÆ°ÁêÜ
function openModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
  }
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.add('closing');
    setTimeout(() => {
      modal.classList.remove('active', 'closing');
      document.body.style.overflow = 'auto';
    }, 300);
  }
}

// Ê®°ÊÄÅÊ°ÜÊâìÂºÄ/ÂÖ≥Èó≠‰∫ã‰ª∂
document.querySelectorAll('[data-modal]').forEach(element => {
  if (element.classList.contains('modal-close') || element.hasAttribute('data-modal')) {
    element.addEventListener('click', function() {
      const modalId = this.getAttribute('data-modal');
      closeModal(modalId);
    });
  }
});

// ÊâìÂºÄ‰∏ä‰º†ÊñáÁ´†Ê®°ÊÄÅÊ°Ü
document.getElementById('uploadArticleBtn').addEventListener('click', async () => {
  // Âä†ËΩΩÊ†áÁ≠æÈÄâÊã©Âô®
  await populateTagSelectorForUpload();
  // Âä†ËΩΩÂàÜÁ±ªÈÄâÊã©Âô®
  await populateCategorySelectorForUpload();
  openModal('uploadModal');
});

// ÊâìÂºÄÊñ∞Âª∫ÊñáÁ´†Ê®°ÊÄÅÊ°Ü
document.getElementById('newArticleBtn').addEventListener('click', async () => {
  // Âä†ËΩΩÊ†áÁ≠æÈÄâÊã©Âô®
  await populateTagSelectorForNewArticle();
  // Âä†ËΩΩÂàÜÁ±ªÈÄâÊã©Âô®
  await populateCategorySelectorForNewArticle();
  openModal('articleModal');
});

// ÊâìÂºÄÊ∑ªÂä†Áî®Êà∑Ê®°ÊÄÅÊ°Ü
document.getElementById('addUserBtn').addEventListener('click', () => {
  openModal('userModal');
});

// Ê†áÁ≠æÈÄâÊã©ÂäüËÉΩ
document.querySelectorAll('.tag-option').forEach(tag => {
  tag.addEventListener('click', function() {
    this.classList.toggle('selected');
  });
});

// Ê∑ªÂä†Ê†áÁ≠æÂäüËÉΩÔºà‰∏ä‰º†ÊñáÁ´†Ê®°ÊÄÅÊ°ÜÔºâ
document.getElementById('addUploadTagBtn').addEventListener('click', async function() {
  const tagInput = document.getElementById('uploadTagInput');
  const tagText = tagInput.value.trim();

  if (!tagText) {
    showToast('ËØ∑ËæìÂÖ•Ê†áÁ≠æÂêçÁß∞', 'warning');
    return;
  }

  // Ê£ÄÊü•Ê†áÁ≠æÊòØÂê¶Â∑≤Â≠òÂú®ÔºàÂåÖÊã¨Â∑≤ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÔºâ
  const tagSelector = document.getElementById('uploadTagSelector');
  const existingTags = Array.from(tagSelector.querySelectorAll('.tag-option')).map(tag =>
    tag.dataset.tagName ? tag.dataset.tagName.toLowerCase() : tag.textContent.trim().toLowerCase()
  );

  if (existingTags.includes(tagText.toLowerCase())) {
    showToast('Ê†áÁ≠æÂ∑≤Â≠òÂú®', 'warning');
    tagInput.value = '';
    return;
  }

  // ÁîüÊàêÈöèÊú∫È¢úËâ≤
  const colors = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#1abc9c', '#3498db', '#9b59b6', '#34495e'];
  const randomColor = colors[Math.floor(Math.random() * colors.length)];

  // ÂàõÂª∫Êñ∞Ê†áÁ≠æ
  const newTag = document.createElement('div');
  newTag.className = 'tag-option selected';
  newTag.dataset.tagName = tagText;
  newTag.dataset.isNew = 'true'; // Ê†áËÆ∞‰∏∫Êñ∞ÂàõÂª∫ÁöÑÊ†áÁ≠æ
  newTag.innerHTML = `
    <span style="display: inline-block; width: 12px; height: 12px; background-color: ${randomColor}; border-radius: 2px; margin-right: 6px;"></span>
    ${tagText}
  `;
  newTag.addEventListener('click', function() {
    this.classList.toggle('selected');
  });

  tagSelector.appendChild(newTag);
  tagInput.value = '';

  // ÊèêÁ§∫Áî®Êà∑Ê†áÁ≠æÂ∑≤Ê∑ªÂä†
  showToast(`Ê†áÁ≠æ "${tagText}" Â∑≤Ê∑ªÂä†`, 'success');
});

// Ê∑ªÂä†ÂàÜÁ±ªÂäüËÉΩÔºà‰∏ä‰º†ÊñáÁ´†Ê®°ÊÄÅÊ°ÜÔºâ
document.getElementById('addUploadCategoryBtn').addEventListener('click', async function() {
  const categoryInput = document.getElementById('uploadCategoryInput');
  const categoryText = categoryInput.value.trim();

  if (!categoryText) {
    showToast('ËØ∑ËæìÂÖ•ÂàÜÁ±ªÂêçÁß∞', 'warning');
    return;
  }

  // Ê£ÄÊü•ÂàÜÁ±ªÊòØÂê¶Â∑≤Â≠òÂú®
  const categorySelector = document.getElementById('uploadCategorySelector');
  const existingCategories = Array.from(categorySelector.querySelectorAll('.category-option')).map(cat =>
    cat.dataset.categoryName ? cat.dataset.categoryName.toLowerCase() : cat.textContent.trim().toLowerCase()
  );

  if (existingCategories.includes(categoryText.toLowerCase())) {
    showToast('ÂàÜÁ±ªÂ∑≤Â≠òÂú®', 'warning');
    categoryInput.value = '';
    return;
  }

  // ÂàõÂª∫Êñ∞ÂàÜÁ±ª
  const newCategory = document.createElement('div');
  newCategory.className = 'category-option selected';
  newCategory.dataset.categoryName = categoryText;
  newCategory.dataset.isNew = 'true'; // Ê†áËÆ∞‰∏∫Êñ∞ÂàõÂª∫ÁöÑÂàÜÁ±ª
  newCategory.innerHTML = `
    <span style="display: inline-block; width: 12px; height: 12px; background-color: #007bff; border-radius: 2px; margin-right: 6px;"></span>
    ${categoryText}
  `;
  newCategory.addEventListener('click', function() {
    // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂ∑≤ÈÄâ‰∏≠ÁöÑÂàÜÁ±ªÔºåÂèñÊ∂àÈÄâ‰∏≠
    if (this.classList.contains('selected')) {
      this.classList.remove('selected');
      return;
    }

    // Âê¶ÂàôÔºåÁßªÈô§ÂÖ∂‰ªñÂàÜÁ±ªÁöÑÈÄâ‰∏≠Áä∂ÊÄÅÔºåÈÄâ‰∏≠ÂΩìÂâçÂàÜÁ±ª
    categorySelector.querySelectorAll('.category-option').forEach(cat => {
      cat.classList.remove('selected');
    });
    this.classList.add('selected');
  });

  // ÂÖàÁßªÈô§ÂÖ∂‰ªñÂàÜÁ±ªÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
  categorySelector.querySelectorAll('.category-option').forEach(cat => {
    cat.classList.remove('selected');
  });

  // Ê∑ªÂä†Êñ∞ÂàÜÁ±ªÂà∞DOM
  categorySelector.appendChild(newCategory);
  categoryInput.value = '';

  // ÊèêÁ§∫Áî®Êà∑ÂàÜÁ±ªÂ∑≤Ê∑ªÂä†
  showToast(`ÂàÜÁ±ª "${categoryText}" Â∑≤Ê∑ªÂä†`, 'success');
});

// Êñá‰ª∂‰∏ä‰º†ÂäüËÉΩ
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const uploadPreview = document.getElementById('uploadPreview');

// Â≠òÂÇ®ÈÄâ‰∏≠ÁöÑÊñá‰ª∂
let selectedFiles = [];

uploadArea.addEventListener('click', () => {
  fileInput.click();
});

uploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
  uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  const files = e.dataTransfer.files;
  handleFiles(files);
});

fileInput.addEventListener('change', () => {
  const files = fileInput.files;
  handleFiles(files);
});

function handleFiles(files) {
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    
    // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞èÔºàÊúÄÂ§ß10MBÔºâ
    if (file.size > 10 * 1024 * 1024) {
      showToast(`Êñá‰ª∂ ${file.name} Ë∂ÖËøá10MBÈôêÂà∂`, 'error');
      continue;
    }
    
    // Ê∑ªÂä†Âà∞ÈÄâ‰∏≠ÁöÑÊñá‰ª∂ÂàóË°®
    selectedFiles.push(file);
    
    // ÂàõÂª∫È¢ÑËßàÈ°π
    const reader = new FileReader();
    reader.onload = function(e) {
      const uploadItem = document.createElement('div');
      uploadItem.className = 'upload-item';
      uploadItem.dataset.fileIndex = selectedFiles.length - 1; // Â≠òÂÇ®Êñá‰ª∂Á¥¢Âºï
      
      // Âà§Êñ≠Êñá‰ª∂Á±ªÂûã
      if (file.type.startsWith('image/')) {
        uploadItem.innerHTML = `
          <img src="${e.target.result}" alt="${file.name}">
          <button class="upload-remove">√ó</button>
        `;
      } else {
        const fileType = file.name.split('.').pop().toUpperCase();
        uploadItem.innerHTML = `
          <div style="background:#f0f0f0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#666;">
            <div style="font-size:2em;">üìÑ</div>
            <div style="font-size:0.8em; margin-top:5px; text-align:center; padding:0 5px;">${fileType}</div>
          </div>
          <button class="upload-remove">√ó</button>
        `;
      }
      
      // Ê∑ªÂä†Âà†Èô§ÂäüËÉΩ
      const removeBtn = uploadItem.querySelector('.upload-remove');
      removeBtn.addEventListener('click', function() {
        const index = parseInt(uploadItem.dataset.fileIndex);
        selectedFiles.splice(index, 1); // ‰ªéÊï∞ÁªÑ‰∏≠ÁßªÈô§
        uploadItem.remove();
      });
      
      uploadPreview.appendChild(uploadItem);
    };
    
    reader.readAsDataURL(file);
  }
}

// Ë°®ÂçïÊèê‰∫§
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
  const title = document.getElementById('uploadTitle').value.trim();
  if (!title) {
    showToast('ËØ∑ËæìÂÖ•ÊñáÁ´†Ê†áÈ¢ò', 'warning');
    document.getElementById('uploadTitle').focus();
    return;
  }

  const author = document.getElementById('uploadAuthor').value.trim();
  if (!author) {
    showToast('ËØ∑ËæìÂÖ•‰ΩúËÄÖÂêçÁß∞', 'warning');
    document.getElementById('uploadAuthor').focus();
    return;
  }

  // ÂàÜÁ±ªÂíåÊ†áÁ≠æÁé∞Âú®ÊòØÂèØÈÄâÁöÑ
  const selectedCategory = document.querySelector('#uploadCategorySelector .category-option.selected');
  const category = selectedCategory ? selectedCategory.dataset.categoryName : '';

  // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÔºàÂèØÈÄâÔºâ
  const selectedTags = [];
  document.querySelectorAll('#uploadTagSelector .tag-option.selected').forEach(option => {
    selectedTags.push(option.dataset.tagName);
  });

  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = '‰∏ä‰º†‰∏≠...';
  submitBtn.disabled = true;

  try {
    // Ëé∑ÂèñÊñá‰ª∂ÂíåÊñáÁ´†ÂÜÖÂÆπ
    const files = selectedFiles;
    const content = document.getElementById('uploadContent').value.trim();

    // Ê£ÄÊü•ÊòØÂê¶Ëá≥Â∞ëÊèê‰æõ‰∫Ü‰∏ÄÁßçÊñπÂºè
    if (files.length === 0 && !content) {
      showToast('ËØ∑ÈÄâÊã©Ë¶Å‰∏ä‰º†ÁöÑÊñá‰ª∂ÊàñËæìÂÖ•ÊñáÁ´†ÂÜÖÂÆπ', 'warning');
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      return;
    }

    // Ëé∑ÂèñÊñáÁ´†ÂÜÖÂÆπ
    let articleContent = content;

    // Â¶ÇÊûúÊúâÊñá‰ª∂‰∏ä‰º†,ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ
    if (files.length > 0 && !content) {
      const file = files[0];
      articleContent = await readFileContent(file);
    }

    // È™åËØÅÊñáÁ´†ÂÜÖÂÆπ
    if (!articleContent || articleContent.trim().length === 0) {
      showToast('ÊñáÁ´†ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫', 'warning');
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      return;
    }

    // Ëé∑ÂèñË°®ÂçïÊï∞ÊçÆ
    const status = document.getElementById('uploadStatus').value;

    // Ëé∑ÂèñÂèëÂ∏ÉÊó•Êúü
    const year = document.getElementById('uploadYear').value;
    const month = document.getElementById('uploadMonth').value;
    const day = document.getElementById('uploadDay').value;

    // Â¶ÇÊûúÊèê‰æõ‰∫ÜÂÆåÊï¥ÁöÑÂπ¥ÊúàÊó•ÔºåÂàôÂàõÂª∫ created_at
    let created_at = null;
    if (year && month && day) {
      // Ê†ºÂºèÂåñ‰∏∫ ISO 8601/RFC3339
      const y = parseInt(year);
      const m = parseInt(month);
      const d = parseInt(day);
      
      // È™åËØÅÊó•ÊúüÊúâÊïàÊÄß
      if (y >= 2020 && y <= 2030 && m >= 1 && m <= 12 && d >= 1 && d <= 31) {
        created_at = new Date(y, m - 1, d).toISOString();
      }
    }

    // ÂàõÂª∫ÊñáÁ´†
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const requestBody = {
      title: title,
      content: articleContent,
      author: author,
      category: category,
      tags: selectedTags.join(','),
      status: status
    };

    // Â¶ÇÊûúÊúâ created_atÔºåÊ∑ªÂä†Âà∞ËØ∑Ê±Ç‰Ωì
    if (created_at) {
      requestBody.created_at = created_at;
    }

    const response = await fetch('/api/admin/passages', {
      method: 'POST',
      headers: headers,
      body: JSON.stringify(requestBody)
    });

    const result = await response.json();

    if (!result.success) {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      showToast('ÂàõÂª∫Â§±Ë¥•Ôºö' + (result.message || 'Êú™Áü•ÈîôËØØ'), 'error');
      return;
    }

    // ÊñáÁ´†ÂàõÂª∫ÊàêÂäü,Áé∞Âú®‰∏ä‰º†ÈôÑ‰ª∂
    const passageId = result.data.id;
    let uploadSuccessCount = 0;
    let uploadFailCount = 0;
    const uploadErrors = [];

    for (const file of files) {
      try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('passage_id', passageId);

        const uploadResponse = await fetch('/api/admin/attachments', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        const uploadResult = await uploadResponse.json();
        if (uploadResult.success) {
          uploadSuccessCount++;
          console.log(`ÈôÑ‰ª∂ ${file.name} ‰∏ä‰º†ÊàêÂäü`);
        } else {
          uploadFailCount++;
          uploadErrors.push(`${file.name}: ${uploadResult.message || 'Êú™Áü•ÈîôËØØ'}`);
          console.error(`ÈôÑ‰ª∂ ${file.name} ‰∏ä‰º†Â§±Ë¥•:`, uploadResult);
        }
      } catch (error) {
        uploadFailCount++;
        uploadErrors.push(`${file.name}: ${error.message || 'ÁΩëÁªúÈîôËØØ'}`);
        console.error(`‰∏ä‰º†ÈôÑ‰ª∂ ${file.name} Â§±Ë¥•:`, error);
      }
    }

    // Â¶ÇÊûúÊúâÈôÑ‰ª∂‰∏ä‰º†Â§±Ë¥•ÔºåÊòæÁ§∫ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ
    if (uploadFailCount > 0) {
      console.error('ÈôÑ‰ª∂‰∏ä‰º†Â§±Ë¥•ËØ¶ÊÉÖ:', uploadErrors);
    }

    // ÊòæÁ§∫ÁªìÊûú
    submitBtn.textContent = 'ÂàõÂª∫ÊàêÂäü!';
    submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';

    let message = 'ÊñáÁ´†ÂàõÂª∫ÊàêÂäüÔºÅ';
    if (uploadSuccessCount > 0) {
      message += ` ÊàêÂäü‰∏ä‰º† ${uploadSuccessCount} ‰∏™ÈôÑ‰ª∂`;
    }
    if (uploadFailCount > 0) {
      message += ` Â§±Ë¥• ${uploadFailCount} ‰∏™ÈôÑ‰ª∂`;
    }

    setTimeout(() => {
      closeModal('uploadModal');
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';
      this.reset();

      // Ê∏ÖÁ©∫È¢ÑËßàÂíåÊñá‰ª∂ÂàóË°®
      uploadPreview.innerHTML = '';
      selectedFiles = [];

      // Âà∑Êñ∞ÊñáÁ´†ÂàóË°®
      fetchAdminData();

      showToast(message, uploadFailCount > 0 ? 'warning' : 'success');
    }, 2000);
  } catch (error) {
    console.error('ÂàõÂª∫ÊñáÁ´†Â§±Ë¥•:', error);
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
    showToast('ÂàõÂª∫Â§±Ë¥•ÔºåÊó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂêéÈáçËØï', 'error');
  }
});

// ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ
function readFileContent(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      resolve(e.target.result);
    };
    reader.onerror = (e) => {
      reject(new Error('ËØªÂèñÊñá‰ª∂Â§±Ë¥•'));
    };
    reader.readAsText(file);
  });
}

document.getElementById('articleForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const title = document.getElementById('articleTitle').value;
  if (!title) {
    showToast('ËØ∑ËæìÂÖ•ÊñáÁ´†Ê†áÈ¢ò', 'warning');
    return;
  }

  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = '‰øùÂ≠ò‰∏≠...';
  submitBtn.disabled = true;

  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/admin/passages', {
      method: 'POST',
      headers: headers,
      body: JSON.stringify({
        title: title,
        content: document.getElementById('articleContent').value,
        author: document.getElementById('articleAuthor').value,
        category: document.getElementById('articleCategory').value,
        tags: document.getElementById('articleTags').value,
        cover_image: document.getElementById('articleCoverImage').value,
      })
    });

    const result = await response.json();

    if (result.success) {
      submitBtn.textContent = '‰øùÂ≠òÊàêÂäü!';
      submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';

      setTimeout(() => {
        closeModal('articleModal');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';
        this.reset();

        // Âà∑Êñ∞ÊñáÁ´†ÂàóË°®
        fetchAdminData();

        showToast('ÊñáÁ´†ÂàõÂª∫ÊàêÂäüÔºÅ', 'success');
      }, 2000);
    } else {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      showToast('‰øùÂ≠òÂ§±Ë¥•Ôºö' + (result.message || 'Êú™Áü•ÈîôËØØ'), 'error');
    }
  } catch (error) {
    console.error('‰øùÂ≠òÊñáÁ´†Â§±Ë¥•:', error);
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
    showToast('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
  }
});

document.getElementById('editForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const articleId = this.dataset.articleId;
  if (!articleId) {
    showToast('Êó†Ê≥ïÁ°ÆÂÆöË¶ÅÁºñËæëÁöÑÊñáÁ´†', 'error');
    return;
  }

  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = '‰øùÂ≠ò‰∏≠...';
  submitBtn.disabled = true;

  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    // Ëé∑ÂèñÂÆöÊó∂ÂèëÂ∏ÉÊó∂Èó¥
    const isScheduled = document.getElementById('editIsScheduled').checked;
    let publishedAt = null;
    if (isScheduled) {
      const publishedAtInput = document.getElementById('editPublishedAt').value;
      if (publishedAtInput) {
        // Â∞Ü datetime-local Ê†ºÂºèËΩ¨Êç¢‰∏∫ ISO 8601 Ê†ºÂºè
        publishedAt = new Date(publishedAtInput).toISOString();
      }
    }

    const response = await fetch(`/api/admin/passages?id=${articleId}`, {
      method: 'PUT',
      headers: headers,
      body: JSON.stringify({
        title: document.getElementById('editTitle').value,
        content: document.getElementById('editContent').value,
        author: document.getElementById('editAuthor').value,
        category: document.getElementById('editCategory').value,
        show_title: document.getElementById('editShowTitle').checked,
        tags: document.getElementById('editTags').value,
        status: document.getElementById('editStatus').value,
        visibility: document.getElementById('editVisibility').value,
        is_scheduled: isScheduled,
        published_at: publishedAt,
        cover_image: document.getElementById('editCoverImage').value || undefined
      })
    });

    const result = await response.json();

    if (result.success) {
      submitBtn.textContent = '‰øùÂ≠òÊàêÂäü!';
      submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';

      setTimeout(() => {
        closeModal('editModal');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';

        // Âà∑Êñ∞ÊñáÁ´†ÂàóË°®
        fetchAdminData();

        showToast('ÊñáÁ´†‰øÆÊîπÂ∑≤‰øùÂ≠òÔºÅ', 'success');
      }, 2000);
    } else {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      showToast('‰øùÂ≠òÂ§±Ë¥•Ôºö' + (result.message || 'Êú™Áü•ÈîôËØØ'), 'error');
    }
  } catch (error) {
    console.error('‰øùÂ≠òÊñáÁ´†Â§±Ë¥•:', error);
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
    showToast('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
  }
});

// ÂÆöÊó∂ÂèëÂ∏ÉÂ§çÈÄâÊ°Ü‰∫ã‰ª∂ÁõëÂê¨Âô®
document.getElementById('editIsScheduled').addEventListener('change', function(e) {
  const publishedAtGroup = document.getElementById('editPublishedAtGroup');
  const publishedAtInput = document.getElementById('editPublishedAt');

  if (e.target.checked) {
    // ÊòæÁ§∫ÂèëÂ∏ÉÊó∂Èó¥ËæìÂÖ•Ê°Ü
    publishedAtGroup.style.display = 'block';

    // Â¶ÇÊûúÊ≤°ÊúâËÆæÁΩÆÊó∂Èó¥ÔºåÈªòËÆ§ËÆæÁΩÆ‰∏∫ÊòéÂ§©Âêå‰∏ÄÊó∂Èó¥
    if (!publishedAtInput.value) {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const localDateTime = new Date(tomorrow.getTime() - tomorrow.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 16);
      publishedAtInput.value = localDateTime;
    }
  } else {
    // ÈöêËóèÂèëÂ∏ÉÊó∂Èó¥ËæìÂÖ•Ê°Ü
    publishedAtGroup.style.display = 'none';
    publishedAtInput.value = '';
  }
});

document.getElementById('userForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = 'ÂàõÂª∫‰∏≠...';
  submitBtn.disabled = true;

  const username = document.getElementById('userName').value.trim();
  const email = document.getElementById('userEmail').value.trim();
  const password = document.getElementById('userPassword').value;
  const role = document.getElementById('userRole').value;

  try {
    const response = await fetch('/api/register', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...getAuthHeaders()
      },
      body: JSON.stringify({
        username: username,
        email: email,
        password: password,
        role: role
      })
    });

    const result = await response.json();

    if (result.success) {
      showToast('Áî®Êà∑ÂàõÂª∫ÊàêÂäüÔºÅ', 'success');
      closeModal('userModal');
      this.reset();
      // ÈáçÊñ∞Âä†ËΩΩÁî®Êà∑ÂàóË°®
      fetchAdminData(currentPage, 10, currentUserPage, 10);
    } else {
      showToast(result.message || 'Áî®Êà∑ÂàõÂª∫Â§±Ë¥•', 'error');
    }
  } catch (error) {
    console.error('ÂàõÂª∫Áî®Êà∑Â§±Ë¥•:', error);
    showToast('ÂàõÂª∫Áî®Êà∑Â§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
  } finally {
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  }
});

// ÁºñËæëÁî®Êà∑Ë°®ÂçïÊèê‰∫§
document.getElementById('editUserForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const userId = this.dataset.userId;
  if (!userId) {
    showToast('Êó†Ê≥ïÁ°ÆÂÆöË¶ÅÁºñËæëÁöÑÁî®Êà∑', 'error');
    return;
  }

  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = '‰øùÂ≠ò‰∏≠...';
  submitBtn.disabled = true;

  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    // ÊûÑÂª∫Êõ¥Êñ∞Êï∞ÊçÆ
    const updates = {
      username: document.getElementById('editUserName').value,
      email: document.getElementById('editUserEmail').value,
      role: document.getElementById('editUserRole').value,
      status: document.getElementById('editUserStatus').value,
    };

    // Âè™ÊúâÂΩìÂØÜÁ†Å‰∏ç‰∏∫Á©∫Êó∂ÊâçÊõ¥Êñ∞ÂØÜÁ†Å
    const password = document.getElementById('editUserPassword').value;
    if (password) {
      updates.password = password;
    }

    const response = await fetch(`/api/admin/users?id=${userId}`, {
      method: 'PATCH',
      headers: headers,
      body: JSON.stringify(updates)
    });

    const result = await response.json();

    if (result.success) {
      submitBtn.textContent = '‰øùÂ≠òÊàêÂäü!';
      submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';

      setTimeout(() => {
        closeModal('editUserModal');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';

        // Âà∑Êñ∞Áî®Êà∑ÂàóË°®
        fetchAdminData();

        showToast('Áî®Êà∑‰øÆÊîπÂ∑≤‰øùÂ≠òÔºÅ', 'success');
      }, 2000);
    } else {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      showToast('‰øùÂ≠òÂ§±Ë¥•Ôºö' + (result.message || 'Êú™Áü•ÈîôËØØ'), 'error');
    }
  } catch (error) {
    console.error('‰øùÂ≠òÁî®Êà∑Â§±Ë¥•:', error);
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
    showToast('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
  }
});

// ÂàÜÁ±ªË°®ÂçïÊèê‰∫§
document.getElementById('categoryForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const categoryId = this.dataset.categoryId;
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = '‰øùÂ≠ò‰∏≠...';
  submitBtn.disabled = true;

  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const categoryData = {
      name: document.getElementById('categoryName').value,
      description: document.getElementById('categoryDescription').value,
      icon: document.getElementById('categoryIcon').value,
      sort_order: parseInt(document.getElementById('categorySortOrder').value) || 0,
      is_enabled: document.getElementById('categoryEnabled').checked,
    };

    let url = '/api/admin/categories';
    let method = 'POST';

    if (categoryId) {
      url += `?id=${categoryId}`;
      method = 'PUT';
    }

    const response = await fetch(url, {
      method: method,
      headers: headers,
      body: JSON.stringify(categoryData)
    });

    const result = await response.json();

    if (result.success) {
      submitBtn.textContent = '‰øùÂ≠òÊàêÂäü!';
      submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';

      setTimeout(() => {
        closeModal('categoryModal');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';
        this.reset();
        delete this.dataset.categoryId;

        // Âà∑Êñ∞ÂàÜÁ±ªÂíåÊ†áÁ≠æÂàóË°®
        loadCategoriesAndTags();

        showToast(categoryId ? 'ÂàÜÁ±ª‰øÆÊîπÂ∑≤‰øùÂ≠òÔºÅ' : 'ÂàÜÁ±ªÂàõÂª∫ÊàêÂäüÔºÅ', 'success');
      }, 2000);
    } else {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      showToast('‰øùÂ≠òÂ§±Ë¥•Ôºö' + (result.message || 'Êú™Áü•ÈîôËØØ'), 'error');
    }
  } catch (error) {
    console.error('‰øùÂ≠òÂàÜÁ±ªÂ§±Ë¥•:', error);
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
    showToast('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
  }
});

// Ê†áÁ≠æË°®ÂçïÊèê‰∫§
document.getElementById('tagForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const tagId = this.dataset.tagId;
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = '‰øùÂ≠ò‰∏≠...';
  submitBtn.disabled = true;

  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const tagData = {
      name: document.getElementById('tagName').value,
      description: document.getElementById('tagDescription').value,
      color: document.getElementById('tagColor').value,
      category_id: parseInt(document.getElementById('tagCategory').value) || 0,
      sort_order: parseInt(document.getElementById('tagSortOrder').value) || 0,
      is_enabled: document.getElementById('tagEnabled').checked,
    };

    let url = '/api/admin/tags';
    let method = 'POST';

    if (tagId) {
      url += `?id=${tagId}`;
      method = 'PUT';
    }

    const response = await fetch(url, {
      method: method,
      headers: headers,
      body: JSON.stringify(tagData)
    });

    const result = await response.json();

    if (result.success) {
      submitBtn.textContent = '‰øùÂ≠òÊàêÂäü!';
      submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';

      setTimeout(() => {
        closeModal('tagModal');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';
        this.reset();
        delete this.dataset.tagId;

        // Âà∑Êñ∞Ê†áÁ≠æÂàóË°®
        loadCategoriesAndTags();

        showToast(tagId ? 'Ê†áÁ≠æ‰øÆÊîπÂ∑≤‰øùÂ≠òÔºÅ' : 'Ê†áÁ≠æÂàõÂª∫ÊàêÂäüÔºÅ', 'success');
      }, 2000);
    } else {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      showToast('‰øùÂ≠òÂ§±Ë¥•Ôºö' + (result.message || 'Êú™Áü•ÈîôËØØ'), 'error');
    }
  } catch (error) {
    console.error('‰øùÂ≠òÊ†áÁ≠æÂ§±Ë¥•:', error);
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
    showToast('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
  }
});

// Êìç‰ΩúÊåâÈíÆÂäüËÉΩ
let currentAction = null;
let currentItemId = null;
let selectedAttachments = new Set();

// ÊåâÈíÆ‰∫ã‰ª∂ÁªëÂÆöÂú® bindActionButtons ÂáΩÊï∞‰∏≠Â§ÑÁêÜ

// Á°ÆËÆ§Êìç‰Ωú
document.getElementById('confirmAction').addEventListener('click', async function() {
  if (currentAction && currentItemId) {
    // Ê£ÄÊü•ÊòØÂê¶ÊòØÊâπÈáèÂà†Èô§Êìç‰Ωú
    if (currentAction.startsWith('batch-delete-')) {
      await handleBatchDelete(currentAction, currentItemId);
      return;
    }

    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    try {
      let apiUrl = '';
      if (currentAction === 'delete') {
        apiUrl = `/api/admin/passages?id=${currentItemId}`;
      } else if (currentAction === 'delete-comment') {
        apiUrl = `/api/admin/comments/${currentItemId}`;
      } else if (currentAction === 'delete-user') {
        apiUrl = `/api/admin/users?id=${currentItemId}`;
      } else if (currentAction === 'delete-category') {
        apiUrl = `/api/admin/categories?id=${currentItemId}`;
      } else if (currentAction === 'delete-tag') {
        apiUrl = `/api/admin/tags/${currentItemId}`;
      } else if (currentAction === 'delete-main-card') {
        apiUrl = `/api/about/main-cards/delete?id=${currentItemId}`;
      } else if (currentAction === 'delete-sub-card') {
        apiUrl = `/api/about/sub-cards/delete?id=${currentItemId}`;
      } else if (currentAction === 'delete-attachment') {
        apiUrl = `/api/admin/attachments/${currentItemId}`;
      } else if (currentAction === 'batch-delete-attachment') {
        // ÊâπÈáèÂà†Èô§ÈôÑ‰ª∂‰∏ç‰ΩøÁî® APIÔºåÁõ¥Êé•Âú®ÂÆ¢Êà∑Á´ØÂ§ÑÁêÜ
        const ids = currentItemId.split(',');
        let successCount = 0;
        let failCount = 0;

        for (const id of ids) {
          try {
            const response = await fetch(`/api/admin/attachments/${id}`, {
              method: 'DELETE'
            });
            const result = await response.json();

            if (result.success) {
              successCount++;
            } else {
              failCount++;
            }
          } catch (error) {
            console.error('Âà†Èô§Â§±Ë¥•:', error);
            failCount++;
          }
        }

        closeModal('confirmModal');
        if (successCount > 0) {
          showToast(`ÊàêÂäüÂà†Èô§ ${successCount} ‰∏™ÈôÑ‰ª∂`, 'success');
        }
        if (failCount > 0) {
          showToast(`${failCount} ‰∏™ÈôÑ‰ª∂Âà†Èô§Â§±Ë¥•`, 'error');
        }

        selectedAttachments.clear();
        updateBatchActions();
        loadAttachments();
        return;
      }

      const response = await fetch(apiUrl, {
        method: 'DELETE',
        headers: headers
      });

      const result = await response.json();

      if (result.success) {
        closeModal('confirmModal');
        showToast('Âà†Èô§ÊàêÂäüÔºÅ', 'success');
        // Âà∑Êñ∞Êï∞ÊçÆ
        if (currentAction === 'delete-category' || currentAction === 'delete-tag') {
          loadCategoriesAndTags();
        } else if (currentAction === 'delete-main-card') {
          loadMainCards();
          loadSubCards();
        } else if (currentAction === 'delete-sub-card') {
          loadSubCards();
        } else if (currentAction === 'delete-attachment') {
          selectedAttachments.delete(currentItemId);
          updateBatchActions();
          loadAttachments();
        } else {
          fetchAdminData();
        }
      } else {
        showToast('Âà†Èô§Â§±Ë¥•Ôºö' + (result.message || 'Êú™Áü•ÈîôËØØ'), 'error');
      }
    } catch (error) {
      console.error('Âà†Èô§Â§±Ë¥•:', error);
      alert('Âà†Èô§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
    }
  }
});

// Â§ÑÁêÜÊâπÈáèÂà†Èô§Êìç‰Ωú
async function handleBatchDelete(action, idsString) {
  const ids = idsString.split(',').map(id => parseInt(id.trim()));
  let apiUrl = '';
  let successMessage = '';
  let refreshFunction = null;

  switch (action) {
    case 'batch-delete-comments':
      apiUrl = '/api/admin/comments/batch-delete';
      successMessage = 'ÊâπÈáèÂà†Èô§ËØÑËÆ∫ÊàêÂäü';
      refreshFunction = () => {
        clearCommentSelection();
        fetchAdminData(currentPage, currentLimit, currentUserPage, currentUserLimit, currentCommentsPage, currentCommentsLimit);
      };
      break;
    case 'batch-delete-categories':
      apiUrl = '/api/admin/categories/batch-delete';
      successMessage = 'ÊâπÈáèÂà†Èô§ÂàÜÁ±ªÊàêÂäü';
      refreshFunction = () => {
        clearCategorySelection();
        loadCategoriesAndTags();
      };
      break;
    case 'batch-delete-tags':
      apiUrl = '/api/admin/tags/batch-delete';
      successMessage = 'ÊâπÈáèÂà†Èô§Ê†áÁ≠æÊàêÂäü';
      refreshFunction = () => {
        clearTagSelection();
        loadCategoriesAndTags();
      };
      break;
    case 'batch-delete-users':
      apiUrl = '/api/admin/users/batch-delete';
      successMessage = 'ÊâπÈáèÂà†Èô§Áî®Êà∑ÊàêÂäü';
      refreshFunction = () => {
        clearUserSelection();
        fetchAdminData(currentPage, 10, currentUserPage, 10);
      };
      break;
    case 'batch-delete-articles':
      apiUrl = '/api/admin/passages/batch-delete';
      successMessage = 'ÊâπÈáèÂà†Èô§ÊñáÁ´†ÊàêÂäü';
      refreshFunction = () => {
        clearSelection();
        fetchAdminData(currentPage, 10);
      };
      break;
    default:
      return;
  }

  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...getAuthHeaders()
      },
      body: JSON.stringify({ ids })
    });

    const result = await response.json();

    if (result.success) {
      closeModal('confirmModal');
      showToast(result.message || successMessage, 'success');
      if (refreshFunction) {
        refreshFunction();
      }
    } else {
      showToast(result.message || 'ÊâπÈáèÂà†Èô§Â§±Ë¥•', 'error');
    }
  } catch (error) {
    console.error('ÊâπÈáèÂà†Èô§Â§±Ë¥•:', error);
    showToast('ÊâπÈáèÂà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
  }
}

// ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', function(e) {
    if (e.target === this) {
      const modalId = this.id;
      closeModal(modalId);
    }
  });
});

// ESCÈîÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal.active').forEach(modal => {
      const modalId = modal.id;
      closeModal(modalId);
    });
  }
});
</script>

<!-- ÁôªÂΩïÊ®°ÊÄÅÊ°Ü -->
<div class="modal" id="loginModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Áî®Êà∑ÁôªÂΩï</h3>
      <button class="modal-close" data-modal="loginModal">√ó</button>
    </div>
    <div class="modal-body">
      <form id="loginForm">
        <div class="form-group">
          <label for="loginUsername">Áî®Êà∑Âêç</label>
          <input type="text" id="loginUsername" class="form-control" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç" required autocomplete="username">
        </div>
        <div class="form-group">
          <label for="loginPassword">ÂØÜÁ†Å</label>
          <input type="password" id="loginPassword" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" required autocomplete="current-password">
        </div>
        <div class="form-group" id="loginError" style="display: none; color: #e74c3c; font-size: 0.9em;"></div>
        <button type="submit" id="loginSubmitBtn" class="btn-primary" style="width: 100%;">ÁôªÂΩï</button>
      </form>
      <div style="margin-top: 20px; text-align: center; font-size: 0.9em;">
        <a href="#" id="openRegisterModal" style="color: #007bff; text-decoration: none;">ËøòÊ≤°ÊúâË¥¶Âè∑ÔºüÁ´ãÂç≥Ê≥®ÂÜå</a>
      </div>
    </div>
  </div>
</div>

<!-- Ê≥®ÂÜåÊ®°ÊÄÅÊ°Ü -->
<div class="modal" id="registerModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Áî®Êà∑Ê≥®ÂÜå</h3>
      <button class="modal-close" data-modal="registerModal">√ó</button>
    </div>
    <div class="modal-body">
      <form id="registerForm">
        <div class="form-group">
          <label for="registerUsername">Áî®Êà∑Âêç</label>
          <input type="text" id="registerUsername" class="form-control" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÔºà3-20‰∏™Â≠óÁ¨¶ÔºåÂ≠óÊØçÊï∞Â≠ó‰∏ãÂàíÁ∫øÔºâ" required autocomplete="username">
        </div>
        <div class="form-group">
          <label for="registerEmail">ÈÇÆÁÆ±</label>
          <input type="email" id="registerEmail" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±" required autocomplete="email">
        </div>
        <div class="form-group">
          <label for="registerPassword">ÂØÜÁ†Å</label>
          <input type="password" id="registerPassword" class="form-control" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†ÅÔºàËá≥Â∞ë6‰∏™Â≠óÁ¨¶Ôºâ" required autocomplete="new-password">
        </div>
        <div class="form-group" id="registerError" style="display: none; color: #e74c3c; font-size: 0.9em;"></div>
        <button type="submit" id="registerSubmitBtn" class="btn-primary" style="width: 100%;">Ê≥®ÂÜå</button>
      </form>
      <div style="margin-top: 20px; text-align: center; font-size: 0.9em;">
        <a href="#" id="openLoginModal" style="color: #007bff; text-decoration: none;">Â∑≤ÊúâË¥¶Âè∑ÔºüÁ´ãÂç≥ÁôªÂΩï</a>
      </div>
    </div>
  </div>
</div>

<!-- Ê®°ÊÄÅÊ°ÜÊ†∑Âºè -->
<style>
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 20px;
  max-width: 500px;
  width: 100%;
  animation: slideIn 0.3s ease;
  position: relative;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideIn {
  from { transform: translateY(-50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  background: rgba(0, 123, 255, 0.1);
  backdrop-filter: blur(40px) saturate(200%);
  -webkit-backdrop-filter: blur(40px) saturate(200%);
  border: 1px solid rgba(255, 255, 255, 0.5);
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  padding: 20px 30px;
  color: #007bff;
  border-radius: 20px 20px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  font-size: 1.5em;
  font-weight: 600;
}

.modal-close {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  font-size: 1.5em;
  cursor: pointer;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.modal-close:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: rotate(90deg);
}

.modal-body {
  padding: 30px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: rgba(255, 255, 255, 0.9);
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 12px 15px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 8px;
  font-size: 1em;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  color: rgba(255, 255, 255, 0.9);
  transition: all 0.3s ease;
}

.form-control:focus {
  outline: none;
  border-color: rgba(255, 255, 255, 0.5);
  background: rgba(0, 0, 0, 0);
}

.btn-primary {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  padding: 12px 30px;
  border-radius: 8px;
  font-size: 1em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-primary:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.btn-primary:disabled:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.3);
  transform: none;
}

.btn-danger {
  background: rgba(231, 76, 60, 0.2);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(231, 76, 60, 0.4);
  color: rgba(255, 255, 255, 0.95);
  padding: 12px 30px;
  border-radius: 8px;
  font-size: 1em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(231, 76, 60, 0.2);
}

.btn-danger:hover {
  background: rgba(231, 76, 60, 0.35);
  border-color: rgba(231, 76, 60, 0.6);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
}

.btn-danger:active {
  transform: translateY(0);
  box-shadow: 0 2px 10px rgba(231, 76, 60, 0.2);
}

.btn-danger:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.btn-danger:disabled:hover {
  background: rgba(231, 76, 60, 0.2);
  border-color: rgba(231, 76, 60, 0.4);
  transform: none;
  box-shadow: none;
}
</style>

<script>
// ËÆæÁΩÆÁõ∏ÂÖ≥ÂäüËÉΩ
let originalAppearanceSettings = {};

// Âä†ËΩΩËÆæÁΩÆ
async function loadSettings() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/settings/appearance', {
      headers: headers
    });

    if (response.ok) {
      const settings = await response.json();

      // ‰øùÂ≠òÂéüÂßãËÆæÁΩÆÂÄº
      originalAppearanceSettings = { ...settings };

      // Â°´ÂÖÖË°®Âçï
      document.getElementById('backgroundImage').value = settings.background_image || '/img/test.webp';
      document.getElementById('mobileBackgroundImage').value = settings.mobile_background_image || '/img/mobile-test.webp';
      document.getElementById('globalOpacity').value = settings.global_opacity || '0.15';
      document.getElementById('opacityValue').textContent = settings.global_opacity || '0.15';
      document.getElementById('backgroundSize').value = settings.background_size || 'cover';
      document.getElementById('backgroundPosition').value = settings.background_position || 'center';
      document.getElementById('backgroundRepeat').value = settings.background_repeat || 'no-repeat';
      document.getElementById('backgroundAttachment').value = settings.background_attachment || 'fixed';
      document.getElementById('blurAmount').value = settings.blur_amount || '20px';
      document.getElementById('saturateAmount').value = settings.saturate_amount || '180%';
      document.getElementById('darkModeEnabled').checked = settings.dark_mode_enabled || false;
      document.getElementById('navbarGlassColor').value = settings.navbar_glass_color || 'rgba(255, 255, 255, 0.85)';
      document.getElementById('navbarTextColor').value = settings.navbar_text_color || '#333333';
      document.getElementById('cardGlassColor').value = settings.card_glass_color || 'rgba(255, 255, 255, 0.75)';
      document.getElementById('footerGlassColor').value = settings.footer_glass_color || 'rgba(255, 255, 255, 0.9)';
      document.getElementById('floatingTextEnabled').checked = settings.floating_text_enabled || false;
      document.getElementById('floatingTexts').value = settings.floating_texts && Array.isArray(settings.floating_texts) ? settings.floating_texts.join(', ') : 'perfect, good, excellent, extraordinary, legend';

      // Êõ¥Êñ∞È¢úËâ≤ÈÄâÊã©Âô®
      updateColorPickers();

      // Â∫îÁî®ÊöóËâ≤Ê®°Âºè
      applyDarkMode(settings.dark_mode_enabled || false);

      // Â∫îÁî®ÊØõÁéªÁíÉÈ¢úËâ≤
      applyGlassColors(settings.navbar_glass_color, settings.card_glass_color, settings.footer_glass_color);

      // Êõ¥Êñ∞È¢ÑËßà
      updatePreview();
    } else {
      console.error('Âä†ËΩΩËÆæÁΩÆÂ§±Ë¥•:', response.statusText);
    }
  } catch (error) {
    console.error('Âä†ËΩΩËÆæÁΩÆÂ§±Ë¥•:', error);
  }
}

// ‰øùÂ≠òËÆæÁΩÆ
async function saveSettings() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    // Ëé∑ÂèñÂΩìÂâçË°®ÂçïÂÄº
    const currentSettings = {
      background_image: document.getElementById('backgroundImage').value,
      mobile_background_image: document.getElementById('mobileBackgroundImage').value,
      global_opacity: document.getElementById('globalOpacity').value,
      background_size: document.getElementById('backgroundSize').value,
      background_position: document.getElementById('backgroundPosition').value,
      background_repeat: document.getElementById('backgroundRepeat').value,
      background_attachment: document.getElementById('backgroundAttachment').value,
      blur_amount: document.getElementById('blurAmount').value,
      saturate_amount: document.getElementById('saturateAmount').value,
      dark_mode_enabled: document.getElementById('darkModeEnabled').checked,
      navbar_glass_color: document.getElementById('navbarGlassColor').value,
      navbar_text_color: document.getElementById('navbarTextColor').value,
      card_glass_color: document.getElementById('cardGlassColor').value,
      footer_glass_color: document.getElementById('footerGlassColor').value,
      floating_text_enabled: document.getElementById('floatingTextEnabled').checked,
      floating_texts: document.getElementById('floatingTexts').value.split(',').map(s => s.trim()).filter(s => s.length > 0)
    };

    // Âè™ÂèëÈÄÅÂèëÁîüÂèòÂåñÁöÑÂ≠óÊÆµ
    const changedSettings = {};
    for (const key in currentSettings) {
      const originalValue = originalAppearanceSettings[key];
      const currentValue = currentSettings[key];

      // Ë∞ÉËØïÊØè‰∏™Â≠óÊÆµÁöÑÊØîÂØπ
      if (key === 'navbar_text_color') {
        console.log('navbar_text_color ÊØîÂØπ:');
        console.log('  ÂéüÂßãÂÄº:', originalValue, '(Á±ªÂûã:', typeof originalValue, ')');
        console.log('  ÂΩìÂâçÂÄº:', currentValue, '(Á±ªÂûã:', typeof currentValue, ')');
        console.log('  ÊòØÂê¶Áõ∏Á≠â:', currentValue === originalValue);
      }

      if (currentValue !== originalValue) {
        changedSettings[key] = currentValue;
      }
    }

    // Ë∞ÉËØï‰ø°ÊÅØ
    console.log('ÂéüÂßãËÆæÁΩÆ:', originalAppearanceSettings);
    console.log('ÂΩìÂâçËÆæÁΩÆ:', currentSettings);
    console.log('ÂèòÊõ¥ËÆæÁΩÆ:', changedSettings);

    // Â¶ÇÊûúÊ≤°ÊúâÂèòÂåñÔºåÊèêÁ§∫Áî®Êà∑
    if (Object.keys(changedSettings).length === 0) {
      showToast('Ê≤°ÊúâÊ£ÄÊµãÂà∞‰ªª‰ΩïÂèòÂåñ', 'warning');
      return;
    }

    console.log('ÂèëÈÄÅÂèòÊõ¥ÁöÑÂ§ñËßÇÂ≠óÊÆµ:', changedSettings);

    const response = await fetch('/api/settings/appearance', {
      method: 'PATCH',
      headers: headers,
      body: JSON.stringify(changedSettings)
    });

    if (response.ok) {
      showToast('ËÆæÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅ', 'success');
      // Êõ¥Êñ∞ÂéüÂßãËÆæÁΩÆÂÄº
      Object.assign(originalAppearanceSettings, changedSettings);

      // Â¶ÇÊûúÊöóËâ≤Ê®°ÂºèËÆæÁΩÆÊúâÂèòÂåñÔºåÂ∫îÁî®Êñ∞ËÆæÁΩÆ
      if ('dark_mode_enabled' in changedSettings) {
        applyDarkMode(changedSettings.dark_mode_enabled);
      }

      updatePreview();
    } else {
      const result = await response.json();
      showToast('‰øùÂ≠òÂ§±Ë¥•Ôºö' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
    }
  } catch (error) {
    console.error('‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•:', error);
    showToast('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
  }
}

// ÈáçÁΩÆËÆæÁΩÆ
function resetSettings() {
  if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆ‰∏∫ÈªòËÆ§ËÆæÁΩÆÂêóÔºü')) {
    document.getElementById('backgroundImage').value = '/img/test.webp';
    document.getElementById('globalOpacity').value = '0.15';
    document.getElementById('opacityValue').textContent = '0.15';
    document.getElementById('backgroundSize').value = 'cover';
    document.getElementById('backgroundPosition').value = 'center';
    document.getElementById('backgroundRepeat').value = 'no-repeat';
    document.getElementById('backgroundAttachment').value = 'fixed';
    document.getElementById('blurAmount').value = '20px';
    document.getElementById('saturateAmount').value = '180%';
    document.getElementById('darkModeEnabled').checked = false;
    document.getElementById('navbarGlassColor').value = 'rgba(255, 255, 255, 0.85)';
    document.getElementById('navbarTextColor').value = '#333333';
    document.getElementById('cardGlassColor').value = 'rgba(255, 255, 255, 0.75)';
    document.getElementById('footerGlassColor').value = 'rgba(255, 255, 255, 0.9)';
      document.getElementById('floatingTextEnabled').checked = false;
      document.getElementById('floatingTexts').value = 'perfect, good, excellent, extraordinary, legend';
    updateColorPickers();
    applyDarkMode(false);
    applyGlassColors('rgba(255, 255, 255, 0.85)', 'rgba(255, 255, 255, 0.75)', 'rgba(255, 255, 255, 0.9)');
    updatePreview();
  }
}

// Êõ¥Êñ∞È¢ÑËßà
function updatePreview() {
  const previewBox = document.getElementById('previewBox');
  if (!previewBox) return;

  const backgroundImage = document.getElementById('backgroundImage').value;
  const mobileBackgroundImage = document.getElementById('mobileBackgroundImage').value;
  const globalOpacity = document.getElementById('globalOpacity').value;
  const backgroundSize = document.getElementById('backgroundSize').value;
  const backgroundPosition = document.getElementById('backgroundPosition').value;
  const backgroundRepeat = document.getElementById('backgroundRepeat').value;
  const backgroundAttachment = document.getElementById('backgroundAttachment').value;
  const blurAmount = document.getElementById('blurAmount').value;
  const saturateAmount = document.getElementById('saturateAmount').value;

  // ÂìçÂ∫îÂºèÈÄâÊã©ËÉåÊôØÂõæÁâá
  const isMobile = window.innerWidth <= 768;
  const currentBackgroundImage = isMobile && mobileBackgroundImage ? mobileBackgroundImage : backgroundImage;

  // Êõ¥Êñ∞È¢ÑËßàÊ°ÜÁöÑÊ†∑Âºè
  previewBox.style.backgroundImage = `url('${currentBackgroundImage}')`;
  previewBox.style.backgroundSize = backgroundSize;
  previewBox.style.backgroundPosition = backgroundPosition;
  previewBox.style.backgroundRepeat = backgroundRepeat;
  previewBox.style.backgroundAttachment = backgroundAttachment;

  // Êõ¥Êñ∞::before‰º™ÂÖÉÁ¥†ÁöÑÊ†∑ÂºèÔºàÈÄöËøáCSSÂèòÈáèÔºâ
  previewBox.style.setProperty('--blur-amount', blurAmount);
  previewBox.style.setProperty('--saturate-amount', saturateAmount);
  previewBox.style.setProperty('--global-opacity', globalOpacity);

  // Êõ¥Êñ∞È¢ÑËßàÊ°ÜÁöÑËÉåÊôØÂ±Ç
  const beforeElement = document.createElement('style');
  beforeElement.textContent = `
    #previewBox::before {
      background-image: url('${currentBackgroundImage}') !important;
      background-size: ${backgroundSize} !important;
      background-position: ${backgroundPosition} !important;
      background-repeat: ${backgroundRepeat} !important;
      background-attachment: ${backgroundAttachment} !important;
      filter: blur(${blurAmount}) saturate(${saturateAmount}) !important;
    }
    #previewBox {
      background: rgba(255, 255, 255, ${globalOpacity}) !important;
      backdrop-filter: blur(${blurAmount}) saturate(${saturateAmount}) !important;
      -webkit-backdrop-filter: blur(${blurAmount}) saturate(${saturateAmount}) !important;
    }
  `;

  // ÁßªÈô§ÊóßÁöÑÊ†∑Âºè
  const oldStyle = document.getElementById('preview-style');
  if (oldStyle) {
    oldStyle.remove();
  }

  beforeElement.id = 'preview-style';
  document.head.appendChild(beforeElement);
}

// Â∫îÁî®ÊöóËâ≤Ê®°Âºè
function applyDarkMode(enabled) {
  if (enabled) {
    document.documentElement.classList.add('dark-mode');
  } else {
    document.documentElement.classList.remove('dark-mode');
  }
}

// Êõ¥Êñ∞È¢úËâ≤ÈÄâÊã©Âô®
function updateColorPickers() {
  const navbarColor = document.getElementById('navbarGlassColor').value;
  const navbarTextColor = document.getElementById('navbarTextColor').value;
  const cardColor = document.getElementById('cardGlassColor').value;
  const footerColor = document.getElementById('footerGlassColor').value;

  // Ëß£Êûê rgba Âπ∂Êõ¥Êñ∞È¢úËâ≤ÈÄâÊã©Âô®
  if (navbarColor.startsWith('rgba')) {
    const rgba = parseRgba(navbarColor);
    if (rgba) {
      document.getElementById('navbarGlassColorPicker').value = rgbaToHex(rgba.r, rgba.g, rgba.b);
    }
  }

  // Êõ¥Êñ∞ÂØºËà™Ê†èÊñáÂ≠óÈ¢úËâ≤ÈÄâÊã©Âô®ÔºàÊîØÊåÅ hex Âíå rgb Ê†ºÂºèÔºâ
  if (navbarTextColor.startsWith('#')) {
    document.getElementById('navbarTextColorPicker').value = navbarTextColor;
  } else if (navbarTextColor.startsWith('rgb')) {
    const rgb = parseRgba(navbarTextColor);
    if (rgb) {
      document.getElementById('navbarTextColorPicker').value = rgbaToHex(rgb.r, rgb.g, rgb.b);
    }
  }

  if (cardColor.startsWith('rgba')) {
    const rgba = parseRgba(cardColor);
    if (rgba) {
      document.getElementById('cardGlassColorPicker').value = rgbaToHex(rgba.r, rgba.g, rgba.b);
    }
  }

  if (footerColor.startsWith('rgba')) {
    const rgba = parseRgba(footerColor);
    if (rgba) {
      document.getElementById('footerGlassColorPicker').value = rgbaToHex(rgba.r, rgba.g, rgba.b);
    }
  }
}

// Â∫îÁî®ÊØõÁéªÁíÉÈ¢úËâ≤
function applyGlassColors(navbarColor, cardColor, footerColor) {
  // ËÆæÁΩÆ CSS ÂèòÈáè
  document.documentElement.style.setProperty('--navbar-glass-color', navbarColor);
  document.documentElement.style.setProperty('--card-glass-color', cardColor);
  document.documentElement.style.setProperty('--footer-glass-color', footerColor);
}

// Ëß£Êûê rgba Â≠óÁ¨¶‰∏≤
function parseRgba(rgbaStr) {
  const match = rgbaStr.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);
  if (match) {
    return {
      r: parseInt(match[1]),
      g: parseInt(match[2]),
      b: parseInt(match[3]),
      a: match[4] ? parseFloat(match[4]) : 1
    };
  }
  return null;
}

// Â∞Ü RGB ËΩ¨Êç¢‰∏∫ Hex
function rgbaToHex(r, g, b) {
  const toHex = (n) => {
    const hex = n.toString(16);
    return hex.length === 1 ? '0' + hex : hex;
  };
  return '#' + toHex(r) + toHex(g) + toHex(b);
}

// ÈÄèÊòéÂ∫¶ÊªëÂùóÂèòÂåñ‰∫ã‰ª∂

document.addEventListener('DOMContentLoaded', async function() {

  // È°µÈù¢Âä†ËΩΩÊó∂Ëá™Âä®Âä†ËΩΩËÆæÁΩÆ

  await loadSettings();

  await loadTemplateSettings();

  await loadMusicSettings();

  await loadMusicPlaylist();

  const opacitySlider = document.getElementById('globalOpacity');

  const opacityValue = document.getElementById('opacityValue');

  if (opacitySlider && opacityValue) {
    opacitySlider.addEventListener('input', function() {
      opacityValue.textContent = this.value;
      updatePreview();
    });
  }

  // ‰øùÂ≠òÂ§ñËßÇËÆæÁΩÆÊåâÈíÆ
  const saveBtn = document.getElementById('saveSettingsBtn');
  if (saveBtn) {
    saveBtn.addEventListener('click', saveSettings);
  }

  // ‰øùÂ≠òÊ®°ÊùøËÆæÁΩÆÊåâÈíÆ
  const saveTemplateBtn = document.getElementById('saveTemplateSettingsBtn');
  if (saveTemplateBtn) {
    saveTemplateBtn.addEventListener('click', saveTemplateSettings);
  }

  // ‰øùÂ≠òÈü≥‰πêËÆæÁΩÆÊåâÈíÆ
  const saveMusicSettingsBtn = document.getElementById('saveMusicSettingsBtn');
  if (saveMusicSettingsBtn) {
    saveMusicSettingsBtn.addEventListener('click', saveMusicSettings);
  }

  // ÂàùÂßãÂåñÈü≥‰πêÊãñÊãΩ‰∏ä‰º†ÂäüËÉΩ
  initMusicDragDrop();

  // Èü≥‰πêÊí≠ÊîæÂô®È¢úËâ≤ÈÄâÊã©Âô®
  const musicPlayerColorPicker = document.getElementById('musicPlayerColorPicker');
  const musicPlayerColorInput = document.getElementById('musicPlayerColor');
  if (musicPlayerColorPicker && musicPlayerColorInput) {
    musicPlayerColorPicker.addEventListener('input', function() {
      const currentRgba = musicPlayerColorInput.value;
      const rgba = parseRgba(currentRgba);
      if (rgba) {
        const newRgba = `rgba(${this.value.match(/\w\w/g).map(x => parseInt(x, 16)).join(', ')}, ${rgba.a})`;
        musicPlayerColorInput.value = newRgba;
      }
    });
  }

  // Live2D ÂêØÁî®/Á¶ÅÁî®ÂàáÊç¢
  const live2dEnabled = document.getElementById('live2dEnabled');
  const live2dConfig = document.getElementById('live2dConfig');
  if (live2dEnabled && live2dConfig) {
    live2dEnabled.addEventListener('change', function() {
      live2dConfig.style.display = this.checked ? 'block' : 'none';
    });
  }

  // ÈáçÁΩÆËÆæÁΩÆÊåâÈíÆ
  const resetBtn = document.getElementById('resetSettingsBtn');
  if (resetBtn) {
    resetBtn.addEventListener('click', resetSettings);
  }

  // È¢úËâ≤ÈÄâÊã©Âô®‰∫ã‰ª∂ÁõëÂê¨
  const colorPickers = [
    { picker: 'navbarGlassColorPicker', input: 'navbarGlassColor' },
    { picker: 'navbarTextColorPicker', input: 'navbarTextColor' },
    { picker: 'cardGlassColorPicker', input: 'cardGlassColor' },
    { picker: 'footerGlassColorPicker', input: 'footerGlassColor' }
  ];

  colorPickers.forEach(({ picker, input }) => {
    const pickerEl = document.getElementById(picker);
    const inputEl = document.getElementById(input);

    if (pickerEl && inputEl) {
      pickerEl.addEventListener('input', function() {
        const currentValue = inputEl.value;

        // Âà§Êñ≠ÂΩìÂâçÂÄºÊòØ rgba Ê†ºÂºèËøòÊòØ hex Ê†ºÂºè
        if (currentValue.startsWith('rgba')) {
          // rgba Ê†ºÂºèÔºö‰øùÊåÅÈÄèÊòéÂ∫¶ÔºåÂè™Êõ¥Êñ∞È¢úËâ≤
          const rgba = parseRgba(currentValue);
          if (rgba) {
            const newRgba = `rgba(${this.value.match(/\w\w/g).map(x => parseInt(x, 16)).join(', ')}, ${rgba.a})`;
            inputEl.value = newRgba;
          }
        } else {
          // hex Ê†ºÂºèÊàñÊôÆÈÄöÊñáÊú¨ÔºöÁõ¥Êé•Êõ¥Êñ∞‰∏∫ hex ÂÄº
          inputEl.value = this.value;
        }
      });

      inputEl.addEventListener('input', function() {
        updateColorPickers();
      });
    }
  });

  // ÁõëÂê¨ÊâÄÊúâËÆæÁΩÆËæìÂÖ•ÁöÑÂèòÂåñÔºåÂÆûÊó∂Êõ¥Êñ∞È¢ÑËßà
  const settingInputs = [
    'backgroundImage', 'mobileBackgroundImage', 'backgroundSize', 'backgroundPosition',
    'backgroundRepeat', 'backgroundAttachment', 'blurAmount', 'saturateAmount'
  ];

  settingInputs.forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.addEventListener('input', updatePreview);
      input.addEventListener('change', updatePreview);
    }
  });

  // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñÔºåÊõ¥Êñ∞ÂìçÂ∫îÂºèËÉåÊôØÂõæÁâá
  window.addEventListener('resize', updatePreview);

  // ÂΩìÂàáÊç¢Âà∞ËÆæÁΩÆÊ†áÁ≠æÈ°µÊó∂Âä†ËΩΩËÆæÁΩÆ
  const settingsTab = document.querySelector('[data-tab="settings"]');
  if (settingsTab) {
    settingsTab.addEventListener('click', function() {
      loadSettings();
      loadTemplateSettings();
    });
  }
});

// Â≠òÂÇ®ÂéüÂßãÊ®°ÊùøËÆæÁΩÆÂÄºÔºåÁî®‰∫éÊØîÂØπÂ∑ÆÂºÇ
let originalTemplateSettings = {};

// Âä†ËΩΩÊ®°ÊùøËÆæÁΩÆ
async function loadTemplateSettings() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/settings/template', {
      method: 'GET',
      headers: headers
    });

    if (response.ok) {
      const settings = await response.json();

      // ‰øùÂ≠òÂéüÂßãËÆæÁΩÆÂÄº
      originalTemplateSettings = { ...settings };

      // Â°´ÂÖÖË°®Âçï
      document.getElementById('templateName').value = settings.name || '';
      document.getElementById('templateGreting').value = settings.greting || '';
      document.getElementById('templateYear').value = settings.year || '';
      document.getElementById('templateFoodes').value = settings.foodes || '';
      document.getElementById('globalAvatar').value = settings.global_avatar || '/img/avatar.webp';

      // Â°´ÂÖÖÊñáÁ´†Ê†áÈ¢òËÆæÁΩÆ
      document.getElementById('templateArticleTitle').checked = settings.article_title || false;
      document.getElementById('templateArticleTitlePrefix').value = settings.article_title_prefix || '';

      // Â°´ÂÖÖÂàáÊç¢ÁïåÈù¢ÊèêÁ§∫ËÆæÁΩÆ
      document.getElementById('templateSwitchNotice').checked = settings.switch_notice || false;
      document.getElementById('templateSwitchNoticeText').value = settings.switch_notice_text || '';

      // Â°´ÂÖÖÂ§ñÈÉ®ÈìæÊé•ËÆæÁΩÆ
      document.getElementById('externalLinkWarning').checked = settings.external_link_warning || false;
      document.getElementById('externalLinkWhitelist').value = settings.external_link_whitelist || '';
      document.getElementById('externalLinkWarningText').value = settings.external_link_warning_text || '';

      // Â°´ÂÖÖ Live2D ËÆæÁΩÆ
      document.getElementById('live2dEnabled').checked = settings.live2d_enabled || false;
      document.getElementById('live2dShowOnIndex').checked = settings.live2d_show_on_index !== false;
      document.getElementById('live2dShowOnPassage').checked = settings.live2d_show_on_passage !== false;
      document.getElementById('live2dShowOnCollect').checked = settings.live2d_show_on_collect !== false;
      document.getElementById('live2dShowOnAbout').checked = settings.live2d_show_on_about !== false;
      document.getElementById('live2dShowOnAdmin').checked = settings.live2d_show_on_admin || false;
      document.getElementById('live2dModelId').value = settings.live2d_model_id || '1';
      document.getElementById('live2dModelPath').value = settings.live2d_model_path || '';
      document.getElementById('live2dCDNPath').value = settings.live2d_cdn_path || 'https://unpkg.com/live2d-widget-model@1.0.5/';
      document.getElementById('live2dPosition').value = settings.live2d_position || 'right';
      document.getElementById('live2dWidth').value = settings.live2d_width || '280px';
      document.getElementById('live2dHeight').value = settings.live2d_height || '250px';

      // ÊòæÁ§∫/ÈöêËóè Live2D ËØ¶ÁªÜÈÖçÁΩÆ
      const live2dConfig = document.getElementById('live2dConfig');
      live2dConfig.style.display = settings.live2d_enabled ? 'block' : 'none';

      // Â°´ÂÖÖËµûÂä©ËÆæÁΩÆ
      document.getElementById('sponsorEnabled').checked = settings.sponsor_enabled || false;
      document.getElementById('sponsorTitle').value = settings.sponsor_title || 'ÊÑüË∞¢ÊÇ®ÁöÑÊîØÊåÅ';
      document.getElementById('sponsorImage').value = settings.sponsor_image || '/img/avatar.webp';
      document.getElementById('sponsorDescription').value = settings.sponsor_description || 'Â¶ÇÊûúÊÇ®ËßâÂæóËøô‰∏™ÂçöÂÆ¢ÂØπÊÇ®ÊúâÂ∏ÆÂä©ÔºåÊ¨¢ËøéËµûÂä©ÊîØÊåÅÔºÅ';
      document.getElementById('sponsorButtonText').value = settings.sponsor_button_text || '‚ù§Ô∏è ËµûÂä©ÊîØÊåÅ';
    } else {
      console.error('Âä†ËΩΩÊ®°ÊùøËÆæÁΩÆÂ§±Ë¥•');
    }
  } catch (error) {
    console.error('Âä†ËΩΩÊ®°ÊùøËÆæÁΩÆÂ§±Ë¥•:', error);
  }
}

// ‰øùÂ≠òÊ®°ÊùøËÆæÁΩÆ
async function saveTemplateSettings() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    // Ëé∑ÂèñÂΩìÂâçË°®ÂçïÂÄº
    const currentSettings = {
      name: document.getElementById('templateName').value,
      greting: document.getElementById('templateGreting').value,
      year: document.getElementById('templateYear').value,
      foodes: document.getElementById('templateFoodes').value,
      global_avatar: document.getElementById('globalAvatar').value,
      article_title: document.getElementById('templateArticleTitle').checked,
      article_title_prefix: document.getElementById('templateArticleTitlePrefix').value,
      switch_notice: document.getElementById('templateSwitchNotice').checked,
      switch_notice_text: document.getElementById('templateSwitchNoticeText').value,
      external_link_warning: document.getElementById('externalLinkWarning').checked,
      external_link_whitelist: document.getElementById('externalLinkWhitelist').value,
      external_link_warning_text: document.getElementById('externalLinkWarningText').value,
      live2d_enabled: document.getElementById('live2dEnabled').checked,
      live2d_show_on_index: document.getElementById('live2dShowOnIndex').checked,
      live2d_show_on_passage: document.getElementById('live2dShowOnPassage').checked,
      live2d_show_on_collect: document.getElementById('live2dShowOnCollect').checked,
      live2d_show_on_about: document.getElementById('live2dShowOnAbout').checked,
      live2d_show_on_admin: document.getElementById('live2dShowOnAdmin').checked,
      live2d_model_id: document.getElementById('live2dModelId').value,
      live2d_model_path: document.getElementById('live2dModelPath').value,
      live2d_cdn_path: document.getElementById('live2dCDNPath').value,
      live2d_position: document.getElementById('live2dPosition').value,
      live2d_width: document.getElementById('live2dWidth').value,
      live2d_height: document.getElementById('live2dHeight').value,
      sponsor_enabled: document.getElementById('sponsorEnabled').checked,
      sponsor_title: document.getElementById('sponsorTitle').value,
      sponsor_image: document.getElementById('sponsorImage').value,
      sponsor_description: document.getElementById('sponsorDescription').value,
      sponsor_button_text: document.getElementById('sponsorButtonText').value
    };

    // Âè™ÂèëÈÄÅÂèëÁîüÂèòÂåñÁöÑÂ≠óÊÆµ
    const changedSettings = {};
    for (const key in currentSettings) {
      if (currentSettings[key] !== originalTemplateSettings[key]) {
        changedSettings[key] = currentSettings[key];
      }
    }

    // Â¶ÇÊûúÊ≤°ÊúâÂèòÂåñÔºåÊèêÁ§∫Áî®Êà∑
    if (Object.keys(changedSettings).length === 0) {
      showToast('Ê≤°ÊúâÊ£ÄÊµãÂà∞‰ªª‰ΩïÂèòÂåñ', 'warning');
      return;
    }

    console.log('ÂèëÈÄÅÂèòÊõ¥ÁöÑÂ≠óÊÆµ:', changedSettings);

    const response = await fetch('/api/settings/template', {
      method: 'PATCH',
      headers: headers,
      body: JSON.stringify(changedSettings)
    });

    if (response.ok) {
      showToast('Ê®°ÊùøËÆæÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅ', 'success');
      // Êõ¥Êñ∞ÂéüÂßãËÆæÁΩÆÂÄº
      Object.assign(originalTemplateSettings, changedSettings);
    } else {
      const result = await response.json();
      showToast('‰øùÂ≠òÂ§±Ë¥•Ôºö' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
    }
  } catch (error) {
    console.error('‰øùÂ≠òÊ®°ÊùøËÆæÁΩÆÂ§±Ë¥•:', error);
    showToast('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
  }
}

// Â≠òÂÇ®ÂéüÂßãÈü≥‰πêËÆæÁΩÆÂÄº
let originalMusicSettings = {};

// Âä†ËΩΩÈü≥‰πêËÆæÁΩÆ
async function loadMusicSettings() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/settings/music', {
      method: 'GET',
      headers: headers
    });

    if (response.ok) {
      const settings = await response.json();

      // ‰øùÂ≠òÂéüÂßãËÆæÁΩÆÂÄº
      originalMusicSettings = { ...settings };

      // Â°´ÂÖÖË°®Âçï
      document.getElementById('musicEnabled').checked = settings.enabled || false;
      document.getElementById('musicAutoPlay').checked = settings.auto_play || false;
      document.getElementById('musicControlSize').value = settings.control_size || 'medium';
      document.getElementById('musicPlayerColor').value = settings.player_color || 'rgba(66, 133, 244, 0.9)';
      document.getElementById('musicPosition').value = settings.position || 'bottom-right';
      document.getElementById('musicCustomCSS').value = settings.custom_css || '';

      // Êõ¥Êñ∞È¢úËâ≤ÈÄâÊã©Âô®
      const playerColor = settings.player_color || 'rgba(66, 133, 244, 0.9)';
      const rgba = parseRgba(playerColor);
      if (rgba) {
        document.getElementById('musicPlayerColorPicker').value = rgbaToHex(rgba.r, rgba.g, rgba.b);
      }
    } else {
      console.error('Âä†ËΩΩÈü≥‰πêËÆæÁΩÆÂ§±Ë¥•');
    }
  } catch (error) {
    console.error('Âä†ËΩΩÈü≥‰πêËÆæÁΩÆÂ§±Ë¥•:', error);
  }
}

// ‰øùÂ≠òÈü≥‰πêËÆæÁΩÆ
async function saveMusicSettings() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    // Ëé∑ÂèñÂΩìÂâçË°®ÂçïÂÄº
    const currentSettings = {
      enabled: document.getElementById('musicEnabled').checked,
      auto_play: document.getElementById('musicAutoPlay').checked,
      control_size: document.getElementById('musicControlSize').value,
      player_color: document.getElementById('musicPlayerColor').value,
      position: document.getElementById('musicPosition').value,
      custom_css: document.getElementById('musicCustomCSS').value
    };

    // Âè™ÂèëÈÄÅÂèëÁîüÂèòÂåñÁöÑÂ≠óÊÆµ
    const changedSettings = {};
    for (const key in currentSettings) {
      if (currentSettings[key] !== originalMusicSettings[key]) {
        changedSettings[key] = currentSettings[key];
      }
    }

    // Â¶ÇÊûúÊ≤°ÊúâÂèòÂåñÔºåÊèêÁ§∫Áî®Êà∑
    if (Object.keys(changedSettings).length === 0) {
      showToast('Ê≤°ÊúâÊ£ÄÊµãÂà∞‰ªª‰ΩïÂèòÂåñ', 'warning');
      return;
    }

    console.log('ÂèëÈÄÅÂèòÊõ¥ÁöÑÈü≥‰πêËÆæÁΩÆÂ≠óÊÆµ:', changedSettings);

    const response = await fetch('/api/settings/music', {
      method: 'PATCH',
      headers: headers,
      body: JSON.stringify(changedSettings)
    });

    if (response.ok) {
      showToast('Èü≥‰πêËÆæÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅ', 'success');
      // Êõ¥Êñ∞ÂéüÂßãËÆæÁΩÆÂÄº
      Object.assign(originalMusicSettings, changedSettings);
    } else {
      const result = await response.json();
      showToast('‰øùÂ≠òÂ§±Ë¥•Ôºö' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
    }
  } catch (error) {
    console.error('‰øùÂ≠òÈü≥‰πêËÆæÁΩÆÂ§±Ë¥•:', error);
    showToast('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
  }
}

// Èü≥‰πêÊñá‰ª∂‰∏ä‰º†ÈòüÂàóÁÆ°ÁêÜ
let musicUploadQueue = [];
let isUploading = false;
let uploadAbortController = null;

// ÂàùÂßãÂåñÈü≥‰πêÊãñÊãΩ‰∏ä‰º†ÂäüËÉΩ
function initMusicDragDrop() {
  const dropZone = document.getElementById('musicDropZone');
  const fileInput = document.getElementById('musicFileUpload');
  const browseLink = document.querySelector('.browse-link');

  if (!dropZone || !fileInput) return;

  // ÁÇπÂáª‰∏ä‰º†Âå∫ÂüüËß¶ÂèëÊñá‰ª∂ÈÄâÊã©
  dropZone.addEventListener('click', () => {
    fileInput.click();
  });

  // ÁÇπÂáª"ÁÇπÂáªÈÄâÊã©Êñá‰ª∂"ÈìæÊé•Ëß¶ÂèëÊñá‰ª∂ÈÄâÊã©
  if (browseLink) {
    browseLink.addEventListener('click', (e) => {
      e.stopPropagation();
      fileInput.click();
    });
  }

  // Êñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂
  fileInput.addEventListener('change', (e) => {
    handleFileSelect(e.target.files);
    fileInput.value = ''; // Ê∏ÖÁ©∫‰ª•‰æøÂèØ‰ª•ÈáçÂ§çÈÄâÊã©Áõ∏ÂêåÊñá‰ª∂
  });

  // ÊãñÊãΩ‰∫ã‰ª∂
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  // ÊãñÊãΩËøõÂÖ•
  ['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
      dropZone.classList.add('dragover');
    }, false);
  });

  // ÊãñÊãΩÁ¶ªÂºÄ
  dropZone.addEventListener('dragleave', (e) => {
    // Âè™ÊúâÂΩìÁ¶ªÂºÄÊï¥‰∏™ÊãñÊãΩÂå∫ÂüüÊó∂ÊâçÁßªÈô§Ê†∑Âºè
    if (!dropZone.contains(e.relatedTarget)) {
      dropZone.classList.remove('dragover');
    }
  }, false);

  // ÊãñÊãΩÊîæ‰∏ã
  dropZone.addEventListener('drop', (e) => {
    dropZone.classList.remove('dragover');
    const files = e.dataTransfer.files;
    handleFileSelect(files);
  }, false);

  // Ê∏ÖÁ©∫‰∏ä‰º†ÂàóË°®ÊåâÈíÆ
  const clearUploadBtn = document.getElementById('clearUploadBtn');
  if (clearUploadBtn) {
    clearUploadBtn.addEventListener('click', () => {
      if (isUploading) {
        showToast('Ê≠£Âú®‰∏ä‰º†‰∏≠ÔºåËØ∑ÂÖàÂèñÊ∂à‰∏ä‰º†', 'warning');
        return;
      }
      musicUploadQueue = [];
      updateUploadListUI();
    });
  }

  // ÂºÄÂßã‰∏ä‰º†ÊåâÈíÆ
  const uploadAllBtn = document.getElementById('uploadAllMusicBtn');
  if (uploadAllBtn) {
    uploadAllBtn.addEventListener('click', startBatchUpload);
  }

  // ÂèñÊ∂à‰∏ä‰º†ÊåâÈíÆ
  const cancelUploadBtn = document.getElementById('cancelUploadBtn');
  if (cancelUploadBtn) {
    cancelUploadBtn.addEventListener('click', cancelBatchUpload);
  }
}

// Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
function handleFileSelect(files) {
  if (!files || files.length === 0) return;

  const validFiles = Array.from(files).filter(file => {
    // È™åËØÅÊñá‰ª∂Á±ªÂûã
    const validTypes = ['audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/wave', 'audio/ogg', 'audio/x-m4a', 'audio/mp4'];
    const validExtensions = ['.mp3', '.wav', '.ogg', '.m4a'];
    const extension = '.' + file.name.split('.').pop().toLowerCase();

    const isValidType = validTypes.includes(file.type) || validExtensions.includes(extension);

    if (!isValidType) {
      showToast(`Ë∑≥Ëøá‰∏çÊîØÊåÅÁöÑÊñá‰ª∂: ${file.name}`, 'warning');
    }

    return isValidType;
  });

  if (validFiles.length === 0) {
    showToast('Ê≤°ÊúâÊúâÊïàÁöÑÈü≥È¢ëÊñá‰ª∂', 'warning');
    return;
  }

  // Ê∑ªÂä†Âà∞‰∏ä‰º†ÈòüÂàó
  validFiles.forEach(file => {
    // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®
    const exists = musicUploadQueue.some(item => item.file.name === file.name && item.file.size === file.size);
    if (!exists) {
      musicUploadQueue.push({
        file: file,
        id: Date.now() + Math.random(),
        status: 'pending', // pending, uploading, success, error
        progress: 0,
        error: null
      });
    }
  });

  updateUploadListUI();
}

// Êõ¥Êñ∞‰∏ä‰º†ÂàóË°®UI
function updateUploadListUI() {
  const uploadList = document.getElementById('musicUploadList');
  const uploadItems = document.getElementById('musicUploadItems');

  if (!uploadList || !uploadItems) return;

  if (musicUploadQueue.length === 0) {
    uploadList.style.display = 'none';
    return;
  }

  uploadList.style.display = 'block';

  uploadItems.innerHTML = musicUploadQueue.map((item, index) => `
    <div class="upload-item" data-id="${item.id}">
      <div class="upload-item-cover">
        <div class="cover-preview ${item.coverFile ? 'has-cover' : ''}" onclick="triggerCoverSelect('${item.id}')">
          ${item.coverFile ?
            `<img src="${item.coverPreview}" alt="Â∞ÅÈù¢">
             <div class="cover-remove-btn" onclick="event.stopPropagation(); removeCover('${item.id}')">√ó</div>` :
            '<span class="cover-placeholder">üñºÔ∏è</span>'
          }
          <div class="cover-upload-hint">ÁÇπÂáª‰∏ä‰º†Â∞ÅÈù¢</div>
        </div>
        <input type="file" class="cover-input" id="coverInput-${item.id}" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" onchange="handleCoverSelect('${item.id}', this)">
      </div>
      <div class="upload-item-icon" style="display: none;">üéµ</div>
      <div class="upload-item-info">
        <div class="upload-item-name">${item.file.name}</div>
        <div class="upload-item-meta">
          <span>${formatFileSize(item.file.size)}</span>
          <span>${item.file.type || 'audio/*'}</span>
        </div>
      </div>
      <div class="upload-item-progress">
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${item.progress}%"></div>
        </div>
        <div class="progress-text">${item.progress}%</div>
      </div>
      <div class="upload-item-status ${item.status}">
        ${getStatusText(item.status)}
      </div>
      <div class="upload-item-action">
        <button class="remove-upload-btn" onclick="removeUploadItem('${item.id}')" ${item.status === 'uploading' ? 'disabled' : ''}>√ó</button>
      </div>
    </div>
  `).join('');
}

// Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Ëé∑ÂèñÁä∂ÊÄÅÊñáÊú¨
function getStatusText(status) {
  const statusMap = {
    'pending': 'Á≠âÂæÖ‰∏ä‰º†',
    'uploading': '‰∏ä‰º†‰∏≠',
    'success': '‰∏ä‰º†ÊàêÂäü',
    'error': '‰∏ä‰º†Â§±Ë¥•'
  };
  return statusMap[status] || status;
}

// ÁßªÈô§‰∏ä‰º†È°π
function removeUploadItem(id) {
  if (isUploading) {
    showToast('Ê≠£Âú®‰∏ä‰º†‰∏≠ÔºåËØ∑ÂÖàÂèñÊ∂à‰∏ä‰º†', 'warning');
    return;
  }
  musicUploadQueue = musicUploadQueue.filter(item => item.id != id);
  updateUploadListUI();
}

// Ëß¶ÂèëÂ∞ÅÈù¢ÈÄâÊã©
function triggerCoverSelect(id) {
  const coverInput = document.getElementById(`coverInput-${id}`);
  if (coverInput) {
    coverInput.click();
  }
}

// Â§ÑÁêÜÂ∞ÅÈù¢ÈÄâÊã©
function handleCoverSelect(id, input) {
  const file = input.files[0];
  if (!file) return;

  // È™åËØÅÊñá‰ª∂Á±ªÂûã
  const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
  if (!validTypes.includes(file.type)) {
    showToast('ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑÂõæÁâáÊñá‰ª∂ÔºàJPG„ÄÅPNG„ÄÅGIF„ÄÅWebPÔºâ', 'error');
    input.value = '';
    return;
  }

  // È™åËØÅÊñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂ 5MBÔºâ
  if (file.size > 5 * 1024 * 1024) {
    showToast('Â∞ÅÈù¢ÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá 5MB', 'error');
    input.value = '';
    return;
  }

  // ÂàõÂª∫È¢ÑËßà
  const reader = new FileReader();
  reader.onload = function(e) {
    const item = musicUploadQueue.find(i => i.id == id);
    if (item) {
      item.coverFile = file;
      item.coverPreview = e.target.result;
      updateUploadListUI();
    }
  };
  reader.readAsDataURL(file);
}

// ÁßªÈô§Â∞ÅÈù¢
function removeCover(id) {
  const item = musicUploadQueue.find(i => i.id == id);
  if (item) {
    item.coverFile = null;
    item.coverPreview = null;

    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
    const coverInput = document.getElementById(`coverInput-${id}`);
    if (coverInput) {
      coverInput.value = '';
    }

    updateUploadListUI();
  }
}

// ÂºÄÂßãÊâπÈáè‰∏ä‰º†
async function startBatchUpload() {
  if (isUploading) {
    showToast('Ê≠£Âú®‰∏ä‰º†‰∏≠...', 'info');
    return;
  }

  const pendingItems = musicUploadQueue.filter(item => item.status === 'pending');
  if (pendingItems.length === 0) {
    showToast('Ê≤°ÊúâÁ≠âÂæÖ‰∏ä‰º†ÁöÑÊñá‰ª∂', 'warning');
    return;
  }

  isUploading = true;
  uploadAbortController = new AbortController();

  const uploadAllBtn = document.getElementById('uploadAllMusicBtn');
  const cancelUploadBtn = document.getElementById('cancelUploadBtn');
  if (uploadAllBtn) uploadAllBtn.disabled = true;
  if (cancelUploadBtn) cancelUploadBtn.disabled = false;

  let successCount = 0;
  let failCount = 0;

  // È°∫Â∫è‰∏ä‰º†Êñá‰ª∂
  for (const item of pendingItems) {
    if (!isUploading) break; // Â¶ÇÊûúÂ∑≤ÂèñÊ∂à‰∏ä‰º†

    item.status = 'uploading';
    updateUploadListUI();

    try {
      await uploadSingleMusicFile(item, uploadAbortController.signal);
      item.status = 'success';
      item.progress = 100;
      successCount++;
    } catch (error) {
      item.status = 'error';
      item.error = error.message;
      failCount++;
      console.error(`‰∏ä‰º†Êñá‰ª∂ ${item.file.name} Â§±Ë¥•:`, error);
    }

    updateUploadListUI();
  }

  isUploading = false;
  uploadAbortController = null;

  if (uploadAllBtn) uploadAllBtn.disabled = false;
  if (cancelUploadBtn) cancelUploadBtn.disabled = true;

  // ÊòæÁ§∫‰∏ä‰º†ÁªìÊûú
  if (successCount > 0) {
    showToast(`ÊàêÂäü‰∏ä‰º† ${successCount} ‰∏™Êñá‰ª∂`, 'success');
    // ÈáçÊñ∞Âä†ËΩΩÊí≠ÊîæÂàóË°®
    loadMusicPlaylist();
  }
  if (failCount > 0) {
    showToast(`${failCount} ‰∏™Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•`, 'error');
  }

  // Âª∂ËøüÊ∏ÖÁ©∫ÊàêÂäüÁöÑ‰∏ä‰º†È°π
  setTimeout(() => {
    musicUploadQueue = musicUploadQueue.filter(item => item.status !== 'success');
    updateUploadListUI();
  }, 2000);
}

// ‰∏ä‰º†Âçï‰∏™Èü≥‰πêÊñá‰ª∂
function uploadSingleMusicFile(item, signal) {
  return new Promise((resolve, reject) => {
    const formData = new FormData();
    formData.append('file', item.file);

    // ‰ªéÊñá‰ª∂ÂêçÊèêÂèñÊ†áÈ¢òÔºàÂéªÊéâÊâ©Â±ïÂêçÔºâ
    const title = item.file.name.replace(/\.[^/.]+$/, '');
    formData.append('title', title);
    formData.append('artist', 'Êú™Áü•Ëâ∫ÊúØÂÆ∂');

    // Â¶ÇÊûúÊúâÂ∞ÅÈù¢Êñá‰ª∂ÔºåÊ∑ªÂä†Âà∞Ë°®Âçï
    if (item.coverFile) {
      formData.append('cover', item.coverFile);
    }

    const token = localStorage.getItem('auth_token');
    const headers = {};
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    // ‰ΩøÁî® XMLHttpRequest ‰ª•ÊîØÊåÅËøõÂ∫¶ÁõëÊéß
    const xhr = new XMLHttpRequest();

    // ‰∏ä‰º†ËøõÂ∫¶
    xhr.upload.addEventListener('progress', (e) => {
      if (e.lengthComputable) {
        const percentComplete = Math.round((e.loaded / e.total) * 100);
        item.progress = percentComplete;
        updateUploadListUI();
      }
    });

    // ‰∏ä‰º†ÂÆåÊàê
    xhr.addEventListener('load', () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        resolve();
      } else {
        try {
          const result = JSON.parse(xhr.responseText);
          reject(new Error(result.error || '‰∏ä‰º†Â§±Ë¥•'));
        } catch (e) {
          reject(new Error(`‰∏ä‰º†Â§±Ë¥•: ${xhr.status}`));
        }
      }
    });

    // ‰∏ä‰º†ÈîôËØØ
    xhr.addEventListener('error', () => {
      reject(new Error('ÁΩëÁªúÈîôËØØ'));
    });

    // ‰∏ä‰º†‰∏≠Ê≠¢
    xhr.addEventListener('abort', () => {
      reject(new Error('‰∏ä‰º†Â∑≤ÂèñÊ∂à'));
    });

    // ÁõëÂê¨‰∏≠Ê≠¢‰ø°Âè∑
    signal.addEventListener('abort', () => {
      xhr.abort();
    });

    xhr.open('POST', '/api/music/upload');
    if (token) {
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
    }

    xhr.send(formData);
  });
}

// ÂèñÊ∂àÊâπÈáè‰∏ä‰º†
function cancelBatchUpload() {
  if (!isUploading) return;

  if (uploadAbortController) {
    uploadAbortController.abort();
  }

  isUploading = false;
  uploadAbortController = null;

  // ÈáçÁΩÆÊâÄÊúâÊ≠£Âú®‰∏ä‰º†ÁöÑÈ°πÁõÆÁä∂ÊÄÅ
  musicUploadQueue.forEach(item => {
    if (item.status === 'uploading') {
      item.status = 'pending';
      item.progress = 0;
    }
  });

  updateUploadListUI();
  showToast('Â∑≤ÂèñÊ∂à‰∏ä‰º†', 'info');

  const uploadAllBtn = document.getElementById('uploadAllMusicBtn');
  const cancelUploadBtn = document.getElementById('cancelUploadBtn');
  if (uploadAllBtn) uploadAllBtn.disabled = false;
  if (cancelUploadBtn) cancelUploadBtn.disabled = true;
}

// Èü≥‰πêÊñá‰ª∂‰∏ä‰º†Ôºà‰øùÁïôÊóßÂáΩÊï∞‰ª•ÂÖºÂÆπÔºâ
async function uploadMusicFile() {
  const fileInput = document.getElementById('musicFileUpload');

  if (!fileInput.files || fileInput.files.length === 0) {
    showToast('ËØ∑ÈÄâÊã©Ë¶Å‰∏ä‰º†ÁöÑÈü≥‰πêÊñá‰ª∂', 'warning');
    return;
  }

  handleFileSelect(fileInput.files);
  fileInput.value = '';
}

// Âä†ËΩΩÈü≥‰πêÊí≠ÊîæÂàóË°®
async function loadMusicPlaylist() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/music/playlist', {
      method: 'GET',
      headers: headers
    });

    if (response.ok) {
      const playlist = await response.json();
      updateMusicPlaylistUI(playlist);
    } else {
      console.error('Âä†ËΩΩÊí≠ÊîæÂàóË°®Â§±Ë¥•');
    }
  } catch (error) {
    console.error('Âä†ËΩΩÊí≠ÊîæÂàóË°®Â§±Ë¥•:', error);
  }
}

// Êõ¥Êñ∞Èü≥‰πêÊí≠ÊîæÂàóË°® UI
function updateMusicPlaylistUI(playlist) {
  const container = document.getElementById('musicPlaylistContainer');
  if (!container) return;

  if (!playlist || playlist.length === 0) {
    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">ÊöÇÊó†Èü≥‰πêÊñá‰ª∂</div>';
    return;
  }

  container.innerHTML = playlist.map((track, index) => {
    // ÁßªÈô§Êñá‰ª∂Âêç‰∏≠ÁöÑÊó∂Èó¥Êà≥Âíå‰∏ãÂàíÁ∫øÂâçÁºÄ
    let displayTitle = track.title;
    const timestampMatch = displayTitle.match(/^\d+_/);
    if (timestampMatch) {
      displayTitle = displayTitle.substring(timestampMatch[0].length);
    }
    
    return `
    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid rgba(0, 0, 0, 0.05);">
      <div style="width: 50px; height: 50px; border-radius: 8px; overflow: hidden; background: rgba(0, 0, 0, 0.05); display: flex; align-items: center; justify-content: center;">
        ${track.cover_image ? 
          `<img src="${track.cover_image}" alt="${track.title}" style="width: 100%; height: 100%; object-fit: cover;">` : 
          '<span style="font-size: 24px;">üéµ</span>'
        }
      </div>
      <div style="flex: 1;">
        <div style="font-weight: 500;">${displayTitle}</div>
        <div style="font-size: 0.85em; color: #666;">${track.artist}</div>
      </div>
      <div style="font-size: 0.85em; color: #999;">${track.duration}</div>
      <div style="display: flex; gap: 5px;">
        <button onclick="editMusicTitle(${track.id}, '${displayTitle.replace(/'/g, "\\'")}')" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">ÁºñËæëÊ†áÈ¢ò</button>
        <button onclick="changeMusicCover(${track.id})" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Êõ¥Êç¢Â∞ÅÈù¢</button>
        <button onclick="deleteMusicTrack(${track.id})" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Âà†Èô§</button>
      </div>
    </div>
    `;
  }).join('');
}

// Âà†Èô§Èü≥‰πêÊñá‰ª∂
async function deleteMusicTrack(trackId) {
  if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÈ¶ñÈü≥‰πêÂêóÔºü')) {
    return;
  }

  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch(`/api/music/${trackId}`, {
      method: 'DELETE',
      headers: headers
    });

    if (response.ok) {
      showToast('Âà†Èô§ÊàêÂäüÔºÅ', 'success');
      loadMusicPlaylist();
    } else {
      const result = await response.json();
      showToast('Âà†Èô§Â§±Ë¥•Ôºö' + (result.error || 'Êú™Áü•ÈîôËØØ'), 'error');
    }
  } catch (error) {
    console.error('Âà†Èô§Èü≥‰πêÂ§±Ë¥•:', error);
    showToast('Âà†Èô§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
  }
}

// Êõ¥Êç¢Èü≥‰πêÂ∞ÅÈù¢
async function changeMusicCover(trackId) {
  // ÂàõÂª∫Êñá‰ª∂ÈÄâÊã©Âô®
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/jpeg,image/jpg,image/png,image/gif,image/webp';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    // È™åËØÅÊñá‰ª∂Á±ªÂûã
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
      showToast('ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑÂõæÁâáÊñá‰ª∂ÔºàJPEG, PNG, GIF, WebPÔºâ', 'error');
      return;
    }
    
    // È™åËØÅÊñá‰ª∂Â§ßÂ∞èÔºàÊúÄÂ§ß 5MBÔºâ
    if (file.size > 5 * 1024 * 1024) {
      showToast('ÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá 5MB', 'error');
      return;
    }
    
    // ÂàõÂª∫ FormData
    const formData = new FormData();
    formData.append('cover', file);
    
    try {
      const token = localStorage.getItem('auth_token');
      const headers = {};
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      const response = await fetch(`/api/music/${trackId}`, {
        method: 'PUT',
        body: formData,
        headers: headers
      });
      
      if (response.ok) {
        const result = await response.json();
        showToast('Â∞ÅÈù¢Êõ¥Êñ∞ÊàêÂäüÔºÅ', 'success');
        loadMusicPlaylist(); // ÈáçÊñ∞Âä†ËΩΩÊí≠ÊîæÂàóË°®‰ª•ÊòæÁ§∫Êñ∞Â∞ÅÈù¢
      } else {
        const result = await response.json();
        showToast('Â∞ÅÈù¢Êõ¥Êñ∞Â§±Ë¥•Ôºö' + (result.message || 'Êú™Áü•ÈîôËØØ'), 'error');
      }
    } catch (error) {
      console.error('Êõ¥Êñ∞Â∞ÅÈù¢Â§±Ë¥•:', error);
      showToast('Êõ¥Êñ∞Â∞ÅÈù¢Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
    }
  };
  
  // Ëß¶ÂèëÊñá‰ª∂ÈÄâÊã©
  input.click();
}

// ÁºñËæëÈü≥‰πêÊ†áÈ¢ò
function editMusicTitle(trackId, currentTitle) {
  // ÂàõÂª∫Ê®°ÊÄÅÊ°Ü
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  `;
  
  modal.innerHTML = `
    <div style="background: white; padding: 30px; border-radius: 10px; width: 400px; max-width: 90%;">
      <h3 style="margin: 0 0 20px 0;">ÁºñËæëÊ†áÈ¢ò</h3>
      <input type="text" id="musicTitleInput" value="${currentTitle}" 
             style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px; box-sizing: border-box;">
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button id="cancelBtn" style="padding: 8px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">ÂèñÊ∂à</button>
        <button id="saveBtn" style="padding: 8px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">‰øùÂ≠ò</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // ÁªëÂÆö‰∫ã‰ª∂
  const input = modal.querySelector('#musicTitleInput');
  const cancelBtn = modal.querySelector('#cancelBtn');
  const saveBtn = modal.querySelector('#saveBtn');
  
  cancelBtn.onclick = () => {
    document.body.removeChild(modal);
  };
  
  saveBtn.onclick = async () => {
    const newTitle = input.value.trim();
    if (!newTitle) {
      showToast('Ê†áÈ¢ò‰∏çËÉΩ‰∏∫Á©∫', 'error');
      return;
    }
    
    try {
      const token = localStorage.getItem('auth_token');
      const headers = {
        'Content-Type': 'application/json'
      };
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      const response = await fetch(`/api/music/${trackId}?action=title`, {
        method: 'PUT',
        body: JSON.stringify({ title: newTitle }),
        headers: headers
      });
      
      if (response.ok) {
        const result = await response.json();
        showToast('Ê†áÈ¢òÊõ¥Êñ∞ÊàêÂäüÔºÅ', 'success');
        document.body.removeChild(modal);
        loadMusicPlaylist(); // ÈáçÊñ∞Âä†ËΩΩÊí≠ÊîæÂàóË°®‰ª•ÊòæÁ§∫Êñ∞Ê†áÈ¢ò
      } else {
        const result = await response.json();
        showToast('Ê†áÈ¢òÊõ¥Êñ∞Â§±Ë¥•Ôºö' + (result.message || 'Êú™Áü•ÈîôËØØ'), 'error');
      }
    } catch (error) {
      console.error('Êõ¥Êñ∞Ê†áÈ¢òÂ§±Ë¥•:', error);
      showToast('Êõ¥Êñ∞Ê†áÈ¢òÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
    }
  };
  
  // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
  modal.onclick = (e) => {
    if (e.target === modal) {
      document.body.removeChild(modal);
    }
  };
  
  // Êåâ ESC ÈîÆÂÖ≥Èó≠
  const handleEsc = (e) => {
    if (e.key === 'Escape') {
      document.body.removeChild(modal);
      document.removeEventListener('keydown', handleEsc);
    }
  };
  document.addEventListener('keydown', handleEsc);
}

// ÂÖ≥‰∫éÈ°µÈù¢Âç°ÁâáÁÆ°ÁêÜ
let mainCards = [];
let subCards = [];

// Âä†ËΩΩ‰∏ªÂç°Áâá
async function loadMainCards() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/about/main-cards/admin', {
      method: 'GET',
      headers: headers
    });

    if (response.ok) {
      mainCards = await response.json();
      updateMainCardsTable();
      updateMainCardFilter();
    } else {
      showToast('Âä†ËΩΩ‰∏ªÂç°ÁâáÂ§±Ë¥•', 'error');
    }
  } catch (error) {
    console.error('Âä†ËΩΩ‰∏ªÂç°ÁâáÂ§±Ë¥•:', error);
    showToast('Âä†ËΩΩ‰∏ªÂç°ÁâáÂ§±Ë¥•', 'error');
  }
}

// Êõ¥Êñ∞‰∏ªÂç°ÁâáË°®Ê†º
function updateMainCardsTable() {
  const tbody = document.getElementById('mainCardsTableBody');
  if (!tbody) return;

  if (mainCards.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">ÊöÇÊó†‰∏ªÂç°Áâá</td></tr>';
    return;
  }

  tbody.innerHTML = mainCards.map(card => `
    <tr>
      <td>${card.sort_order}</td>
      <td>${card.icon || ''}</td>
      <td>${card.title}</td>
      <td>${card.layout_type}</td>
      <td>${getSubCardCount(card.id)}</td>
      <td>
        <span class="status ${card.is_enabled ? 'active' : 'inactive'}">
          ${card.is_enabled ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}
        </span>
      </td>
      <td>
        <button class="btn-secondary" onclick="editMainCard(${card.id})">ÁºñËæë</button>
        <button class="btn-secondary" onclick="toggleMainCardEnabled(${card.id}, ${card.is_enabled})">
          ${card.is_enabled ? 'Á¶ÅÁî®' : 'ÂêØÁî®'}
        </button>
        <button class="btn-danger" onclick="deleteMainCard(${card.id})">Âà†Èô§</button>
      </td>
    </tr>
  `).join('');
}

// Ëé∑ÂèñÊ¨°Âç°ÁâáÊï∞Èáè
function getSubCardCount(mainCardId) {
  return subCards.filter(sub => sub.main_card_id === mainCardId).length;
}

// Êõ¥Êñ∞‰∏ªÂç°ÁâáËøáÊª§Âô®
function updateMainCardFilter() {
  const select = document.getElementById('subCardMainCardFilter');
  if (!select) return;

  const currentValue = select.value;
  select.innerHTML = '<option value="">ÂÖ®ÈÉ®‰∏ªÂç°Áâá</option>' +
    mainCards.map(card => `<option value="${card.id}">${card.title}</option>`).join('');
  select.value = currentValue;
}

// Âä†ËΩΩÊ¨°Âç°Áâá
async function loadSubCards() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/about/sub-cards/admin', {
      method: 'GET',
      headers: headers
    });

    if (response.ok) {
      subCards = await response.json();
      updateSubCardsTable();
      updateMainCardsTable();
    } else {
      showToast('Âä†ËΩΩÊ¨°Âç°ÁâáÂ§±Ë¥•', 'error');
    }
  } catch (error) {
    console.error('Âä†ËΩΩÊ¨°Âç°ÁâáÂ§±Ë¥•:', error);
    showToast('Âä†ËΩΩÊ¨°Âç°ÁâáÂ§±Ë¥•', 'error');
  }
}

// Êõ¥Êñ∞Ê¨°Âç°ÁâáË°®Ê†º
function updateSubCardsTable() {
  const tbody = document.getElementById('subCardsTableBody');
  if (!tbody) return;

  const filterValue = document.getElementById('subCardMainCardFilter').value;
  let filteredCards = subCards;

  if (filterValue) {
    filteredCards = subCards.filter(sub => sub.main_card_id === parseInt(filterValue));
  }

  if (filteredCards.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">ÊöÇÊó†Ê¨°Âç°Áâá</td></tr>';
    return;
  }

  tbody.innerHTML = filteredCards.map(card => {
    const mainCard = mainCards.find(m => m.id === card.main_card_id);
    return `
      <tr>
        <td>${card.sort_order}</td>
        <td>${card.icon || ''}</td>
        <td>${card.title}</td>
        <td>${card.description.substring(0, 30)}${card.description.length > 30 ? '...' : ''}</td>
        <td>${card.link_url || '-'}</td>
        <td>
          <span class="status ${card.is_enabled ? 'active' : 'inactive'}">
            ${card.is_enabled ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}
          </span>
        </td>
        <td>
          <button class="btn-secondary" onclick="editSubCard(${card.id})">ÁºñËæë</button>
          <button class="btn-secondary" onclick="toggleSubCardEnabled(${card.id}, ${card.is_enabled})">
            ${card.is_enabled ? 'Á¶ÅÁî®' : 'ÂêØÁî®'}
          </button>
          <button class="btn-danger" onclick="deleteSubCard(${card.id})">Âà†Èô§</button>
        </td>
      </tr>
    `;
  }).join('');
}

// Ê∑ªÂä†‰∏ªÂç°Áâá
async function addMainCard() {
  // Ê∏ÖÁ©∫Ë°®Âçï
  document.getElementById('mainCardModalTitle').textContent = 'Ê∑ªÂä†‰∏ªÂç°Áâá';
  document.getElementById('mainCardForm').reset();
  document.getElementById('mainCardId').value = '';
  document.getElementById('mainCardSortOrder').value = mainCards.length + 1;
  document.getElementById('mainCardEnabled').checked = true;

  // ÊâìÂºÄÊ®°ÊÄÅÊ°Ü
  openModal('mainCardModal');
}

// ÁºñËæë‰∏ªÂç°Áâá
async function editMainCard(id) {
  const card = mainCards.find(c => c.id === id);
  if (!card) return;

  // Â°´ÂÖÖÁºñËæëË°®Âçï
  document.getElementById('mainCardModalTitle').textContent = 'ÁºñËæë‰∏ªÂç°Áâá';
  document.getElementById('mainCardId').value = card.id;
  document.getElementById('mainCardTitle').value = card.title || '';
  document.getElementById('mainCardIcon').value = card.icon || '';
  document.getElementById('mainCardLayoutType').value = card.layout_type || 'grid';
  document.getElementById('mainCardCustomCss').value = card.custom_css || '';
  document.getElementById('mainCardSortOrder').value = card.sort_order || 0;
  document.getElementById('mainCardEnabled').checked = card.is_enabled;

  // ÊâìÂºÄÊ®°ÊÄÅÊ°Ü
  openModal('mainCardModal');
}

// Âà†Èô§‰∏ªÂç°Áâá
async function deleteMainCard(id) {
  currentAction = 'delete-main-card';
  currentItemId = id;
  document.getElementById('confirmMessage').textContent = `Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰∏ªÂç°ÁâáÂêóÔºüÊâÄÊúâÂÖ≥ËÅîÁöÑÊ¨°Âç°Áâá‰πü‰ºöË¢´Âà†Èô§„ÄÇÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`;
  openModal('confirmModal');
}

// ÂàáÊç¢‰∏ªÂç°ÁâáÂêØÁî®Áä∂ÊÄÅ
async function toggleMainCardEnabled(id, currentStatus) {
  try {
    const token = localStorage.getItem('auth_token');
    const response = await fetch(`/api/about/main-cards/enabled?id=${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        enabled: !currentStatus
      })
    });

    if (response.ok) {
      loadMainCards();
    } else {
      showToast('Êìç‰ΩúÂ§±Ë¥•', 'error');
    }
  } catch (error) {
    console.error('ÂàáÊç¢Áä∂ÊÄÅÂ§±Ë¥•:', error);
    showToast('Êìç‰ΩúÂ§±Ë¥•', 'error');
  }
}

// Ê∑ªÂä†Ê¨°Âç°Áâá
async function addSubCard() {
  const mainCardId = document.getElementById('subCardMainCardFilter').value;
  if (!mainCardId) {
    showToast('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™‰∏ªÂç°Áâá', 'warning');
    return;
  }

  // Ê∏ÖÁ©∫Ë°®Âçï
  document.getElementById('subCardModalTitle').textContent = 'Ê∑ªÂä†Ê¨°Âç°Áâá';
  document.getElementById('subCardForm').reset();
  document.getElementById('subCardId').value = '';

  // Â°´ÂÖÖ‰∏ªÂç°Áâá‰∏ãÊãâÊ°ÜÈÄâÈ°π
  const mainCardSelect = document.getElementById('subCardMainCardId');
  mainCardSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©‰∏ªÂç°Áâá</option>' +
    mainCards.map(card => `<option value="${card.id}">${card.title}</option>`).join('');
  mainCardSelect.value = mainCardId;

  document.getElementById('subCardSortOrder').value = subCards.filter(s => s.main_card_id === parseInt(mainCardId)).length + 1;
  document.getElementById('subCardEnabled').checked = true;

  // ÊâìÂºÄÊ®°ÊÄÅÊ°Ü
  openModal('subCardModal');
}

// ÁºñËæëÊ¨°Âç°Áâá
async function editSubCard(id) {
  const card = subCards.find(c => c.id === id);
  if (!card) return;

  // Â°´ÂÖÖÁºñËæëË°®Âçï
  document.getElementById('subCardModalTitle').textContent = 'ÁºñËæëÊ¨°Âç°Áâá';
  document.getElementById('subCardId').value = card.id;

  // Â°´ÂÖÖ‰∏ªÂç°Áâá‰∏ãÊãâÊ°ÜÈÄâÈ°π
  const mainCardSelect = document.getElementById('subCardMainCardId');
  mainCardSelect.innerHTML = '<option value="">ËØ∑ÈÄâÊã©‰∏ªÂç°Áâá</option>' +
    mainCards.map(card => `<option value="${card.id}">${card.title}</option>`).join('');
  mainCardSelect.value = card.main_card_id;

  document.getElementById('subCardTitle').value = card.title || '';
  document.getElementById('subCardDescription').value = card.description || '';
  document.getElementById('subCardIcon').value = card.icon || '';
  document.getElementById('subCardLinkUrl').value = card.link_url || '';
  document.getElementById('subCardCustomCss').value = card.custom_css || '';
  document.getElementById('subCardSortOrder').value = card.sort_order || 0;
  document.getElementById('subCardEnabled').checked = card.is_enabled;

  // ÊâìÂºÄÊ®°ÊÄÅÊ°Ü
  openModal('subCardModal');
}

// Âà†Èô§Ê¨°Âç°Áâá
async function deleteSubCard(id) {
  currentAction = 'delete-sub-card';
  currentItemId = id;
  document.getElementById('confirmMessage').textContent = `Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ê¨°Âç°ÁâáÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`;
  openModal('confirmModal');
}

// ÂàáÊç¢Ê¨°Âç°ÁâáÂêØÁî®Áä∂ÊÄÅ
async function toggleSubCardEnabled(id, currentStatus) {
  try {
    const token = localStorage.getItem('auth_token');
    const response = await fetch(`/api/about/sub-cards/enabled?id=${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        enabled: !currentStatus
      })
    });

    if (response.ok) {
      loadSubCards();
    } else {
      showToast('Êìç‰ΩúÂ§±Ë¥•', 'error');
    }
  } catch (error) {
    console.error('ÂàáÊç¢Áä∂ÊÄÅÂ§±Ë¥•:', error);
    showToast('Êìç‰ΩúÂ§±Ë¥•', 'error');
  }
}

// ÂàùÂßãÂåñÂÖ≥‰∫éÈ°µÈù¢Âç°ÁâáÁÆ°ÁêÜ
document.addEventListener('DOMContentLoaded', function() {
  // Ê∑ªÂä†‰∏ªÂç°ÁâáÊåâÈíÆ
  const addMainCardBtn = document.getElementById('addMainCardBtn');
  if (addMainCardBtn) {
    addMainCardBtn.addEventListener('click', addMainCard);
  }

  // Ê∑ªÂä†Ê¨°Âç°ÁâáÊåâÈíÆ
  const addSubCardBtn = document.getElementById('addSubCardBtn');
  if (addSubCardBtn) {
    addSubCardBtn.addEventListener('click', addSubCard);
  }

  // Âà∑Êñ∞ÊåâÈíÆ
  const refreshAboutCardsBtn = document.getElementById('refreshAboutCardsBtn');
  if (refreshAboutCardsBtn) {
    refreshAboutCardsBtn.addEventListener('click', function() {
      loadMainCards();
      loadSubCards();
    });
  }

  // ‰∏ªÂç°ÁâáËøáÊª§Âô®ÂèòÂåñ
  const subCardMainCardFilter = document.getElementById('subCardMainCardFilter');
  if (subCardMainCardFilter) {
    subCardMainCardFilter.addEventListener('change', updateSubCardsTable);
  }

  // ÂΩìÂàáÊç¢Âà∞ÂÖ≥‰∫éÈ°µÈù¢Ê†áÁ≠æÊó∂Âä†ËΩΩÊï∞ÊçÆ
  const aboutTab = document.querySelector('[data-tab="about"]');
  if (aboutTab) {
    aboutTab.addEventListener('click', function() {
      loadMainCards();
      loadSubCards();
    });
  }

  // ‰∏ªÂç°ÁâáË°®ÂçïÊèê‰∫§
  const mainCardForm = document.getElementById('mainCardForm');
  if (mainCardForm) {
    mainCardForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      const cardId = document.getElementById('mainCardId').value;
      const title = document.getElementById('mainCardTitle').value;
      const icon = document.getElementById('mainCardIcon').value;
      const layoutType = document.getElementById('mainCardLayoutType').value;
      const customCss = document.getElementById('mainCardCustomCss').value;
      const sortOrder = parseInt(document.getElementById('mainCardSortOrder').value);
      const isEnabled = document.getElementById('mainCardEnabled').checked;

      try {
        const token = localStorage.getItem('auth_token');
        const headers = {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        };

        let url = '/api/about/main-cards';
        let method = 'POST';

        if (cardId) {
          url = `/api/about/main-cards/update?id=${cardId}`;
          method = 'PUT';
        }

        const response = await fetch(url, {
          method: method,
          headers: headers,
          body: JSON.stringify({
            title: title,
            icon: icon,
            layout_type: layoutType,
            custom_css: customCss,
            sort_order: sortOrder,
            is_enabled: isEnabled
          })
        });

        if (response.ok) {
          showToast(cardId ? 'Êõ¥Êñ∞ÊàêÂäü' : 'Ê∑ªÂä†ÊàêÂäü', 'success');
          closeModal('mainCardModal');
          loadMainCards();
        } else {
          showToast('Êìç‰ΩúÂ§±Ë¥•', 'error');
        }
      } catch (error) {
        console.error('Êìç‰ΩúÂ§±Ë¥•:', error);
        showToast('Êìç‰ΩúÂ§±Ë¥•', 'error');
      }
    });
  }

  // Ê¨°Âç°ÁâáË°®ÂçïÊèê‰∫§
  const subCardForm = document.getElementById('subCardForm');
  if (subCardForm) {
    subCardForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      const cardId = document.getElementById('subCardId').value;
      const mainCardId = parseInt(document.getElementById('subCardMainCardId').value);
      const title = document.getElementById('subCardTitle').value;
      const description = document.getElementById('subCardDescription').value;
      const icon = document.getElementById('subCardIcon').value;
      const linkUrl = document.getElementById('subCardLinkUrl').value;
      const customCss = document.getElementById('subCardCustomCss').value;
      const sortOrder = parseInt(document.getElementById('subCardSortOrder').value);
      const isEnabled = document.getElementById('subCardEnabled').checked;

      try {
        const token = localStorage.getItem('auth_token');
        const headers = {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        };

        let url = '/api/about/sub-cards';
        let method = 'POST';

        if (cardId) {
          url = `/api/about/sub-cards/update?id=${cardId}`;
          method = 'PUT';
        }

        const response = await fetch(url, {
          method: method,
          headers: headers,
          body: JSON.stringify({
            main_card_id: mainCardId,
            title: title,
            description: description,
            icon: icon,
            link_url: linkUrl,
            custom_css: customCss,
            sort_order: sortOrder,
            is_enabled: isEnabled
          })
        });

        if (response.ok) {
          showToast(cardId ? 'Êõ¥Êñ∞ÊàêÂäü' : 'Ê∑ªÂä†ÊàêÂäü', 'success');
          closeModal('subCardModal');
          loadSubCards();
        } else {
          showToast('Êìç‰ΩúÂ§±Ë¥•', 'error');
        }
      } catch (error) {
        console.error('Êìç‰ΩúÂ§±Ë¥•:', error);
        showToast('Êìç‰ΩúÂ§±Ë¥•', 'error');
      }
    });
  }
});
</script>

<!-- Êñá‰ª∂ÁÆ°ÁêÜÂô®ËÑöÊú¨ -->
<script>
// Êñá‰ª∂ÁÆ°ÁêÜÂô®ÂØπË±°
const FileManager = {
  currentPath: 'img',
  currentRoot: 'img',
  selectedFile: null,
  filesToUpload: [],

  // Ëé∑ÂèñËÆ§ËØÅÂ§¥
  getAuthHeader() {
    const token = localStorage.getItem('auth_token');
    return token ? `Bearer ${token}` : '';
  },

  // ÂàùÂßãÂåñ
  init() {
    this.bindEvents();
    this.loadTree();
    this.loadFiles();
  },

  // ÁªëÂÆö‰∫ã‰ª∂
  bindEvents() {
    // ‰∏ä‰º†ÊåâÈíÆ
    document.getElementById('fmUploadBtn').addEventListener('click', () => this.openUploadModal());

    // Êñ∞Âª∫Êñá‰ª∂Â§πÊåâÈíÆ
    document.getElementById('fmCreateDirBtn').addEventListener('click', () => this.openCreateDirModal());

    // ËøîÂõûÊåâÈíÆ
    document.getElementById('fmBackBtn').addEventListener('click', () => this.goBack());

    // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∏ä‰∏ãÊñáËèúÂçï
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.fm-context-menu') && !e.target.closest('.fm-file-item')) {
        this.hideContextMenu();
      }
    });

    // ÈîÆÁõò‰∫ã‰ª∂
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        this.hideContextMenu();
      }
    });
  },

  // Âä†ËΩΩÁõÆÂΩïÊ†ë
  async loadTree() {
    try {
      const roots = ['img', 'markdown', 'attachments', 'music'];
      const treeContainer = document.getElementById('fmTree');
      treeContainer.innerHTML = '';

      for (const root of roots) {
        const rootItem = this.createTreeItem(root, true);
        treeContainer.appendChild(rootItem);

        // Âä†ËΩΩÂ≠êÁõÆÂΩï
        await this.loadSubDirectories(root, rootItem);
      }
    } catch (error) {
      console.error('Âä†ËΩΩÁõÆÂΩïÊ†ëÂ§±Ë¥•:', error);
    }
  },

  // Âä†ËΩΩÂ≠êÁõÆÂΩï
  async loadSubDirectories(path, parentElement) {
    try {
      const response = await fetch(`/api/files?path=${encodeURIComponent(path)}`, {
        headers: {
          'Authorization': this.getAuthHeader()
        }
      });
      const result = await response.json();

      if (result.success && result.data.files) {
        const directories = result.data.files.filter(f => f.is_dir);

        if (directories.length > 0) {
          const childrenContainer = document.createElement('div');
          childrenContainer.className = 'fm-tree-children';

          for (const dir of directories) {
            const dirPath = `${path}/${dir.name}`;
            const dirItem = this.createTreeItem(dir.name, false, dirPath);
            childrenContainer.appendChild(dirItem);

            // ÈÄíÂΩíÂä†ËΩΩÂ≠êÁõÆÂΩï
            await this.loadSubDirectories(dirPath, dirItem);
          }

          parentElement.appendChild(childrenContainer);
        }
      }
    } catch (error) {
      console.error('Âä†ËΩΩÂ≠êÁõÆÂΩïÂ§±Ë¥•:', error);
    }
  },

  // ÂàõÂª∫Ê†ëËäÇÁÇπ
  createTreeItem(name, isRoot, path = null) {
    const item = document.createElement('div');
    item.className = 'fm-tree-item';
    if (isRoot && name === this.currentRoot) {
      item.classList.add('active');
    }

    const icon = document.createElement('span');
    icon.className = 'fm-tree-icon';
    icon.textContent = isRoot ? 'üìÅ' : 'üìÇ';
    item.appendChild(icon);

    const text = document.createElement('span');
    text.textContent = name;
    item.appendChild(text);

    const itemPath = path || name;
    item.addEventListener('click', (e) => {
      e.stopPropagation();
      this.navigateTo(itemPath);
      
      // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
      document.querySelectorAll('.fm-tree-item').forEach(el => el.classList.remove('active'));
      item.classList.add('active');
    });

    return item;
  },

  // Âä†ËΩΩÊñá‰ª∂ÂàóË°®
  async loadFiles() {
    try {
      const response = await fetch(`/api/files?path=${encodeURIComponent(this.currentPath)}`, {
        headers: {
          'Authorization': this.getAuthHeader()
        }
      });
      const result = await response.json();

      if (result.success) {
        this.renderFiles(result.data.files);
        this.updateBreadcrumb(result.data.current_path);
        this.updateBackButton(result.data.parent_path);
        this.updateFileCount(result.data.files.length);
      } else {
        showToast(result.message, 'error');
      }
    } catch (error) {
      console.error('Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•:', error);
      showToast('Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•', 'error');
    }
  },

  // Ê∏≤ÊüìÊñá‰ª∂ÂàóË°®
  renderFiles(files) {
    const fileList = document.getElementById('fmFileList');
    const emptyState = document.getElementById('fmEmptyState');

    if (files.length === 0) {
      fileList.innerHTML = '';
      emptyState.style.display = 'flex';
      return;
    }

    emptyState.style.display = 'none';

    // ÂÖàÊòæÁ§∫ÁõÆÂΩïÔºåÂÜçÊòæÁ§∫Êñá‰ª∂
    const sortedFiles = [...files].sort((a, b) => {
      if (a.is_dir && !b.is_dir) return -1;
      if (!a.is_dir && b.is_dir) return 1;
      return a.name.localeCompare(b.name);
    });

    fileList.innerHTML = sortedFiles.map(file => this.createFileItem(file)).join('');

    // ÁªëÂÆöÊñá‰ª∂È°π‰∫ã‰ª∂
    fileList.querySelectorAll('.fm-file-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.stopPropagation();
        const path = item.dataset.path;
        const isDir = item.dataset.isDir === 'true';

        if (isDir) {
          this.navigateTo(path);
        } else {
          this.openFile(path);
        }
      });

      item.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        const path = item.dataset.path;
        const isDir = item.dataset.isDir === 'true';
        this.showContextMenu(e, path, isDir);
      });
    });
  },

  // ÂàõÂª∫Êñá‰ª∂È°πHTML
  createFileItem(file) {
    let icon = 'üìÑ';

    if (file.is_dir) {
      icon = 'üìÅ';
    } else if (['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg'].includes(file.extension)) {
      icon = `<img src="/${file.path}" alt="${file.name}" onerror="this.parentElement.innerHTML='üñºÔ∏è'">`;
    } else if (file.extension === '.md') {
      icon = 'üìù';
    }

    const size = this.formatFileSize(file.size);

    return `
      <div class="fm-file-item" data-path="${file.path}" data-is-dir="${file.is_dir}">
        <div class="fm-file-icon">${icon}</div>
        <div class="fm-file-name">${file.name}</div>
        <div class="fm-file-meta">${file.is_dir ? 'Êñá‰ª∂Â§π' : size}</div>
      </div>
    `;
  },

  // Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
  formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  },

  // Êõ¥Êñ∞Èù¢ÂåÖÂ±ë
  updateBreadcrumb(path) {
    document.getElementById('fmBreadcrumb').textContent = path || '/';
  },

  // Êõ¥Êñ∞ËøîÂõûÊåâÈíÆÁä∂ÊÄÅ
  updateBackButton(parentPath) {
    const backBtn = document.getElementById('fmBackBtn');
    backBtn.disabled = !parentPath;
  },

  // Êõ¥Êñ∞Êñá‰ª∂ËÆ°Êï∞
  updateFileCount(count) {
    document.getElementById('fmInfo').textContent = `${count} ‰∏™È°πÁõÆ`;
  },

  // ÂØºËà™Âà∞ÁõÆÂΩï
  navigateTo(path) {
    this.currentPath = path;
    this.loadFiles();
  },

  // ËøîÂõû‰∏äÁ∫ßÁõÆÂΩï
  goBack() {
    const parentPath = this.getParentPath(this.currentPath);
    if (parentPath) {
      this.navigateTo(parentPath);
    }
  },

  // Ëé∑ÂèñÁà∂ÁõÆÂΩïË∑ØÂæÑ
  getParentPath(path) {
    if (path === this.currentRoot) {
      return null;
    }
    const parts = path.split('/');
    parts.pop();
    const parent = parts.join('/');
    return parent || this.currentRoot;
  },

  // ÊâìÂºÄÊñá‰ª∂
  openFile(path) {
    const fileName = path.split('/').pop();
    const extension = fileName.split('.').pop().toLowerCase();

    // ÂõæÁâáÊñá‰ª∂ÔºöÂÖ®Â±èÂ±ïÁ§∫
    if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'].includes(extension)) {
      const imageUrl = `/${path}`;
      this.showImagePreview(imageUrl);
      return;
    }

    // Markdown Êñá‰ª∂Ôºö‰ΩøÁî®Ê®°ÊÄÅÊ°ÜÈ¢ÑËßà
    if (extension === 'md') {
      let markdownPath = path;

      // Â§ÑÁêÜÁªùÂØπË∑ØÂæÑÔºàÂ¶ÇÔºö/home/user/project/markdown/2026/02/19/test.mdÔºâ
      if (markdownPath.startsWith('/')) {
        const markdownIndex = markdownPath.indexOf('/markdown/');
        if (markdownIndex !== -1) {
          markdownPath = markdownPath.substring(markdownIndex + 10); // ÂéªÊéâ '/markdown/' ÂâçÁºÄ
        } else {
          console.error('Êó†ÊïàÁöÑ Markdown Ë∑ØÂæÑ:', path);
          this.showToast('Êó†ÊïàÁöÑ Markdown Ë∑ØÂæÑ', 'error');
          return;
        }
      }
      // Â§ÑÁêÜÁõ∏ÂØπË∑ØÂæÑÔºàÂ¶ÇÔºömarkdown/2026/02/19/test.mdÔºâ
      else if (markdownPath.startsWith('markdown/')) {
        markdownPath = markdownPath.substring(9); // ÂéªÊéâ 'markdown/' ÂâçÁºÄ
      } else {
        console.error('Êó†ÊïàÁöÑ Markdown Ë∑ØÂæÑ:', path);
        this.showToast('Êó†ÊïàÁöÑ Markdown Ë∑ØÂæÑ', 'error');
        return;
      }

      // È™åËØÅÊèêÂèñÂêéÁöÑË∑ØÂæÑ‰∏ç‰∏∫Á©∫‰∏î‰∏çÊòØÊ†πË∑ØÂæÑ
      if (!markdownPath || markdownPath === '/' || markdownPath.trim() === '') {
        console.error('ÊèêÂèñÂêéÁöÑ Markdown Ë∑ØÂæÑÊó†Êïà:', markdownPath);
        this.showToast('Êó†ÊïàÁöÑ Markdown Ë∑ØÂæÑ', 'error');
        return;
      }

      if (window.MarkdownPreviewModal) {
        window.MarkdownPreviewModal.open(markdownPath);
      } else {
        console.error('MarkdownPreviewModal not available');
      }
      return;
    }

    // ÂÖ∂‰ªñÊñá‰ª∂Á±ªÂûãÔºö‰∏ãËΩΩ
    this.downloadFile(path);
  },

  // Â±ïÁ§∫ÂõæÁâáÈ¢ÑËßà
  showImagePreview(imageUrl) {
    // ÂàõÂª∫ÂõæÁâáÈ¢ÑËßàÊ®°ÊÄÅÊ°Ü
    const preview = document.createElement('div');
    preview.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    `;

    const img = document.createElement('img');
    img.src = imageUrl;
    img.style.cssText = `
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      border-radius: 8px;
    `;

    const closeHint = document.createElement('div');
    closeHint.textContent = 'ÁÇπÂáªÂÖ≥Èó≠';
    closeHint.style.cssText = `
      position: absolute;
      bottom: 30px;
      color: white;
      font-size: 16px;
      opacity: 0.7;
    `;

    preview.appendChild(img);
    preview.appendChild(closeHint);

    // ÁÇπÂáªÂÖ≥Èó≠
    preview.addEventListener('click', () => {
      document.body.removeChild(preview);
    });

    // ESC ÈîÆÂÖ≥Èó≠
    const closeHandler = (e) => {
      if (e.key === 'Escape') {
        document.body.removeChild(preview);
        document.removeEventListener('keydown', closeHandler);
      }
    };
    document.addEventListener('keydown', closeHandler);

    document.body.appendChild(preview);
  },

  // ‰∏ãËΩΩÊñá‰ª∂
  async downloadFile(path) {
    try {
      const response = await fetch(`/api/files/download?path=${encodeURIComponent(path)}`, {
        headers: {
          'Authorization': this.getAuthHeader()
        }
      });

      if (!response.ok) {
        const result = await response.json();
        showToast(result.message || '‰∏ãËΩΩÂ§±Ë¥•', 'error');
        return;
      }

      const fileName = path.split('/').pop();
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    } catch (error) {
      console.error('‰∏ãËΩΩÂ§±Ë¥•:', error);
      showToast('‰∏ãËΩΩÂ§±Ë¥•', 'error');
    }
  },

  // ÊòæÁ§∫‰∏ä‰∏ãÊñáËèúÂçï
  showContextMenu(event, path, isDir) {
    this.selectedFile = { path, isDir };

    // ÁßªÈô§ÊóßÁöÑËèúÂçï
    const oldMenu = document.querySelector('.fm-context-menu');
    if (oldMenu) {
      oldMenu.remove();
    }

    // ÂàõÂª∫Êñ∞ËèúÂçï
    const menu = document.createElement('div');
    menu.className = 'fm-context-menu';
    menu.style.left = event.pageX + 'px';
    menu.style.top = event.pageY + 'px';

    // Âà§Êñ≠Êñá‰ª∂Á±ªÂûã
    const fileName = path.split('/').pop();
    const extension = fileName.split('.').pop().toLowerCase();
    const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'].includes(extension);
    const isMarkdown = extension === 'md';

    const items = [
      { action: 'open', label: 'ÊâìÂºÄ', icon: 'üìÇ' },
      { action: 'download', label: '‰∏ãËΩΩ', icon: '‚¨áÔ∏è', hide: isDir },
      { action: 'rename', label: 'ÈáçÂëΩÂêç', icon: '‚úèÔ∏è' },
      { action: 'delete', label: 'Âà†Èô§', icon: 'üóëÔ∏è', danger: true }
    ];

    items.forEach(item => {
      if (item.hide) return;

      const menuItem = document.createElement('div');
      menuItem.className = 'fm-context-menu-item' + (item.danger ? ' danger' : '');
      menuItem.innerHTML = `<span>${item.icon}</span>${item.label}`;
      menuItem.addEventListener('click', () => {
        this.handleContextAction(item.action);
        this.hideContextMenu();
      });
      menu.appendChild(menuItem);
    });

    document.body.appendChild(menu);
    menu.classList.add('active');
  },

  // ÈöêËóè‰∏ä‰∏ãÊñáËèúÂçï
  hideContextMenu() {
    const menu = document.querySelector('.fm-context-menu');
    if (menu) {
      menu.remove();
    }
  },

  // Â§ÑÁêÜ‰∏ä‰∏ãÊñáËèúÂçïÊìç‰Ωú
  handleContextAction(action) {
    if (!this.selectedFile) return;

    switch (action) {
      case 'open':
        if (this.selectedFile.isDir) {
          this.navigateTo(this.selectedFile.path);
        } else {
          this.openFile(this.selectedFile.path);
        }
        break;
      case 'download':
        this.downloadFile(this.selectedFile.path);
        break;
      case 'rename':
        this.openRenameModal();
        break;
      case 'delete':
        this.openDeleteModal();
        break;
    }
  },

  // ÊâìÂºÄ‰∏ä‰º†Ê®°ÊÄÅÊ°Ü
  openUploadModal() {
    // ‰ΩøÁî®Áé∞ÊúâÁöÑ‰∏ä‰º†Ê®°ÊÄÅÊ°Ü
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.style.display = 'none';
    input.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      if (files.length > 0) {
        this.uploadFiles(files);
      }
      input.remove();
    });
    document.body.appendChild(input);
    input.click();
  },

  // ‰∏ä‰º†Êñá‰ª∂
  async uploadFiles(files) {
    for (const file of files) {
      try {
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch(`/api/files?path=${encodeURIComponent(this.currentPath)}`, {
          method: 'POST',
          headers: {
            'Authorization': this.getAuthHeader()
          },
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          showToast(`ÊàêÂäü‰∏ä‰º† ${file.name}`, 'success');
        } else {
          showToast(`‰∏ä‰º† ${file.name} Â§±Ë¥•`, 'error');
        }
      } catch (error) {
        console.error('‰∏ä‰º†Â§±Ë¥•:', error);
        showToast(`‰∏ä‰º† ${file.name} Â§±Ë¥•`, 'error');
      }
    }

    this.loadFiles();
    this.loadTree();
  },

  // ÊâìÂºÄÂàõÂª∫ÁõÆÂΩïÊ®°ÊÄÅÊ°Ü
  openCreateDirModal() {
    const dirName = prompt('ËØ∑ËæìÂÖ•Êñá‰ª∂Â§πÂêçÁß∞:');
    if (dirName && dirName.trim()) {
      this.createDirectory(dirName.trim());
    }
  },

  // ÂàõÂª∫ÁõÆÂΩï
  async createDirectory(dirName) {
    try {
      const response = await fetch('/api/files/create-dir', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': this.getAuthHeader()
        },
        body: JSON.stringify({
          path: this.currentPath,
          dir_name: dirName
        })
      });

      const result = await response.json();

      if (result.success) {
        showToast('Êñá‰ª∂Â§πÂàõÂª∫ÊàêÂäü', 'success');
        this.loadFiles();
        this.loadTree();
      } else {
        showToast(result.message, 'error');
      }
    } catch (error) {
      console.error('ÂàõÂª∫ÁõÆÂΩïÂ§±Ë¥•:', error);
      showToast('ÂàõÂª∫Êñá‰ª∂Â§πÂ§±Ë¥•', 'error');
    }
  },

  // ÊâìÂºÄÈáçÂëΩÂêçÊ®°ÊÄÅÊ°Ü
  openRenameModal() {
    if (!this.selectedFile) return;

    const oldName = this.selectedFile.path.split('/').pop();
    const newName = prompt('ËØ∑ËæìÂÖ•Êñ∞ÂêçÁß∞:', oldName);

    if (newName && newName.trim() && newName.trim() !== oldName) {
      this.renameFile(newName.trim());
    }
  },

  // ÈáçÂëΩÂêçÊñá‰ª∂
  async renameFile(newName) {
    if (!this.selectedFile) return;

    try {
      const response = await fetch('/api/files', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': this.getAuthHeader()
        },
        body: JSON.stringify({
          old_path: this.selectedFile.path,
          new_name: newName
        })
      });

      const result = await response.json();

      if (result.success) {
        showToast('ÈáçÂëΩÂêçÊàêÂäü', 'success');
        this.loadFiles();
        this.loadTree();
      } else {
        showToast(result.message, 'error');
      }
    } catch (error) {
      console.error('ÈáçÂëΩÂêçÂ§±Ë¥•:', error);
      showToast('ÈáçÂëΩÂêçÂ§±Ë¥•', 'error');
    }
  },

  // ÊâìÂºÄÂà†Èô§Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü
  openDeleteModal() {
    if (!this.selectedFile) return;

    const fileName = this.selectedFile.path.split('/').pop();
    if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ "${fileName}" ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
      this.deleteFile();
    }
  },

  // Âà†Èô§Êñá‰ª∂
  async deleteFile() {
    if (!this.selectedFile) return;

    try {
      const response = await fetch(`/api/files?path=${encodeURIComponent(this.selectedFile.path)}`, {
        method: 'DELETE',
        headers: {
          'Authorization': this.getAuthHeader()
        }
      });

      const result = await response.json();

      if (result.success) {
        showToast('Âà†Èô§ÊàêÂäü', 'success');
        this.loadFiles();
        this.loadTree();
      } else {
        showToast(result.message, 'error');
      }
    } catch (error) {
      console.error('Âà†Èô§Â§±Ë¥•:', error);
      showToast('Âà†Èô§Â§±Ë¥•', 'error');
    }
  }
};

// ‰∏ä‰º†ÈôÑ‰ª∂ÂäüËÉΩ
const AttachmentUploader = {
  currentArticleId: null,

  init() {
    const uploadBtn = document.getElementById('uploadAttachmentBtn');
    if (uploadBtn) {
      uploadBtn.addEventListener('click', () => this.uploadAttachment());
    }
  },

  async uploadAttachment() {
    const fileInput = document.getElementById('attachmentFile');
    const articleIdElement = document.getElementById('uploadAttachmentArticleId');
    const progressDiv = document.getElementById('uploadAttachmentProgress');
    const resultDiv = document.getElementById('uploadAttachmentResult');
    const progressBar = document.getElementById('uploadAttachmentProgressBar');
    const statusDiv = document.getElementById('uploadAttachmentStatus');
    const fileInfoDiv = document.getElementById('uploadAttachmentFileInfo');

    if (!fileInput.files || fileInput.files.length === 0) {
      showToast('ËØ∑ÈÄâÊã©Ë¶Å‰∏ä‰º†ÁöÑÊñá‰ª∂', 'error');
      return;
    }

    const file = fileInput.files[0];
    this.currentArticleId = articleIdElement.dataset.articleId;

    // ÊòæÁ§∫ËøõÂ∫¶
    progressDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    progressBar.style.width = '0%';
    statusDiv.textContent = 'Ê≠£Âú®‰∏ä‰º†...';

    const formData = new FormData();
    formData.append('file', file);
    formData.append('passage_id', this.currentArticleId);

    try {
      const token = localStorage.getItem('auth_token');
      const response = await fetch('/api/admin/attachments', {
        method: 'POST',
        headers: token ? { 'Authorization': `Bearer ${token}` } : {},
        body: formData
      });

      const result = await response.json();

      // Êõ¥Êñ∞ËøõÂ∫¶
      progressBar.style.width = '100%';

      if (result.success) {
        statusDiv.textContent = '‰∏ä‰º†ÊàêÂäüÔºÅ';
        
        // ÊòæÁ§∫ÁªìÊûú
        resultDiv.style.display = 'block';
        fileInfoDiv.innerHTML = `
          <div><strong>Êñá‰ª∂ÂêçÔºö</strong>${result.data.fileName}</div>
          <div><strong>Êñá‰ª∂Â§ßÂ∞èÔºö</strong>${this.formatFileSize(result.data.size)}</div>
          <div><strong>Êñá‰ª∂Á±ªÂûãÔºö</strong>${result.data.type}</div>
          <div><strong>ËÆøÈóÆURLÔºö</strong><a href="${result.data.url}" target="_blank" style="color: #007bff;">${result.data.url}</a></div>
        `;

        showToast('ÈôÑ‰ª∂‰∏ä‰º†ÊàêÂäüÔºÅ', 'success');

        // 3ÁßíÂêéÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        setTimeout(() => {
          closeModal('uploadAttachmentModal');
        }, 3000);
      } else {
        statusDiv.textContent = '‰∏ä‰º†Â§±Ë¥•Ôºö' + (result.message || 'Êú™Áü•ÈîôËØØ');
        showToast('ÈôÑ‰ª∂‰∏ä‰º†Â§±Ë¥•Ôºö' + (result.message || 'Êú™Áü•ÈîôËØØ'), 'error');
      }
    } catch (error) {
      console.error('‰∏ä‰º†ÈôÑ‰ª∂Â§±Ë¥•:', error);
      progressBar.style.width = '100%';
      statusDiv.textContent = '‰∏ä‰º†Â§±Ë¥•ÔºöÁΩëÁªúÈîôËØØ';
      showToast('ÈôÑ‰ª∂‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
    }
  },

  formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }
};

// ÂΩìÂàáÊç¢Âà∞Êñá‰ª∂ÁÆ°ÁêÜÊ†áÁ≠æÈ°µÊó∂ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', () => {
  // ÂàùÂßãÂåñ‰∏ä‰º†ÈôÑ‰ª∂ÂäüËÉΩ
  AttachmentUploader.init();

  const fileManagerTab = document.querySelector('[data-tab="filemanager"]');
  if (fileManagerTab) {
    fileManagerTab.addEventListener('click', () => {
      setTimeout(() => {
        if (!FileManager.initialized) {
          FileManager.init();
          FileManager.initialized = true;
        }
      }, 100);
    });
  }
});
</script>

<!-- ECCÂä†ÂØÜÂ∑•ÂÖ∑ -->
<script src="/js/ecc-encrypt.js"></script>
<script src="/js/login.js"></script>
<!-- Ê®°ÊÄÅÊ°ÜÂä®ÁîªÊéßÂà∂ËÑöÊú¨ -->
<script src="/js/modal-animations.js"></script>
<!-- ÈîÆÁõòÂø´Êç∑ÈîÆËÑöÊú¨ -->
<script src="/js/keyboard-shortcuts.js"></script>
<!-- Markdown È¢ÑËßàÊ®°ÊÄÅÊ°Ü -->
<script src="/js/markdown-preview-modal.js?v=3"></script>

<!-- Live2D ÁúãÊùøÂ®òÈÖçÁΩÆ -->
<script>
(function() {
  const live2dEnabled = {{ live2d_enabled }};
  const live2dShowOnAdmin = {{ live2d_show_on_admin }};

  if (!live2dEnabled || !live2dShowOnAdmin) {
    return;
  }

  const live2dConfig = {
    waifuPath: 'https://fastly.jsdelivr.net/npm/live2d-widget@1.0.0/dist/waifu-tips.json',
    cdnPath: '{{ live2d_cdn_path }}',
    cubism2Path: 'https://fastly.jsdelivr.net/npm/live2d-widget@1.0.0/dist/live2d.min.js',
    cubism5Path: 'https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js',
    modelId: {{ live2d_model_id }},
    modelPath: '{{ live2d_model_path }}',
    tools: ['switch-model', 'switch-texture', 'photo', 'info', 'quit'],
    drag: true,
    logLevel: 'error',
    position: '{{ live2d_position }}',
    width: '{{ live2d_width }}',
    height: '{{ live2d_height }}'
  };

  window.addEventListener('load', function() {
    setTimeout(function() {
      try {
        if (document.querySelector('script[src*="autoload.js"]')) {
          return;
        }

        const script = document.createElement('script');
        script.src = 'https://fastly.jsdelivr.net/npm/live2d-widgets@1.0.0/dist/autoload.js';
        script.async = true;

        script.onload = function() {
          console.log('Live2D ÁúãÊùøÂ®òÂä†ËΩΩÂÆåÊàê');
          if (typeof initWidget === 'function') {
            try {
              initWidget(live2dConfig);
            } catch (e) {
              console.warn('Live2D ÁúãÊùøÂ®òÂàùÂßãÂåñÂ§±Ë¥•:', e);
            }
          }
        };

        script.onerror = function() {
          console.warn('Live2D ÁúãÊùøÂ®òÂä†ËΩΩÂ§±Ë¥•ÔºåÂèØËÉΩÊòØÁΩëÁªúÈóÆÈ¢òÊàñ CDN ‰∏çÂèØÁî®');
        };

        document.body.appendChild(script);
      } catch (error) {
        console.warn('Live2D ÁúãÊùøÂ®òÂàùÂßãÂåñÈîôËØØ:', error);
      }
    }, 1000);
  });
})();
</script>

<!-- ÈôÑ‰ª∂ÁÆ°ÁêÜ JavaScript -->
<script>
(function() {
  // ÈôÑ‰ª∂ÁÆ°ÁêÜÂÖ®Â±ÄÂèòÈáè
  let attachmentsData = [];
  let currentPage = 1;
  const pageSize = 20;
  let totalAttachments = 0;

  // DOM ÂÖÉÁ¥†
  const elements = {
    uploadBtn: document.getElementById('amUploadBtn'),
    emptyUploadBtn: document.getElementById('amEmptyUploadBtn'),
    refreshBtn: document.getElementById('amRefreshBtn'),
    fileTypeFilter: document.getElementById('amFileTypeFilter'),
    visibilityFilter: document.getElementById('amVisibilityFilter'),
    passageFilter: document.getElementById('amPassageFilter'),
    searchInput: document.getElementById('amSearchInput'),
    tableBody: document.getElementById('attachmentsTableBody'),
    selectAll: document.getElementById('amSelectAll'),
    totalCount: document.getElementById('amTotalCount'),
    totalSize: document.getElementById('amTotalSize'),
    imageCount: document.getElementById('amImageCount'),
    documentCount: document.getElementById('amDocumentCount'),
    paginationContainer: document.getElementById('amPaginationContainer'),
    paginationInfo: document.getElementById('amPaginationInfo'),
    prevPageBtn: document.getElementById('amPrevPageBtn'),
    nextPageBtn: document.getElementById('amNextPageBtn'),
    paginationPages: document.getElementById('amPaginationPages'),
    batchActions: document.getElementById('amBatchActions'),
    selectedCount: document.getElementById('amSelectedCount'),
    batchDeleteBtn: document.getElementById('amBatchDeleteBtn'),
    batchSetPublicBtn: document.getElementById('amBatchSetPublicBtn'),
    batchSetPrivateBtn: document.getElementById('amBatchSetPrivateBtn'),
    cancelSelectionBtn: document.getElementById('amCancelSelectionBtn')
  };

  // Â∑•ÂÖ∑ÂáΩÊï∞ÔºöÊ†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  // Â∑•ÂÖ∑ÂáΩÊï∞ÔºöÊ†ºÂºèÂåñÊó•Êúü
  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // Â∑•ÂÖ∑ÂáΩÊï∞ÔºöËé∑ÂèñÊñá‰ª∂Á±ªÂûãÂõæÊ†á
  function getFileTypeIcon(fileType) {
    const icons = {
      image: 'üñºÔ∏è',
      document: 'üìÑ',
      video: 'üé¨',
      audio: 'üéµ',
      archive: 'üì¶'
    };
    return icons[fileType] || 'üìé';
  }

  // Â∑•ÂÖ∑ÂáΩÊï∞ÔºöËé∑ÂèñÂèØËßÅÊÄßÊ†áÁ≠æ
  function getVisibilityBadge(visibility) {
    const badges = {
      public: '<span class="status published">ÂÖ¨ÂºÄ</span>',
      private: '<span class="status draft">ÁßÅÂØÜ</span>',
      protected: '<span class="status pending">Âèó‰øùÊä§</span>'
    };
    return badges[visibility] || visibility;
  }

  // Âä†ËΩΩÈôÑ‰ª∂ÂàóË°®
  window.loadAttachments = async function loadAttachments() {
    try {
      const params = new URLSearchParams({
        limit: pageSize,
        offset: (currentPage - 1) * pageSize
      });

      // Ê∑ªÂä†Á≠õÈÄâÂèÇÊï∞
      const fileType = elements.fileTypeFilter.value;
      const visibility = elements.visibilityFilter.value;
      const passageId = elements.passageFilter.value;
      const search = elements.searchInput.value.trim();

      if (fileType) params.append('file_type', fileType);
      if (visibility) params.append('visibility', visibility);
      if (passageId) params.append('passage_id', passageId);

      const response = await fetch(`/api/admin/attachments?${params.toString()}`);
      const result = await response.json();

      if (result.success) {
        attachmentsData = result.data || [];
        totalAttachments = result.total || 0;

        // Â¶ÇÊûúÊúâÊêúÁ¥¢ÂÖ≥ÈîÆËØçÔºåÂú®ÂâçÁ´ØËøáÊª§
        if (search) {
          attachmentsData = attachmentsData.filter(att => 
            att.file_name.toLowerCase().includes(search.toLowerCase())
          );
          totalAttachments = attachmentsData.length;
        }

        renderAttachments();
        updateStats();
        updatePagination();
      } else {
        showToast('Âä†ËΩΩÈôÑ‰ª∂ÂàóË°®Â§±Ë¥•: ' + result.message, 'error');
      }
    } catch (error) {
      console.error('Âä†ËΩΩÈôÑ‰ª∂ÂàóË°®Â§±Ë¥•:', error);
      showToast('Âä†ËΩΩÈôÑ‰ª∂ÂàóË°®Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•', 'error');
    }
  }

  // Ê∏≤ÊüìÈôÑ‰ª∂ÂàóË°®
  function renderAttachments() {
    if (attachmentsData.length === 0) {
      elements.tableBody.innerHTML = `
        <tr>
          <td colspan="9" style="text-align: center; padding: 40px;">
            <div class="am-empty-state">
              <div class="am-empty-icon">üì≠</div>
              <p>ÊöÇÊó†ÈôÑ‰ª∂</p>
              <button class="btn-primary" id="amEmptyUploadBtn" style="margin-top: 15px;">
                ‰∏ä‰º†Á¨¨‰∏Ä‰∏™ÈôÑ‰ª∂
              </button>
            </div>
          </td>
        </tr>
      `;
      return;
    }

    elements.tableBody.innerHTML = attachmentsData.map(attachment => {
      const isSelected = selectedAttachments.has(attachment.id);
      const previewUrl = attachment.file_path;
      const isImage = attachment.file_type === 'image';

      return `
        <tr class="${isSelected ? 'selected' : ''}" data-id="${attachment.id}">
          <td>
            <input type="checkbox" class="am-checkbox" 
                   data-id="${attachment.id}" 
                   ${isSelected ? 'checked' : ''}>
          </td>
          <td>
            ${isImage ? 
              `<img src="${previewUrl}" alt="${attachment.file_name}" 
                     style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; cursor: pointer;"
                     onclick="window.open('${previewUrl}', '_blank')">` :
              `<div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: #f5f5f5; border-radius: 4px;">
                ${getFileTypeIcon(attachment.file_type)}
               </div>`
            }
          </td>
          <td>
            <div style="font-weight: 500;">${attachment.file_name}</div>
            <div style="font-size: 0.85em; color: #888;">${attachment.stored_name}</div>
          </td>
          <td>${getFileTypeIcon(attachment.file_type)} ${attachment.file_type}</td>
          <td>${formatFileSize(attachment.file_size)}</td>
          <td>${getVisibilityBadge(attachment.visibility)}</td>
          <td>${attachment.passage_id ? `<a href="/passage?id=${attachment.passage_id}" target="_blank">#${attachment.passage_id}</a>` : '-'}</td>
          <td>${formatDate(attachment.uploaded_at)}</td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-sm btn-view" onclick="viewAttachment(${attachment.id})" title="Êü•Áúã">
                üëÅÔ∏è
              </button>
              <button class="btn btn-sm btn-edit" onclick="editAttachment(${attachment.id})" title="ÁºñËæëÊùÉÈôê">
                üîí
              </button>
              <button class="btn btn-sm btn-delete" onclick="deleteAttachment(${attachment.id})" title="Âà†Èô§">
                üóëÔ∏è
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join('');

    // ÁªëÂÆöÂ§çÈÄâÊ°Ü‰∫ã‰ª∂
    document.querySelectorAll('.am-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', handleCheckboxChange);
    });

    // ÁªëÂÆöÁ©∫Áä∂ÊÄÅ‰∏ä‰º†ÊåâÈíÆ
    const emptyUploadBtn = document.getElementById('amEmptyUploadBtn');
    if (emptyUploadBtn) {
      emptyUploadBtn.addEventListener('click', showUploadModal);
    }
  }

  // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
  function updateStats() {
    elements.totalCount.textContent = totalAttachments;

    let totalSize = 0;
    let imageCount = 0;
    let documentCount = 0;

    attachmentsData.forEach(att => {
      totalSize += att.file_size;
      if (att.file_type === 'image') imageCount++;
      if (att.file_type === 'document') documentCount++;
    });

    elements.totalSize.textContent = formatFileSize(totalSize);
    elements.imageCount.textContent = imageCount;
    elements.documentCount.textContent = documentCount;
  }

  // Êõ¥Êñ∞ÂàÜÈ°µ
  function updatePagination() {
    const totalPages = Math.ceil(totalAttachments / pageSize);

    if (totalPages <= 1) {
      elements.paginationContainer.style.display = 'none';
      return;
    }

    elements.paginationContainer.style.display = 'flex';
    elements.paginationInfo.textContent = `ÊòæÁ§∫ ${(currentPage - 1) * pageSize + 1}-${Math.min(currentPage * pageSize, totalAttachments)} Êù°ÔºåÂÖ± ${totalAttachments} Êù°`;

    elements.prevPageBtn.disabled = currentPage === 1;
    elements.nextPageBtn.disabled = currentPage === totalPages;

    // ÁîüÊàêÈ°µÁ†Å
    let pages = '';
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage < maxVisiblePages - 1) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    for (let i = startPage; i <= endPage; i++) {
      pages += `<button class="pagination-page ${i === currentPage ? 'active' : ''}" 
                       data-page="${i}">${i}</button>`;
    }

    elements.paginationPages.innerHTML = pages;

    // ÁªëÂÆöÈ°µÁ†ÅÁÇπÂáª‰∫ã‰ª∂
    document.querySelectorAll('#amPaginationPages .pagination-page').forEach(btn => {
      btn.addEventListener('click', () => {
        currentPage = parseInt(btn.dataset.page);
        loadAttachments();
      });
    });
  }

  // Â§ÑÁêÜÂ§çÈÄâÊ°ÜÂèòÂåñ
  function handleCheckboxChange(e) {
    const id = parseInt(e.target.dataset.id);
    if (e.target.checked) {
      selectedAttachments.add(id);
    } else {
      selectedAttachments.delete(id);
      elements.selectAll.checked = false;
    }
    updateBatchActions();
  }

  // Êõ¥Êñ∞ÊâπÈáèÊìç‰ΩúÊ†è
  window.updateBatchActions = function updateBatchActions() {
    const count = selectedAttachments.size;
    elements.selectedCount.textContent = count;
    elements.batchActions.style.display = count > 0 ? 'flex' : 'none';
  }

  // ÊòæÁ§∫‰∏ä‰º†Ê®°ÊÄÅÊ°Ü
  function showUploadModal() {
    const modalHtml = `
      <div class="modal active" id="uploadModal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>‰∏ä‰º†ÈôÑ‰ª∂</h3>
            <button class="modal-close" onclick="closeUploadModal()">√ó</button>
          </div>
          <div class="modal-body">
            <div class="upload-area" id="uploadArea">
              <div class="upload-icon">üì§</div>
              <div class="upload-text">
                <h4>ÊãñÊãΩÊñá‰ª∂Âà∞ËøôÈáåÊàñÁÇπÂáª‰∏ä‰º†</h4>
                <p>ÊîØÊåÅÂõæÁâá„ÄÅÊñáÊ°£„ÄÅËßÜÈ¢ë„ÄÅÈü≥È¢ë„ÄÅÂéãÁº©ÂåÖ</p>
              </div>
              <input type="file" id="fileInput" multiple style="display: none;">
            </div>
            <div class="upload-preview" id="uploadPreview"></div>
            <div class="form-group" style="margin-top: 20px;">
              <label for="uploadPassageId">ÂÖ≥ËÅîÊñáÁ´†ÔºàÂèØÈÄâÔºâ</label>
              <select id="uploadPassageId" class="form-control">
                <option value="">‰∏çÂÖ≥ËÅî</option>
              </select>
            </div>
          </div>
          <div class="btn-group" style="padding: 0 30px 30px;">
            <button class="btn-secondary" onclick="closeUploadModal()">ÂèñÊ∂à</button>
            <button class="btn-primary" id="confirmUploadBtn" disabled>ÂºÄÂßã‰∏ä‰º†</button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);
    initUploadModal();
  }

  // ÂàùÂßãÂåñ‰∏ä‰º†Ê®°ÊÄÅÊ°Ü
  function initUploadModal() {
    const modal = document.getElementById('uploadModal');
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadPreview = document.getElementById('uploadPreview');
    const confirmUploadBtn = document.getElementById('confirmUploadBtn');
    const passageIdSelect = document.getElementById('uploadPassageId');

    let selectedFiles = [];

    // Âä†ËΩΩÊñáÁ´†ÂàóË°®
    loadPassageList(passageIdSelect);

    // ÁÇπÂáª‰∏ä‰º†Âå∫Âüü
    uploadArea.addEventListener('click', () => fileInput.click());

    // Êñá‰ª∂ÈÄâÊã©
    fileInput.addEventListener('change', (e) => {
      handleFileSelect(e.target.files);
    });

    // ÊãñÊãΩ‰∏ä‰º†
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFileSelect(e.dataTransfer.files);
    });

    function handleFileSelect(files) {
      selectedFiles = Array.from(files);
      renderPreview();
      confirmUploadBtn.disabled = selectedFiles.length === 0;
    }

    function renderPreview() {
      uploadPreview.innerHTML = selectedFiles.map((file, index) => `
        <div class="upload-item">
          ${file.type.startsWith('image/') ? 
            `<img src="${URL.createObjectURL(file)}" alt="${file.name}">` :
            `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #f5f5f5;">
              ${getFileTypeIcon(getFileTypeFromMime(file.type))}
             </div>`
          }
          <button class="upload-remove" onclick="removeUploadFile(${index})">√ó</button>
          <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; font-size: 0.75em; padding: 4px; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${file.name}
          </div>
        </div>
      `).join('');
    }

    // Á°ÆËÆ§‰∏ä‰º†
    confirmUploadBtn.addEventListener('click', async () => {
      if (selectedFiles.length === 0) return;

      confirmUploadBtn.disabled = true;
      confirmUploadBtn.textContent = '‰∏ä‰º†‰∏≠...';

      const passageId = passageIdSelect.value;

      for (const file of selectedFiles) {
        const formData = new FormData();
        formData.append('file', file);
        if (passageId) {
          formData.append('passage_id', passageId);
        }

        try {
          const response = await fetch('/api/admin/attachments', {
            method: 'POST',
            body: formData
          });
          const result = await response.json();

          if (!result.success) {
            showToast(`‰∏ä‰º† ${file.name} Â§±Ë¥•: ${result.message}`, 'error');
          }
        } catch (error) {
          console.error('‰∏ä‰º†Â§±Ë¥•:', error);
          showToast(`‰∏ä‰º† ${file.name} Â§±Ë¥•`, 'error');
        }
      }

      showToast('‰∏ä‰º†ÂÆåÊàê', 'success');
      closeUploadModal();
      loadAttachments();
    });

    // ÂÖ®Â±ÄÂáΩÊï∞ÔºöÁßªÈô§‰∏ä‰º†Êñá‰ª∂
    window.removeUploadFile = function(index) {
      selectedFiles.splice(index, 1);
      renderPreview();
      confirmUploadBtn.disabled = selectedFiles.length === 0;
    };
  }

  // Âä†ËΩΩÊñáÁ´†ÂàóË°®
  async function loadPassageList(selectElement) {
    try {
      const response = await fetch('/api/admin/passages?limit=100');
      const result = await response.json();

      if (result.success && result.data) {
        result.data.forEach(passage => {
          const option = document.createElement('option');
          option.value = passage.id;
          option.textContent = passage.title;
          selectElement.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Âä†ËΩΩÊñáÁ´†ÂàóË°®Â§±Ë¥•:', error);
    }
  }

  // ÂÖ≥Èó≠‰∏ä‰º†Ê®°ÊÄÅÊ°Ü
  window.closeUploadModal = function() {
    const modal = document.getElementById('uploadModal');
    if (modal) {
      modal.remove();
    }
  };

  // Êü•ÁúãÈôÑ‰ª∂
  window.viewAttachment = function(id) {
    const attachment = attachmentsData.find(a => a.id === id);
    if (attachment) {
      window.open(attachment.file_path, '_blank');
    }
  };

  // ÁºñËæëÈôÑ‰ª∂ÊùÉÈôê
  window.editAttachment = async function(id) {
    console.log('ÊâìÂºÄÁºñËæëÊ®°ÊÄÅÊ°ÜÔºåID:', id);

    // ÂÖàÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÊ®°ÊÄÅÊ°Ü
    const existingModal = document.getElementById('editModal');
    if (existingModal) {
      existingModal.remove();
    }

    // ‰ªéAPIËé∑ÂèñÊúÄÊñ∞ÁöÑÈôÑ‰ª∂Êï∞ÊçÆ
    try {
      const response = await fetch(`/api/admin/attachments/${id}`);
      const result = await response.json();

      if (result.success && result.data) {
        // ÂêéÁ´ØËøîÂõûÁöÑÊòØÊï∞ÁªÑÊ†ºÂºè,ÂèñÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†
        const attachment = Array.isArray(result.data) ? result.data[0] : result.data;
        console.log('‰ªéAPIËé∑ÂèñÁöÑÈôÑ‰ª∂Êï∞ÊçÆ:', attachment);

        const modalHtml = `
          <div class="modal active" id="editModal">
            <div class="modal-content">
              <div class="modal-header">
                <h3>ÁºñËæëÈôÑ‰ª∂ÊùÉÈôê</h3>
                <button class="modal-close" onclick="closeEditModal()">√ó</button>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label>Êñá‰ª∂Âêç</label>
                  <input type="text" class="form-control" value="${attachment.file_name}" disabled>
                </div>
                <div class="form-group">
                  <label for="editVisibility">ÂèØËßÅÊÄß</label>
                  <select id="editVisibility" class="form-control">
                    <option value="public" ${(attachment.visibility || 'public') === 'public' ? 'selected' : ''}>ÂÖ¨ÂºÄ</option>
                    <option value="private" ${(attachment.visibility || 'public') === 'private' ? 'selected' : ''}>ÁßÅÂØÜ</option>
                    <option value="protected" ${(attachment.visibility || 'public') === 'protected' ? 'selected' : ''}>Âèó‰øùÊä§</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="editShowInPassage">
                    <input type="checkbox" id="editShowInPassage" ${attachment.show_in_passage ? 'checked' : ''}>
                    Âú®ÊñáÁ´†‰∏≠ÊòæÁ§∫
                  </label>
                </div>
              </div>
              <div class="btn-group" style="padding: 0 30px 30px;">
                <button class="btn-secondary" onclick="closeEditModal()">ÂèñÊ∂à</button>
                <button class="btn-primary" onclick="saveAttachmentSettings(${id})">‰øùÂ≠ò</button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
      } else {
        showToast('Ëé∑ÂèñÈôÑ‰ª∂‰ø°ÊÅØÂ§±Ë¥•: ' + (result.message || 'Êú™Áü•ÈîôËØØ'), 'error');
      }
    } catch (error) {
      console.error('Ëé∑ÂèñÈôÑ‰ª∂‰ø°ÊÅØÂ§±Ë¥•:', error);
      showToast('Ëé∑ÂèñÈôÑ‰ª∂‰ø°ÊÅØÂ§±Ë¥•', 'error');
    }
  };

  // ‰øùÂ≠òÈôÑ‰ª∂ËÆæÁΩÆ
  window.saveAttachmentSettings = async function(id) {
    const visibility = document.getElementById('editVisibility').value;
    const showInPassage = document.getElementById('editShowInPassage').checked;

    console.log('‰øùÂ≠òÈôÑ‰ª∂ËÆæÁΩÆ:', { id, visibility, showInPassage });

    try {
      const response = await fetch(`/api/admin/attachments/${id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          visibility: visibility,
          show_in_passage: showInPassage
        })
      });
      const result = await response.json();

      console.log('‰øùÂ≠òÂìçÂ∫î:', result);

      if (result.success) {
        showToast('‰øùÂ≠òÊàêÂäü', 'success');
        closeEditModal();
        console.log('Ê≠£Âú®ÈáçÊñ∞Âä†ËΩΩÈôÑ‰ª∂ÂàóË°®...');
        await loadAttachments();
        console.log('ÈôÑ‰ª∂ÂàóË°®ÈáçÊñ∞Âä†ËΩΩÂÆåÊàê');
      } else {
        showToast('‰øùÂ≠òÂ§±Ë¥•: ' + result.message, 'error');
      }
    } catch (error) {
      console.error('‰øùÂ≠òÂ§±Ë¥•:', error);
      showToast('‰øùÂ≠òÂ§±Ë¥•', 'error');
    }
  };

  // ÂÖ≥Èó≠ÁºñËæëÊ®°ÊÄÅÊ°Ü
  window.closeEditModal = function() {
    const modal = document.getElementById('editModal');
    if (modal) {
      modal.classList.add('closing');
      setTimeout(() => {
        modal.remove();
      }, 300);
    }
  };

  // Âà†Èô§ÈôÑ‰ª∂
  window.deleteAttachment = async function(id) {
    currentAction = 'delete-attachment';
    currentItemId = id;

    const message = `Á°ÆÂÆöË¶ÅÂà†Èô§ÈôÑ‰ª∂ #${id} ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`;
    document.getElementById('confirmMessage').textContent = message;
    openModal('confirmModal');
  };

  // ÊâπÈáèÂà†Èô§
  async function batchDelete() {
    if (selectedAttachments.size === 0) return;

    currentAction = 'batch-delete-attachment';
    currentItemId = Array.from(selectedAttachments).join(',');

    const message = `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedAttachments.size} ‰∏™ÈôÑ‰ª∂ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`;
    document.getElementById('confirmMessage').textContent = message;
    openModal('confirmModal');
  }

  // ÊâπÈáèËÆæÁΩÆÂèØËßÅÊÄß
  async function batchSetVisibility(visibility) {
    if (selectedAttachments.size === 0) return;

    let successCount = 0;
    let failCount = 0;

    for (const id of selectedAttachments) {
      try {
        const response = await fetch(`/api/admin/attachments/${id}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            visibility: visibility
          })
        });
        const result = await response.json();

        if (result.success) {
          successCount++;
        } else {
          failCount++;
        }
      } catch (error) {
        console.error('ËÆæÁΩÆÂ§±Ë¥•:', error);
        failCount++;
      }
    }

    if (successCount > 0) {
      showToast(`ÊàêÂäüËÆæÁΩÆ ${successCount} ‰∏™ÈôÑ‰ª∂`, 'success');
    }
    if (failCount > 0) {
      showToast(`${failCount} ‰∏™ÈôÑ‰ª∂ËÆæÁΩÆÂ§±Ë¥•`, 'error');
    }

    loadAttachments();
  }

  // ÂèñÊ∂àÈÄâÊã©
  function cancelSelection() {
    selectedAttachments.clear();
    elements.selectAll.checked = false;
    updateBatchActions();
    renderAttachments();
  }

  // ‰ªéMIMEÁ±ªÂûãËé∑ÂèñÊñá‰ª∂Á±ªÂûã
  function getFileTypeFromMime(mimeType) {
    if (mimeType.startsWith('image/')) return 'image';
    if (mimeType.startsWith('video/')) return 'video';
    if (mimeType.startsWith('audio/')) return 'audio';
    if (mimeType.includes('pdf') || mimeType.includes('document') || mimeType.includes('word') || mimeType.includes('excel') || mimeType.includes('powerpoint')) return 'document';
    if (mimeType.includes('zip') || mimeType.includes('tar') || mimeType.includes('rar') || mimeType.includes('7z')) return 'archive';
    return 'document';
  }

  // ÊòæÁ§∫ToastÊèêÁ§∫
  function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
      <span class="toast-icon">${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}</span>
      <span class="toast-message">${message}</span>
      <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
    `;
    container.appendChild(toast);

    setTimeout(() => {
      toast.remove();
    }, 3000);
  }

  // ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨
  function initEventListeners() {
    // Âø´Êç∑ÈîÆÂ∏ÆÂä©ÊåâÈíÆ
    const shortcutsHelpBtn = document.getElementById('adminShortcutsHelpBtn');
    if (shortcutsHelpBtn && window.adminKeyboardManager) {
      shortcutsHelpBtn.addEventListener('click', () => {
        window.adminKeyboardManager.showAdminShortcutHelp();
      });
    }

    // ‰∏ä‰º†ÊåâÈíÆ
    if (elements.uploadBtn) {
      elements.uploadBtn.addEventListener('click', showUploadModal);
    }

    // Âà∑Êñ∞ÊåâÈíÆ
    if (elements.refreshBtn) {
      elements.refreshBtn.addEventListener('click', loadAttachments);
    }

    // Á≠õÈÄâÂô®
    if (elements.fileTypeFilter) {
      elements.fileTypeFilter.addEventListener('change', () => {
        currentPage = 1;
        loadAttachments();
      });
    }

    if (elements.visibilityFilter) {
      elements.visibilityFilter.addEventListener('change', () => {
        currentPage = 1;
        loadAttachments();
      });
    }

    if (elements.passageFilter) {
      elements.passageFilter.addEventListener('change', () => {
        currentPage = 1;
        loadAttachments();
      });
    }

    if (elements.searchInput) {
      elements.searchInput.addEventListener('input', debounce(() => {
        currentPage = 1;
        loadAttachments();
      }, 500));
    }

    // ÂÖ®ÈÄâÊ°Ü
    if (elements.selectAll) {
      elements.selectAll.addEventListener('change', (e) => {
        const checked = e.target.checked;
        document.querySelectorAll('.am-checkbox').forEach(checkbox => {
          checkbox.checked = checked;
          const id = parseInt(checkbox.dataset.id);
          if (checked) {
            selectedAttachments.add(id);
          } else {
            selectedAttachments.delete(id);
          }
        });
        updateBatchActions();
        renderAttachments();
      });
    }

    // ÂàÜÈ°µÊåâÈíÆ
    if (elements.prevPageBtn) {
      elements.prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          loadAttachments();
        }
      });
    }

    if (elements.nextPageBtn) {
      elements.nextPageBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(totalAttachments / pageSize);
        if (currentPage < totalPages) {
          currentPage++;
          loadAttachments();
        }
      });
    }

    // ÊâπÈáèÊìç‰ΩúÊåâÈíÆ
    if (elements.batchDeleteBtn) {
      elements.batchDeleteBtn.addEventListener('click', batchDelete);
    }

    if (elements.batchSetPublicBtn) {
      elements.batchSetPublicBtn.addEventListener('click', () => batchSetVisibility('public'));
    }

    if (elements.batchSetPrivateBtn) {
      elements.batchSetPrivateBtn.addEventListener('click', () => batchSetVisibility('private'));
    }

    if (elements.cancelSelectionBtn) {
      elements.cancelSelectionBtn.addEventListener('click', cancelSelection);
    }
  }

  // Èò≤ÊäñÂáΩÊï∞
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // ÂàùÂßãÂåñ
  function init() {
    initEventListeners();
    loadAttachments();
    loadAppearanceSettings();
  }

  // Âä†ËΩΩÂ§ñËßÇËÆæÁΩÆÂπ∂Â∫îÁî®ÂìçÂ∫îÂºèËÉåÊôØÂõæÁâá
  function loadAppearanceSettings() {
    fetch('/api/settings/appearance')
      .then(response => response.json())
      .then(settings => {
        // ‰øùÂ≠òÂà∞ localStorage ‰æõÂÖ∂‰ªñÁªÑ‰ª∂‰ΩøÁî®
        localStorage.setItem('appearanceSettings', JSON.stringify(settings));

        if (settings.dark_mode_enabled) {
          document.documentElement.classList.add('dark-mode');
        }

        // Â∫îÁî®ÊØõÁéªÁíÉÈ¢úËâ≤
        if (settings.navbar_glass_color || settings.card_glass_color || settings.footer_glass_color || settings.navbar_text_color) {
          document.documentElement.style.setProperty('--navbar-glass-color', settings.navbar_glass_color || 'rgba(255, 255, 255, 0.85)');
          document.documentElement.style.setProperty('--navbar-text-color', settings.navbar_text_color || 'rgba(255, 255, 255, 0.9)');
          document.documentElement.style.setProperty('--card-glass-color', settings.card_glass_color || 'rgba(255, 255, 255, 0.75)');
          document.documentElement.style.setProperty('--footer-glass-color', settings.footer_glass_color || 'rgba(255, 255, 255, 0.9)');
        }

        // ÂìçÂ∫îÂºèÂä†ËΩΩËÉåÊôØÂõæÁâá
        function applyBackgroundImage() {
          const isMobile = window.innerWidth <= 768;
          const backgroundImage = isMobile && settings.mobile_background_image ? settings.mobile_background_image : settings.background_image;
          if (backgroundImage) {
            document.body.style.backgroundImage = `url('${backgroundImage}')`;
            document.body.style.backgroundSize = settings.background_size || 'cover';
            document.body.style.backgroundPosition = settings.background_position || 'center';
            document.body.style.backgroundRepeat = settings.background_repeat || 'no-repeat';
            document.body.style.backgroundAttachment = settings.background_attachment || 'fixed';
          }
        }

        // ÂàùÂßãÂ∫îÁî®
        applyBackgroundImage();

        // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñ
        window.addEventListener('resize', applyBackgroundImage);
      })
      .catch(error => {
        console.error('Âä†ËΩΩÂ§ñËßÇËÆæÁΩÆÂ§±Ë¥•:', error);
      });
  }

  // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

<!-- Èü≥‰πêÊí≠ÊîæÂô® -->
<link rel="stylesheet" href="/css/music-player.css">
<script src="/js/music-player.js"></script>
</body>
</html>
