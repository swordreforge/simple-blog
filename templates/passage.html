<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
<meta name="description" content="{{ summary | default(value='é˜…è¯»æŠ€æœ¯æ–‡ç« ã€åˆ†äº«ç¼–ç¨‹ç»éªŒã€æ¢ç´¢æŠ€æœ¯è¾¹ç•Œ - ' ~ title) }}">
<meta name="keywords" content="{{ tags | default(value='æŠ€æœ¯åšå®¢,ç¼–ç¨‹,å¼€å‘') }}">
<title>{{ title }} - æ–‡ç« é˜…è¯»</title>
<!-- Disable favicon -->
<link rel="icon" href="data:,">
<!-- Highlight.js CSS (å…³é”®) -->
<link rel="stylesheet" href="/css/tokyo-night-dark.min.css">
<!-- æ–‡ç« é¡µé¢åŸºç¡€æ ·å¼ (å…³é”®) -->
<link rel="stylesheet" href="/css/passage-base.css">
<!-- æ ¸å¿ƒåŠ¨ç”» CSS (å…³é”® - åŒ…å« @keyframes) -->
<!-- å†…è”å…³é”®åŠ¨ç”» CSSï¼Œå‡å°‘ HTTP è¯·æ±‚ -->
<style>
/* æ ¸å¿ƒåŠ¨ç”»å®šä¹‰ - å†…è”ä»¥å‡å°‘æ¸²æŸ“é˜»å¡ */
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideInLeft { from { transform: translateX(-100%); } to { transform: translateX(0); } }
@keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
.fade-in { animation: fadeIn 0.3s ease; }
.slide-in { animation: slideIn 0.3s ease; }
.spin { animation: spin 0.8s linear infinite; }
.pulse { animation: pulse 1.5s ease-in-out infinite; }
</style>
<!-- KaTeX CSS (å»¶è¿ŸåŠ è½½) -->
<link rel="stylesheet" href="/css/katex.min.css" media="print" onload="this.media='all'">
<!-- é£˜å­—æ•ˆæœ CSS (å»¶è¿ŸåŠ è½½) -->
<link rel="stylesheet" href="/css/floating-text.css" media="print" onload="this.media='all'">
<!--script defer src="/js/katex@0.16.27/dist/katex.min.js" integrity="sha384-2B8pfmZZ6JlVoScJm/5hQfNS2TI/6hPqDZInzzPc8oHpN5SgeNOf4LzREO6p5YtZ" crossorigin="anonymous"-->
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --sidebar-width: 280px;
  --header-height: 60px;
  --tagbar-height: 50px;
  --primary-color: #007bff;
  --secondary-color: #00b894;
  --accent-color: #6c5ce7;
  --bg-light: rgba(255, 255, 255, 0.85);
  --text-dark: #222;
  --text-light: #666;
  --border-color: rgba(0, 0, 0, 0.1);
}

html, body {
  height: 100%;
  width: 100%;
  overflow: hidden;
  font-family: 'Segoe UI', 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', sans-serif;
}

body {
  display: flex;
  flex-direction: column;
  background-image: url('{{ settings.background_image | safe }}');
  background-size: {{ settings.background_size }};
  background-position: {{ settings.background_position }};
  background-repeat: {{ settings.background_repeat }};
  background-attachment: {{ settings.background_attachment }};
  position: relative;
  --global-opacity: {{ settings.global_opacity }};
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(5px);
  z-index: -1;
}

/* å¯¼èˆªæ æ ·å¼ */
nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  height: var(--header-height);
  padding: 0 5px;
  background: var(--navbar-glass-color, rgba(255, 255, 255, 0.85));
  backdrop-filter: blur(10px) saturate(180%);
  -webkit-backdrop-filter: blur(10px) saturate(180%);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  z-index: 100;
  box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
  transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
              opacity 0.4s ease;
  transform: translateY(0);
  opacity: 1;
}

.nav-left, .nav-right {
  display: flex;
  align-items: center;
  gap: 4px;
}

/* å¯¼èˆªæ éšè—çŠ¶æ€ - å·²æ”¹ç”¨å†…è”æ ·å¼ display: none æ§åˆ¶ */

/* éšè—å…³äºæŒ‰é”®å’Œç®¡ç†å‘˜é¢æ¿æŒ‰é”® */
.nav-left a[href="/about"],
.nav-left a[href="/admin"] {
  display: none;
}

nav a {
  color: var(--navbar-text-color, rgba(255, 255, 255, 0.9));
  text-decoration: none;
  padding: 4px 8px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(30px) saturate(200%);
  -webkit-backdrop-filter: blur(30px) saturate(200%);
  border-radius: 25px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* å¯¼èˆªæ æŒ‰é’®æ ·å¼ */
nav button {
  color: var(--navbar-text-color, rgba(255, 255, 255, 0.9));
  text-decoration: none;
  padding: 4px 8px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(30px) saturate(200%);
  -webkit-backdrop-filter: blur(30px) saturate(200%);
  border-radius: 25px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  cursor: pointer;
}

nav a:hover {
  color: #fff;
  background: rgba(0, 0, 0, 0);
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
}

nav a::after {
  display: none;
}

nav a.current {
  color: #fff;
  background: rgba(255, 255, 255, 0.3);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® */
.sidebar-toggle {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  padding: 8px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(30px) saturate(200%);
  -webkit-backdrop-filter: blur(30px) saturate(200%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  color: rgba(255, 255, 255, 0.9);
}

.sidebar-toggle:hover {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.5);
  transform: scale(1.05);
}

.sidebar-toggle:active {
  transform: scale(0.95);
}

/* ä¸»å®¹å™¨ - Obsidiané£æ ¼åŒæ å¸ƒå±€ */
.main-container {
  display: flex;
  flex: 1;
  height: calc(100vh - var(--header-height));
  overflow: hidden;
  position: relative;
}

/* å·¦ä¾§æ–‡ä»¶æ ‘ - å¼ºåˆ¶æ·±è‰²æ¨¡å¼ */
.sidebar {
  width: var(--sidebar-width);
  background-color: rgba(30, 30, 35, 0.95) !important;
  border-right: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  flex-direction: column;
  transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  backdrop-filter: blur(30px) saturate(200%);
  -webkit-backdrop-filter: blur(30px) saturate(200%);
  z-index: 10;
  transform: translateX(0);
}

/* æ¡Œé¢ç«¯ä¾§è¾¹æ éšè—çŠ¶æ€ */
.sidebar.hidden {
  width: 0 !important;
  min-width: 0 !important;
  overflow: hidden;
  opacity: 0;
  transform: translateX(-100%);
}

.sidebar-header {
  padding: 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.sidebar-header h2 {
  font-size: 1.4em;
  color: #f0f0f0;
  font-weight: 600;
}

.sidebar-controls {
  display: flex;
  gap: 10px;
}

.sidebar-controls button {
  background: none;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 4px;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: #aaa;
  transition: all 0.2s ease;
}

.sidebar-controls button:hover {
  background-color: rgba(255, 255, 255, 0.1);
  color: #007bff;
}

/* æ–‡ä»¶æ ‘æ ·å¼ */
.file-tree {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
}

/* æœ¬æ–‡ç´¢å¼•ç›®å½•æ ·å¼ */
.toc-container {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
  display: none;
}

.toc-container.active {
  display: block;
}

.toc-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.toc-item {
  margin-bottom: 4px;
}

.toc-link {
  display: block;
  padding: 6px 10px;
  color: #f0f0f0;
  text-decoration: none;
  border-radius: 6px;
  transition: all 0.2s ease;
  font-size: 0.9em;
  cursor: pointer;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.toc-link:hover {
  background-color: rgba(0, 123, 255, 0.1);
  color: var(--primary-color);
}

.toc-link.active {
  background-color: rgba(0, 123, 255, 0.15);
  color: var(--primary-color);
  font-weight: 500;
}

/* ä¸åŒçº§åˆ«çš„æ ‡é¢˜ç¼©è¿› */
.toc-level-1 {
  padding-left: 0;
  font-weight: 600;
  font-size: 1em;
}

.toc-level-2 {
  padding-left: 20px;
  font-size: 0.95em;
}

.toc-level-3 {
  padding-left: 35px;
  font-size: 0.9em;
}

.toc-level-4 {
  padding-left: 50px;
  font-size: 0.85em;
}

.toc-level-5 {
  padding-left: 65px;
  font-size: 0.8em;
}

.toc-level-6 {
  padding-left: 80px;
  font-size: 0.75em;
}

/* ç©ºç›®å½•çŠ¶æ€ */
.toc-empty {
  text-align: center;
  color: #aaa;
  padding: 40px 20px;
  font-size: 0.9em;
}

.toc-empty svg {
  width: 48px;
  height: 48px;
  margin-bottom: 10px;
  opacity: 0.5;
}

.file-tree ul {
  list-style: none;
}

.file-tree li {
  margin-bottom: 2px;
  position: relative;
}

.file-tree .folder > .folder-header {
  display: flex;
  align-items: center;
  padding: 8px 10px;
  cursor: pointer;
  border-radius: 6px;
  transition: background-color 0.2s ease;
}

.file-tree .folder > .folder-header:hover {
  background-color: rgba(255, 255, 255, 0.05);
}

.file-tree .folder > .folder-header .folder-icon {
  margin-right: 8px;
  color: var(--accent-color);
  font-size: 0.9em;
  transition: transform 0.3s ease;
}

.file-tree .folder.open > .folder-header .folder-icon {
  transform: rotate(90deg);
}

.file-tree .folder > .folder-header .folder-name {
  flex: 1;
  font-weight: 500;
  color: #f0f0f0;
}

.file-tree .folder > .folder-header .file-count {
  background-color: rgba(255, 255, 255, 0.1);
  color: #aaa;
  font-size: 0.8em;
  padding: 2px 8px;
  border-radius: 10px;
}

.file-tree .folder-content {
  margin-left: 15px;
  padding-left: 15px;
  border-left: 1px dashed rgba(255, 255, 255, 0.1);
  display: none;
}

.file-tree .folder.open > .folder-content {
  display: block;
}

.file-tree .file-item {
  display: flex;
  align-items: center;
  padding: 8px 10px;
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s ease;
  margin-bottom: 2px;
}

.file-tree .file-item:hover {
  background-color: rgba(255, 255, 255, 0.05);
}

.file-tree .file-item.active {
  background-color: rgba(0, 123, 255, 0.1);
  color: var(--primary-color);
  font-weight: 500;
}

.file-tree .file-item .file-icon {
  margin-right: 8px;
  color: var(--primary-color);
  font-size: 0.9em;
}

.file-tree .file-item .file-name {
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: #ffffff !important;
  font-size: 0.95em;
  font-weight: 400;
  opacity: 1 !important;
  visibility: visible !important;
  display: inline-block !important;
}

.file-tree .file-item .file-date {
  font-size: 0.8em;
  color: #aaa;
  margin-left: 8px;
}

/* æœªå‘å¸ƒæ–‡ç« æ ·å¼ */
.file-tree .file-item.file-unpublished {
  opacity: 0.7;
}

.file-tree .file-item.file-unpublished .file-name {
  color: #ff9800 !important;
  font-style: italic;
}

.file-tree .file-item.file-unpublished .file-icon {
  color: #ff9800;
}

.file-tree .file-item .file-status {
  font-size: 0.75em;
  padding: 2px 6px;
  border-radius: 3px;
  margin-left: 8px;
  background: rgba(255, 152, 0, 0.2);
  color: #ff9800;
  font-weight: 500;
}

/* å³ä¾§å†…å®¹åŒºåŸŸ */
.content-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* æ ‡ç­¾æ  */
.tab-bar {
  display: flex;
  height: var(--tagbar-height);
  background-color: rgba(255, 255, 255, 0.75);
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  overflow-x: auto;
  overflow-y: hidden;
  backdrop-filter: blur(30px) saturate(200%);
  -webkit-backdrop-filter: blur(30px) saturate(200%);
  z-index: 5;
}

.tab {
  display: flex;
  align-items: center;
  padding: 0 20px;
  border-right: 1px solid var(--border-color);
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
  position: relative;
  min-width: 120px;
  max-width: 200px;
}

.tab:hover {
  background-color: rgba(0, 0, 0, 0.05);
}

.tab.active {
  background-color: white;
  color: var(--primary-color);
  font-weight: 500;
}

.tab.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background-color: var(--primary-color);
}

.tab .tab-title {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 0.95em;
}

.tab .tab-close {
  margin-left: 10px;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8em;
  transition: background-color 0.2s ease;
}

.tab .tab-close:hover {
  background-color: rgba(0, 0, 0, 0.1);
}

/* æ–‡ç« å†…å®¹åŒºåŸŸ */
.article-container {
  flex: 1;
  overflow-y: auto;
  padding: 30px;
  background-color: rgba(255, 255, 255, 0.75);
  backdrop-filter: blur(30px) saturate(200%);
  -webkit-backdrop-filter: blur(30px) saturate(200%);
}

/* æœªå‘å¸ƒæ–‡ç« æç¤º */
.unpublished-notice {
  max-width: 600px;
  margin: 40px auto;
  padding: 30px;
  background: rgba(255, 193, 7, 0.1);
  border: 2px solid rgba(255, 193, 7, 0.3);
  border-radius: 12px;
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
}

.notice-content {
  display: flex;
  align-items: flex-start;
  gap: 20px;
}

.notice-icon {
  font-size: 48px;
  flex-shrink: 0;
}

.notice-text h3 {
  margin: 0 0 10px 0;
  color: #d68910;
  font-size: 1.5em;
}

.notice-text p {
  margin: 8px 0;
  color: #666;
  line-height: 1.6;
}

.notice-text #scheduledTime {
  font-weight: bold;
  color: #d68910;
}

.article {
  max-width: 900px;
  margin: 0 auto;
  display: none;
}

.article.active {
  display: block;
  animation: fadeIn 0.5s ease;
}

.article-header {
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 2px solid var(--primary-color);
}

.article-title {
  font-size: 2.5em;
  color: var(--text-dark);
  margin-bottom: 15px;
  font-weight: 700;
  line-height: 1.2;
}

.article-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  color: var(--text-light);
  font-size: 0.95em;
}

.article-meta .meta-item {
  display: flex;
  align-items: center;
  gap: 5px;
}

.article-meta .meta-item i {
  font-size: 0.9em;
}

.article-category {
  background-color: rgba(0, 184, 148, 0.1);
  color: var(--secondary-color);
  padding: 2px 10px;
  border-radius: 12px;
  font-size: 0.85em;
  font-weight: 500;
  transition: all 0.2s ease;
}

.article-category:hover {
  background-color: rgba(0, 184, 148, 0.2);
  transform: translateY(-1px);
}

.article-tags-inline {
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
}

.article-tags-inline .inline-tag {
  background-color: rgba(108, 92, 231, 0.1);
  color: var(--accent-color);
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.8em;
  transition: all 0.2s ease;
}

.article-tags-inline .inline-tag:hover {
  background-color: rgba(108, 92, 231, 0.2);
  transform: translateY(-1px);
}

.article-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 15px;
}

.article-tags .tag {
  background-color: rgba(0, 123, 255, 0.1);
  color: var(--primary-color);
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.85em;
  transition: all 0.2s ease;
}

.article-tags .tag:hover {
  background-color: rgba(0, 123, 255, 0.2);
  transform: translateY(-2px);
}

.article-content {
  line-height: 1.7;
  color: var(--text-dark);
  font-size: 1.05em;
}

.article-content h1 {
  font-size: 2em;
  margin: 30px 0 15px;
  padding-bottom: 10px;
  border-bottom: 2px solid var(--primary-color);
  color: var(--text-dark);
}

.article-content h2 {
  font-size: 1.8em;
  margin: 30px 0 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border-color);
  color: var(--text-dark);
}

.article-content h3 {
  font-size: 1.4em;
  margin: 25px 0 12px;
  color: var(--text-dark);
}

.article-content h4 {
  font-size: 1.2em;
  margin: 20px 0 10px;
  color: var(--text-dark);
  font-weight: 600;
}

.article-content h5 {
  font-size: 1.1em;
  margin: 18px 0 8px;
  color: var(--text-dark);
  font-weight: 600;
}

.article-content h6 {
  font-size: 1em;
  margin: 15px 0 8px;
  color: var(--text-light);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.article-content video {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin: 20px 0;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.article-content iframe {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin: 20px 0;
  border: none;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.article-content p {
  margin-bottom: 18px;
}

.article-content blockquote {
  border-left: 4px solid var(--primary-color);
  padding-left: 20px;
  margin: 20px 0;
  font-style: italic;
  color: var(--text-light);
}

.article-content pre {
  background-color: rgba(0, 0, 0, 0.05);
  padding: 15px;
  border-radius: 8px;
  overflow-x: auto;
  margin: 20px 0;
  font-family: 'Courier New', monospace;
  font-size: 0.9em;
  position: relative;
}

/* ä»£ç å—å·¥å…·æ  - è‹¹æœé£æ ¼ */
.code-block-wrapper {
  position: relative;
  margin: 20px 0;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.code-block-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  padding: 10px 16px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.98) 0%, rgba(245, 245, 245, 0.98) 100%);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid rgba(0, 0, 0, 0.12);
}

.code-block-toolbar .code-language {
  font-size: 0.75em;
  color: #1a1a1a;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 4px 10px;
  background-color: rgba(0, 0, 0, 0.08);
  border-radius: 6px;
}

.code-block-toolbar .toolbar-actions {
  display: flex;
  gap: 6px;
}

.code-block-toolbar button {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 6px 12px;
  background-color: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(0, 0, 0, 0.15);
  border-radius: 6px;
  font-size: 0.75em;
  font-weight: 600;
  color: #1a1a1a;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
}

.code-block-toolbar button:hover {
  background-color: #007AFF;
  color: white;
  border-color: #007AFF;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 122, 255, 0.35);
}

.code-block-toolbar button:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(0, 122, 255, 0.25);
}

.code-block-toolbar button svg {
  width: 13px;
  height: 13px;
}

.code-block-wrapper pre {
  margin: 0;
  border-radius: 0 0 12px 12px;
  background-color: #FFF8E7;
  border: none;
  padding: 16px;
  display: flex;
  align-items: flex-start;
}

.code-block-wrapper pre code {
  background-color: transparent;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Mono', Monaco, 'Courier New', monospace;
  font-size: 0.9em;
  line-height: 1.6;
  color: #2D2D2D;
  font-weight: 500;
  flex: 1;
  margin-left: 16px;
}

.code-line-numbers {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  padding-right: 12px;
  user-select: none;
  color: #999;
  font-size: 0.85em;
  line-height: 1.6;
  min-width: 30px;
}

.code-line-numbers span {
  display: block;
}

/* å¤åˆ¶æˆåŠŸæç¤º - è‹¹æœé£æ ¼ */
.copy-toast {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color: white;
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 0.85em;
  font-weight: 500;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 10;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.copy-toast.show {
  opacity: 1;
}

/* å…¨å±ä»£ç æŸ¥çœ‹å™¨ - è‹¹æœé£æ ¼ */
.code-viewer {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  z-index: 10000;
  padding: 0;
  box-sizing: border-box;
  overflow: hidden;
}

.code-viewer.active {
  display: flex;
  flex-direction: column;
}

.code-viewer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.1) 100%);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.15);
}

.code-viewer-title {
  color: #ffffff;
  font-size: 1em;
  font-weight: 700;
  letter-spacing: 0.3px;
}

.code-viewer-close,
.code-viewer-copy {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background-color: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 8px;
  color: #ffffff;
  font-size: 0.85em;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.code-viewer-close:hover,
.code-viewer-copy:hover {
  background-color: rgba(255, 255, 255, 0.3);
  border-color: rgba(255, 255, 255, 0.4);
  transform: scale(1.02);
}

.code-viewer-close:active,
.code-viewer-copy:active {
  transform: scale(0.98);
}

.code-viewer-close svg,
.code-viewer-copy svg {
  width: 14px;
  height: 14px;
}

.code-viewer-content {
  flex: 1;
  overflow: auto;
  padding: 24px;
  background-color: #FFF8E7;
}

.code-viewer-content pre {
  margin: 0;
  padding: 0;
  background-color: transparent;
  border-radius: 0;
  font-size: 1em;
  line-height: 1.7;
}

.code-viewer-content code {
  background-color: transparent;
  padding: 0;
  color: #2D2D2D;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Mono', Monaco, 'Courier New', monospace;
  font-weight: 500;
}

.code-viewer-toast {
  position: fixed;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  color: #ffffff;
  padding: 16px 32px;
  border-radius: 12px;
  font-size: 0.9em;
  font-weight: 500;
  opacity: 0;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  z-index: 10001;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  pointer-events: none;
}

.code-viewer-toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

.article-content code {
  background-color: rgba(0, 0, 0, 0.05);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  font-size: 0.9em;
}

.article-content ul, .article-content ol {
  margin-left: 20px;
  margin-bottom: 18px;
}

.article-content li {
  margin-bottom: 8px;
}

/* è¡¨æ ¼æ ·å¼ */
.article-content table {
  width: auto;
  max-width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  font-size: 0.95em;
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 8px;
  overflow: hidden;
}

.article-content thead {
  background: linear-gradient(180deg, rgba(0, 0, 0, 0.05) 0%, rgba(0, 0, 0, 0.03) 100%);
}

.article-content th {
  padding: 12px 16px;
  text-align: left;
  font-weight: 600;
  color: var(--text-dark);
  border-bottom: 2px solid rgba(255, 255, 255, 0.4);
  border-right: 1px solid rgba(255, 255, 255, 0.2);
}

.article-content th:last-child {
  border-right: none;
}

.article-content td {
  padding: 12px 16px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  border-right: 1px solid rgba(255, 255, 255, 0.15);
  color: var(--text-dark);
}

.article-content td:last-child {
  border-right: none;
}

.article-content tr:hover {
  background-color: rgba(0, 0, 0, 0.03);
}

.article-content tr:last-child td {
  border-bottom: none;
}

/* æš—è‰²æ¨¡å¼ä¸‹çš„è¡¨æ ¼æ ·å¼ */
html.dark-mode .article-content table {
  border-color: rgba(255, 255, 255, 0.15);
}

html.dark-mode .article-content thead {
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.05) 100%);
}

html.dark-mode .article-content th {
  border-bottom-color: rgba(255, 255, 255, 0.2);
  border-right-color: rgba(255, 255, 255, 0.1);
  color: #e0e0e0;
}

html.dark-mode .article-content td {
  border-bottom-color: rgba(255, 255, 255, 0.1);
  border-right-color: rgba(255, 255, 255, 0.08);
  color: #d0d0d0;
}

html.dark-mode .article-content tr:hover {
  background-color: rgba(255, 255, 255, 0.05);
}

.article-content img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin: 20px 0;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  cursor: zoom-in;
  transition: transform 0.2s ease;
}

.article-content img:hover {
  transform: scale(1.02);
}

/* å…¨å±å›¾ç‰‡æŸ¥çœ‹å™¨ */
.image-viewer {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.95);
  z-index: 2000;
  justify-content: center;
  align-items: center;
  animation: fadeIn 0.3s ease;
}

.image-viewer.active {
  display: flex;
}

.image-viewer img {
  max-width: 90%;
  max-height: 90%;
  object-fit: contain;
  cursor: zoom-out;
  border-radius: 4px;
  box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
}

.image-viewer-close {
  position: absolute;
  top: 20px;
  right: 30px;
  color: white;
  font-size: 40px;
  cursor: pointer;
  transition: all 0.2s ease;
  z-index: 2001;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.1);
}

.image-viewer-close:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: rotate(90deg);
}

/* è¯„è®ºåŒºåŸŸæ ·å¼ */
.comments-section {
  margin-top: 40px;
  padding-top: 30px;
  border-top: 2px solid var(--border-color);
}

/* é™„ä»¶åˆ—è¡¨æ ·å¼ */
.attachments-section {
  margin-top: 30px;
  padding: 20px;
  background-color: rgba(255, 255, 255, 0.5);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
}

.attachments-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.attachments-header h3 {
  font-size: 1.3em;
  color: var(--text-dark);
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.attachments-count {
  color: var(--text-light);
  font-size: 0.9em;
}

.attachments-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.attachment-item {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  background-color: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(10px) saturate(150%);
  -webkit-backdrop-filter: blur(10px) saturate(150%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 8px;
  transition: all 0.3s ease;
  cursor: pointer;
  text-decoration: none;
  color: var(--text-dark);
}

.attachment-item:hover {
  background-color: rgba(255, 255, 255, 0.8);
  border-color: var(--primary-color);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.attachment-item:active {
  transform: translateY(0);
}

.attachment-icon {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 12px;
  flex-shrink: 0;
  font-size: 20px;
}

.attachment-icon.image {
  background-color: rgba(0, 123, 255, 0.1);
  color: var(--primary-color);
}

.attachment-icon.video {
  background-color: rgba(220, 53, 69, 0.1);
  color: #dc3545;
}

.attachment-icon.document {
  background-color: rgba(255, 193, 7, 0.1);
  color: #ffc107;
}

.attachment-icon.audio {
  background-color: rgba(108, 92, 231, 0.1);
  color: var(--accent-color);
}

.attachment-icon.archive {
  background-color: rgba(40, 167, 69, 0.1);
  color: #28a745;
}

.attachment-icon.default {
  background-color: rgba(108, 117, 125, 0.1);
  color: #6c757d;
}

.attachment-info {
  flex: 1;
  min-width: 0;
}

.attachment-name {
  font-weight: 500;
  margin-bottom: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.attachment-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 0.85em;
  color: var(--text-light);
}

.attachment-size {
  display: flex;
  align-items: center;
  gap: 4px;
}

.attachment-type {
  display: flex;
  align-items: center;
  gap: 4px;
}

.attachment-download {
  width: 32px;
  height: 32px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: rgba(0, 123, 255, 0.1);
  color: var(--primary-color);
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.attachment-item:hover .attachment-download {
  background-color: var(--primary-color);
  color: white;
}

/* é™„ä»¶ç©ºçŠ¶æ€ */
.empty-attachments {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 30px;
  color: var(--text-light);
  text-align: center;
}

.empty-attachments svg {
  margin-bottom: 12px;
  opacity: 0.5;
}

.empty-attachments p {
  font-size: 0.95em;
}

.comments-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
}

.comments-header h3 {
  font-size: 1.5em;
  color: var(--text-dark);
  font-weight: 600;
}

.comments-count {
  color: var(--text-light);
  font-size: 0.95em;
}

/* è¯„è®ºè¡¨å• - GitHub é£æ ¼ */
.github-comment-form {
  display: flex;
  gap: 12px;
  margin-top: 20px;
  padding: 20px;
  background-color: rgba(255, 255, 255, 0.5);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
}

.comment-user-avatar {
  flex-shrink: 0;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-top: 4px;
  overflow: hidden;
}

.comment-input-wrapper {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.comment-username-input {
  width: 100%;
  padding: 10px 14px;
  border: 1px solid #d0d7de;
  border-radius: 6px;
  font-size: 14px;
  background-color: rgba(255, 255, 255, 0.9);
  transition: all 0.2s ease;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
}

.comment-username-input:focus {
  outline: none;
  border-color: #0969da;
  box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
}

.comment-textarea {
  width: 100%;
  padding: 12px 14px;
  border: 1px solid #d0d7de;
  border-radius: 6px;
  font-size: 14px;
  background-color: rgba(255, 255, 255, 0.9);
  transition: all 0.2s ease;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
  line-height: 1.6;
  resize: vertical;
  min-height: 100px;
}

.comment-textarea:focus {
  outline: none;
  border-color: #0969da;
  box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
}

.comment-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 4px;
}

.comment-tips {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #6e7781;
  font-size: 12px;
}

.submit-comment-btn {
  background: #2da44e;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
}

.submit-comment-btn:hover {
  background: #2c974b;
}

.submit-comment-btn:active {
  background: #298e46;
}

html.dark-mode .comment-username-input,
html.dark-mode .comment-textarea {
  background-color: rgba(30, 30, 30, 0.9);
  border-color: #30363d;
  color: #c9d1d9;
}

html.dark-mode .comment-username-input:focus,
html.dark-mode .comment-textarea:focus {
  border-color: #58a6ff;
  box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
}

html.dark-mode .comment-tips {
  color: #8b949e;
}

html.dark-mode .submit-comment-btn {
  background: #238636;
}

html.dark-mode .submit-comment-btn:hover {
  background: #2ea043;
}

@media (max-width: 768px) {
  .github-comment-form {
    flex-direction: column;
  }

  .comment-user-avatar {
    width: 32px;
    height: 32px;
  }

  .comment-actions {
    flex-direction: column;
    gap: 12px;
    align-items: stretch;
  }

  .comment-tips {
    justify-content: center;
  }
}

/* è¯„è®ºåˆ—è¡¨ */
.comments-list {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.comment-item {
  background-color: rgba(255, 255, 255, 0.5);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  padding: 20px;
  transition: all 0.3s ease;
  animation: slideIn 0.3s ease;
}

.comment-item:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.comment-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.comment-user {
  display: flex;
  align-items: center;
  gap: 10px;
}

.comment-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.comment-username {
  font-weight: 600;
  color: var(--text-dark);
}

.comment-date {
  color: var(--text-light);
  font-size: 0.85em;
}

.comment-content {
  color: var(--text-dark);
  line-height: 1.6;
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* åŠ è½½çŠ¶æ€ */
.loading-state {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 30px;
  color: var(--text-light);
}

.spinner {
  width: 24px;
  height: 24px;
  border: 3px solid rgba(0, 123, 255, 0.1);
  border-top-color: var(--primary-color);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* ç©ºçŠ¶æ€ */
.empty-comments {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px;
  color: var(--text-light);
  text-align: center;
}

.empty-comments svg {
  margin-bottom: 15px;
  opacity: 0.5;
}

.empty-comments p {
  font-size: 1em;
}

/* å…¨å±æ¨¡å¼ */
body.fullscreen .sidebar {
  position: fixed;
  left: 0;
  top: var(--header-height);
  bottom: 0;
  z-index: 100;
  box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
}

body.fullscreen .content-area {
  margin-left: 0;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1200px) {
  :root {
    --sidebar-width: 240px;
  }
}

@media (max-width: 992px) {
  .sidebar {
    position: fixed;
    left: 0;
    top: var(--header-height);
    bottom: 0;
    transform: translateX(-100%);
    z-index: 100;
    box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
  }
  
  .sidebar.open {
    transform: translateX(0);
  }
  
  .content-area {
    margin-left: 0;
  }
  
  .article-title {
    font-size: 2em;
  }
}

@media (max-width: 768px) {
  .article-container {
    padding: 20px;
  }

  .article-title {
    font-size: 1.8em;
  }

  .tab {
    min-width: 80px;
    max-width: 120px;
    padding: 0 12px;
  }

  .tab .tab-title {
    font-size: 0.85em;
    max-width: 3em;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .tab .tab-close {
    margin-left: 5px;
    width: 16px;
    height: 16px;
  }

  /* ç§»åŠ¨ç«¯å¯¼èˆªæ å›¾æ ‡åŒ–å¤„ç† */
  nav {
    padding: 10px 15px;
  }

  .nav-left a,
  .nav-right button {
    font-size: 0;
    margin: 0 4px;
    padding: 10px;
    min-width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
  }

  /* éšè—å¯¼èˆªæ æ–‡å­—ï¼Œåªæ˜¾ç¤ºå›¾æ ‡ */
  .nav-left a span:not(.shortcut-hint),
  .nav-right button span:not(.shortcut-hint) {
    display: none;
  }

  /* éšè—å¿«æ·é”®æŒ‰é’® */
  .shortcuts-help-btn {
    display: none !important;
  }

  /* éšè—å¿«æ·é”®æç¤º */
  .shortcut-hint {
    display: none !important;
  }

  /* ç¡®ä¿å›¾æ ‡å¯è§ */
  .nav-left a svg,
  .nav-right button svg {
    display: block;
    font-size: initial;
  }

  /* ä¸ºæ²¡æœ‰å›¾æ ‡çš„é“¾æ¥æ·»åŠ é»˜è®¤å›¾æ ‡ */
  .nav-left a[href="/"]::before {
    content: 'ğŸ ';
    font-size: 18px;
  }

  .nav-left a[href="/passage"]::before {
    content: 'ğŸ“';
    font-size: 18px;
  }

  .nav-left a[href="/collect"]::before {
    content: 'ğŸ“';
    font-size: 18px;
  }

  .nav-left a[href="/about"]::before {
    content: 'â„¹ï¸';
    font-size: 18px;
  }

  .nav-left a[href="/friends"]::before {
    content: 'ğŸ”—';
    font-size: 18px;
  }

  .nav-left a[href="/markdown-editor"]::before {
    content: 'âœï¸';
    font-size: 18px;
  }

  .nav-left a[href="/admin"]::before {
    content: 'âš™ï¸';
    font-size: 18px;
  }

  /* ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’®æ ·å¼è°ƒæ•´ */
  .sidebar-toggle {
    padding: 10px;
    min-width: 40px;
    height: 40px;
    border-radius: 50%;
  }

  .sidebar-toggle svg {
    display: block;
  }

  /* ç§»åŠ¨ç«¯éšè—ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® */
  .sidebar-toggle {
    display: none !important;
  }

  /* ç§»åŠ¨ç«¯æ˜¾ç¤ºæ–‡ç« ç­›é€‰æŒ‰é’® */
  #articleFilterToggle {
    display: flex !important;
  }

  /* æ–‡ç« ç­›é€‰æ¨¡æ€æ¡†ç‰¹æ®Šæ ·å¼ */
  .article-filter-modal .modal-content {
    background: rgba(30, 30, 35, 0.98);
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    /* å‘å³ä¸‹è§’ç§»åŠ¨ */
    transform: translate(30px, 30px);
  }

  .article-filter-modal.active .modal-content {
    transform: translate(30px, 30px);
  }

  .article-filter-modal .modal-body {
    padding: 20px;
    overflow-y: auto;
  }

  .article-filter-modal .filter-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }

  .article-filter-modal .filter-tab {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 16px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: #aaa;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .article-filter-modal .filter-tab.active {
    background: rgba(89, 89, 156, 0.5);
    border-color: rgba(89, 89, 156, 0.8);
    color: #fff;
  }

  .article-filter-modal .filter-tab svg {
    width: 16px;
    height: 16px;
  }

  .article-filter-modal .filter-search {
    margin-bottom: 15px;
  }

  .article-filter-modal .filter-search input {
    width: 100%;
    padding: 10px 15px;
    background: rgba(50, 50, 55, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: #f0f0f0;
    font-size: 14px;
    outline: none;
    transition: all 0.2s ease;
  }

  .article-filter-modal .filter-search input:focus {
    border-color: rgba(89, 89, 156, 0.8);
    background: rgba(60, 60, 65, 0.9);
  }

  .article-filter-modal .filter-search input::placeholder {
    color: #666;
  }

  .article-filter-modal .filter-content {
    max-height: 300px;
    overflow-y: auto;
  }

  .article-filter-modal .filter-content::-webkit-scrollbar {
    width: 6px;
  }

  .article-filter-modal .filter-content::-webkit-scrollbar-track {
    background: rgba(50, 50, 55, 0.5);
    border-radius: 3px;
  }

  .article-filter-modal .filter-content::-webkit-scrollbar-thumb {
    background: rgba(89, 89, 156, 0.5);
    border-radius: 3px;
  }

  .article-filter-modal .filter-content::-webkit-scrollbar-thumb:hover {
    background: rgba(89, 89, 156, 0.7);
  }

  /* æ–‡ç« åˆ—è¡¨é¡¹æ ·å¼ */
  .article-filter-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .article-filter-item:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateX(5px);
  }

  .article-filter-item.active {
    background: rgba(89, 89, 156, 0.3);
    border-color: rgba(89, 89, 156, 0.6);
  }

  .article-filter-item-icon {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(89, 89, 156, 0.3);
    border-radius: 6px;
    margin-right: 12px;
    font-size: 16px;
  }

  .article-filter-item-info {
    flex: 1;
  }

  .article-filter-item-title {
    color: #f0f0f0;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 4px;
  }

  .article-filter-item-meta {
    color: #888;
    font-size: 12px;
  }

  /* ç©ºçŠ¶æ€ */
  .filter-empty {
    text-align: center;
    padding: 40px 20px;
    color: #666;
    font-size: 14px;
  }

  /* é®ç½©å±‚ */
  .modal-overlay {
    display: block;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1999;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .modal-overlay.active {
    opacity: 1;
    pointer-events: auto;
  }

/* é»˜è®¤éšè—æ–‡ç« ç­›é€‰æŒ‰é’® */
#articleFilterToggle {
  display: none;
}

/* æ¨¡æ€æ¡†é»˜è®¤éšè— */
.article-filter-modal,
.modal-overlay {
  display: none;
}

/* æ¨¡æ€æ¡†æ¿€æ´»æ—¶æ˜¾ç¤º */
.article-filter-modal.active,
.modal-overlay.active {
  display: flex;
}
  }

  .tab .tab-title {
    font-size: 0.9em;
  }
}

/* å·¥å…·æŒ‰é’® */
.toolbar {
  display: flex;
  gap: 10px;
  margin-left: auto;
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 999;
  pointer-events: auto;
}

.toolbar button {
  background: none;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--text-light);
  transition: all 0.2s ease;
}

.toolbar button:hover {
  background-color: rgba(0, 0, 0, 0.05);
  color: var(--primary-color);
}

/* ç©ºçŠ¶æ€ */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-light);
  text-align: center;
  padding: 40px;
}

.empty-state i {
  font-size: 3em;
  margin-bottom: 20px;
  opacity: 0.5;
}

.empty-state h3 {
  font-size: 1.5em;
  margin-bottom: 10px;
  color: var(--text-dark);
}

/* åˆ†å‰²çº¿æ ·å¼ */
.resizer {
  width: 5px;
  background-color: transparent;
  cursor: col-resize;
  transition: background-color 0.2s ease;
  z-index: 20;
  position: relative;
}

.resizer:hover, .resizer.active {
  background-color: var(--primary-color);
}

/* é˜…è¯»æ¨¡å¼åˆ‡æ¢æŒ‰é’®æ ·å¼ */
#readingModeToggle:hover {
  background: rgba(0, 0, 0, 0);
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
}

#readingModeToggle:active {
  transform: translateY(0);
}

/* æš—è‰²æ¨¡å¼æ”¯æŒ */
@media (prefers-color-scheme: dark) {
  :root {
    --bg-light: rgba(30, 30, 35, 0.85);
    --text-dark: #f0f0f0;
    --text-light: #aaa;
    --border-color: rgba(255, 255, 255, 0.1);
  }
  
  body::before {
    background: rgba(0, 0, 0, 0.3);
  }
  
  nav {
    background-color: rgba(30, 30, 35, 0.95);
  }
  
  nav a {
    color: #f0f0f0;
  }
  
  .tab-bar {
    background-color: rgba(30, 30, 35, 0.9);
  }
  
  .tab.active {
    background-color: rgba(40, 40, 45, 0.95);
  }
  
  .article-container {
    background-color: rgba(30, 30, 35, 0.85);
  }
  
  .file-tree .file-item:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }
  
  .file-tree .folder > .folder-header:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }

  /* è¯„è®ºè¡¨å•æš—è‰²æ¨¡å¼é€‚é… */
  .comment-form {
    background-color: rgba(40, 40, 45, 0.8);
    border-color: rgba(255, 255, 255, 0.1);
  }

  .comment-form label {
    color: #f0f0f0;
  }

  .comment-form .form-input,
  .comment-form .form-textarea {
    background-color: rgba(50, 50, 55, 0.8);
    border-color: rgba(255, 255, 255, 0.1);
    color: #f0f0f0;
  }

  .comment-form .form-input:focus,
  .comment-form .form-textarea:focus {
    background-color: rgba(60, 60, 65, 0.9);
    border-color: var(--primary-color);
  }

  /* è¯„è®ºåˆ—è¡¨æš—è‰²æ¨¡å¼é€‚é… */
  .comment-item {
    background-color: rgba(40, 40, 45, 0.8);
    border-color: rgba(255, 255, 255, 0.1);
  }

  .comment-username {
    color: #f0f0f0;
  }

  .comment-content {
    color: #e0e0e0;
  }

  /* è¯„è®ºå¤´éƒ¨æš—è‰²æ¨¡å¼é€‚é… */
  .comments-header h3 {
    color: #f0f0f0;
  }

  .comments-count {
    color: #aaa;
  }
}

/* ç®¡ç†å‘˜ä¸“ç”¨å…ƒç´  - é»˜è®¤éšè—ï¼Œåªæœ‰ç®¡ç†å‘˜å¯è§ */
.admin-only {
  display: none !important;
}

/* æ–‡æœ¬èšç„¦æ¨¡å¼æ ·å¼ */
body.focus-mode .sidebar {
  box-shadow: 0 0 0 3px var(--primary-color);
}

body.focus-mode .content-area {
  box-shadow: 0 0 0 3px var(--primary-color);
}

body.focus-mode-left .sidebar {
  box-shadow: 0 0 0 3px var(--primary-color);
}

body.focus-mode-left .content-area {
  box-shadow: none;
}

body.focus-mode-right .content-area {
  box-shadow: 0 0 0 3px var(--primary-color);
}

body.focus-mode-right .sidebar {
  box-shadow: none;
}

.focus-selected {
  border: 2px solid var(--primary-color) !important;
  border-radius: 6px !important;
  background-color: rgba(0, 123, 255, 0.1) !important;
}

.focus-mode-toast {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(0, 0, 0, 0.85);
  color: white;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 0.95em;
  z-index: 10001;
  opacity: 0;
  transition: opacity 0.3s ease;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.focus-mode-toast.show {
  opacity: 1;
}

/* Toast é€šçŸ¥æ ·å¼ */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-width: 400px;
  width: 100%;
}

.toast {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  display: flex;
  align-items: center;
  gap: 12px;
  animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
  min-width: 280px;
  max-width: 100%;
}

.toast.success {
  border-left: 4px solid #10b981;
}

.toast.error {
  border-left: 4px solid #ef4444;
}

.toast.warning {
  border-left: 4px solid #f59e0b;
}

.toast-icon {
  font-size: 24px;
  flex-shrink: 0;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.toast-message {
  flex: 1;
  color: #1f2937;
  font-size: 14px;
  line-height: 1.4;
  word-wrap: break-word;
}

.toast-close {
  background: none;
  border: none;
  color: #9ca3af;
  cursor: pointer;
  font-size: 18px;
  padding: 0;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.2s ease;
  flex-shrink: 0;
}

.toast-close:hover {
  color: #4b5563;
}

@media (max-width: 768px) {
  .toast-container {
    top: 10px;
    right: 10px;
    left: 10px;
    max-width: none;
  }

  .toast {
    padding: 14px 16px;
    min-width: auto;
  }

  .toast-message {
    font-size: 13px;
  }
}

/* KaTeX æ•°å­¦å…¬å¼æ ·å¼ */
.katex-display {
  overflow-x: auto;
  overflow-y: hidden;
  padding: 10px 0;
}

.katex {
  font-size: 1.1em;
}

.article-content .katex-display {
  margin: 20px 0;
}

/* Mermaid æµç¨‹å›¾æ ·å¼ */
.mermaid {
  margin: 20px 0;
  text-align: center;
  background-color: rgba(26, 26, 46, 0.95);
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border: 1px solid rgba(89, 89, 156, 0.4);
}

.mermaid svg {
  max-width: 100%;
  height: auto;
}

/* Mermaid èŠ‚ç‚¹æ ‡ç­¾æ–‡å­—é¢œè‰² - æµ…ç°è‰² */
.mermaid .nodeLabel,
.mermaid .label {
  fill: #808080 !important;
}

/* ä¿®å¤foreignObjectå†…çš„æ–‡å­—é¢œè‰² */
.mermaid foreignObject .nodeLabel,
.mermaid foreignObject span,
.mermaid foreignObject div {
  color: #808080 !important;
}

/* Mermaid å…¶ä»–æ–‡å­—é¢œè‰² - æµ…ç°è‰² */
.mermaid text:not(.nodeLabel):not(.label) {
  fill: #808080 !important;
}

/* Mermaid èŠ‚ç‚¹æ ·å¼ - ç±³é»„è‰²èƒŒæ™¯ */
.mermaid .node rect,
.mermaid .node circle,
.mermaid .node polygon,
.mermaid .node path {
  fill: #f5f5dc !important;
  stroke: #7aa2f7 !important;
  stroke-width: 2px !important;
}

/* Mermaid è¾¹æ¡†æ ·å¼ */
.mermaid .edgePath path {
  stroke: #7aa2f7 !important;
  stroke-width: 2px !important;
}

/* Mermaid ç®­å¤´æ ·å¼ */
.mermaid .arrowheadPath {
  fill: #7aa2f7 !important;
}
</style>

<!-- æš—è‰²æ¨¡å¼æ ·å¼ (å»¶è¿ŸåŠ è½½) -->
<link rel="stylesheet" href="/css/dark-mode.css" media="print" onload="this.media='all'">

<!-- æ¯›ç»ç’ƒæ•ˆæœæ ·å¼ (å»¶è¿ŸåŠ è½½) -->
<link rel="stylesheet" href="/css/glass-effect.css" media="print" onload="this.media='all'">

<!-- æ¨¡æ€æ¡†åŠ¨ç”»æ ·å¼ (å»¶è¿ŸåŠ è½½) -->
<link rel="stylesheet" href="/css/modal-animations.css" media="print" onload="this.media='all'">

<!-- é”®ç›˜å¿«æ·é”®æ ·å¼ (å»¶è¿ŸåŠ è½½) -->
<link rel="stylesheet" href="/css/keyboard-shortcuts.css" media="print" onload="this.media='all'">
</head>
<body>
<div class="toast-container" id="toastContainer"></div>

<nav>
  <div class="nav-left">
    <button id="articleFilterToggle" aria-label="æ‰“å¼€æ–‡ç« ç­›é€‰" style="display: none; align-items: center; justify-content: center; width: 40px; height: 40px; padding: 8px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(30px) saturate(200%); -webkit-backdrop-filter: blur(30px) saturate(200%); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; cursor: pointer; transition: all 0.3s ease; color: var(--navbar-text-color, rgba(255, 255, 255, 0.9)); margin-right: 4px;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    </button>
    <button id="sidebarToggle" class="sidebar-toggle" aria-label="åˆ‡æ¢ä¾§è¾¹æ ">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>
    <a href="/">ä¸»é¡µ</a>
    <a href="/passage" class="current">æ–‡ç« </a>
    <a href="/collect">å½’æ¡£</a>
    <a href="/about">å…³äº</a>
    <a href="/friends">å‹é“¾<span class="shortcut-hint">f</span></a>
    <a href="/markdown-editor">ç¼–è¾‘å™¨<span class="shortcut-hint">6</span></a>
    <a href="/admin" class="admin-only">ç®¡ç†å‘˜è®¾ç½®</a>
  </div>
  <div class="nav-right">
    <button id="readingModeToggle" aria-label="åˆ‡æ¢é˜…è¯»æ¨¡å¼" style="display: flex; align-items: center; gap: 8px; color: var(--navbar-text-color, rgba(255, 255, 255, 0.9)); font-weight: 500; transition: all 0.3s ease; padding: 8px 16px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(30px) saturate(200%); -webkit-backdrop-filter: blur(30px) saturate(200%); border-radius: 25px; border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
      </svg>
      <span id="readingModeText">æ—¶é—´æˆ³</span>
    </button>
  </div>
</nav>

<!-- æ–‡ç« ç­›é€‰æ¨¡æ€æ¡† -->
<div class="modal article-filter-modal" id="articleFilterModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>æ–‡ç« ç´¢å¼•</h3>
      <button class="modal-close" data-modal="articleFilterModal">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="modal-body">
    <div class="filter-tabs">
      <button class="filter-tab active" data-mode="timestamp">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        æ–‡ç« ç´¢å¼•
      </button>
      <button class="filter-tab" data-mode="outline">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="8" y1="6" x2="21" y2="6"></line>
          <line x1="8" y1="12" x2="21" y2="12"></line>
          <line x1="8" y1="18" x2="21" y2="18"></line>
          <line x1="3" y1="6" x2="3.01" y2="6"></line>
          <line x1="3" y1="12" x2="3.01" y2="12"></line>
          <line x1="3" y1="18" x2="3.01" y2="18"></line>
        </svg>
        æœ¬æ–‡ç›®å½•
      </button>
    </div>
    <div class="filter-search">
      <input type="text" id="articleFilterSearch" placeholder="æœç´¢æ–‡ç« ..." />
    </div>
    <div class="filter-content" id="filterContent">
      <!-- æ–‡ç« åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>
  </div>
</div>

<main class="main-container" role="main">
  <!-- å·¦ä¾§æ–‡ä»¶æ ‘ -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2 id="sidebarTitle">æ–‡ç« ç´¢å¼•</h2>
      <div class="sidebar-controls" id="fileTreeControls">
        <button id="collapseAll" title="å…¨éƒ¨æŠ˜å ">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="18 15 12 9 6 15"></polyline>
          </svg>
        </button>
        <button id="expandAll" title="å…¨éƒ¨å±•å¼€">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>
      </div>
    </div>
    <div class="file-tree" id="fileTree">
      <!-- æ–‡ä»¶æ ‘å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
    <div class="toc-container" id="tocContainer">
      <!-- æœ¬æ–‡ç´¢å¼•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>
  
  <!-- åˆ†å‰²çº¿ -->
  <div class="resizer" id="resizer"></div>
  
  <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
  <div class="content-area">
    <!-- æ ‡ç­¾æ  -->
    <div class="tab-bar" id="tabBar">
      <!-- æ ‡ç­¾é¡µå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <!-- æ–‡ç« å†…å®¹åŒºåŸŸ -->
    <div class="article-container" id="articleContainer">
      <!-- æœªå‘å¸ƒæ–‡ç« æç¤º -->
      {% if is_unpublished %}
      <div class="unpublished-notice" id="unpublishedNotice" style="display: block;">
        <div class="notice-content">
          <div class="notice-icon">ğŸ”’</div>
          <div class="notice-text">
            <h3>æ–‡ç« å°šæœªå‘å¸ƒ</h3>
            {% if passage_status == "draft" %}
              <p>æ­¤æ–‡ç« æ˜¯è‰ç¨¿ï¼Œæ­£åœ¨ç¼–è¾‘ä¸­ï¼Œæš‚æ—¶æ— æ³•è®¿é—®ã€‚</p>
            {% elif passage_status == "pending" %}
              <p>æ­¤æ–‡ç« æ­£åœ¨ç­‰å¾…å®¡æ ¸ï¼Œæš‚æ—¶æ— æ³•è®¿é—®ã€‚</p>
            {% else %}
              <p>æ­¤æ–‡ç« å°šæœªå‘å¸ƒï¼Œæš‚æ—¶æ— æ³•è®¿é—®ã€‚</p>
            {% endif %}
            {% if is_scheduled %}
            <p>
              é¢„è®¡å‘å¸ƒæ—¶é—´ï¼š<span id="scheduledTime">{{ published_at }}</span>
            </p>
            {% endif %}
          </div>
        </div>
      </div>
      {% else %}
      <div class="unpublished-notice" id="unpublishedNotice" style="display: none;">
        <div class="notice-content">
          <div class="notice-icon">ğŸ”’</div>
          <div class="notice-text">
            <h3>æ–‡ç« å°šæœªå‘å¸ƒ</h3>
            <p id="unpublishedMessage">æ­¤æ–‡ç« æ­£åœ¨ç¼–è¾‘ä¸­ï¼Œæš‚æ—¶æ— æ³•è®¿é—®ã€‚</p>
            <p id="scheduledMessage" style="display: none;">
              é¢„è®¡å‘å¸ƒæ—¶é—´ï¼š<span id="scheduledTime"></span>
            </p>
          </div>
        </div>
      </div>
      {% endif %}

      {% if content %}
      <!-- æœåŠ¡å™¨ç«¯æ¸²æŸ“çš„ markdown å†…å®¹ -->
      <div class="article active" id="articleContent" {% if is_unpublished %}style="display: none;"{% endif %}>
        <div class="article-header">
          <div class="article-meta">
            <div class="meta-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <span class="article-date">{{ date }}</span>
            </div>
            <div class="meta-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
              </svg>
              <span class="article-category" id="articleCategory">åŠ è½½ä¸­...</span>
            </div>
            <div class="meta-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                <line x1="7" y1="7" x2="7.01" y2="7"></line>
              </svg>
              <span class="article-tags-inline" id="articleTagsInline">åŠ è½½ä¸­...</span>
            </div>
            <div class="meta-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="2" y1="12" x2="22" y2="12"></line>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
              </svg>
              <span class="article-readtime" id="articleReadTime">é¢„è®¡ {{ read_time }} åˆ†é’Ÿè¯»å®Œ</span>
            </div>
          </div>
        </div>
        <div class="article-content">
          {{ content }}
        </div>

        <!-- é™„ä»¶åˆ—è¡¨åŒºåŸŸ -->
        <div class="attachments-section" id="attachmentsSection" style="display: none;">
          <div class="attachments-header">
            <h3>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
              </svg>
              é™„ä»¶
            </h3>
            <span class="attachments-count" id="attachmentsCount">0 ä¸ªé™„ä»¶</span>
          </div>
          <div class="attachments-list" id="attachmentsList">
            <!-- åŠ è½½çŠ¶æ€ -->
            <div class="loading-state" id="attachmentsLoading" style="display: none;">
              <div class="spinner"></div>
              <span>åŠ è½½é™„ä»¶ä¸­...</span>
            </div>
            <!-- ç©ºçŠ¶æ€ -->
            <div class="empty-attachments" id="emptyAttachments" style="display: none;">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
              </svg>
              <p>æš‚æ— é™„ä»¶</p>
            </div>
            <!-- é™„ä»¶åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>

        <!-- èµåŠ©åŒºåŸŸ - Bing é£æ ¼ -->
        {% if sponsor_enabled %}
        <div class="sponsor-section">
          <div class="sponsor-card">
            <div class="sponsor-header">
              <div class="sponsor-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
              </div>
              <div class="sponsor-title">
                <h3>æ„Ÿè°¢æ‚¨çš„æ”¯æŒ</h3>
                <p>{{ sponsor_description }}</p>
              </div>
            </div>
            <div class="sponsor-options">
              <button class="sponsor-option-btn" data-amount="5">
                <span class="amount">Â¥5</span>
                <span class="label">å’–å•¡</span>
              </button>
              <button class="sponsor-option-btn" data-amount="10">
                <span class="amount">Â¥10</span>
                <span class="label">å¥¶èŒ¶</span>
              </button>
              <button class="sponsor-option-btn" data-amount="20">
                <span class="amount">Â¥20</span>
                <span class="label">åˆé¤</span>
              </button>
              <button class="sponsor-option-btn custom-amount">
                <span class="amount">è‡ªå®šä¹‰</span>
              </button>
            </div>
            <button class="sponsor-submit-btn" id="sponsorSubmitBtn">æ”¯æŒä½œè€…</button>
          </div>
        </div>
        {% endif %}

        <!-- è¯„è®ºåŒºåŸŸ - GitHub é£æ ¼ -->
        <div class="comments-section" id="commentsSection" {% if is_unpublished %}style="display: none;"{% endif %}>
          <div class="comments-header">
            <h3>
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
              </svg>
              è¯„è®º
            </h3>
            <span class="comments-count" id="commentsCount">0 æ¡è¯„è®º</span>
          </div>

          <!-- GitHub é£æ ¼çš„è¯„è®ºè¡¨å• -->
          <div class="github-comment-form">
            <div class="comment-user-avatar">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
              </svg>
            </div>
            <div class="comment-input-wrapper">
              <input type="text" id="commentUsername" class="comment-username-input" placeholder="ç”¨æˆ·å" required>
              <textarea id="commentContent" class="comment-textarea" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." rows="3" required></textarea>
              <div class="comment-actions">
                <div class="comment-tips">
                  <span class="tip">æ”¯æŒ Markdown è¯­æ³•</span>
                  <span class="tip">â€¢</span>
                  <span class="tip">Ctrl+Enter æäº¤</span>
                </div>
                <button type="button" class="submit-comment-btn" id="submitCommentBtn">å‘è¡¨è¯„è®º</button>
              </div>
            </div>
          </div>

          <!-- è¯„è®ºåˆ—è¡¨ -->
          <div class="comments-list" id="commentsList">
            <!-- è¯„è®ºå°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
          </div>

          <!-- åŠ è½½çŠ¶æ€ -->
          <div class="loading-state" id="commentsLoading" style="display: none;">
            <div class="spinner"></div>
            <span>åŠ è½½è¯„è®ºä¸­...</span>
          </div>

          <!-- ç©ºçŠ¶æ€ -->
          <div class="empty-comments" id="emptyComments" style="display: none;">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
            </svg>
            <p>è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</p>
          </div>
        </div>
      </div>
      {% else %}
      <!-- åˆå§‹ç©ºçŠ¶æ€ -->
      <div class="empty-state" id="emptyState">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        <h3>é€‰æ‹©æ–‡ç« å¼€å§‹é˜…è¯»</h3>
        <p>ä»å·¦ä¾§æ–‡ä»¶æ ‘ä¸­é€‰æ‹©ä¸€ç¯‡æ–‡ç« ï¼Œæˆ–åŒå‡»æ–‡ç« ä»¥åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€</p>
      </div>
      {% endif %}
      
      <!-- æ–‡ç« æ¨¡æ¿ï¼ˆéšè—ï¼Œç”¨äºåŠ¨æ€ç”Ÿæˆï¼‰ -->
      <div class="article" id="articleTemplate" style="display: none;">
        <div class="article-header">
          <h1 class="article-title">æ–‡ç« æ ‡é¢˜</h1>
          <div class="article-meta">
            <div class="meta-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <span class="article-date">2024-01-01</span>
            </div>
            <div class="meta-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
              </svg>
              <span class="article-category">æœªåˆ†ç±»</span>
            </div>
            <div class="meta-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                <line x1="7" y1="7" x2="7.01" y2="7"></line>
              </svg>
              <span class="article-tags-inline">æ— æ ‡ç­¾</span>
            </div>
            <div class="meta-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="2" y1="12" x2="22" y2="12"></line>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
              </svg>
              <span class="article-readtime">é¢„è®¡ 10 åˆ†é’Ÿè¯»å®Œ</span>
            </div>
          </div>
          <div class="article-tags">
            <!-- æ ‡ç­¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        <div class="article-content">
          <!-- æ–‡ç« å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- é™„ä»¶åˆ—è¡¨åŒºåŸŸ -->
        <div class="attachments-section attachments-section-template" style="display: none;">
          <div class="attachments-header">
            <h3>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
              </svg>
              é™„ä»¶
            </h3>
            <span class="attachments-count" id="attachmentsCount">0 ä¸ªé™„ä»¶</span>
          </div>
          <div class="attachments-list" id="attachmentsList">
            <!-- åŠ è½½çŠ¶æ€ -->
            <div class="loading-state" id="attachmentsLoading" style="display: none;">
              <div class="spinner"></div>
              <span>åŠ è½½é™„ä»¶ä¸­...</span>
            </div>
            <!-- ç©ºçŠ¶æ€ -->
            <div class="empty-attachments" id="emptyAttachments" style="display: none;">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
              </svg>
              <p>æš‚æ— é™„ä»¶</p>
            </div>
            <!-- é™„ä»¶åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>

        <!-- èµåŠ©åŒºåŸŸ -->
        <div class="sponsor-section sponsor-section-template" style="display: none;">
          <button class="sponsor-btn" id="sponsorBtn">{{ sponsor_button_text }}</button>
        </div>

        <!-- æ–‡ç« è¯„è®ºç³»ç»Ÿ - æ¯ç¯‡æ–‡ç« éƒ½æœ‰ç‹¬ç«‹çš„è¯„è®ºåŒºåŸŸ -->
        <div class="article-comments" data-article-id="">
          <div class="comments-section">
            <div class="comments-header">
              <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                </svg>
                è¯„è®º
              </h3>
              <span class="comments-count">0 æ¡è¯„è®º</span>
            </div>

            <!-- GitHub é£æ ¼çš„è¯„è®ºè¡¨å• -->
            <div class="github-comment-form">
              <div class="comment-user-avatar">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
              </div>
              <div class="comment-input-wrapper">
                <input type="text" class="comment-username-input" placeholder="ç”¨æˆ·å" required>
                <textarea class="comment-textarea" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." rows="3" required></textarea>
                <div class="comment-actions">
                  <div class="comment-tips">
                    <span class="tip">æ”¯æŒ Markdown è¯­æ³•</span>
                    <span class="tip">â€¢</span>
                    <span class="tip">Ctrl+Enter æäº¤</span>
                  </div>
                  <button type="button" class="submit-comment-btn">å‘è¡¨è¯„è®º</button>
                </div>
              </div>
            </div>

            <!-- è¯„è®ºåˆ—è¡¨ -->
            <div class="comments-list">
              <!-- è¯„è®ºå°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div class="loading-state" style="display: none;">
              <div class="spinner"></div>
              <span>åŠ è½½è¯„è®ºä¸­...</span>
            </div>

            <!-- ç©ºçŠ¶æ€ -->
            <div class="empty-comments" style="display: none;">
              <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
              </svg>
              <p>è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</main>

<!-- é¡µè„šå’Œå¤‡æ¡ˆä¿¡æ¯ -->
<footer style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-top: 1px solid rgba(255, 255, 255, 0.2); margin-top: auto; position: relative; z-index: 1; color: rgba(255, 255, 255, 0.9);">
  <div>&copy; {{ year }} {{ foodes }}</div>
  {% if beian_enabled %}
  <div style="margin-top: 10px; font-size: 0.9em;">
    {% if icp_number %}<a href="http://beian.miit.gov.cn/" target="_blank" style="color: inherit; text-decoration: none;">{{ icp_number }}</a>{% endif %}
    {% if police_record_code %}<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode={{ police_record_code }}" target="_blank" style="color: inherit; text-decoration: none; margin-left: 10px;"><img src="/img/police.png" alt="" style="height: 1em; vertical-align: middle; margin-right: 3px;">{{ police_record_content }}</a>{% endif %}
  </div>{% endif %}
</footer>

<!-- å·¥å…·æŒ‰é’® -->
<div class="toolbar" id="toolbar" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; pointer-events: auto;">
  <button id="fullscreenToggle" title="åˆ‡æ¢å…¨å±">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
    </svg>
  </button>
  <button id="sidebarToggleFixed" title="åˆ‡æ¢å¯¼èˆªæ ">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M4 6h16M4 12h16M4 18h16"></path>
    </svg>
  </button>
</div>

<!-- KaTeX JavaScript (å»¶è¿ŸåŠ è½½) -->
<script src="/js/npm/katex-0.16.27/dist/katex.min.js" defer></script>
<!-- KaTeX auto-render extension (å»¶è¿ŸåŠ è½½) -->
<script src="/js/npm/katex-0.16.27/dist/contrib/auto-render.min.js" defer></script>
<!-- Mermaid JavaScript (å»¶è¿ŸåŠ è½½) -->
<script src="/js/npm/mermaid@11.12.2/dist/mermaid.min.js" defer></script>

<script>
// ç­‰å¾… Mermaid åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  // æ£€æŸ¥ mermaid æ˜¯å¦å·²åŠ è½½
  const checkMermaid = setInterval(() => {
    if (typeof mermaid !== 'undefined') {
      clearInterval(checkMermaid);
      // åˆå§‹åŒ– Mermaid
      mermaid.initialize({
  startOnLoad: false,
  theme: 'base',
  themeVariables: {
    // ä¸»è‰²è°ƒ - ä½¿ç”¨ç±³é»„è‰²èƒŒæ™¯é…æµ…ç°è‰²æ–‡å­—
    primaryColor: '#f5f5dc',
    primaryTextColor: '#808080',
    primaryBorderColor: '#7aa2f7',
    lineColor: '#7aa2f7',
    secondaryColor: '#ebebd0',
    tertiaryColor: '#e0e0c0',

    // èƒŒæ™¯è‰²
    background: '#1a1b26',
    mainBkg: '#f5f5dc',
    nodeBorder: '#7aa2f7',

    // æ–‡å­—é¢œè‰²
    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif',
    fontSize: '14px',

    // è¾¹æ¡†é¢œè‰²
    tertiaryBorderColor: '#7aa2f7',

    // ç®­å¤´é¢œè‰²
    arrowheadColor: '#7aa2f7',

    // æµç¨‹å›¾ç‰¹å®š
    flowchartNodeBkg: '#f5f5dc',
    flowchartNodeBorder: '#7aa2f7',
    flowchartNodeText: '#808080',
    flowchartLinkColor: '#7aa2f7',

    // åºåˆ—å›¾ç‰¹å®š
    actorBkg: '#f5f5dc',
    actorBorder: '#7aa2f7',
    actorTextColor: '#808080',
    actorLineColor: '#7aa2f7',
    signalColor: '#7aa2f7',
    signalTextColor: '#808080',
    labelBoxBkgColor: '#f5f5dc',
    labelBoxBorderColor: '#7aa2f7',
    labelTextColor: '#808080',

    // ç±»å›¾ç‰¹å®š
    classText: '#808080',
    classBorderColor: '#7aa2f7',
    classBkg: '#f5f5dc',

    // çŠ¶æ€å›¾ç‰¹å®š
    stateBkg: '#f5f5dc',
    stateBorder: '#7aa2f7',
    stateLabelColor: '#808080',

    // å®ä½“å…³ç³»å›¾ç‰¹å®š
    entityBkg: '#f5f5dc',
    entityBorder: '#7aa2f7',
    entityTextColor: '#808080',

    // ç”¨æˆ·æ—…ç¨‹å›¾ç‰¹å®š
    sectionBkgColor: '#f5f5dc',
    altSectionBkgColor: '#ebebd0',
    gridColor: '#7aa2f7',
    taskBorderColor: '#7aa2f7',
    taskBkgColor: '#f5f5dc',
    taskTextColor: '#808080',
  },
  securityLevel: 'loose',
});

    }
  }, 100); // æ¯ 100ms æ£€æŸ¥ä¸€æ¬¡
});

// æ¸²æŸ“æ•°å­¦å…¬å¼å’Œæµç¨‹å›¾
async function renderMathAndDiagrams(container) {
  if (!container) return;

  // å¤„ç† Mermaid ä»£ç å— - å°† pre code è½¬æ¢ä¸º mermaid å®¹å™¨
  const codeBlocks = container.querySelectorAll('pre code');

  codeBlocks.forEach((block, index) => {
    // æ£€æŸ¥ class å±æ€§æ˜¯å¦åŒ…å« 'language-mermaid'
    if (block.classList.contains('language-mermaid') || block.className.includes('mermaid')) {
      const pre = block.parentElement;
      const mermaidDiv = document.createElement('div');
      mermaidDiv.className = 'mermaid';
      // è·å–åŸå§‹æ–‡æœ¬å†…å®¹ï¼Œç§»é™¤ 'mermaid' æ ‡è¯†
      let text = block.textContent.trim();
      if (text.startsWith('mermaid')) {
        text = text.replace(/^mermaid\n?/, '');
      }
      mermaidDiv.textContent = text;
      pre.replaceWith(mermaidDiv);
    }
  });

  // è¿˜åŸè¢«è½¬ä¹‰çš„ HTML å®ä½“ï¼Œä»¥ä¾¿ KaTeX æ­£ç¡®æ¸²æŸ“æ•°å­¦å…¬å¼
  const paragraphs = container.querySelectorAll('p');
  paragraphs.forEach(p => {
    p.innerHTML = p.innerHTML
      .replace(/&amp;/g, '&')
      .replace(/&lt;/g, '<')
      .replace(/&gt;/g, '>')
      .replace(/&quot;/g, '"')
      .replace(/&#39;/g, "'");
  });

  // æ¸²æŸ“æ•°å­¦å…¬å¼
  renderMathInElement(container, {
    delimiters: [
      {left: '$$', right: '$$', display: true},
      {left: '$', right: '$', display: false},
      {left: '\\(', right: '\\)', display: false},
      {left: '\\[', right: '\\]', display: true}
    ],
    throwOnError: false,
    strict: false
  });

  // æ¸²æŸ“ Mermaid æµç¨‹å›¾
  const mermaidBlocks = container.querySelectorAll('.mermaid');

  if (mermaidBlocks.length > 0) {
    try {
      // æ£€æŸ¥ mermaid æ˜¯å¦å·²åŠ è½½
      if (typeof mermaid === 'undefined') {
        console.warn('Mermaid å°šæœªåŠ è½½ï¼Œè·³è¿‡æ¸²æŸ“');
        mermaidBlocks.forEach(block => {
          block.innerHTML = '<div style="color: #666; padding: 10px;">æµç¨‹å›¾åŠ è½½ä¸­...</div>';
        });
        return;
      }

      await mermaid.run({
        nodes: [...mermaidBlocks],
      });

      // åŠ¨æ€ä¿®å¤Mermaidæ–‡å­—é¢œè‰²
      fixMermaidTextColor();
    } catch (err) {
      console.error('Mermaid æ¸²æŸ“å¤±è´¥:', err);
      mermaidBlocks.forEach(block => {
        block.innerHTML = `<div style="color: red; padding: 10px;">æµç¨‹å›¾æ¸²æŸ“å¤±è´¥: ${err.message}</div>`;
      });
    }
  }
}

// åŠ¨æ€ä¿®å¤Mermaidæµç¨‹å›¾æ–‡å­—é¢œè‰²
function fixMermaidTextColor() {
  const mermaidBlocks = document.querySelectorAll('.mermaid');

  mermaidBlocks.forEach(block => {
    // ä¿®å¤foreignObjectå†…çš„æ–‡å­—é¢œè‰²
    const foreignObjects = block.querySelectorAll('foreignObject');
    foreignObjects.forEach(fo => {
      const spans = fo.querySelectorAll('span.nodeLabel');
      spans.forEach(span => {
        span.style.color = '#808080';
        span.style.fill = '#808080';
      });
    });

    // ç¡®ä¿SVGå†…çš„textå…ƒç´ ä¹Ÿæœ‰æ­£ç¡®çš„é¢œè‰²
    const textElements = block.querySelectorAll('text.nodeLabel, text.label');
    textElements.forEach(text => {
      text.setAttribute('fill', '#808080');
      text.style.fill = '#808080';
    });
  });
}

// ä»åç«¯APIè·å–æ–‡ç« æ•°æ®
let articlesData = {
  folders: []
};

// åˆå§‹åŒ–åº”ç”¨
async function initApp() {
  // ä» URL è·¯å¾„ä¸­æå–æ–‡ç«  ID
  const pathParts = window.location.pathname.split('/');

  if (pathParts.length === 6 && pathParts[1] === 'passage') {
    // æ ¼å¼: /passage/{year}/{month}/{day}/{title}
    // éœ€è¦ä»åç«¯ API è·å–æ–‡ç«  ID
    await loadCurrentArticleFromPath();
  } else if (pathParts.length === 3 && pathParts[1] === 'passage' && !isNaN(pathParts[2])) {
    // æ ¼å¼: /passage/{id}
    currentPassageID = parseInt(pathParts[2]);
  }

  await fetchArticlesData();
  setupEventListeners();

  // æ£€æŸ¥ URL hash æ˜¯å¦åŒ…å«è¦æ‰“å¼€çš„æ–‡ç« æ ‡é¢˜
  if (window.location.hash) {
    // è§£æ hashï¼Œæ ¼å¼å¦‚: #æ–‡ç« æ ‡é¢˜1,æ–‡ç« æ ‡é¢˜2,æ–‡ç« æ ‡é¢˜3
    const hashTitles = window.location.hash.substring(1).split(',');
    
    // æŸ¥æ‰¾å¹¶æ‰“å¼€æ‰€æœ‰æŒ‡å®šçš„æ–‡ç« 
    for (const title of hashTitles) {
      // URL è§£ç æ ‡é¢˜
      const decodedTitle = decodeURIComponent(title.trim());
      if (decodedTitle) {
        // æŸ¥æ‰¾åŒ¹é…çš„æ–‡ç« 
        const article = findArticleByTitle(decodedTitle);
        if (article) {
          await openArticle(article.id);
        } else {
          console.warn('æœªæ‰¾åˆ°æ–‡ç« :', decodedTitle);
        }
      }
    }
    
    // æ¸…ç©º hashï¼ˆå¯é€‰ï¼Œé¿å… URL å˜é•¿ï¼‰
    // window.location.hash = '';
  }
  // å¦‚æœ URL ä¸­æŒ‡å®šäº†æ–‡ç«  IDï¼Œè‡ªåŠ¨æ‰“å¼€å¹¶æ˜¾ç¤ºè¯¥æ–‡ç« 
  else if (currentPassageID) {
    const articleId = `article-${currentPassageID}`;
    const articleData = findArticleById(articleId);
    if (articleData) {
      // æ‰“å¼€æ–‡ç« 
      openArticle(articleId);
    } else {
      console.warn('æœªæ‰¾åˆ°æ–‡ç« :', currentPassageID);
    }
  }

  updateUI();

  // åˆå§‹åŒ–è¯„è®ºåŠŸèƒ½ï¼ˆç¡®ä¿åœ¨ currentPassageID è®¾ç½®å®Œæˆåï¼‰
  initComments();
}

// æ ¹æ®æ ‡é¢˜æŸ¥æ‰¾æ–‡ç« 
function findArticleByTitle(title) {
  console.log('æŸ¥æ‰¾æ–‡ç« ï¼Œè¾“å…¥æ ‡é¢˜:', title);
  console.log('å½“å‰æ–‡ç« æ•°æ®:', articlesData);
  
  // æ ‡å‡†åŒ–æ ‡é¢˜å‡½æ•°ï¼ˆç”¨äºæ¨¡ç³ŠåŒ¹é…ï¼‰
  const normalizeTitle = (t) => t.toLowerCase()
    .trim()
    .replace(/\s+/g, ' ')
    .replace(/[\/\?#\[\]@!$&'()*+,;=]/g, '');

  const normalizedInput = normalizeTitle(title);
  console.log('æ ‡å‡†åŒ–åçš„è¾“å…¥æ ‡é¢˜:', normalizedInput);

  // é€’å½’æœç´¢æ‰€æœ‰æ–‡ä»¶å¤¹
  function searchInFolders(folders) {
    if (!folders || folders.length === 0) {
      return null;
    }
    
    for (const folder of folders) {
      console.log('æ£€æŸ¥æ–‡ä»¶å¤¹:', folder.name);
      if (folder.files && folder.files.length > 0) {
        console.log('  æ–‡ä»¶å¤¹ä¸­çš„æ–‡ç« :', folder.files.map(f => f.title));
        // å…ˆå°è¯•ç²¾ç¡®åŒ¹é…
        let found = folder.files.find(file => file.title === title);
        
        // å¦‚æœç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå°è¯•æ ‡å‡†åŒ–åçš„åŒ¹é…
        if (!found) {
          found = folder.files.find(file => normalizeTitle(file.title) === normalizedInput);
          if (found) {
            console.log('  é€šè¿‡æ ‡å‡†åŒ–åŒ¹é…æ‰¾åˆ°:', found.title);
          }
        } else {
          console.log('  é€šè¿‡ç²¾ç¡®åŒ¹é…æ‰¾åˆ°:', found.title);
        }
        
        if (found) {
          return found;
        }
      }
      if (folder.subfolders) {
        const found = searchInFolders(Object.values(folder.subfolders));
        if (found) {
          return found;
        }
      }
    }
    return null;
  }
  
  // articlesData çš„ç»“æ„æ˜¯ { folders: [...] }
  const folders = articlesData.folders || Object.values(articlesData);
  const result = searchInFolders(folders);
  console.log('æŸ¥æ‰¾ç»“æœ:', result);
  return result;
}

// ä»è·¯å¾„åŠ è½½å½“å‰æ–‡ç« 
async function loadCurrentArticleFromPath() {
  try {
    const pathParts = window.location.pathname.split('/');
    // æ ¼å¼: /passage/{year}/{month}/{day}/{title}
    const titleFromPath = decodeURIComponent(pathParts[4]);

    // å°è¯•æ ¹æ®è·¯å¾„æŸ¥æ‰¾æ–‡ç« 
    const response = await fetch('/api/passages');
    const result = await response.json();

    if (result.success && result.data) {
      // æ ‡å‡†åŒ–æ ‡é¢˜è¿›è¡Œæ¯”è¾ƒ
      const normalizeTitle = (title) => title.toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/[\/\?#\[\]@!$&'()*+,;=]/g, '')
        .replace(/-+/g, '-');

      // æŸ¥æ‰¾åŒ¹é…è·¯å¾„çš„æ–‡ç« 
      const article = result.data.find(a => {
        return normalizeTitle(a.title) === normalizeTitle(titleFromPath);
      });

      if (article) {
        currentPassageID = article.id;

        // è°ƒç”¨è¯¦æƒ…æ¥å£è·å–å®Œæ•´çš„æ–‡ç« å†…å®¹ï¼ˆåŒ…æ‹¬ html_contentï¼‰
        const detailResponse = await fetch(`/api/passages/${article.id}`);
        const detailResult = await detailResponse.json();

        if (detailResult.success && detailResult.data) {
          // ä½¿ç”¨è¯¦æƒ…æ¥å£è¿”å›çš„ html_contentï¼ˆå·²æ¸²æŸ“çš„HTMLï¼‰æˆ– contentï¼ˆåŸå§‹Markdownï¼‰
          const renderedContent = detailResult.data.html_content || detailResult.data.content;

          const articleData = {
            id: `article-${article.id}`,
            title: article.title,
            date: article.created_at || '2024-01-01',
            readtime: '5åˆ†é’Ÿ',
            tags: article.tags || '[]',
            category: article.category || 'æœªåˆ†ç±»',
            content: renderedContent || '',
            show_title: true,
            status: article.status || 'published',
            isScheduled: article.is_scheduled || false,
            publishedAt: article.published_at || null
          };

          // æ¸²æŸ“æ–‡ç« å†…å®¹
          renderArticle(articleData);

          // æ›´æ–°æ´»åŠ¨æ–‡ç« 
          appState.activeArticleId = `article-${article.id}`;
          if (!appState.openTabs.includes(`article-${article.id}`)) {
            appState.openTabs.push(`article-${article.id}`);
          }
        } else {
          console.error('è·å–æ–‡ç« è¯¦æƒ…å¤±è´¥:', detailResult.message);
        }
        
        // æ›´æ–°æ´»åŠ¨æ–‡ç« 
        appState.activeArticleId = `article-${article.id}`;
        if (!appState.openTabs.includes(`article-${article.id}`)) {
          appState.openTabs.push(`article-${article.id}`);
        }
      } else {
        console.warn('æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ç« :', titleFromPath);
      }
    }
  } catch (error) {
    console.error('åŠ è½½å½“å‰æ–‡ç« å¤±è´¥:', error);
  }
}

// åˆ†é¡µçŠ¶æ€
let currentPage = 1;
const pageSize = 10;
let hasMoreArticles = true;
let isLoadingArticles = false;

// æ–‡ç« å†…å®¹ç¼“å­˜
const articleContentCache = new Map(); // key: articleId, value: { content, timestamp }

// è¯„è®ºåŠ è½½çŠ¶æ€ç¼“å­˜ï¼Œé¿å…é‡å¤åŠ è½½è¯„è®º
const commentsLoadedCache = new Set(); // key: articleId

// ä»åç«¯APIè·å–æ–‡ç« æ•°æ®ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
async function fetchArticlesData() {
  if (isLoadingArticles || !hasMoreArticles) {
    return;
  }

  try {
    isLoadingArticles = true;
    
    // è·å–æ–‡ç« åˆ—è¡¨ï¼ˆå¸¦åˆ†é¡µï¼‰
    const response = await fetch(`/api/passages?page=${currentPage}&limit=${pageSize}`);
    const result = await response.json();
    
    if (result.success && result.data) {
      // å¦‚æœæ˜¯ç¬¬ä¸€é¡µï¼Œé‡æ–°ç»„ç»‡æ•°æ®
      if (currentPage === 1) {
        articlesData = organizeArticlesByFolder(result.data);
        renderFileTree();
      } else {
        // å¦åˆ™è¿½åŠ æ•°æ®
        const newArticles = organizeArticlesByFolder(result.data);
        articlesData = mergeArticlesData(articlesData, newArticles);
        renderFileTree();
      }
      
      // æ›´æ–°åˆ†é¡µçŠ¶æ€
      if (result.pagination) {
        hasMoreArticles = result.pagination.has_more;
      }
      
      currentPage++;
    }
  } catch (error) {
    console.error('è·å–æ–‡ç« æ•°æ®å¤±è´¥:', error);
    // ä½¿ç”¨é»˜è®¤æ•°æ®ä½œä¸ºfallback
    if (currentPage === 1) {
      articlesData = getDefaultArticlesData();
      renderFileTree();
    }
  } finally {
    isLoadingArticles = false;
  }
}

// åˆå¹¶æ–‡ç« æ•°æ®
function mergeArticlesData(existingData, newData) {
  // ç®€å•å®ç°ï¼šé‡æ–°ç»„ç»‡æ‰€æœ‰æ•°æ®
  // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯ä»¥ä¼˜åŒ–ä¸ºå¢é‡æ›´æ–°
  const allArticles = [...getAllArticlesFromData(existingData), ...getAllArticlesFromData(newData)];
  return organizeArticlesByFolder(allArticles);
}

// ä»æ•°æ®ç»“æ„ä¸­æå–æ‰€æœ‰æ–‡ç« 
function getAllArticlesFromData(data) {
  const articles = [];
  
  Object.values(data).forEach(year => {
    Object.values(year.subfolders).forEach(month => {
      Object.values(month.subfolders).forEach(day => {
        if (day.files) {
          articles.push(...day.files);
        }
      });
    });
  });
  
  return articles;
}

// æ»šåŠ¨åˆ°åº•éƒ¨åŠ è½½æ›´å¤š
function setupInfiniteScroll() {
  const fileTree = document.querySelector('.file-tree');
  if (!fileTree) return;
  
  fileTree.addEventListener('scroll', () => {
    const scrollTop = fileTree.scrollTop;
    const scrollHeight = fileTree.scrollHeight;
    const clientHeight = fileTree.clientHeight;
    
    // å½“æ»šåŠ¨åˆ°è·ç¦»åº•éƒ¨ 100px æ—¶åŠ è½½æ›´å¤š
    if (scrollTop + clientHeight >= scrollHeight - 100) {
      fetchArticlesData();
    }
  });
}

// åˆå§‹åŒ–åˆ†é¡µå’Œæ— é™æ»šåŠ¨
function initPagination() {
  currentPage = 1;
  hasMoreArticles = true;
  isLoadingArticles = false;
  articleContentCache.clear(); // æ¸…ç©ºæ—§ç¼“å­˜
  fetchArticlesData();
  setupInfiniteScroll();
  
  // å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰
  setInterval(() => {
    clearExpiredCache(30 * 60 * 1000); // 30 åˆ†é’Ÿè¿‡æœŸ
  }, 5 * 60 * 1000);
}

// å°†æ–‡ç« æŒ‰æ–‡ä»¶å¤¹ç»„ç»‡ï¼ˆå¹´-æœˆ-æ—¥-æ–‡ç« åï¼‰
function organizeArticlesByFolder(articles) {
  const years = {};
  
  articles.forEach(article => {
    // ä»æ—¥æœŸä¸­æå–å¹´æœˆæ—¥
    // created_at æ ¼å¼: "2026-01-28 03:11:43"
    const dateParts = article.created_at.split(' ')[0].split('-');
    const year = dateParts[0];
    const month = dateParts[1];
    const day = dateParts[2];
    
    // åˆ›å»ºå¹´ä»½å±‚çº§
    if (!years[year]) {
      years[year] = {
        name: `${year}å¹´`,
        id: `year-${year}`,
        open: true,
        subfolders: {}
      };
    }
    
    // åˆ›å»ºæœˆä»½å±‚çº§
    const monthKey = `${year}-${month}`;
    if (!years[year].subfolders[monthKey]) {
      years[year].subfolders[monthKey] = {
        name: `${month}æœˆ`,
        id: monthKey,
        open: true,
        subfolders: {}
      };
    }
    
    // åˆ›å»ºæ—¥æœŸå±‚çº§
    const dayKey = `${year}-${month}-${day}`;
    if (!years[year].subfolders[monthKey].subfolders[dayKey]) {
      years[year].subfolders[monthKey].subfolders[dayKey] = {
        name: `${day}æ—¥`,
        id: dayKey,
        open: true,
        files: []
      };
    }
    
    // ç”Ÿæˆ markdown è·¯å¾„
    const markdownPath = `${year}/${month}/${day}/${sanitizeTitle(article.title)}`;
    
    // ä¼°ç®—é˜…è¯»æ—¶é•¿ï¼ˆåŸºäºæ‘˜è¦é•¿åº¦ï¼‰
    const summary = article.summary || '';
    const readTime = Math.ceil(summary.length / 400) || 1;
    
    // æ·»åŠ æ–‡ç« åˆ°æ—¥æœŸæ–‡ä»¶å¤¹ï¼ˆä¸åŒ…å«å®Œæ•´å†…å®¹ï¼‰
    // ç®€åŒ–æ—¥æœŸæ ¼å¼ï¼šåªæ˜¾ç¤ºæ—¥æœŸéƒ¨åˆ†ï¼ˆYYYY-MM-DDï¼‰
    const dateOnly = (article.created_at || '2024-01-01').split(' ')[0];
    years[year].subfolders[monthKey].subfolders[dayKey].files.push({
      id: `article-${article.id}`,
      title: article.title,
      date: dateOnly,
      readtime: `${readTime}åˆ†é’Ÿ`,
      tags: article.tags || [],
      category: article.category || 'æœªåˆ†ç±»',
      content: '', // ä¸åŠ è½½å®Œæ•´å†…å®¹ï¼Œç‚¹å‡»æ—¶å†åŠ è½½
      summary: summary,
      show_title: true,
      markdownPath: markdownPath,
      status: article.status || 'published',
      isScheduled: article.is_scheduled || false,
      publishedAt: article.published_at || null
    });
  });
  
  // è½¬æ¢ä¸ºæ•°ç»„æ ¼å¼å¹¶é€’å½’å¤„ç†å­æ–‡ä»¶å¤¹
  const folders = Object.values(years).map(yearFolder => {
    yearFolder.subfolders = Object.values(yearFolder.subfolders).map(monthFolder => {
      monthFolder.subfolders = Object.values(monthFolder.subfolders).map(dayFolder => {
        return {
          name: dayFolder.name,
          id: dayFolder.id,
          open: dayFolder.open,
          files: dayFolder.files
        };
      });
      return {
        name: monthFolder.name,
        id: monthFolder.id,
        open: monthFolder.open,
        subfolders: monthFolder.subfolders
      };
    });
    return yearFolder;
  });
  
  return {
    folders: folders
  };
}

// æ¸…ç†ä¸å®Œæ•´çš„ UTF-8 å­—ç¬¦ï¼ˆä¿®å¤ä¸­æ–‡ä¹±ç ï¼‰
function sanitizeUTF8(str) {
  if (!str) return '';
  
  // ä½¿ç”¨ TextEncoder å’Œ TextDecoder æ¥æ¸…ç†ä¸å®Œæ•´çš„ UTF-8 åºåˆ—
  try {
    const encoder = new TextEncoder();
    const decoder = new TextDecoder({ fatal: false });
    const bytes = encoder.encode(str);
    return decoder.decode(bytes);
  } catch (e) {
    // å¦‚æœ TextEncoder/Decoder ä¸å¯ç”¨ï¼Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ–¹æ³•
    // ç§»é™¤æ— æ•ˆçš„ UTF-8 å­—ç¬¦
    return str.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
  }
}

// æ¸…ç†æ ‡é¢˜ç”¨äºç”Ÿæˆè·¯å¾„
function sanitizeTitle(title) {
  return title.toLowerCase()
    .replace(/\s+/g, '-')
    .replace(/[\/\?#\[\]@!$&'()*+,;=]/g, '') // ç§»é™¤ URL ä¸­çš„ç‰¹æ®Šå­—ç¬¦
    .replace(/-+/g, '-'); // åˆå¹¶å¤šä¸ªè¿å­—ç¬¦ä¸ºä¸€ä¸ª
}

// è®¡ç®—é˜…è¯»æ—¶é•¿ï¼ˆæŒ‰200å­—/åˆ†é’Ÿä¼°ç®—ï¼‰
function calculateReadTime(content) {
  // ç§»é™¤HTMLæ ‡ç­¾ï¼Œåªä¿ç•™çº¯æ–‡æœ¬
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = content;
  const text = tempDiv.textContent || tempDiv.innerText || '';
  
  // ç§»é™¤ç©ºç™½å­—ç¬¦
  const cleanText = text.trim();
  
  // è®¡ç®—å­—æ•°ï¼ˆæ”¯æŒä¸­æ–‡å’Œè‹±æ–‡ï¼‰
  let wordCount = 0;
  for (let i = 0; i < cleanText.length; i++) {
    const char = cleanText[i];
    // ä¸­æ–‡å­—ç¬¦ç®—1ä¸ªå­—
    if (/[\u4e00-\u9fa5]/.test(char)) {
      wordCount++;
    } 
    // è‹±æ–‡å•è¯æŒ‰ç©ºæ ¼åˆ†éš”
    else if (/\s/.test(char)) {
      wordCount++;
    }
  }
  
  // æŒ‰200å­—/åˆ†é’Ÿè®¡ç®—é˜…è¯»æ—¶é•¿
  let readTime = Math.floor(wordCount / 200);
  
  // è‡³å°‘æ˜¾ç¤º1åˆ†é’Ÿ
  if (readTime === 0) {
    readTime = 1;
  }
  
  return readTime;
}

// é»˜è®¤æ–‡ç« æ•°æ®ï¼ˆAPIå¤±è´¥æ—¶ä½¿ç”¨ï¼‰
function getDefaultArticlesData() {
  return {
    folders: [
      {
        name: "æŠ€æœ¯æ–‡ç« ",
        id: "tech",
        open: true,
        files: [
          {
            id: "article-1",
            title: "å“åº”å¼è®¾è®¡çš„æœ€ä½³å®è·µä¸è¶‹åŠ¿",
            date: "2024-03-15",
            author: "å‰ç«¯è®¾è®¡å¸ˆ",
            readtime: "12åˆ†é’Ÿ",
            tags: ["å‰ç«¯å¼€å‘", "CSS", "å“åº”å¼è®¾è®¡", "ç”¨æˆ·ä½“éªŒ"],
            category: "æŠ€æœ¯",
            content: `
              <h2>å“åº”å¼è®¾è®¡çš„é‡è¦æ€§</h2>
              <p>éšç€ç§»åŠ¨è®¾å¤‡çš„æ™®åŠï¼Œå“åº”å¼è®¾è®¡å·²æˆä¸ºç°ä»£Webå¼€å‘çš„æ ¸å¿ƒã€‚æœ¬æ–‡å°†æ¢è®¨æœ€æ–°çš„å“åº”å¼è®¾è®¡æ¨¡å¼ã€CSS Gridä¸Flexboxçš„é«˜çº§ç”¨æ³•ï¼Œä»¥åŠå¦‚ä½•åœ¨å¤æ‚å¸ƒå±€ä¸­ä¿æŒç”¨æˆ·ä½“éªŒçš„ä¸€è‡´æ€§ã€‚</p>
              
              <h2>ç§»åŠ¨ä¼˜å…ˆç­–ç•¥</h2>
              <p>ç§»åŠ¨ä¼˜å…ˆçš„è®¾è®¡ç†å¿µå·²æˆä¸ºè¡Œä¸šæ ‡å‡†ã€‚è¿™ç§ç­–ç•¥è¦æ±‚æˆ‘ä»¬å…ˆä¸ºç§»åŠ¨è®¾å¤‡è®¾è®¡ï¼Œç„¶åé€æ­¥å¢å¼ºä»¥é€‚åº”æ›´å¤§çš„å±å¹•ã€‚</p>
              
              <blockquote>
                ç§»åŠ¨ä¼˜å…ˆä¸ä»…æ˜¯ä¸€ç§è®¾è®¡ç­–ç•¥ï¼Œæ›´æ˜¯ä¸€ç§æ€ç»´æ–¹å¼ã€‚å®ƒè¿«ä½¿æˆ‘ä»¬å…³æ³¨å†…å®¹çš„æœ¬è´¨ï¼Œå»é™¤ä¸å¿…è¦çš„è£…é¥°ã€‚
              </blockquote>
              
              <h2>CSS Gridä¸Flexboxçš„é…åˆ</h2>
              <p>CSS Gridå’ŒFlexboxæ˜¯ç°ä»£å“åº”å¼å¸ƒå±€çš„ä¸¤å¤§æ”¯æŸ±ã€‚Gridæ“…é•¿äºŒç»´å¸ƒå±€ï¼Œè€ŒFlexboxåˆ™åœ¨ä¸€ç»´å¸ƒå±€ä¸Šè¡¨ç°å‡ºè‰²ã€‚</p>
              
              <pre><code>.container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
}

.card {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}</code></pre>
              
              <h2>æ€§èƒ½ä¼˜åŒ–è€ƒè™‘</h2>
              <p>å“åº”å¼è®¾è®¡ä¸ä»…ä»…æ˜¯è§†è§‰ä¸Šçš„é€‚åº”ï¼Œè¿˜éœ€è¦è€ƒè™‘æ€§èƒ½ã€‚å›¾ç‰‡å“åº”å¼ã€æ¡ä»¶åŠ è½½å’Œä»£ç åˆ†å‰²éƒ½æ˜¯é‡è¦çš„ä¼˜åŒ–æ‰‹æ®µã€‚</p>
              
              <h2>æœªæ¥è¶‹åŠ¿</h2>
              <p>å®¹å™¨æŸ¥è¯¢ã€å±‚å æ ·å¼å±‚å’Œæ–°çš„è§†å£å•ä½å°†è¿›ä¸€æ­¥æå‡å“åº”å¼è®¾è®¡çš„èƒ½åŠ›å’Œçµæ´»æ€§ã€‚</p>
            `
          },
          {
            id: "article-2",
            title: "JavaScript ES2024 æ–°ç‰¹æ€§è§£æ",
            date: "2024-02-28",
            author: "JavaScriptå¼€å‘è€…",
            readtime: "15åˆ†é’Ÿ",
            tags: ["JavaScript", "ES2024", "å‰ç«¯", "ç¼–ç¨‹"],
            category: "æŠ€æœ¯",
            content: `
              <h2>ES2024æ¦‚è§ˆ</h2>
              <p>ECMAScript 2024å³å°†å¸¦æ¥ä¸€ç³»åˆ—ä»¤äººå…´å¥‹çš„æ–°ç‰¹æ€§ï¼ŒåŒ…æ‹¬Recordå’ŒTupleæ•°æ®ç±»å‹ã€ç®¡é“è¿ç®—ç¬¦ç­‰ã€‚æœ¬æ–‡æ·±å…¥è§£æè¿™äº›æ–°ç‰¹æ€§çš„ç”¨æ³•ã€é€‚ç”¨åœºæ™¯ä»¥åŠå®ƒä»¬å¦‚ä½•æ”¹å˜æˆ‘ä»¬çš„ç¼–ç¨‹æ–¹å¼ã€‚</p>
              
              <h2>Recordå’ŒTupleæ•°æ®ç±»å‹</h2>
              <p>Recordå’ŒTupleæ˜¯ä¸¤ç§æ–°çš„ä¸å¯å˜æ•°æ®ç»“æ„ï¼Œå®ƒä»¬å¯ä»¥æ˜¾è‘—æé«˜ä»£ç çš„å¯é¢„æµ‹æ€§å’Œå®‰å…¨æ€§ã€‚</p>
              
              <pre><code>// Recordç¤ºä¾‹
const person = #{
  name: "å¼ ä¸‰",
  age: 30
};

// Tupleç¤ºä¾‹
const coordinates = #[10, 20, 30];</code></pre>
              
              <h2>ç®¡é“è¿ç®—ç¬¦</h2>
              <p>ç®¡é“è¿ç®—ç¬¦(|>)å…è®¸æˆ‘ä»¬ä»¥æ›´ç›´è§‚çš„æ–¹å¼é“¾å¼è°ƒç”¨å‡½æ•°ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§ã€‚</p>
              
              <pre><code>// ä¼ ç»Ÿæ–¹å¼
const result = capitalize(filterEven(square([1, 2, 3, 4, 5])));

// ä½¿ç”¨ç®¡é“è¿ç®—ç¬¦
const result = [1, 2, 3, 4, 5]
  |> square
  |> filterEven
  |> capitalize;</code></pre>
              
              <h2>å…¶ä»–é‡è¦ç‰¹æ€§</h2>
              <ul>
                <li><strong>æ•°ç»„åˆ†ç»„æ–¹æ³•</strong>ï¼šåŸç”Ÿçš„æ•°ç»„åˆ†ç»„æ–¹æ³•ï¼Œæ— éœ€ä¾èµ–Lodashç­‰åº“</li>
                <li><strong>è£…é¥°å™¨æ”¹è¿›</strong>ï¼šæ›´å¼ºå¤§å’Œæ ‡å‡†çš„è£…é¥°å™¨è¯­æ³•</li>
                <li><strong>é”™è¯¯åŸå› </strong>ï¼šErroræ„é€ å‡½æ•°ç°åœ¨å¯ä»¥æ¥å—causeå‚æ•°</li>
              </ul>
              
              <h2>è¿ç§»å»ºè®®</h2>
              <p>å¯¹äºç°æœ‰é¡¹ç›®ï¼Œå»ºè®®é€æ­¥å¼•å…¥è¿™äº›æ–°ç‰¹æ€§ï¼Œå…ˆä»ä¸ä¼šç ´åç°æœ‰ä»£ç çš„åŠŸèƒ½å¼€å§‹ã€‚</p>
            `
          }
        ]
      },
      {
        name: "è®¾è®¡ç›¸å…³",
        id: "design",
        open: false,
        files: [
          {
            id: "article-3",
            title: "æš—è‰²æ¨¡å¼è®¾è®¡çš„å¿ƒç†å­¦ä¸å®ç°",
            date: "2024-01-10",
            author: "UIè®¾è®¡å¸ˆ",
            readtime: "10åˆ†é’Ÿ",
            tags: ["è®¾è®¡", "æš—è‰²æ¨¡å¼", "CSS", "ç”¨æˆ·ä½“éªŒ"],
            category: "è®¾è®¡",
            content: `
              <h2>æš—è‰²æ¨¡å¼çš„å…´èµ·</h2>
              <p>æš—è‰²æ¨¡å¼ä¸ä»…æ˜¯æ—¶å°šæ½®æµï¼Œæ›´æ˜¯å¯¹ç”¨æˆ·è§†åŠ›ä¿æŠ¤å’Œç”µæ± å¯¿å‘½çš„å…³æ€€ã€‚æœ¬æ–‡ä»å¿ƒç†å­¦è§’åº¦åˆ†ææš—è‰²æ¨¡å¼çš„ç›Šå¤„ï¼Œå¹¶æä¾›å®ç”¨çš„CSSå’ŒJavaScriptå®ç°æ–¹æ¡ˆã€‚</p>
              
              <h2>å¿ƒç†å­¦åŸºç¡€</h2>
              <p>æš—è‰²æ¨¡å¼å¯ä»¥å‡å°‘çœ¼ç›ç–²åŠ³ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½å…‰ç¯å¢ƒä¸‹ã€‚ç ”ç©¶è¡¨æ˜ï¼Œé€‚å½“çš„å¯¹æ¯”åº¦å¯ä»¥æé«˜é˜…è¯»èˆ’é€‚åº¦ï¼Œå‡å°‘è§†è§‰å‹åŠ›ã€‚</p>
              
              <h2>CSSå®ç°æ–¹æ¡ˆ</h2>
              <p>ä½¿ç”¨CSSè‡ªå®šä¹‰å±æ€§å’Œåª’ä½“æŸ¥è¯¢å¯ä»¥è½»æ¾å®ç°æš—è‰²æ¨¡å¼ã€‚</p>
              
              <pre><code>:root {
  --bg-color: #ffffff;
  --text-color: #333333;
  --primary-color: #007bff;
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg-color: #1a1a1a;
    --text-color: #f0f0f0;
    --primary-color: #3399ff;
  }
}

body {
  background-color: var(--bg-color);
  color: var(--text-color);
}</code></pre>
              
              <h2>JavaScriptåˆ‡æ¢åŠŸèƒ½</h2>
              <p>é™¤äº†ç³»ç»Ÿåå¥½ï¼Œæˆ‘ä»¬è¿˜åº”è¯¥å…è®¸ç”¨æˆ·æ‰‹åŠ¨åˆ‡æ¢ä¸»é¢˜ã€‚</p>
              
              <pre><code>const themeToggle = document.getElementById('themeToggle');
const currentTheme = localStorage.getItem('theme');

if (currentTheme) {
  document.documentElement.setAttribute('data-theme', currentTheme);
}

themeToggle.addEventListener('click', () => {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
});</code></pre>
              
              <h2>è®¾è®¡æ³¨æ„äº‹é¡¹</h2>
              <ul>
                <li>é¿å…çº¯é»‘è‰²èƒŒæ™¯ï¼Œä½¿ç”¨æ·±ç°è‰²</li>
                <li>è°ƒæ•´é¢œè‰²é¥±å’Œåº¦å’Œå¯¹æ¯”åº¦</li>
                <li>ä¸ºé˜´å½±å’Œå±‚æ¬¡æ„Ÿä½¿ç”¨ä¸åŒçš„ç°åº¦</li>
                <li>æµ‹è¯•ä¸åŒç¯å¢ƒä¸‹çš„å¯è¯»æ€§</li>
              </ul>
            `
          }
        ]
      },
      {
        name: "ç”Ÿæ´»éšç¬”",
        id: "life",
        open: false,
        files: [
          {
            id: "article-4",
            title: "è¿œç¨‹å·¥ä½œç¯å¢ƒä¸‹çš„å›¢é˜Ÿåä½œå·¥å…·æ¯”è¾ƒ",
            date: "2023-04-14",
            author: "è¿œç¨‹å·¥ä½œè€…",
            readtime: "8åˆ†é’Ÿ",
            tags: ["è¿œç¨‹å·¥ä½œ", "å›¢é˜Ÿåä½œ", "å·¥å…·æ¯”è¾ƒ"],
            category: "ç”Ÿæ´»",
            content: `
              <h2>è¿œç¨‹å·¥ä½œçš„æ–°å¸¸æ€</h2>
              <p>è¿œç¨‹å·¥ä½œå·²æˆä¸ºæ–°å¸¸æ€ï¼Œé€‰æ‹©åˆé€‚çš„åä½œå·¥å…·è‡³å…³é‡è¦ã€‚æœ¬æ–‡æ¯”è¾ƒäº†Slackã€Teamsã€Notionã€Figmaç­‰ä¸»æµå·¥å…·çš„ä¼˜ç¼ºç‚¹ï¼Œå¸®åŠ©å›¢é˜Ÿåšå‡ºæ˜æ™ºé€‰æ‹©ã€‚</p>
              
              <h2>æ²Ÿé€šå·¥å…·</h2>
              <h3>Slack</h3>
              <p>Slackä»¥å…¶å¼ºå¤§çš„é¢‘é“åŠŸèƒ½å’Œä¸°å¯Œçš„é›†æˆç”Ÿæ€ç³»ç»Ÿè‘—ç§°ï¼Œé€‚åˆéœ€è¦é¢‘ç¹æ²Ÿé€šå’Œé›†æˆçš„å›¢é˜Ÿã€‚</p>
              
              <h3>Microsoft Teams</h3>
              <p>Teamsæ·±åº¦é›†æˆOffice 365å¥—ä»¶ï¼Œé€‚åˆå·²ç»ä½¿ç”¨å¾®è½¯ç”Ÿæ€ç³»ç»Ÿçš„ä¼ä¸šï¼Œä½†å­¦ä¹ æ›²çº¿è¾ƒé™¡å³­ã€‚</p>
              
              <h2>æ–‡æ¡£ä¸é¡¹ç›®ç®¡ç†</h2>
              <h3>Notion</h3>
              <p>Notionæ˜¯ä¸€æ¬¾å…¨èƒ½å‹å·¥å…·ï¼Œç»“åˆäº†æ–‡æ¡£ã€æ•°æ®åº“ã€çœ‹æ¿å’Œç»´åŸºåŠŸèƒ½ï¼Œçµæ´»æ€§æé«˜ã€‚</p>
              
              <h3>Confluence</h3>
              <p>Confluenceæ˜¯ä¼ä¸šçº§çš„çŸ¥è¯†ç®¡ç†å’Œæ–‡æ¡£åä½œå¹³å°ï¼Œä¸Jiraé›†æˆè‰¯å¥½ï¼Œé€‚åˆè½¯ä»¶å¼€å‘å›¢é˜Ÿã€‚</p>
              
              <h2>è®¾è®¡åä½œ</h2>
              <h3>Figma</h3>
              <p>Figmaæ”¹å˜äº†è®¾è®¡åä½œçš„æ–¹å¼ï¼Œæ”¯æŒå®æ—¶åä½œå’Œè®¾è®¡ç³»ç»Ÿç®¡ç†ï¼Œå·²æˆä¸ºè¡Œä¸šæ ‡å‡†ã€‚</p>
              
              <h3>Miro</h3>
              <p>Miroæ˜¯æ•°å­—ç™½æ¿å·¥å…·ï¼Œé€‚åˆå¤´è„‘é£æš´ã€å·¥ä½œåŠå’Œæ•æ·ä»ªå¼ï¼Œæ”¯æŒå¤šç§æ¨¡æ¿å’Œæ¡†æ¶ã€‚</p>
              
              <h2>é€‰æ‹©å»ºè®®</h2>
              <p>é€‰æ‹©å·¥å…·æ—¶éœ€è¦è€ƒè™‘å›¢é˜Ÿè§„æ¨¡ã€å·¥ä½œæµç¨‹ã€ç°æœ‰ç”Ÿæ€ç³»ç»Ÿå’Œé¢„ç®—ã€‚å»ºè®®å…ˆè¿›è¡Œå°è§„æ¨¡è¯•ç”¨ï¼Œæ”¶é›†åé¦ˆåå†åšå†³å®šã€‚</p>
            `
          }
        ]
      }
    ]
  };
}

// åº”ç”¨çŠ¶æ€
const appState = {
  activeArticleId: null,
  openTabs: [],
  sidebarOpen: true,
  fullscreen: false,
  sidebarWidth: 280,
  isResizing: false,
  readingMode: 'timestamp' // 'timestamp' æˆ– 'toc'
};

// DOMå…ƒç´ 
const sidebar = document.getElementById('sidebar');
const fileTree = document.getElementById('fileTree');
const tabBar = document.getElementById('tabBar');
const articleContainer = document.getElementById('articleContainer');
const emptyState = document.getElementById('emptyState');
const sidebarToggle = document.getElementById('sidebarToggle');
const sidebarToggleFixed = document.getElementById('sidebarToggleFixed');
const fullscreenToggle = document.getElementById('fullscreenToggle');
const collapseAllBtn = document.getElementById('collapseAll');
const expandAllBtn = document.getElementById('expandAll');
const resizer = document.getElementById('resizer');
const readingModeToggle = document.getElementById('readingModeToggle');
const readingModeText = document.getElementById('readingModeText');
const tocContainer = document.getElementById('tocContainer');
const sidebarTitle = document.getElementById('sidebarTitle');
const fileTreeControls = document.getElementById('fileTreeControls');

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– - å·²åœ¨æ–‡ä»¶æœ«å°¾æ³¨å†Œ

// åŠ è½½é™„ä»¶åˆ—è¡¨
async function loadAttachments(articleDate, articleElement) {
  // å¦‚æœæœªæä¾› articleElementï¼Œå°è¯•æŸ¥æ‰¾å½“å‰æ¿€æ´»çš„æ–‡ç« 
  if (!articleElement) {
    articleElement = document.querySelector('.article.active');
  }

  if (!articleElement) {
    console.warn('loadAttachments: æœªæ‰¾åˆ°æ–‡ç« å…ƒç´ ');
    return;
  }

  const attachmentsSection = articleElement.querySelector('.attachments-section');
  const attachmentsList = articleElement.querySelector('.attachments-list');
  const attachmentsLoading = articleElement.querySelector('.loading-state');
  const emptyAttachments = articleElement.querySelector('.empty-attachments');
  const attachmentsCount = articleElement.querySelector('.attachments-count');

  if (!attachmentsSection || !attachmentsList) return;

  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  if (attachmentsLoading) attachmentsLoading.style.display = 'flex';
  if (emptyAttachments) emptyAttachments.style.display = 'none';

  try {
    // å¦‚æœæœ‰ passage_uuid,ä½¿ç”¨ passage_uuid è·å–é™„ä»¶,å¦åˆ™ä½¿ç”¨æ—¥æœŸ
    let url;
    if (currentPassageUUID) {
      url = `/api/attachments?passage_id=${currentPassageUUID}`;
    } else {
      // è§£ææ—¥æœŸï¼ˆä½¿ç”¨å­—ç¬¦ä¸²åˆ†å‰²é¿å…æ—¶åŒºé—®é¢˜ï¼‰
      const dateParts = articleDate.split('-');
      const year = dateParts[0];
      const month = dateParts[1];
      const day = dateParts[2];
      url = `/api/attachments/by-date?year=${year}&month=${month}&day=${day}`;
    }

    // è°ƒç”¨APIè·å–é™„ä»¶åˆ—è¡¨
    const response = await fetch(url);
    const result = await response.json();

    // æ¸…ç©ºé™„ä»¶åˆ—è¡¨
    attachmentsList.innerHTML = '';

    if (result.success && result.data && result.data.length > 0) {
      // æ˜¾ç¤ºé™„ä»¶åˆ—è¡¨
      attachmentsSection.style.display = 'block';
      if (attachmentsCount) attachmentsCount.textContent = `${result.data.length} ä¸ªé™„ä»¶`;

      result.data.forEach(attachment => {
        const attachmentEl = createAttachmentElement(attachment);
        attachmentsList.appendChild(attachmentEl);
      });
    } else {
          // æ˜¾ç¤ºç©ºçŠ¶æ€
          attachmentsSection.style.display = 'block';
          if (attachmentsCount) attachmentsCount.textContent = '0 ä¸ªé™„ä»¶';
          if (emptyAttachments) {
            emptyAttachments.style.display = 'flex';
            attachmentsList.appendChild(emptyAttachments);
          }
        }
    
      } catch (error) {
        console.error('åŠ è½½é™„ä»¶å¤±è´¥:', error);
        // æ˜¾ç¤ºç©ºçŠ¶æ€
        attachmentsSection.style.display = 'block';
        if (attachmentsCount) attachmentsCount.textContent = '0 ä¸ªé™„ä»¶';
        if (emptyAttachments) {
          emptyAttachments.style.display = 'flex';
          attachmentsList.appendChild(emptyAttachments);
        }
      } finally {
        // éšè—åŠ è½½çŠ¶æ€
        if (attachmentsLoading) attachmentsLoading.style.display = 'none';
      }
    }

// åˆ›å»ºé™„ä»¶å…ƒç´ 
function createAttachmentElement(attachment) {
  const attachmentEl = document.createElement('a');
  attachmentEl.className = 'attachment-item';

  // å…¼å®¹ snake_case å’Œ camelCase å­—æ®µå
  const url = attachment.url || `/api/attachments/${attachment.id}/download`;
  const fileName = attachment.fileName || attachment.file_name;
  const fileSize = attachment.fileSize || attachment.file_size;
  const fileType = attachment.fileType || attachment.file_type;

  attachmentEl.href = url;
  attachmentEl.target = '_blank';
  attachmentEl.rel = 'noopener noreferrer';

  // æ ¹æ®æ–‡ä»¶ç±»å‹è·å–å›¾æ ‡
  const iconType = getFileIconType(fileType);
  const iconClass = getFileIconClass(fileType);

  attachmentEl.innerHTML = `
    <div class="attachment-icon ${iconClass}">
      ${getFileIconSVG(iconType)}
    </div>
    <div class="attachment-info">
      <div class="attachment-name" title="${fileName}">${fileName}</div>
      <div class="attachment-meta">
        <span class="attachment-size">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          ${formatFileSize(fileSize)}
        </span>
        <span class="attachment-type">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          ${fileType || 'æ–‡ä»¶'}
        </span>
      </div>
    </div>
    <div class="attachment-download">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    </div>
  `;

  return attachmentEl;
}

// è·å–æ–‡ä»¶å›¾æ ‡ç±»å‹
function getFileIconType(fileType) {
  const typeMap = {
    'image': 'image',
    'video': 'video',
    'document': 'document',
    'audio': 'audio',
    'archive': 'archive'
  };
  return typeMap[fileType] || 'default';
}

// è·å–æ–‡ä»¶å›¾æ ‡CSSç±»
function getFileIconClass(fileType) {
  const classMap = {
    'image': 'image',
    'video': 'video',
    'document': 'document',
    'audio': 'audio',
    'archive': 'archive'
  };
  return classMap[fileType] || 'default';
}

// è·å–æ–‡ä»¶å›¾æ ‡SVG
function getFileIconSVG(iconType) {
  const icons = {
    image: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
      <circle cx="8.5" cy="8.5" r="1.5"></circle>
      <polyline points="21 15 16 10 5 21"></polyline>
    </svg>`,
    video: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polygon points="23 7 16 12 23 17 23 7"></polygon>
      <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
    </svg>`,
    document: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
      <polyline points="14 2 14 8 20 8"></polyline>
      <line x1="16" y1="13" x2="8" y2="13"></line>
      <line x1="16" y1="17" x2="8" y2="17"></line>
      <polyline points="10 9 9 9 8 9"></polyline>
    </svg>`,
    audio: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M9 18V5l12-2v13"></path>
      <circle cx="6" cy="18" r="3"></circle>
      <circle cx="18" cy="16" r="3"></circle>
    </svg>`,
    archive: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
      <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
      <line x1="12" y1="22.08" x2="12" y2="12"></line>
    </svg>`,
    default: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
      <polyline points="13 2 13 9 20 9"></polyline>
    </svg>`
  };
  return icons[iconType] || icons.default;
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// æ¸²æŸ“æ–‡ä»¶æ ‘
function renderFileTree() {
  fileTree.innerHTML = '';
  articlesData.folders.forEach((folder, index) => {
    const folderEl = createFolderElement(folder);
    fileTree.appendChild(folderEl);
  });
}

// é€’å½’åˆ›å»ºæ–‡ä»¶å¤¹å…ƒç´ 
function createFolderElement(folder) {
  const folderEl = document.createElement('div');
  folderEl.className = `folder ${folder.open ? 'open' : ''}`;
  folderEl.dataset.folderId = folder.id;

  

  // è®¡ç®—æ–‡ä»¶æ€»æ•°ï¼ˆåŒ…æ‹¬å­æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶ï¼‰

  const totalFiles = countFilesInFolder(folder);

  

  // åˆ›å»ºæ–‡ä»¶å¤¹å¤´éƒ¨

  const folderHeader = document.createElement('div');

  folderHeader.className = 'folder-header';

  folderHeader.innerHTML = `

    <span class="folder-icon">

      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">

        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>

      </svg>

    </span>

    <span class="folder-name">${folder.name}</span>

    <span class="file-count">${totalFiles}</span>

  `;

  folderEl.appendChild(folderHeader);

  

  // åˆ›å»ºæ–‡ä»¶å¤¹å†…å®¹å®¹å™¨

  const folderContent = document.createElement('div');

  folderContent.className = 'folder-content';

  

  // é€’å½’æ·»åŠ å­æ–‡ä»¶å¤¹

  if (folder.subfolders) {

    folder.subfolders.forEach(subfolder => {

      const subfolderEl = createFolderElement(subfolder);

      folderContent.appendChild(subfolderEl);

    });

  }

  

  // æ·»åŠ æ–‡ä»¶
  if (folder.files) {
    folder.files.forEach((file, fileIndex) => {
      const fileItem = document.createElement('div');
      fileItem.className = 'file-item' + (file.status !== 'published' ? ' file-unpublished' : '');
      fileItem.dataset.fileId = file.id;
      fileItem.dataset.status = file.status;
      fileItem.dataset.scheduled = file.isScheduled;
      fileItem.dataset.publishedAt = file.publishedAt || '';

  

        

  

        // åˆ›å»ºæ–‡ä»¶å›¾æ ‡

  

        const fileIcon = document.createElement('span');

  

        fileIcon.className = 'file-icon';

  

        if (file.status !== 'published') {

  

          fileIcon.innerHTML = `

  

            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">

  

              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>

  

              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>

  

            </svg>

  

          `;

  

        } else {

  

          fileIcon.innerHTML = `

  

            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">

  

              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>

  

              <polyline points="13 2 13 9 20 9"></polyline>

  

            </svg>

  

          `;

  

        }

  

        fileItem.appendChild(fileIcon);

  

        

  

        // åˆ›å»ºæ–‡ä»¶å

  

        const fileName = document.createElement('span');

  

        fileName.className = 'file-name';

  

        fileName.textContent = file.title;

  

        fileItem.appendChild(fileName);

  

        

  

        // åˆ›å»ºæ–‡ä»¶æ—¥æœŸ

  

        

  

                const fileDate = document.createElement('span');

  

        

  

                fileDate.className = 'file-date';

  

        

  

                // åªæ˜¾ç¤ºæ—¥æœŸéƒ¨åˆ†ï¼ˆå¹´-æœˆ-æ—¥ï¼‰ï¼Œä¸æ˜¾ç¤ºæ—¶é—´

  

        

  

                const dateOnly = file.date ? file.date.split(' ')[0] : '';

  

        

  

                fileDate.textContent = dateOnly;

  

        fileItem.appendChild(fileDate);

  

        

  

        // æ·»åŠ çŠ¶æ€æ ‡ç­¾ï¼ˆå¦‚æœéœ€è¦ï¼‰

  if (file.status !== 'published') {

    const fileStatus = document.createElement('span');

    fileStatus.className = 'file-status';

    if (file.status === 'draft') {

      fileStatus.textContent = 'è‰ç¨¿';

    } else if (file.status === 'pending') {

      fileStatus.textContent = 'å¾…å®¡æ ¸';

    } else {

      fileStatus.textContent = 'å®šæ—¶å‘å¸ƒ';

    }

    fileItem.appendChild(fileStatus);

  }

  // æ·»åŠ æ–‡ä»¶é¡¹ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼ˆåªåœ¨åˆ›å»ºæ—¶æ·»åŠ ä¸€æ¬¡ï¼‰
  fileItem.addEventListener('click', () => {
    openArticle(file.id);
  });

  // åŒå‡»åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
  fileItem.addEventListener('dblclick', () => {
    openArticleInNewTab(file.id);
  });

  // å³é”®èœå•ï¼ˆå¯é€‰ï¼‰
  fileItem.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    // å¯ä»¥æ·»åŠ å³é”®èœå•åŠŸèƒ½
  });

  folderContent.appendChild(fileItem);

  

      });

  

    }

  

  folderEl.appendChild(folderContent);

  

  // æ–‡ä»¶å¤¹ç‚¹å‡»äº‹ä»¶

  folderHeader.addEventListener('click', () => {

    folder.open = !folder.open;

    folderEl.classList.toggle('open');

  });

  

  // é€’å½’ç»‘å®šå­æ–‡ä»¶å¤¹çš„äº‹ä»¶

  if (folder.subfolders) {

    folderEl.querySelectorAll('.folder').forEach(subfolderEl => {

      const subfolderId = subfolderEl.dataset.folderId;

      const subfolder = findFolderById(folder, subfolderId);

      if (subfolder) {

        const subfolderHeader = subfolderEl.querySelector('.folder-header');

        subfolderHeader.addEventListener('click', () => {

          subfolder.open = !subfolder.open;

          subfolderEl.classList.toggle('open');

        });

      }

    });

  }

  


  return folderEl;
}

// é€’å½’è®¡ç®—æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶æ€»æ•°
function countFilesInFolder(folder) {
  let count = folder.files ? folder.files.length : 0;
  if (folder.subfolders) {
    folder.subfolders.forEach(subfolder => {
      count += countFilesInFolder(subfolder);
    });
  }
  return count;
}

// é€’å½’æŸ¥æ‰¾æ–‡ä»¶å¤¹
function findFolderById(folder, id) {
  if (folder.id === id) {
    return folder;
  }
  if (folder.subfolders) {
    for (const subfolder of folder.subfolders) {
      const found = findFolderById(subfolder, id);
      if (found) return found;
    }
  }
  return null;
}

// æ‰“å¼€æ–‡ç« 
async function openArticle(articleId) {
  // æŸ¥æ‰¾æ–‡ç« æ•°æ®
  const articleData = findArticleById(articleId);

  if (!articleData) return;

  // æ›´æ–°æ´»åŠ¨æ–‡ç« 
  appState.activeArticleId = articleId;

  // å¦‚æœæ–‡ç« ä¸åœ¨å·²æ‰“å¼€æ ‡ç­¾ä¸­ï¼Œåˆ™æ·»åŠ 
  if (!appState.openTabs.includes(articleId)) {
    appState.openTabs.push(articleId);
  }

  // æ›´æ–°é¡µé¢æ ‡é¢˜
  updatePageTitle(articleData);

  // æ›´æ–°UI
  updateUI();

  // æ£€æŸ¥æ–‡ç« æ˜¯å¦å·²ç»æ¸²æŸ“
  const articleEl = document.getElementById(`article-${articleId}`);

  if (!articleEl) {
    // å¦‚æœæ–‡ç« æœªæ¸²æŸ“ï¼Œåˆ™åŠ è½½å†…å®¹å¹¶æ¸²æŸ“
    if (!articleData.content) {
      await loadArticleContent(articleId);
    } else {
      // æ¸²æŸ“æ–‡ç« å†…å®¹
      renderArticle(articleData);
    }
  } else {
    // å¦‚æœæ–‡ç« å·²æ¸²æŸ“ï¼Œåªéœ€æ˜¾ç¤ºè¯¥æ–‡ç« å¹¶éšè—å…¶ä»–æ–‡ç« 
    document.querySelectorAll('.article').forEach(el => {
      if (el.id !== 'articleTemplate') {
        el.classList.remove('active');
        el.style.display = 'none';
      }
    });
    articleEl.classList.add('active');
    articleEl.style.display = 'block';
  }

  // éšè—ç©ºçŠ¶æ€
  emptyState.style.display = 'none';

  // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šè‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
  if (window.innerWidth < 992) {
    appState.sidebarOpen = false;
    sidebar.classList.add('hidden');
  }
}

// åŠ è½½æ–‡ç« å®Œæ•´å†…å®¹ï¼ˆå¸¦ç¼“å­˜ï¼‰
async function loadArticleContent(articleId) {
  try {
    // æ£€æŸ¥ç¼“å­˜
    if (articleContentCache.has(articleId)) {
      const cached = articleContentCache.get(articleId);
      
      // æ›´æ–°æ–‡ç« æ•°æ®
      const articleData = findArticleById(articleId);
      if (articleData) {
        articleData.content = cached.content;
        renderArticle(articleData);
      }
      return;
    }
    
    // æå–æ–‡ç«  ID
    const numericId = articleId.replace('article-', '');

    // ä» API è·å–æ–‡ç« è¯¦æƒ…
    const response = await fetch(`/api/passages/${numericId}`);
    const result = await response.json();
    
    if (result.success && result.data) {
      // ä¿å­˜æ–‡ç« UUIDç”¨äºè¯„è®ºåŠŸèƒ½
      currentPassageUUID = result.data.uuid;
      currentPassageID = result.data.id;

      // ç¼“å­˜æ–‡ç« å†…å®¹ - ä½¿ç”¨ html_contentï¼ˆå·²æ¸²æŸ“çš„HTMLï¼‰è€Œä¸æ˜¯ contentï¼ˆåŸå§‹Markdownï¼‰
      const renderedContent = result.data.html_content || result.data.content;
      articleContentCache.set(articleId, {
        content: renderedContent,
        timestamp: Date.now()
      });

      // æ›´æ–°æ–‡ç« æ•°æ®ï¼Œä¿å­˜UUIDå’Œå…¶ä»–ä¿¡æ¯
      const articleData = findArticleById(articleId);
      if (articleData) {
        articleData.content = renderedContent;
        articleData.uuid = result.data.uuid;
        articleData.status = result.data.status;
        renderArticle(articleData);
      }
    } else {
      console.error('åŠ è½½æ–‡ç« å†…å®¹å¤±è´¥:', result.message);
      renderLoadingError();
    }
  } catch (error) {
    console.error('åŠ è½½æ–‡ç« å†…å®¹å¤±è´¥:', error);
    renderLoadingError();
  }
}

// æ¸…ç†è¿‡æœŸç¼“å­˜ï¼ˆå¯é€‰ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
function clearExpiredCache(maxAge = 30 * 60 * 1000) { // é»˜è®¤ 30 åˆ†é’Ÿ
  const now = Date.now();
  for (const [articleId, cached] of articleContentCache.entries()) {
    if (now - cached.timestamp > maxAge) {
      articleContentCache.delete(articleId);
    }
  }
}

// æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
function clearAllCache() {
  articleContentCache.clear();
}

// è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
function getCacheStats() {
  return {
    size: articleContentCache.size,
    keys: Array.from(articleContentCache.keys())
  };
}

// æ‰“å°ç¼“å­˜çŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•ï¼‰
function logCacheStats() {
  const stats = getCacheStats();
}

// æ¸²æŸ“åŠ è½½é”™è¯¯
function renderLoadingError() {
  const articleContent = document.getElementById('articleContent');
  if (articleContent) {
    articleContent.innerHTML = '<div class="error">åŠ è½½æ–‡ç« å†…å®¹å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
  }
}

// é€’å½’æŸ¥æ‰¾æ–‡ç« 
function findArticleById(articleId) {
  for (const folder of articlesData.folders) {
    const article = findArticleInFolder(folder, articleId);
    if (article) return article;
  }
  return null;
}

// åœ¨æ–‡ä»¶å¤¹ä¸­é€’å½’æŸ¥æ‰¾æ–‡ç« 
function findArticleInFolder(folder, articleId) {
  // åœ¨å½“å‰æ–‡ä»¶å¤¹çš„æ–‡ä»¶ä¸­æŸ¥æ‰¾
  if (folder.files) {
    const file = folder.files.find(f => f.id === articleId);
    if (file) return file;
  }
  
  // åœ¨å­æ–‡ä»¶å¤¹ä¸­é€’å½’æŸ¥æ‰¾
  if (folder.subfolders) {
    for (const subfolder of folder.subfolders) {
      const article = findArticleInFolder(subfolder, articleId);
      if (article) return article;
    }
  }
  
  return null;
}

// åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€æ–‡ç« 
async function openArticleInNewTab(articleId) {
  // æŸ¥æ‰¾æ–‡ç« æ•°æ®
  const articleData = findArticleById(articleId);
  
  if (!articleData) return;
  
  // å¦‚æœæ–‡ç« å·²ç»åœ¨æ ‡ç­¾ä¸­ï¼Œåˆ™æ¿€æ´»å®ƒ
  if (appState.openTabs.includes(articleId)) {
    appState.activeArticleId = articleId;
    updateUI();
    return;
  }
  
  // æ·»åŠ åˆ°å·²æ‰“å¼€æ ‡ç­¾
  appState.openTabs.push(articleId);
  appState.activeArticleId = articleId;
  
  // æ›´æ–°UI
  updateUI();
  
  // å¦‚æœæ–‡ç« å†…å®¹ä¸ºç©ºï¼Œåˆ™åŠ è½½å®Œæ•´å†…å®¹
  if (!articleData.content) {
    await loadArticleContent(articleId);
  } else {
    renderArticle(articleData);
  }
}

// æ¸²æŸ“æ–‡ç« å†…å®¹
function renderArticle(articleData) {
  // éšè—æœåŠ¡å™¨ç«¯æ¸²æŸ“çš„å†…å®¹
  const serverRenderedContent = document.getElementById('articleContent');
  if (serverRenderedContent) {
    serverRenderedContent.style.display = 'none';
  }

  // éšè—ç©ºçŠ¶æ€æç¤º
  const emptyState = document.getElementById('emptyState');
  if (emptyState) {
    emptyState.style.display = 'none';
  }

  // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çš„æ–‡ç« 
  document.querySelectorAll('.article').forEach(el => {
    if (el.id !== 'articleTemplate') {
      el.remove();
    }
  });

  // å…‹éš†æ–‡ç« æ¨¡æ¿
  const articleTemplate = document.getElementById('articleTemplate');
  const articleEl = articleTemplate.cloneNode(true);
  articleEl.id = `article-${articleData.id}`;
  articleEl.classList.add('active');
  articleEl.style.display = 'block'; // æ˜¾ç¤ºæ–‡ç« å…ƒç´ 

  // æ£€æŸ¥æ–‡ç« çŠ¶æ€
  const isUnpublished = articleData.status !== 'published';
  const unpublishedNotice = document.getElementById('unpublishedNotice');

  if (isUnpublished) {
    // æ˜¾ç¤ºæœªå‘å¸ƒæç¤º
    unpublishedNotice.style.display = 'block';
    const messageEl = document.getElementById('unpublishedMessage');
    const scheduledMessage = document.getElementById('scheduledMessage');
    const scheduledTime = document.getElementById('scheduledTime');

    if (articleData.status === 'draft') {
      messageEl.textContent = 'æ­¤æ–‡ç« æ­£åœ¨ç¼–è¾‘ä¸­ï¼Œæš‚æ—¶æ— æ³•è®¿é—®ã€‚';
      scheduledMessage.style.display = 'none';
    } else if (articleData.status === 'pending') {
      messageEl.textContent = 'æ­¤æ–‡ç« æ­£åœ¨ç­‰å¾…å®¡æ ¸ï¼Œæš‚æ—¶æ— æ³•è®¿é—®ã€‚';
      scheduledMessage.style.display = 'none';
    } else if (articleData.isScheduled && articleData.publishedAt) {
      messageEl.textContent = 'æ­¤æ–‡ç« å·²å®‰æ’å®šæ—¶å‘å¸ƒï¼Œæš‚æ—¶æ— æ³•è®¿é—®ã€‚';
      scheduledMessage.style.display = 'block';
      scheduledTime.textContent = articleData.publishedAt;
    } else {
      messageEl.textContent = 'æ­¤æ–‡ç« å°šæœªå‘å¸ƒï¼Œæš‚æ—¶æ— æ³•è®¿é—®ã€‚';
      scheduledMessage.style.display = 'none';
    }

    // éšè—ç›®å½•
    tocContainer.classList.remove('active');
    fileTree.style.display = 'block';
    sidebarTitle.textContent = 'æ–‡ç« ç´¢å¼•';
  } else {
    // éšè—æœªå‘å¸ƒæç¤º
    unpublishedNotice.style.display = 'none';
  }

  // å¡«å……æ–‡ç« æ•°æ®
  articleEl.querySelector('.article-title').textContent = articleData.title;
  // ç®€åŒ–æ—¥æœŸæ ¼å¼ï¼šåªæ˜¾ç¤ºæ—¥æœŸéƒ¨åˆ†ï¼ˆYYYY-MM-DDï¼‰
  const dateOnly = articleData.date.split(' ')[0];
  articleEl.querySelector('.article-date').textContent = dateOnly;
  articleEl.querySelector('.article-readtime').textContent = `é¢„è®¡ ${articleData.readtime} åˆ†é’Ÿè¯»å®Œ`;

  // å¡«å……åˆ†ç±»
  const categoryEl = articleEl.querySelector('.article-category');
  if (categoryEl) {
    categoryEl.textContent = articleData.category || 'æœªåˆ†ç±»';
  }

  // å¡«å……æ ‡ç­¾ï¼ˆè¡Œå†…æ˜¾ç¤ºï¼‰
  const tagsInlineEl = articleEl.querySelector('.article-tags-inline');
  if (tagsInlineEl) {
    tagsInlineEl.innerHTML = '';
    const tags = typeof articleData.tags === 'string' ? JSON.parse(articleData.tags) : articleData.tags;
    if (tags && tags.length > 0) {
      tags.forEach(tag => {
        const tagEl = document.createElement('span');
        tagEl.className = 'inline-tag';
        tagEl.textContent = tag;
        tagsInlineEl.appendChild(tagEl);
      });
    } else {
      tagsInlineEl.textContent = 'æ— æ ‡ç­¾';
    }
  }

  // æ ¹æ® show_title å†³å®šæ˜¯å¦æ˜¾ç¤ºæ–‡ç« æ ‡é¢˜
  if (articleData.show_title === false) {
    articleEl.querySelector('.article-title').style.display = 'none';
  } else {
    articleEl.querySelector('.article-title').style.display = 'block';
  }

  // éšè—æ–‡ç« åº•éƒ¨çš„æ ‡ç­¾åŒºåŸŸï¼ˆå·²é€šè¿‡è¡Œå†…æ ‡ç­¾æ˜¾ç¤ºï¼‰
  const tagsContainer = articleEl.querySelector('.article-tags');
  tagsContainer.style.display = 'none';
  
  // æ¸²æŸ“å†…å®¹ï¼Œç§»é™¤ç¬¬ä¸€ä¸ª H1 æ ‡ç­¾ï¼ˆé¿å…æ ‡é¢˜é‡å¤æ˜¾ç¤ºï¼‰
  let content = articleData.content;
  // ç§»é™¤å¼€å¤´çš„ H1 æ ‡ç­¾
  content = content.replace(/^\s*<h1[^>]*>.*?<\/h1>\s*/i, '');
  articleEl.querySelector('.article-content').innerHTML = content;

  // æ·»åŠ åˆ°å®¹å™¨
  articleContainer.appendChild(articleEl);

  // æ¸²æŸ“æ•°å­¦å…¬å¼å’Œæµç¨‹å›¾
  const articleContent = articleEl.querySelector('.article-content');
  renderMathAndDiagrams(articleContent);

  // åŠ è½½é™„ä»¶åˆ—è¡¨
  loadAttachments(articleData.date, articleEl);

  // æ˜¾ç¤ºèµåŠ©åŒºåŸŸï¼ˆå¦‚æœå¯ç”¨ï¼‰
  const sponsorSection = articleEl.querySelector('.sponsor-section-template');
  if (sponsorSection) {
    if (window.sponsorEnabled) {
      sponsorSection.style.display = 'block';
      // æ›´æ–°èµåŠ©æŒ‰é’®æ–‡å­—
      const sponsorBtn = sponsorSection.querySelector('#sponsorBtn');
      if (sponsorBtn && window.sponsorButtonText) {
        sponsorBtn.textContent = window.sponsorButtonText;
        
        // ä¸ºåŠ¨æ€ç”Ÿæˆçš„èµåŠ©æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
        const sponsorModal = document.getElementById('sponsorModal');
        if (sponsorModal) {
          sponsorBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            sponsorModal.classList.add('active');
          });
        }
      }
    } else {
      sponsorSection.style.display = 'none';
    }
  }

  // åˆå§‹åŒ–å¹¶åŠ è½½æ–‡ç« è¯„è®ºç³»ç»Ÿ
  initArticleComments(articleEl, articleData.id, articleData);

  // å¦‚æœå½“å‰æ˜¯ç›®å½•æ¨¡å¼ï¼Œé‡æ–°ç”Ÿæˆç›®å½•
  if (appState.readingMode === 'toc') {
    generateTableOfContents();
  }
}

// åˆå§‹åŒ–æ–‡ç« è¯„è®ºç³»ç»Ÿ
function initArticleComments(articleEl, articleId, articleData) {
  const commentsSection = articleEl.querySelector('.article-comments');
  if (!commentsSection) {
    console.warn('æœªæ‰¾åˆ°è¯„è®ºåŒºåŸŸ .article-comments');
    return;
  }

  // ä» articleId ä¸­æå–çº¯æ•°å­— IDï¼ˆarticleId å¯èƒ½æ˜¯ "article-3" æ ¼å¼ï¼‰
  const numericArticleId = typeof articleId === 'string' ? parseInt(articleId.replace('article-', ''), 10) : articleId;
  // è®¾ç½®æ–‡ç« IDï¼ˆä½¿ç”¨çº¯æ•°å­—IDç”¨äºAPIè°ƒç”¨ï¼‰
  commentsSection.dataset.articleId = numericArticleId;

  // ç¡®ä¿è¯„è®ºåŒºåŸŸå¯è§
  commentsSection.style.display = 'block';

  // éšè—è¯„è®ºç³»ç»Ÿï¼ˆå¦‚æœæ–‡ç« æœªå‘å¸ƒï¼‰
  if (articleData && articleData.status !== 'published') {
    commentsSection.style.display = 'none';
    return;
  }

  // è·å–è¯„è®ºå…ƒç´ 
  const usernameInput = commentsSection.querySelector('.comment-username-input');
  const contentTextarea = commentsSection.querySelector('.comment-textarea');
  const submitBtn = commentsSection.querySelector('.submit-comment-btn');
  const commentsList = commentsSection.querySelector('.comments-list');
  const loadingState = commentsSection.querySelector('.loading-state');
  const emptyState = commentsSection.querySelector('.empty-comments');
  const commentsCount = commentsSection.querySelector('.comments-count');

  // è·å–æ–‡ç« UUIDï¼ˆä¼˜å…ˆä»articleDataè·å–ï¼Œå¦åˆ™ä½¿ç”¨numericArticleIdï¼‰
  const articleUUID = articleData && articleData.uuid ? articleData.uuid : numericArticleId.toString();

  // åŠ è½½è¯„è®ºï¼ˆä½¿ç”¨UUIDï¼‰
    loadArticleComments(articleUUID, commentsList, loadingState, emptyState, commentsCount);
  
    // ç»‘å®šæäº¤æŒ‰é’®äº‹ä»¶ï¼ˆå…ˆç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ä»¥é¿å…é‡å¤ç»‘å®šï¼‰
    if (submitBtn) {
      // å…‹éš†èŠ‚ç‚¹ä»¥ç§»é™¤æ‰€æœ‰æ—§çš„äº‹ä»¶ç›‘å¬å™¨
      const newSubmitBtn = submitBtn.cloneNode(true);
      submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);
  
      // ä¸ºæ–°æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ - é‡æ–°è·å–å…ƒç´ å¼•ç”¨
      newSubmitBtn.addEventListener('click', function() {
        // é‡æ–°è·å–å½“å‰è¯„è®ºåŒºåŸŸçš„è¾“å…¥æ¡†
        const currentUsernameInput = commentsSection.querySelector('.comment-username-input');
        const currentContentTextarea = commentsSection.querySelector('.comment-textarea');
        submitArticleComment(articleUUID, currentUsernameInput, currentContentTextarea, commentsList, commentsCount);
      });
    }
  
    // ç»‘å®š Ctrl+Enter æäº¤ï¼ˆå…ˆç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ä»¥é¿å…é‡å¤ç»‘å®šï¼‰
      if (contentTextarea) {
        // å…‹éš†èŠ‚ç‚¹ä»¥ç§»é™¤æ‰€æœ‰æ—§çš„äº‹ä»¶ç›‘å¬å™¨
        const newTextarea = contentTextarea.cloneNode(true);
        contentTextarea.parentNode.replaceChild(newTextarea, contentTextarea);
    
        // ä¸ºæ–° textarea æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ - é‡æ–°è·å–å…ƒç´ å¼•ç”¨
        newTextarea.addEventListener('keydown', function(e) {
          if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            // é‡æ–°è·å–å½“å‰è¯„è®ºåŒºåŸŸçš„è¾“å…¥æ¡†
            const currentUsernameInput = commentsSection.querySelector('.comment-username-input');
            const currentContentTextarea = commentsSection.querySelector('.comment-textarea');
            submitArticleComment(articleUUID, currentUsernameInput, currentContentTextarea, commentsList, commentsCount);
          }
        });
      }
    }
// åŠ è½½æ–‡ç« è¯„è®º
async function loadArticleComments(articleId, commentsList, loadingState, emptyState, commentsCount) {
  // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡è¯¥æ–‡ç« çš„è¯„è®º
  if (commentsLoadedCache.has(articleId)) {
    return;
  }

  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  if (loadingState) loadingState.style.display = 'flex';
  if (commentsList) commentsList.style.display = 'none';
  if (emptyState) emptyState.style.display = 'none';

  try {
    const response = await fetch(`/api/comments?passage_uuid=${articleId}`);
    const result = await response.json();

    if (result.success && result.data) {
      // æ ‡è®°è¯„è®ºå·²åŠ è½½
      commentsLoadedCache.add(articleId);

      // æ›´æ–°è¯„è®ºæ•°é‡
      if (commentsCount) {
        commentsCount.textContent = `${result.data.length} æ¡è¯„è®º`;
      }

      // éšè—åŠ è½½çŠ¶æ€
      if (loadingState) loadingState.style.display = 'none';

      if (result.data.length > 0) {
        // æ˜¾ç¤ºè¯„è®ºåˆ—è¡¨
        if (commentsList) {
          commentsList.style.display = 'flex';
          renderArticleComments(result.data, commentsList);
        }
      } else {
        // æ˜¾ç¤ºç©ºçŠ¶æ€
        if (emptyState) emptyState.style.display = 'flex';
      }
    } else {
      console.error('åŠ è½½è¯„è®ºå¤±è´¥:', result);
      if (loadingState) loadingState.style.display = 'none';
      if (emptyState) emptyState.style.display = 'flex';
    }
  } catch (error) {
    console.error('åŠ è½½è¯„è®ºæ—¶å‡ºé”™:', error);
    if (loadingState) loadingState.style.display = 'none';
    if (emptyState) emptyState.style.display = 'flex';
  }
}

// æ¸²æŸ“æ–‡ç« è¯„è®ºåˆ—è¡¨
function renderArticleComments(comments, commentsList) {
  commentsList.innerHTML = '';

  comments.forEach(comment => {
    const commentEl = document.createElement('div');
    commentEl.className = 'comment-item';

    // ç”ŸæˆåŸºäºç”¨æˆ·åçš„ identicon å¤´åƒ
    const avatarUrl = generateIdenticon(comment.username || 'anonymous', 40);

    commentEl.innerHTML = `
      <div class="comment-header">
        <div class="comment-user">
          <div class="comment-avatar">
            <img src="${avatarUrl}" alt="${comment.username || 'åŒ¿åç”¨æˆ·'}" style="width: 100%; height: 100%; border-radius: 50%;"/>
          </div>
          <span class="comment-username">${comment.username || 'åŒ¿åç”¨æˆ·'}</span>
        </div>
        <span class="comment-date">${formatDate(comment.created_at)}</span>
      </div>
      <div class="comment-content">${comment.content}</div>
    `;

    commentsList.appendChild(commentEl);
  });
}

// æäº¤æ–‡ç« è¯„è®º
async function submitArticleComment(articleId, usernameInput, contentTextarea, commentsList, commentsCount) {
  const username = usernameInput.value.trim();
  const content = contentTextarea.value.trim();

  if (!username || !content) {
    showToast('è¯·å¡«å†™ç”¨æˆ·åå’Œè¯„è®ºå†…å®¹', 'warning');
    return;
  }

  try {
    const response = await fetch('/api/comments', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        passage_uuid: articleId,
        username: username,
        content: content
      })
    });

    const result = await response.json();

    if (result.success) {
      showToast('è¯„è®ºå‘è¡¨æˆåŠŸï¼', 'success');
      // æ¸…ç©ºè¾“å…¥æ¡†
      usernameInput.value = '';
      contentTextarea.value = '';
      // æ¸…é™¤è¯„è®ºç¼“å­˜ï¼Œä»¥ä¾¿é‡æ–°åŠ è½½è¯„è®º
      commentsLoadedCache.delete(articleId);
      // é‡æ–°åŠ è½½è¯„è®º
      const commentsSection = usernameInput.closest('.article-comments');
      loadArticleComments(
        articleId,
        commentsSection.querySelector('.comments-list'),
        commentsSection.querySelector('.loading-state'),
        commentsSection.querySelector('.empty-comments'),
        commentsSection.querySelector('.comments-count')
      );
    } else {
      showToast('è¯„è®ºå‘è¡¨å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
    }
  } catch (error) {
    console.error('æäº¤è¯„è®ºæ—¶å‡ºé”™:', error);
    showToast('è¯„è®ºå‘è¡¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
  }
}

// æ›´æ–°UIçŠ¶æ€
function updateUI() {
  // æ›´æ–°æ–‡ä»¶æ ‘ä¸­çš„æ´»åŠ¨æ–‡ä»¶
  document.querySelectorAll('.file-item').forEach(item => {
    item.classList.remove('active');
    if (item.dataset.fileId === appState.activeArticleId) {
      item.classList.add('active');
    }
  });
  
  // æ›´æ–°æ ‡ç­¾æ 
  updateTabBar();
  
  // æ›´æ–°ä¾§è¾¹æ å®½åº¦
  sidebar.style.width = `${appState.sidebarWidth}px`;
}

// æ›´æ–°æ ‡ç­¾æ 
function updateTabBar() {
  tabBar.innerHTML = '';
  
  appState.openTabs.forEach(articleId => {
    // æŸ¥æ‰¾æ–‡ç« æ•°æ®
    const articleData = findArticleById(articleId);
    
    if (!articleData) return;
    
    const tabEl = document.createElement('div');
    tabEl.className = `tab ${articleId === appState.activeArticleId ? 'active' : ''}`;
    tabEl.dataset.articleId = articleId;
    
    tabEl.innerHTML = `
      <span class="tab-title">${articleData.title}</span>
      <span class="tab-close">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </span>
    `;
    
    // æ ‡ç­¾ç‚¹å‡»äº‹ä»¶
    tabEl.addEventListener('click', (e) => {
      // å¦‚æœç‚¹å‡»çš„æ˜¯å…³é—­æŒ‰é’®ï¼Œåˆ™å…³é—­æ ‡ç­¾
      if (e.target.closest('.tab-close')) {
        closeTab(articleId);
        e.stopPropagation();
      } else if (articleId !== appState.activeArticleId) {
        // å¦åˆ™åˆ‡æ¢åˆ°è¯¥æ ‡ç­¾ï¼ˆä»…å½“ä¸æ˜¯å½“å‰æ´»åŠ¨æ ‡ç­¾æ—¶ï¼‰
        switchToTab(articleId);
      }
    });
    
    tabBar.appendChild(tabEl);
  });
}

// åˆ‡æ¢åˆ°æ ‡ç­¾
function switchToTab(articleId) {
  appState.activeArticleId = articleId;

  // æŸ¥æ‰¾æ–‡ç« æ•°æ®
  const articleData = findArticleById(articleId);

  if (!articleData) return;

  // æ›´æ–°é¡µé¢æ ‡é¢˜
  updatePageTitle(articleData);

  // æ£€æŸ¥æ–‡ç« æ˜¯å¦å·²ç»æ¸²æŸ“ï¼ˆDOM ä¸­æ˜¯å¦å­˜åœ¨è¯¥æ–‡ç« å…ƒç´ ï¼‰
  const articleEl = document.getElementById(`article-${articleId}`);

  if (!articleEl) {
    // å¦‚æœæ–‡ç« è¿˜æœªæ¸²æŸ“ï¼Œåˆ™æ¸²æŸ“æ–‡ç« å†…å®¹
    renderArticle(articleData);
  } else {
    // å¦‚æœæ–‡ç« å·²æ¸²æŸ“ï¼Œåªéœ€æ˜¾ç¤ºè¯¥æ–‡ç« å¹¶éšè—å…¶ä»–æ–‡ç« 
    document.querySelectorAll('.article').forEach(el => {
      if (el.id !== 'articleTemplate') {
        el.classList.remove('active');
        el.style.display = 'none';
      }
    });
    articleEl.classList.add('active');
    articleEl.style.display = 'block';
  }

  // æ›´æ–°UI
  updateUI();
}

// å…³é—­æ ‡ç­¾
function closeTab(articleId) {
  const index = appState.openTabs.indexOf(articleId);
  if (index > -1) {
    appState.openTabs.splice(index, 1);
  }
  
  // å¦‚æœå…³é—­çš„æ˜¯å½“å‰æ´»åŠ¨æ–‡ç« 
  if (appState.activeArticleId === articleId) {
    // å¦‚æœæœ‰å…¶ä»–æ‰“å¼€çš„æ ‡ç­¾ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ª
    if (appState.openTabs.length > 0) {
      appState.activeArticleId = appState.openTabs[0];
      switchToTab(appState.activeArticleId);
    } else {
      // å¦åˆ™æ˜¾ç¤ºç©ºçŠ¶æ€
      appState.activeArticleId = null;
      document.querySelectorAll('.article').forEach(el => {
        if (el.id !== 'articleTemplate') {
          el.remove();
        }
      });
      emptyState.style.display = 'flex';

      // æ›´æ–°é¡µé¢æ ‡é¢˜ä¸ºé»˜è®¤å€¼
      updatePageTitle(null);
    }
  }
  
  // æ›´æ–°UI
  updateUI();
}

// åˆ‡æ¢é˜…è¯»æ¨¡å¼
function toggleReadingMode() {
  appState.readingMode = appState.readingMode === 'timestamp' ? 'toc' : 'timestamp';
  updateReadingModeUI();
}

// æ›´æ–°é˜…è¯»æ¨¡å¼UI
function updateReadingModeUI() {
  const isTimestamp = appState.readingMode === 'timestamp';

  // æ›´æ–°æŒ‰é’®æ–‡æœ¬
  readingModeText.textContent = isTimestamp ? 'æ—¶é—´æˆ³' : 'æœ¬æ–‡ç´¢å¼•';

  // æ›´æ–°ä¾§è¾¹æ æ ‡é¢˜
  sidebarTitle.textContent = isTimestamp ? 'æ–‡ç« ç´¢å¼•' : 'æœ¬æ–‡ç›®å½•';

  // æ£€æŸ¥å½“å‰æ–‡ç« æ˜¯å¦æœªå‘å¸ƒ
  const currentArticleData = appState.activeArticleId ? findArticleById(appState.activeArticleId) : null;
  const isUnpublished = currentArticleData && currentArticleData.status !== 'published';

  // åˆ‡æ¢æ–‡ä»¶æ ‘å’Œç›®å½•çš„æ˜¾ç¤º
  if (isTimestamp) {
    fileTree.style.display = 'block';
    tocContainer.classList.remove('active');
    fileTreeControls.style.display = 'flex';
  } else {
    // å¦‚æœæ˜¯æœªå‘å¸ƒæ–‡ç« ,æ˜¾ç¤ºæç¤ºè€Œä¸æ˜¯ç›®å½•
    if (isUnpublished) {
      tocContainer.innerHTML = `
        <div class="toc-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
          <p>æ­¤æ–‡ç« å°šæœªå‘å¸ƒ,æš‚æ— ç›®å½•</p>
        </div>
      `;
    } else {
      // ç”Ÿæˆç›®å½•
      generateTableOfContents();
    }
    fileTree.style.display = 'none';
    tocContainer.classList.add('active');
    fileTreeControls.style.display = 'none';
  }
}

// ç”Ÿæˆç›®å½•
function generateTableOfContents() {
  // è·å–å½“å‰æ´»åŠ¨æ–‡ç« çš„å†…å®¹åŒºåŸŸ
  const activeArticle = document.querySelector('.article.active .article-content');
  
  if (!activeArticle) {
    tocContainer.innerHTML = `
      <div class="toc-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        <p>è¯·å…ˆé€‰æ‹©ä¸€ç¯‡æ–‡ç« </p>
      </div>
    `;
    return;
  }
  
  // æå–æ‰€æœ‰h1-h6æ ‡é¢˜
  const headings = activeArticle.querySelectorAll('h1, h2, h3, h4, h5, h6');
  
  if (headings.length === 0) {
    tocContainer.innerHTML = `
      <div class="toc-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <p>æœ¬æ–‡æš‚æ— ç›®å½•</p>
      </div>
    `;
    return;
  }
  
  // ä¸ºæ ‡é¢˜æ·»åŠ IDï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
  headings.forEach((heading, index) => {
    if (!heading.id) {
      heading.id = `heading-${index}`;
    }
  });
  
  // ç”Ÿæˆç›®å½•HTML
  let tocHTML = '<ul class="toc-list">';
  headings.forEach((heading, index) => {
    const level = parseInt(heading.tagName.substring(1));
    const text = heading.textContent.trim();
    const id = heading.id;
    
    tocHTML += `
      <li class="toc-item">
        <a href="#${id}" class="toc-link toc-level-${level}" data-target="${id}">
          ${text}
        </a>
      </li>
    `;
  });
  tocHTML += '</ul>';
  
  tocContainer.innerHTML = tocHTML;
  
  // ç»‘å®šç›®å½•ç‚¹å‡»äº‹ä»¶
  tocContainer.querySelectorAll('.toc-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const targetId = link.getAttribute('data-target');
      const targetElement = document.getElementById(targetId);
      
      if (targetElement) {
        // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®
        targetElement.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
        
        // æ›´æ–°æ¿€æ´»çŠ¶æ€
        tocContainer.querySelectorAll('.toc-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
      }
    });
  });
  
  // ç›‘å¬æ»šåŠ¨ï¼Œæ›´æ–°ç›®å½•æ¿€æ´»çŠ¶æ€
  setupScrollSpy();
}

// è®¾ç½®æ»šåŠ¨ç›‘å¬ï¼Œæ›´æ–°ç›®å½•æ¿€æ´»çŠ¶æ€
function setupScrollSpy() {
  // ç§»é™¤æ—§çš„ç›‘å¬å™¨
  if (window.scrollSpyHandler) {
    window.removeEventListener('scroll', window.scrollSpyHandler);
  }
  
  window.scrollSpyHandler = () => {
    if (appState.readingMode !== 'toc') return;
    
    const headings = document.querySelectorAll('.article.active .article-content h1, .article.active .article-content h2, .article.active .article-content h3, .article.active .article-content h4, .article.active .article-content h5, .article.active .article-content h6');
    const tocLinks = tocContainer.querySelectorAll('.toc-link');
    
    let currentHeading = null;
    
    headings.forEach(heading => {
      const rect = heading.getBoundingClientRect();
      if (rect.top <= 100) {
        currentHeading = heading.id;
      }
    });
    
    if (currentHeading) {
      tocLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('data-target') === currentHeading) {
          link.classList.add('active');
        }
      });
    }
  };
  
  window.addEventListener('scroll', window.scrollSpyHandler);
}

// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
function setupEventListeners() {
  // é˜…è¯»æ¨¡å¼åˆ‡æ¢
  readingModeToggle.addEventListener('click', toggleReadingMode);
  
  // ä¾§è¾¹æ åˆ‡æ¢
  sidebarToggle.addEventListener('click', (event) => {
    event.stopPropagation();
    appState.sidebarOpen = !appState.sidebarOpen;
    sidebar.classList.toggle('hidden');
    // æ ¹æ®çŠ¶æ€è®¾ç½®å®½åº¦
    if (appState.sidebarOpen) {
      sidebar.style.width = `${appState.sidebarWidth}px`;
    } else {
      sidebar.style.width = '0';
    }
  });

  sidebarToggleFixed.addEventListener('click', (event) => {
    event.stopPropagation();
    const nav = document.querySelector('nav');
    const mainContainer = document.querySelector('.main-container');
    
    if (nav.style.display === 'none') {
      nav.style.display = 'flex';
      mainContainer.style.height = 'calc(100vh - var(--header-height))';
    } else {
      nav.style.display = 'none';
      mainContainer.style.height = '100vh';
    }
  });
  
  // å…¨å±åˆ‡æ¢
  fullscreenToggle.addEventListener('click', toggleFullscreen);
  
  // æŠ˜å /å±•å¼€æ‰€æœ‰æ–‡ä»¶å¤¹
  collapseAllBtn.addEventListener('click', () => {
    articlesData.folders.forEach(folder => {
      folder.open = false;
    });
    renderFileTree();
  });
  
  expandAllBtn.addEventListener('click', () => {
    articlesData.folders.forEach(folder => {
      folder.open = true;
    });
    renderFileTree();
  });
  
  // ä¾§è¾¹æ å®½åº¦è°ƒæ•´
  resizer.addEventListener('mousedown', startResize);
  
  // å…¨å±€é¼ æ ‡äº‹ä»¶
  document.addEventListener('mousemove', handleResize);
  document.addEventListener('mouseup', stopResize);
  
  // å…¨å±å˜åŒ–ç›‘å¬
  document.addEventListener('fullscreenchange', handleFullscreenChange);
  document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
  document.addEventListener('mozfullscreenchange', handleFullscreenChange);
  document.addEventListener('MSFullscreenChange', handleFullscreenChange);
  
  // çª—å£å¤§å°å˜åŒ–
  window.addEventListener('resize', handleWindowResize);
}

// å¼€å§‹è°ƒæ•´å¤§å°
function startResize(e) {
  appState.isResizing = true;
  document.body.style.cursor = 'col-resize';
  resizer.classList.add('active');
}

// å¤„ç†è°ƒæ•´å¤§å°
function handleResize(e) {
  if (!appState.isResizing) return;
  
  const newWidth = e.clientX;
  if (newWidth >= 200 && newWidth <= 500) {
    appState.sidebarWidth = newWidth;
    sidebar.style.width = `${newWidth}px`;
  }
}

// åœæ­¢è°ƒæ•´å¤§å°
function stopResize() {
  appState.isResizing = false;
  document.body.style.cursor = '';
  resizer.classList.remove('active');
}

// åˆ‡æ¢å…¨å±
function toggleFullscreen() {
  if (!document.fullscreenElement && !document.webkitFullscreenElement && 
      !document.mozFullScreenElement && !document.msFullscreenElement) {
    // è¿›å…¥å…¨å±
    if (document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen();
    } else if (document.documentElement.webkitRequestFullscreen) {
      document.documentElement.webkitRequestFullscreen();
    } else if (document.documentElement.mozRequestFullScreen) {
      document.documentElement.mozRequestFullScreen();
    } else if (document.documentElement.msRequestFullscreen) {
      document.documentElement.msRequestFullscreen();
    }
    appState.fullscreen = true;
    document.body.classList.add('fullscreen');
  } else {
    // é€€å‡ºå…¨å±
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    } else if (document.mozCancelFullScreen) {
      document.mozCancelFullScreen();
    } else if (document.msExitFullscreen) {
      document.msExitFullscreen();
    }
    appState.fullscreen = false;
    document.body.classList.remove('fullscreen');
  }
}

// å¤„ç†å…¨å±å˜åŒ–
function handleFullscreenChange() {
  const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || 
                         document.mozFullScreenElement || document.msFullscreenElement);
  appState.fullscreen = isFullscreen;
  document.body.classList.toggle('fullscreen', isFullscreen);
}

// å¤„ç†çª—å£å¤§å°å˜åŒ–
function handleWindowResize() {
  // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œå¦‚æœä¾§è¾¹æ æ‰“å¼€ä¸”çª—å£å˜å¤§ï¼Œè‡ªåŠ¨æ‰“å¼€ä¾§è¾¹æ 
  if (window.innerWidth >= 992 && !appState.sidebarOpen) {
    appState.sidebarOpen = true;
    sidebar.classList.remove('hidden');
  }
}

// åˆå§‹åŒ–åº”ç”¨
document.addEventListener('DOMContentLoaded', () => initApp());
</script>

<!-- å…¨å±å›¾ç‰‡æŸ¥çœ‹å™¨ -->
<div class="image-viewer" id="imageViewer">
  <div class="image-viewer-close" id="imageViewerClose">Ã—</div>
  <img id="imageViewerImg" src="" alt="æ”¾å¤§æŸ¥çœ‹">
</div>

<!-- å…¨å±ä»£ç æŸ¥çœ‹å™¨ -->
<div class="code-viewer" id="codeViewer">
  <div class="code-viewer-header">
    <span class="code-viewer-title" id="codeViewerTitle">ä»£ç æŸ¥çœ‹</span>
    <div style="display: flex; gap: 8px;">
      <button class="code-viewer-copy" id="codeViewerCopy" title="å¤åˆ¶ä»£ç ">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
        å¤åˆ¶
      </button>
      <button class="code-viewer-close" id="codeViewerClose">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        å…³é—­
      </button>
    </div>
  </div>
  <div class="code-viewer-content" id="codeViewerContent"></div>
  <div class="code-viewer-toast" id="codeViewerToast">å¤åˆ¶æˆåŠŸï¼</div>
</div>

<!-- ç™»å½•æ¨¡æ€æ¡† -->
<div class="modal" id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center; padding: 20px; animation: fadeIn 0.3s ease;">
  <div class="modal-content" style="background: rgba(0, 0, 0, 0); backdrop-filter: blur(40px) saturate(200%); -webkit-backdrop-filter: blur(40px) saturate(200%); border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 20px; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2); max-width: 500px; width: 100%; animation: slideIn 0.3s ease; position: relative; overflow: hidden;">
    <div class="modal-header" style="background: linear-gradient(90deg, #007bff, #00b894); padding: 20px 30px; color: white; border-radius: 20px 20px 0 0; display: flex; justify-content: space-between; align-items: center;">
      <h3 style="font-size: 1.5em; font-weight: 600;">ç”¨æˆ·ç™»å½•</h3>
      <button class="modal-close" data-modal="loginModal" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s;">Ã—</button>
    </div>
    <div class="modal-body" style="padding: 30px;">
      <form id="loginForm">
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="loginUsername" style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">ç”¨æˆ·å</label>
          <input type="text" id="loginUsername" class="form-control" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required autocomplete="username" style="width: 100%; padding: 12px 15px; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 8px; font-size: 1em; background: rgba(255, 255, 255, 0.9); transition: all 0.3s ease;">
        </div>
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="loginPassword" style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">å¯†ç </label>
          <input type="password" id="loginPassword" class="form-control" placeholder="è¯·è¾“å…¥å¯†ç " required autocomplete="current-password" style="width: 100%; padding: 12px 15px; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 8px; font-size: 1em; background: rgba(255, 255, 255, 0.9); transition: all 0.3s ease;">
        </div>
        <div class="form-group" id="loginError" style="display: none; color: #e74c3c; font-size: 0.9em;"></div>
        <button type="submit" id="loginSubmitBtn" class="btn-primary" style="width: 100%; background: rgba(255, 183, 122, 0.8); color: white; padding: 12px 30px; border-radius: 8px; border: none; font-size: 1em; font-weight: 500; cursor: pointer; transition: all 0.3s ease;">ç™»å½•</button>
      </form>
      <div style="margin-top: 20px; text-align: center; font-size: 0.9em;">
        <a href="#" id="openRegisterModal" style="color: #007bff; text-decoration: none;">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ</a>
      </div>
    </div>
  </div>
</div>

<!-- å¤–éƒ¨é“¾æ¥è­¦å‘Šæ¨¡æ€æ¡† -->
<div class="modal" id="externalLinkModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>âš ï¸ å¤–éƒ¨é“¾æ¥è­¦å‘Š</h3>
      <button class="modal-close" data-modal="externalLinkModal">Ã—</button>
    </div>
    <div class="modal-body">
      <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 20px;">
        {{ external_link_warning_text }}
      </p>
      <div style="background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px; word-break: break-all;">
        <p style="font-size: 0.9em; color: rgba(255, 255, 255, 0.7); margin-bottom: 5px;">ç›®æ ‡é“¾æ¥ï¼š</p>
        <p id="externalLinkUrl" style="color: #007bff; font-weight: 500;"></p>
      </div>
      <div style="display: flex; gap: 10px;">
        <button type="button" class="btn-secondary" id="cancelExternalLinkBtn" style="flex: 1;">ä¸è·³è½¬</button>
        <button type="button" class="btn-primary" id="proceedExternalLinkBtn" style="flex: 1;">è·³è½¬</button>
      </div>
    </div>
  </div>
</div>

<style>
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  height: 3px;
  background: linear-gradient(90deg, #007bff, #00b894);
  width: 0%;
  transition: width 3s linear;
}

.modal.active .modal-content::after {
  width: 100%;
}

.modal.active {
  display: flex;
}

.form-control:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 123, 255, 0.3);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.btn-secondary {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  padding: 12px 30px;
  border-radius: 8px;
  font-size: 1em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-secondary:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

#userCenter.active {
  display: block;
}

.user-center-menu a:hover {
  background: rgba(0, 123, 255, 0.1);
  color: #007bff;
}

#logoutBtn:hover {
  background: rgba(231, 76, 60, 0.1);
  color: #c0392b;
}
</style>

<!-- Highlight.js JS (å»¶è¿ŸåŠ è½½) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" defer></script>
<script>
// Toast é€šçŸ¥ç³»ç»Ÿ
function showToast(message, type = 'success') {
  const container = document.getElementById('toastContainer');
  if (!container) {
    console.error('Toast container not found');
    return;
  }

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;

  let icon = '';
  switch (type) {
    case 'success':
      icon = 'â­•';
      break;
    case 'error':
      icon = 'âŒ';
      break;
    case 'warning':
      icon = 'âš ï¸';
      break;
    default:
      icon = 'â­•';
  }

  toast.innerHTML = `
    <div class="toast-icon">${icon}</div>
    <div class="toast-message">${message}</div>
    <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
  `;

  container.appendChild(toast);

  // 3ç§’åè‡ªåŠ¨ç§»é™¤
  setTimeout(() => {
    if (toast.parentElement) {
      toast.remove();
    }
  }, 3000);
}

// åˆå§‹åŒ–ä»£ç é«˜äº®
document.addEventListener('DOMContentLoaded', async function() {
  // æ¸²æŸ“æœåŠ¡å™¨ç«¯æ¸²æŸ“çš„å†…å®¹ä¸­çš„æ•°å­¦å…¬å¼å’Œæµç¨‹å›¾
  const serverRenderedContent = document.querySelector('.article.active .article-content');
  if (serverRenderedContent) {
    try {
      await renderMathAndDiagrams(serverRenderedContent);
    } catch (err) {
      console.error('æ¸²æŸ“å¤±è´¥:', err);
    }
  }

  // åŠ è½½é™„ä»¶åˆ—è¡¨ï¼ˆä»æœåŠ¡å™¨ç«¯æ¸²æŸ“çš„æ–‡ç« æ—¥æœŸä¸­è·å–ï¼‰
  const articleDateEl = document.querySelector('.article.active .article-date');
  if (articleDateEl && articleDateEl.textContent) {
    const activeArticle = document.querySelector('.article.active');
    loadAttachments(articleDateEl.textContent.trim(), activeArticle);
  }

  // åŠ è½½å¤–è§‚è®¾ç½®å¹¶åº”ç”¨æš—è‰²æ¨¡å¼
  fetch('/api/settings/appearance')
    .then(response => response.json())
    .then(settings => {
      // ä¿å­˜åˆ° localStorage ä¾›å…¶ä»–ç»„ä»¶ä½¿ç”¨
      localStorage.setItem('appearanceSettings', JSON.stringify(settings));

      // åªæœ‰å½“æ˜ç¡®è®¾ç½®ä¸º true æ—¶æ‰å¯ç”¨æ·±è‰²æ¨¡å¼ï¼Œå¦åˆ™é»˜è®¤å…³é—­
      if (settings.dark_mode_enabled === true) {
        document.documentElement.classList.add('dark-mode');
      } else {
        // ç¡®ä¿æ·±è‰²æ¨¡å¼å…³é—­
        document.documentElement.classList.remove('dark-mode');
      }

      // åº”ç”¨æ¯›ç»ç’ƒé¢œè‰²
      if (settings.navbar_glass_color || settings.card_glass_color || settings.footer_glass_color || settings.navbar_text_color) {
        document.documentElement.style.setProperty('--navbar-glass-color', settings.navbar_glass_color || 'rgba(255, 255, 255, 0.85)');
        document.documentElement.style.setProperty('--navbar-text-color', settings.navbar_text_color || 'rgba(255, 255, 255, 0.9)');
        document.documentElement.style.setProperty('--card-glass-color', settings.card_glass_color || 'rgba(255, 255, 255, 0.75)');
        document.documentElement.style.setProperty('--footer-glass-color', settings.footer_glass_color || 'rgba(255, 255, 255, 0.9)');
      }

      // å“åº”å¼åŠ è½½èƒŒæ™¯å›¾ç‰‡
      function applyBackgroundImage() {
        const isMobile = window.innerWidth <= 768;
        const backgroundImage = isMobile && settings.mobile_background_image ? settings.mobile_background_image : settings.background_image;
        if (backgroundImage) {
          document.body.style.backgroundImage = `url('${backgroundImage}')`;
        }
      }

      // åˆå§‹åº”ç”¨
      applyBackgroundImage();

      // ç›‘å¬çª—å£å¤§å°å˜åŒ–
      window.addEventListener('resize', applyBackgroundImage);
    })
    .catch(error => {
      console.error('åŠ è½½å¤–è§‚è®¾ç½®å¤±è´¥:', error);
      // åŠ è½½å¤±è´¥æ—¶é»˜è®¤å…³é—­æ·±è‰²æ¨¡å¼
      document.documentElement.classList.remove('dark-mode');
    });

  // åˆå§‹åŒ–å›¾ç‰‡æ”¾å¤§åŠŸèƒ½
  initImageViewer();

  // åˆå§‹åŒ–ä»£ç å—åŠŸèƒ½
  initCodeBlocks();

  // ä»£ç æŸ¥çœ‹å™¨å…³é—­æŒ‰é’®
  const codeViewerClose = document.getElementById('codeViewerClose');
  if (codeViewerClose) {
    codeViewerClose.addEventListener('click', closeCodeViewer);
  }

  // ä»£ç æŸ¥çœ‹å™¨å¤åˆ¶æŒ‰é’®
  const codeViewerCopy = document.getElementById('codeViewerCopy');
  if (codeViewerCopy) {
    codeViewerCopy.addEventListener('click', () => {
      const codeElement = document.querySelector('#codeViewerContent code');
      if (codeElement) {
        const codeText = codeElement.textContent;
        navigator.clipboard.writeText(codeText).then(() => {
          showCodeViewerToast('å¤åˆ¶æˆåŠŸï¼');
        }).catch(err => {
          console.error('å¤åˆ¶å¤±è´¥:', err);
          showCodeViewerToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        });
      }
    });
  }

  // é«˜äº®æ‰€æœ‰ä»£ç å—
  document.querySelectorAll('pre code').forEach((block) => {
    hljs.highlightElement(block);
  });

  // ç›‘å¬åŠ¨æ€æ·»åŠ çš„å†…å®¹ï¼Œè‡ªåŠ¨é«˜äº®
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      mutation.addedNodes.forEach(function(node) {
        if (node.nodeType === 1) { // å…ƒç´ èŠ‚ç‚¹
          // è·³è¿‡ä»£ç æŸ¥çœ‹å™¨ä¸­çš„ä»£ç å—ï¼Œé¿å…é‡å¤æ·»åŠ åŒ…è£…å™¨
          if (node.id === 'codeViewerContent' || node.closest('#codeViewerContent')) {
            return;
          }
          
          node.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
          });

          // åˆå§‹åŒ–æ–°æ·»åŠ çš„ä»£ç å—
          const newCodeBlocks = node.querySelectorAll('pre code');
          newCodeBlocks.forEach((codeBlock) => {
            if (!codeBlock.closest('.code-block-wrapper') && !codeBlock.closest('#codeViewerContent')) {
              const pre = codeBlock.parentElement;
              const language = detectLanguage(codeBlock.className);

              // åˆ›å»ºåŒ…è£…å™¨
              const wrapper = document.createElement('div');
              wrapper.className = 'code-block-wrapper';
              pre.parentNode.insertBefore(wrapper, pre);
              wrapper.appendChild(pre);

              // åˆ›å»ºå·¥å…·æ 
              const toolbar = document.createElement('div');
              toolbar.className = 'code-block-toolbar';
              toolbar.innerHTML = `
                <span class="code-language">${language}</span>
                <button class="copy-code-btn" title="å¤åˆ¶ä»£ç ">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg>
                  å¤åˆ¶
                </button>
                <button class="fullscreen-code-btn" title="å…¨å±æŸ¥çœ‹">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                  </svg>
                  å…¨å±
                </button>
              `;
              wrapper.insertBefore(toolbar, pre);

              // æ·»åŠ è¡Œå·
              const lines = codeBlock.textContent.split('\n');
              const lineNumbers = document.createElement('div');
              lineNumbers.className = 'code-line-numbers';
              lines.forEach((_, index) => {
                const lineNum = document.createElement('span');
                lineNum.textContent = index + 1;
                lineNumbers.appendChild(lineNum);
              });
              pre.style.position = 'relative';
              pre.insertBefore(lineNumbers, codeBlock);

              // å¤åˆ¶æŒ‰é’®äº‹ä»¶
              const copyBtn = toolbar.querySelector('.copy-code-btn');
              copyBtn.addEventListener('click', () => copyCode(codeBlock, wrapper));

              // å…¨å±æŒ‰é’®äº‹ä»¶
              const fullscreenBtn = toolbar.querySelector('.fullscreen-code-btn');
              fullscreenBtn.addEventListener('click', () => {
                // ç¡®ä¿ codeBlock æ˜¯ code å…ƒç´ ï¼Œè€Œä¸æ˜¯ wrapper
                const actualCodeBlock = codeBlock.tagName === 'CODE' ? codeBlock : codeBlock.querySelector('code');
                openCodeViewer(actualCodeBlock, language);
              });
            }
          });
        }
      });
    });
  });

  observer.observe(document.body, {
    childList: true,
    subtree: true
  });

  // è·å–å½“å‰æ–‡ç« çš„åˆ†ç±»å’Œæ ‡ç­¾
  loadCurrentArticleCategoryAndTags();
});

// è¯„è®ºç›¸å…³å˜é‡
let currentPassageID = null; // å°†ä» URL è·¯å¾„ä¸­æå–
let currentPassageUUID = null; // æ–‡ç« çš„UUID

// åˆå§‹åŒ–å›¾ç‰‡æ”¾å¤§åŠŸèƒ½
function initImageViewer() {
  const imageViewer = document.getElementById('imageViewer');
  const imageViewerImg = document.getElementById('imageViewerImg');
  const imageViewerClose = document.getElementById('imageViewerClose');

  if (!imageViewer || !imageViewerImg || !imageViewerClose) return;

  // ç›‘å¬æ‰€æœ‰æ–‡ç« å†…å®¹ä¸­çš„å›¾ç‰‡ç‚¹å‡»äº‹ä»¶
  document.addEventListener('click', function(e) {
    const img = e.target.closest('.article-content img');
    if (img) {
      e.preventDefault();
      openImageViewer(img.src);
    }
  });

  // ç‚¹å‡»å…³é—­æŒ‰é’®
  imageViewerClose.addEventListener('click', closeImageViewer);

  // ç‚¹å‡»å›¾ç‰‡èƒŒæ™¯å…³é—­
  imageViewer.addEventListener('click', function(e) {
    if (e.target === imageViewer) {
      closeImageViewer();
    }
  });

  // æŒ‰ ESC é”®å…³é—­ï¼ˆåŒæ—¶å¤„ç†å›¾ç‰‡æŸ¥çœ‹å™¨å’Œä»£ç æŸ¥çœ‹å™¨ï¼‰
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      if (imageViewer.classList.contains('active')) {
        closeImageViewer();
      }
      const codeViewer = document.getElementById('codeViewer');
      if (codeViewer && codeViewer.classList.contains('active')) {
        closeCodeViewer();
      }
    }
  });
}

// æ‰“å¼€å›¾ç‰‡æŸ¥çœ‹å™¨
function openImageViewer(src) {
  const imageViewer = document.getElementById('imageViewer');
  const imageViewerImg = document.getElementById('imageViewerImg');

  if (!imageViewer || !imageViewerImg) return;

  imageViewerImg.src = src;
  imageViewer.classList.add('active');
  document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
}

// å…³é—­å›¾ç‰‡æŸ¥çœ‹å™¨
function closeImageViewer() {
  const imageViewer = document.getElementById('imageViewer');
  const imageViewerImg = document.getElementById('imageViewerImg');

  if (!imageViewer || !imageViewerImg) return;

  imageViewer.classList.remove('active');
  imageViewerImg.src = '';
  document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
}

// åˆå§‹åŒ–ä»£ç å—åŠŸèƒ½
function initCodeBlocks() {
  const articleContent = document.querySelector('.article-content');
  if (!articleContent) return;

  // å¤„ç†æ‰€æœ‰ä»£ç å—
  const codeBlocks = articleContent.querySelectorAll('pre code');
  codeBlocks.forEach((codeBlock) => {
    const pre = codeBlock.parentElement;
    const language = detectLanguage(codeBlock.className);

    // åˆ›å»ºåŒ…è£…å™¨
    const wrapper = document.createElement('div');
    wrapper.className = 'code-block-wrapper';
    pre.parentNode.insertBefore(wrapper, pre);
    wrapper.appendChild(pre);

    // åˆ›å»ºå·¥å…·æ 
    const toolbar = document.createElement('div');
    toolbar.className = 'code-block-toolbar';
    toolbar.innerHTML = `
      <span class="code-language">${language}</span>
      <button class="copy-code-btn" title="å¤åˆ¶ä»£ç ">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
        å¤åˆ¶
      </button>
      <button class="fullscreen-code-btn" title="å…¨å±æŸ¥çœ‹">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
        </svg>
        å…¨å±
      </button>
    `;
    wrapper.insertBefore(toolbar, pre);

    // æ·»åŠ è¡Œå·
    const lines = codeBlock.textContent.split('\n');
    const lineNumbers = document.createElement('div');
    lineNumbers.className = 'code-line-numbers';
    lines.forEach((_, index) => {
      const lineNum = document.createElement('span');
      lineNum.textContent = index + 1;
      lineNumbers.appendChild(lineNum);
    });
    pre.style.position = 'relative';
    pre.insertBefore(lineNumbers, codeBlock);

    // å¤åˆ¶æŒ‰é’®äº‹ä»¶
    const copyBtn = toolbar.querySelector('.copy-code-btn');
    copyBtn.addEventListener('click', () => copyCode(codeBlock, wrapper));

    // å…¨å±æŒ‰é’®äº‹ä»¶
    const fullscreenBtn = toolbar.querySelector('.fullscreen-code-btn');
    fullscreenBtn.addEventListener('click', () => {
      // ç¡®ä¿ codeBlock æ˜¯ code å…ƒç´ ï¼Œè€Œä¸æ˜¯ wrapper
      const actualCodeBlock = codeBlock.tagName === 'CODE' ? codeBlock : codeBlock.querySelector('code');
      openCodeViewer(actualCodeBlock, language);
    });
  });
}

// æ£€æµ‹ä»£ç è¯­è¨€
function detectLanguage(className) {
  const match = className.match(/language-(\w+)/);
  return match ? match[1] : 'Code';
}

// å¤åˆ¶ä»£ç 
function copyCode(codeBlock, wrapper) {
  const code = codeBlock.textContent;

  navigator.clipboard.writeText(code).then(() => {
    showCopyToast(wrapper, 'å¤åˆ¶æˆåŠŸï¼');
  }).catch(err => {
    console.error('å¤åˆ¶å¤±è´¥:', err);
    showCopyToast(wrapper, 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
  });
}

// æ˜¾ç¤ºå¤åˆ¶æç¤º
function showCopyToast(wrapper, message) {
  let toast = wrapper.querySelector('.copy-toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.className = 'copy-toast';
    wrapper.appendChild(toast);
  }

  toast.textContent = message;
  toast.classList.add('show');

  setTimeout(() => {
    toast.classList.remove('show');
  }, 2000);
}

// æ‰“å¼€ä»£ç æŸ¥çœ‹å™¨
function openCodeViewer(codeBlock, language) {
  const codeViewer = document.getElementById('codeViewer');
  const codeViewerContent = document.getElementById('codeViewerContent');
  const codeViewerTitle = document.getElementById('codeViewerTitle');

  if (!codeViewer || !codeViewerContent || !codeViewerTitle) return;

  // è®¾ç½®æ ‡é¢˜
  codeViewerTitle.textContent = `${language} ä»£ç `;

  // è®¾ç½®å†…å®¹ - IDE é£æ ¼å¸ƒå±€
  codeViewerContent.innerHTML = '';
  
  const wrapper = document.createElement('div');
  wrapper.style.cssText = 'display: flex; align-items: flex-start; background: #1a1b26; padding: 20px; height: 100%; overflow: auto;';
  
  // è·å–çº¯æ–‡æœ¬å†…å®¹ï¼ˆç§»é™¤è¡Œå·ï¼Œåªä¿ç•™ä»£ç ï¼‰
  // å…‹éš†èŠ‚ç‚¹ä»¥é¿å…å½±å“åŸå§‹å…ƒç´ 
  const codeClone = codeBlock.cloneNode(true);
  // ç§»é™¤æ‰€æœ‰è¡Œå·å…ƒç´ 
  const lineNumbers = codeClone.querySelectorAll('.code-line-numbers');
  lineNumbers.forEach(ln => ln.remove());
  // è·å–çº¯ä»£ç æ–‡æœ¬
  const codeText = codeClone.textContent;
  
  // æ·»åŠ è¡Œå·
  const lines = codeText.split('\n');
  const lineNumbersDiv = document.createElement('div');
  lineNumbersDiv.style.cssText = 'display: flex; flex-direction: column; align-items: flex-end; padding-right: 16px; user-select: none; color: #565f89; font-size: 0.9em; line-height: 1.6; min-width: 40px;';
  lines.forEach((_, index) => {
    const lineNum = document.createElement('span');
    lineNum.textContent = index + 1;
    lineNumbersDiv.appendChild(lineNum);
  });
  wrapper.appendChild(lineNumbersDiv);
  
  // æ·»åŠ ä»£ç 
  const pre = document.createElement('pre');
  pre.style.cssText = 'margin: 0; padding: 0; background: transparent; border: none; flex: 1;';
  const code = document.createElement('code');
  code.className = codeBlock.className;
  code.textContent = codeText;
  code.style.cssText = 'background: transparent; padding: 0; font-family: "JetBrains Mono", "Fira Code", Consolas, Monaco, monospace; font-size: 0.95em; line-height: 1.6; color: #a9b1d6;';
  pre.appendChild(code);
  wrapper.appendChild(pre);
  
  codeViewerContent.appendChild(wrapper);

  // é‡æ–°é«˜äº®
  if (typeof hljs !== 'undefined') {
    hljs.highlightElement(code);
  }

  // æ˜¾ç¤ºæŸ¥çœ‹å™¨
  codeViewer.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// å…³é—­ä»£ç æŸ¥çœ‹å™¨
function closeCodeViewer() {
  const codeViewer = document.getElementById('codeViewer');
  if (!codeViewer) return;

  codeViewer.classList.remove('active');
  document.body.style.overflow = '';
}

// æ˜¾ç¤ºä»£ç æŸ¥çœ‹å™¨æç¤ºæ¡†
function showCodeViewerToast(message) {
  const toast = document.getElementById('codeViewerToast');
  if (!toast) return;
  
  toast.textContent = message;
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 2000);
}

// åŠ è½½å½“å‰æ–‡ç« çš„åˆ†ç±»å’Œæ ‡ç­¾
async function loadCurrentArticleCategoryAndTags() {
  if (!currentPassageID) {
    return;
  }

  try {
    const response = await fetch(`/api/passages/${currentPassageID}`);
    
    // æ£€æŸ¥å“åº”çŠ¶æ€
    if (response.status === 423) {
      // 423 Locked - æ–‡ç« æœªå‘å¸ƒ
      const result = await response.json();
      showUnpublishedNotice(result);
      return;
    }
    
    const result = await response.json();

    if (result.success && result.data) {
      const articleData = result.data;

      // æ›´æ–°åˆ†ç±»æ˜¾ç¤º
      const categoryEl = document.getElementById('articleCategory');
      if (categoryEl) {
        categoryEl.textContent = articleData.category || 'æœªåˆ†ç±»';
      }

      // æ›´æ–°æ ‡ç­¾æ˜¾ç¤º
      const tagsInlineEl = document.getElementById('articleTagsInline');
      if (tagsInlineEl) {
        tagsInlineEl.innerHTML = '';
        const tags = typeof articleData.tags === 'string' ? JSON.parse(articleData.tags) : articleData.tags;
        if (tags && tags.length > 0) {
          tags.forEach(tag => {
            const tagEl = document.createElement('span');
            tagEl.className = 'inline-tag';
            tagEl.textContent = tag;
            tagsInlineEl.appendChild(tagEl);
          });
        } else {
          tagsInlineEl.textContent = 'æ— æ ‡ç­¾';
        }
      }

      // æ›´æ–°é˜…è¯»æ—¶é•¿æ˜¾ç¤º
      const readTimeEl = document.getElementById('articleReadTime');
      if (readTimeEl && articleData.content) {
        const readTime = calculateReadTime(articleData.content);
        readTimeEl.textContent = `é¢„è®¡ ${readTime} åˆ†é’Ÿè¯»å®Œ`;
      }
    }
  } catch (error) {
    console.error('åŠ è½½æ–‡ç« åˆ†ç±»å’Œæ ‡ç­¾å¤±è´¥:', error);
  }
}

// æ˜¾ç¤ºæœªå‘å¸ƒæ–‡ç« æç¤º
function showUnpublishedNotice(result) {
  const unpublishedNotice = document.getElementById('unpublishedNotice');
  const unpublishedMessage = document.getElementById('unpublishedMessage');
  const scheduledMessage = document.getElementById('scheduledMessage');
  const scheduledTime = document.getElementById('scheduledTime');
  
  // éšè—æ–‡ç« å†…å®¹
  const articleContainer = document.querySelector('.article-container');
  const articles = articleContainer.querySelectorAll('.article');
  articles.forEach(article => article.style.display = 'none');
  
  // æ˜¾ç¤ºæœªå‘å¸ƒæç¤º
  unpublishedNotice.style.display = 'block';
  
  // è®¾ç½®æ¶ˆæ¯
  if (result.status === 'draft') {
    unpublishedMessage.textContent = 'æ­¤æ–‡ç« æ˜¯è‰ç¨¿ï¼Œæ­£åœ¨ç¼–è¾‘ä¸­ï¼Œæš‚æ—¶æ— æ³•è®¿é—®ã€‚';
  } else if (result.status === 'pending') {
    unpublishedMessage.textContent = 'æ­¤æ–‡ç« æ­£åœ¨ç­‰å¾…å®¡æ ¸ï¼Œæš‚æ—¶æ— æ³•è®¿é—®ã€‚';
  } else {
    unpublishedMessage.textContent = 'æ­¤æ–‡ç« å°šæœªå‘å¸ƒï¼Œæš‚æ—¶æ— æ³•è®¿é—®ã€‚';
  }
  
  // å¦‚æœæ˜¯å®šæ—¶å‘å¸ƒï¼Œæ˜¾ç¤ºå‘å¸ƒæ—¶é—´
  if (result.is_scheduled && result.published_at) {
    scheduledMessage.style.display = 'block';
    const publishDate = new Date(result.published_at);
    scheduledTime.textContent = publishDate.toLocaleString('zh-CN', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  } else {
    scheduledMessage.style.display = 'none';
  }
}

// åˆå§‹åŒ–è¯„è®ºåŠŸèƒ½
function initComments() {
  if (!currentPassageID) {
    return;
  }

  // åŠ è½½è¯„è®º
  loadComments();

  // ç»‘å®šæäº¤è¯„è®ºæŒ‰é’®äº‹ä»¶
  const submitBtn = document.getElementById('submitCommentBtn');
  if (submitBtn) {
    submitBtn.addEventListener('click', submitComment);
  }

  // ç»‘å®š Ctrl+Enter æäº¤è¯„è®º
  const commentContent = document.getElementById('commentContent');
  if (commentContent) {
    commentContent.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        submitComment();
      }
    });
  }

  // ç»‘å®šç”¨æˆ·åè¾“å…¥æ¡†çš„å®æ—¶å¤´åƒé¢„è§ˆ
  const usernameInput = document.getElementById('commentUsername');
  const userAvatar = document.querySelector('.comment-user-avatar');
  if (usernameInput && userAvatar) {
    usernameInput.addEventListener('input', function() {
      const username = this.value.trim() || 'anonymous';
      const avatarUrl = generateIdenticon(username, 40);
      userAvatar.innerHTML = `<img src="${avatarUrl}" alt="${username}" style="width: 100%; height: 100%; border-radius: 50%;"/>`;
    });
    
    // åˆå§‹åŒ–é»˜è®¤å¤´åƒ
    const defaultAvatarUrl = generateIdenticon('anonymous', 40);
    userAvatar.innerHTML = `<img src="${defaultAvatarUrl}" alt="anonymous" style="width: 100%; height: 100%; border-radius: 50%;"/>`;
  }
}

// åŠ è½½è¯„è®º
async function loadComments() {
  const commentsList = document.getElementById('commentsList');
  const loadingState = document.getElementById('commentsLoading');
  const emptyComments = document.getElementById('emptyComments');
  const commentsCount = document.getElementById('commentsCount');

  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  if (loadingState) loadingState.style.display = 'flex';
  if (commentsList) commentsList.style.display = 'none';
  if (emptyComments) emptyComments.style.display = 'none';

  try {
    const response = await fetch(`/api/comments?passage_uuid=${currentPassageUUID}`);
    const result = await response.json();

    if (result.success && result.data) {
      // æ›´æ–°è¯„è®ºæ•°é‡
      if (commentsCount) {
        commentsCount.textContent = `${result.data.length} æ¡è¯„è®º`;
      }

      // éšè—åŠ è½½çŠ¶æ€
      if (loadingState) loadingState.style.display = 'none';

      if (result.data.length > 0) {
        // æ˜¾ç¤ºè¯„è®ºåˆ—è¡¨
        if (commentsList) {
          commentsList.style.display = 'flex';
          renderComments(result.data);
        }
      } else {
        // æ˜¾ç¤ºç©ºçŠ¶æ€
        if (emptyComments) emptyComments.style.display = 'flex';
      }
    } else {
      console.error('åŠ è½½è¯„è®ºå¤±è´¥:', result);
      if (loadingState) loadingState.style.display = 'none';
      if (emptyComments) emptyComments.style.display = 'flex';
    }
  } catch (error) {
    console.error('åŠ è½½è¯„è®ºæ—¶å‡ºé”™:', error);
    if (loadingState) loadingState.style.display = 'none';
    if (emptyComments) emptyComments.style.display = 'flex';
  }
}

// æ¸²æŸ“è¯„è®ºåˆ—è¡¨
function renderComments(comments) {
  const commentsList = document.getElementById('commentsList');
  if (!commentsList) return;

  commentsList.innerHTML = '';

  comments.forEach(comment => {
    const commentEl = createCommentElement(comment);
    commentsList.appendChild(commentEl);
  });
}

// ç”ŸæˆåŸºäºç”¨æˆ·åçš„ identicon å¤´åƒ
function generateIdenticon(username, size = 40) {
  // ä½¿ç”¨ç”¨æˆ·åç”Ÿæˆå“ˆå¸Œå€¼
  const hash = simpleHash(username);
  
  // ä»å“ˆå¸Œå€¼ç”Ÿæˆé¢œè‰²
  const hue = hash % 360;
  const saturation = 65 + (hash % 15);
  const lightness = 55 + (hash % 10);
  const bgColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
  const textColor = `hsl(${hue}, ${saturation}%, ${lightness - 25}%)`;
  
  // åˆ›å»º SVG identicon
  const svgSize = 5; // 5x5 ç½‘æ ¼
  let svgContent = '';
  
  // åŸºäºå“ˆå¸Œå€¼ç”Ÿæˆå¯¹ç§°å›¾æ¡ˆ
  for (let y = 0; y < svgSize; y++) {
    for (let x = 0; x < Math.ceil(svgSize / 2); x++) {
      const index = y * svgSize + x;
      const bit = (hash >> index) & 1;
      
      if (bit) {
        // å¯¹ç§°å¡«å……
        svgContent += `<rect x="${x}" y="${y}" width="1" height="1" fill="${bgColor}"/>`;
        svgContent += `<rect x="${svgSize - 1 - x}" y="${y}" width="1" height="1" fill="${bgColor}"/>`;
      }
    }
  }
  
  // è·å–ç”¨æˆ·åé¦–å­—æ¯
  const initial = username ? username.charAt(0).toUpperCase() : '?';
  
  const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${svgSize} ${svgSize}" width="${size}" height="${size}">
      <rect width="${svgSize}" height="${svgSize}" fill="#f0f0f0"/>
      ${svgContent}
      <text x="${svgSize / 2}" y="${svgSize / 2 + 0.35}" 
            text-anchor="middle" 
            font-size="${svgSize * 0.5}" 
            font-weight="bold" 
            fill="${textColor}"
            font-family="system-ui, -apple-system, sans-serif">${initial}</text>
    </svg>
  `;
  
  return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
}

// ç®€å•å“ˆå¸Œå‡½æ•°
function simpleHash(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // è½¬æ¢ä¸º 32 ä½æ•´æ•°
  }
  return Math.abs(hash);
}

// åˆ›å»ºè¯„è®ºå…ƒç´ 
function createCommentElement(comment) {
  const commentEl = document.createElement('div');
  commentEl.className = 'comment-item';

  // ç”ŸæˆåŸºäºç”¨æˆ·åçš„ identicon å¤´åƒ
  const avatarUrl = generateIdenticon(comment.username || 'anonymous', 40);

  commentEl.innerHTML = `
    <div class="comment-header">
      <div class="comment-user">
        <div class="comment-avatar">
          <img src="${avatarUrl}" alt="${comment.username || 'åŒ¿åç”¨æˆ·'}" style="width: 100%; height: 100%; border-radius: 50%;"/>
        </div>
        <span class="comment-username">${comment.username}</span>
      </div>
      <span class="comment-date">${formatDate(comment.created_at)}</span>
    </div>
    <div class="comment-content">${comment.content}</div>
  `;

  return commentEl;
}

// æäº¤è¯„è®º
async function submitComment() {
  const usernameInput = document.getElementById('commentUsername');
  const contentInput = document.getElementById('commentContent');
  const submitBtn = document.getElementById('submitCommentBtn');

  const username = usernameInput.value.trim();
  const content = contentInput.value.trim();

  // éªŒè¯è¾“å…¥
  if (!username) {
    showToast('è¯·è¾“å…¥ç”¨æˆ·å', 'warning');
    usernameInput.focus();
    return;
  }

  if (!content) {
    showToast('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'warning');
    contentInput.focus();
    return;
  }

  // ç¦ç”¨æäº¤æŒ‰é’®
  if (submitBtn) submitBtn.disabled = true;

  try {
    const response = await fetch('/api/comments', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        username: username,
        content: content,
        passage_uuid: currentPassageUUID
      })
    });

    const result = await response.json();

    if (result.success) {
      // æ¸…ç©ºè¡¨å•
      usernameInput.value = '';
      contentInput.value = '';

      // é‡æ–°åŠ è½½è¯„è®º
      loadComments();

      // æ˜¾ç¤ºæˆåŠŸæç¤º
      showToast('è¯„è®ºå‘è¡¨æˆåŠŸï¼', 'success');
    } else {
      showToast('è¯„è®ºå‘è¡¨å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
    }
  } catch (error) {
    console.error('æäº¤è¯„è®ºæ—¶å‡ºé”™:', error);
    showToast('è¯„è®ºå‘è¡¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
  } finally {
    // æ¢å¤æäº¤æŒ‰é’®
    if (submitBtn) submitBtn.disabled = false;
  }
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateString) {
  const date = new Date(dateString);
  const now = new Date();
  const diff = now - date;

  const seconds = Math.floor(diff / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);

  if (seconds < 60) {
    return 'åˆšåˆš';
  } else if (minutes < 60) {
    return `${minutes} åˆ†é’Ÿå‰`;
  } else if (hours < 24) {
    return `${hours} å°æ—¶å‰`;
  } else if (days < 7) {
    return `${days} å¤©å‰`;
  } else {
    return date.toLocaleDateString('zh-CN');
  }
}

// è½¬ä¹‰HTMLï¼Œé˜²æ­¢XSSæ”»å‡»
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// æ›´æ–°é¡µé¢æ ‡é¢˜
function updatePageTitle(articleData) {
  if (articleData && articleData.title) {
    document.title = `${articleData.title} - æ–‡ç« é˜…è¯»`;
  } else {
    document.title = 'RustBlog - æ–‡ç« é˜…è¯»';
  }
  // æ›´æ–°åŸå§‹æ ‡é¢˜ï¼Œç”¨äºé¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ¢å¤
  originalTitle = document.title;
}
</script>

<!-- æ¨¡æ€æ¡†åŠ¨ç”»æ§åˆ¶è„šæœ¬ -->
<script src="/js/modal-animations.js" defer></script>
<!-- Markdown é¢„è§ˆæ¨¡æ€æ¡† -->
<script src="/js/markdown-preview-modal.js?v=2" defer></script>

<script>
// æµè§ˆå™¨æ ‡ç­¾é¡µæ ‡é¢˜æç¤ºåŠŸèƒ½
let originalTitle = document.title;
const switchNoticeText = '{{ switch_notice_text }}';
const isNoticeEnabled = {{ switch_notice }};

// ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
document.addEventListener('visibilitychange', function() {
  if (!isNoticeEnabled || !switchNoticeText || switchNoticeText === '') return;

  if (document.hidden) {
    // é¡µé¢éšè—æ—¶ï¼Œæ˜¾ç¤ºæç¤ºæ–‡å­—
    document.title = switchNoticeText;
  } else {
    // é¡µé¢æ˜¾ç¤ºæ—¶ï¼Œæ¢å¤åŸå§‹æ ‡é¢˜
    document.title = originalTitle;
  }
});

// ç›‘å¬é¡µé¢è·å¾—ç„¦ç‚¹
window.addEventListener('focus', function() {
  if (!isNoticeEnabled) return;
  document.title = originalTitle;
});

// å¤–éƒ¨é“¾æ¥è­¦å‘ŠåŠŸèƒ½
const isExternalLinkWarningEnabled = {{ external_link_warning }};
const externalLinkWhitelist = '{{ external_link_whitelist }}';
let currentExternalLink = '';

function showExternalLinkWarning(url) {
  currentExternalLink = url;
  const modal = document.getElementById('externalLinkModal');
  const urlDisplay = document.getElementById('externalLinkUrl');
  
  if (modal && urlDisplay) {
    urlDisplay.textContent = url;
    modal.classList.add('active');
  }
}

function hideExternalLinkWarning() {
  const modal = document.getElementById('externalLinkModal');
  if (modal) {
    modal.classList.remove('active');
  }
}

function proceedToExternalLink() {
  if (currentExternalLink) {
    window.open(currentExternalLink, '_blank');
  }
  hideExternalLinkWarning();
}

function isWhitelistedDomain(url, whitelist) {
  try {
    // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œç›´æ¥è¿”å›true
    if (url.startsWith('/')) {
      return true;
    }
    
    // å¦‚æœæ˜¯åè®®ç›¸å¯¹è·¯å¾„ï¼ˆ//example.comï¼‰ï¼Œè½¬æ¢ä¸ºç»å¯¹è·¯å¾„
    if (url.startsWith('//')) {
      url = window.location.protocol + url;
    }
    
    const urlObj = new URL(url);
    const hostname = urlObj.hostname.toLowerCase();
    
    if (hostname === window.location.hostname) {
      return true;
    }
    
    const whitelistDomains = whitelist.split(',').map(d => d.trim().toLowerCase());
    return whitelistDomains.some(domain => {
      // æ”¯æŒï¼šå®Œå…¨åŒ¹é…ã€å­åŸŸååŒ¹é…ã€www å‰ç¼€åŒ¹é…
      return hostname === domain || 
             hostname.endsWith('.' + domain) ||
             hostname === 'www.' + domain ||
             hostname.startsWith('www.') && hostname.slice(4) === domain;
    });
  } catch (e) {
    // å¦‚æœURLè§£æå¤±è´¥ï¼Œå¯èƒ½æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œè¿”å›true
    return true;
  }
}

document.addEventListener('click', function(e) {
  const link = e.target.closest('a');
  if (!link) return;
  
  const href = link.getAttribute('href');
  if (!href) return;
  
  if (href.startsWith('#') || href.startsWith('mailto:') || href.startsWith('tel:')) {
    return;
  }
  
  if (href.startsWith('javascript:')) {
    return;
  }
  
  if (!isExternalLinkWarningEnabled) {
    return;
  }
  
  if (isWhitelistedDomain(href, externalLinkWhitelist)) {
    return;
  }
  
  e.preventDefault();
  showExternalLinkWarning(href);
});

document.addEventListener('DOMContentLoaded', function() {
  const cancelBtn = document.getElementById('cancelExternalLinkBtn');
  const proceedBtn = document.getElementById('proceedExternalLinkBtn');
  const modal = document.getElementById('externalLinkModal');
  const modalClose = modal ? modal.querySelector('.modal-close') : null;
  
  if (cancelBtn) {
    cancelBtn.addEventListener('click', hideExternalLinkWarning);
  }
  
  if (proceedBtn) {
    proceedBtn.addEventListener('click', proceedToExternalLink);
  }
  
  if (modalClose) {
    modalClose.addEventListener('click', hideExternalLinkWarning);
  }
  
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        hideExternalLinkWarning();
      }
    });
  }
});
</script>

<!-- Live2D çœ‹æ¿å¨˜æ ·å¼ -->
<style>
/* Live2D çœ‹æ¿å¨˜å®¹å™¨ - å›ºå®šåœ¨æœ€ä¸Šå±‚å·¦ä¸‹è§’ */
#waifu {
  position: fixed !important;
  left: 0 !important;
  bottom: 0 !important;
  z-index: 9999 !important;
  pointer-events: auto !important;
}

/* çœ‹æ¿å¨˜å·¥å…·æŒ‰é’® */
#waifu-tool {
  display: none !important;
  position: fixed !important;
  left: 0 !important;
  bottom: 0 !important;
  z-index: 9999 !important;
}

/* ç¡®ä¿çœ‹æ¿å¨˜ä¸è¢«å…¶ä»–å…ƒç´ é®æŒ¡ */
.waifu-tips {
  position: fixed !important;
  z-index: 9999 !important;
}

/* çœ‹æ¿å¨˜æ‹–æ‹½åŒºåŸŸ */
.waifu {
  position: fixed !important;
  left: 0 !important;
  bottom: 0 !important;
  z-index: 9999 !important;
}
</style>

<!-- Live2D çœ‹æ¿å¨˜é…ç½® -->
<script>
// Live2D çœ‹æ¿å¨˜åˆå§‹åŒ–é…ç½®
(function() {
  // æ£€æŸ¥æ˜¯å¦å¯ç”¨çœ‹æ¿å¨˜
  const live2dEnabled = {{ live2d_enabled }};
  const live2dShowOnPassage = {{ live2d_show_on_passage }};

  if (!live2dEnabled || !live2dShowOnPassage) {
    return;
  }

  // é…ç½®é€‰é¡¹
  const live2dConfig = {
    waifuPath: 'https://fastly.jsdelivr.net/npm/live2d-widget@1.0.0/dist/waifu-tips.json',
    cdnPath: '{{ live2d_cdn_path }}',
    cubism2Path: 'https://fastly.jsdelivr.net/npm/live2d-widget@1.0.0/dist/live2d.min.js',
    cubism5Path: 'https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js',
    modelId: {{ live2d_model_id }},
    modelPath: '{{ live2d_model_path }}',
    tools: ['switch-model', 'switch-texture', 'photo', 'info', 'quit'],
    drag: true,
    logLevel: 'error',
    position: '{{ live2d_position }}',
    width: '{{ live2d_width }}',
    height: '{{ live2d_height }}'
  };

  // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
  window.addEventListener('load', function() {
    // å»¶è¿ŸåŠ è½½ï¼Œé¿å…é˜»å¡é¡µé¢æ¸²æŸ“
    setTimeout(function() {
      try {
        // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡è„šæœ¬
        if (document.querySelector('script[src*="autoload.js"]')) {
          return;
        }

        // åˆ›å»ºå¹¶åŠ è½½ autoload.js
        const script = document.createElement('script');
        script.src = 'https://fastly.jsdelivr.net/npm/live2d-widgets@1.0.0/dist/autoload.js';
        script.async = true;
        
        script.onload = function() {
          // å¦‚æœæœ‰ initWidget å‡½æ•°ï¼Œåˆ™åˆå§‹åŒ–
          if (typeof initWidget === 'function') {
            try {
              initWidget(live2dConfig);
            } catch (e) {
              console.warn('Live2D çœ‹æ¿å¨˜åˆå§‹åŒ–å¤±è´¥:', e);
            }
          }
        };
        
        script.onerror = function() {
          console.warn('Live2D çœ‹æ¿å¨˜åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ– CDN ä¸å¯ç”¨');
        };
        
        document.body.appendChild(script);
      } catch (error) {
        console.warn('Live2D çœ‹æ¿å¨˜åˆå§‹åŒ–é”™è¯¯:', error);
      }
    }, 1000); // å»¶è¿Ÿ1ç§’åŠ è½½
  });
})();
</script>

<!-- èµåŠ©æ¨¡æ€æ¡† -->
{% if sponsor_enabled %}
<div class="modal" id="sponsorModal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h3>{{ sponsor_title }}</h3>
      <button class="modal-close" data-modal="sponsorModal">Ã—</button>
    </div>
    <div class="modal-body" style="text-align: center;">
      <img src="{{ sponsor_image }}" alt="èµåŠ©äºŒç»´ç " style="max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 20px;">
      <p style="color: #666; line-height: 1.6;">{{ sponsor_description }}</p>
    </div>
  </div>
</div>

<style>
/* èµåŠ©åŒºåŸŸ */
.sponsor-section {
  text-align: right;
  margin: 30px 0;
  padding: 20px;
}

.sponsor-btn {
  background: #007bff;
  color: white;
  border: none;
  padding: 12px 30px;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
}

.sponsor-btn:hover {
  background: #0056b3;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
}

.sponsor-btn:active {
  transform: translateY(0);
}

html.dark-mode .sponsor-btn {
  background: #4a9eff;
  color: white;
}

html.dark-mode .sponsor-btn:hover {
  background: #3395ff;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // ä»æ¨¡æ¿å˜é‡è®¾ç½®èµåŠ©é…ç½®
  window.sponsorEnabled = {{ sponsor_enabled }};
  window.sponsorButtonText = "{{ sponsor_button_text }}";

  // èµåŠ©æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - æ‰“å¼€æ¨¡æ€æ¡†
  const sponsorBtn = document.getElementById('sponsorBtn');
  const sponsorModal = document.getElementById('sponsorModal');
  const modalClose = sponsorModal ? sponsorModal.querySelector('.modal-close') : null;

  if (sponsorBtn && sponsorModal) {
    sponsorBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      sponsorModal.classList.add('active');
    });

    if (modalClose) {
      modalClose.addEventListener('click', function(e) {
        e.stopPropagation();
        sponsorModal.classList.remove('active');
      });
    }

    sponsorModal.addEventListener('click', function(e) {
      if (e.target === sponsorModal) {
        sponsorModal.classList.remove('active');
      }
    });
  }
});
</script>
{% endif %}

<!-- é”®ç›˜å¿«æ·é”®è„šæœ¬ (å»¶è¿ŸåŠ è½½ - æœ€å¤§æ–‡ä»¶ 84.6KB) -->
<script src="/js/keyboard-shortcuts.js" defer></script>
<!-- æ–‡ç« é¡µé¢ä¸“ç”¨å¿«æ·é”®è„šæœ¬ -->
<script src="/js/passage-shortcuts.js" defer></script>
<!-- æ–‡æœ¬èšç„¦æ¨¡å¼è„šæœ¬ -->
<script src="/js/passage-focus-mode.js" defer></script>

<!-- éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ (å»¶è¿ŸåŠ è½½) -->
<link rel="stylesheet" href="/css/music-player.css" media="print" onload="this.media='all'">
<!-- éŸ³ä¹æ’­æ”¾å™¨è„šæœ¬ -->
<script src="/js/music-player.js" defer></script>
<script>
// æ–‡ç« ç­›é€‰æ¨¡æ€æ¡†åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
  const articleFilterToggle = document.getElementById('articleFilterToggle');
  const articleFilterModal = document.getElementById('articleFilterModal');
  const filterTabs = document.querySelectorAll('.filter-tab');
  const filterSearch = document.getElementById('articleFilterSearch');
  const filterContent = document.getElementById('filterContent');

  let currentMode = 'timestamp';

  // æ‰“å¼€/å…³é—­æ¨¡æ€æ¡†
  if (articleFilterToggle) {
    articleFilterToggle.addEventListener('click', function() {
      articleFilterModal.classList.add('active');
      loadFilterContent();
    });
  }

  // å…³é—­æ¨¡æ€æ¡† - ä½¿ç”¨æ ‡å‡†æ¨¡æ€æ¡†å…³é—­å‡½æ•°
  function closeModal() {
    closeModalWithAnimation(articleFilterModal);
  }

  // ç‚¹å‡»æ¨¡æ€æ¡†å†…å®¹åŒºåŸŸä¸å…³é—­
  const modalContent = articleFilterModal ? articleFilterModal.querySelector('.modal-content') : null;
  if (modalContent) {
    modalContent.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  }

  // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
  if (articleFilterModal) {
    articleFilterModal.addEventListener('click', closeModal);
  }

  // åˆ‡æ¢æ¨¡å¼
  filterTabs.forEach(function(tab) {
    tab.addEventListener('click', function() {
      filterTabs.forEach(function(t) {
        t.classList.remove('active');
      });
      this.classList.add('active');
      currentMode = this.dataset.mode;
      loadFilterContent();
    });
  });
  
  // æœç´¢åŠŸèƒ½
  if (filterSearch) {
    filterSearch.addEventListener('input', function() {
      loadFilterContent(this.value);
    });
  }
  
  // åŠ è½½ç­›é€‰å†…å®¹
  function loadFilterContent(searchTerm = '') {
    if (!filterContent) return;
    
    filterContent.innerHTML = '';
    
    if (currentMode === 'timestamp') {
      // åŠ è½½æ–‡ç« ç´¢å¼•ï¼ˆæ—¶é—´æˆ³æ¨¡å¼ï¼‰
      loadArticleIndex(searchTerm);
    } else {
      // åŠ è½½æœ¬æ–‡ç›®å½•
      loadArticleOutline(searchTerm);
    }
  }
  
  // åŠ è½½æ–‡ç« ç´¢å¼•
  function loadArticleIndex(searchTerm = '') {
    if (!articlesData || !articlesData.folders || articlesData.folders.length === 0) {
      filterContent.innerHTML = '<div class="filter-empty">æš‚æ— æ–‡ç« æ•°æ®</div>';
      return;
    }

    // é€’å½’æ”¶é›†æ‰€æœ‰æ–‡ç« 
    const allArticles = [];
    function collectArticlesFromFolder(folder) {
      if (folder.files) {
        folder.files.forEach(file => {
          allArticles.push(file);
        });
      }
      if (folder.subfolders) {
        folder.subfolders.forEach(subfolder => {
          collectArticlesFromFolder(subfolder);
        });
      }
    }

    articlesData.folders.forEach(folder => {
      collectArticlesFromFolder(folder);
    });

    // æœç´¢è¿‡æ»¤
    const filteredArticles = allArticles.filter(function(article) {
      if (!searchTerm) return true;
      return article.title.toLowerCase().includes(searchTerm.toLowerCase());
    });

    if (filteredArticles.length === 0) {
      filterContent.innerHTML = '<div class="filter-empty">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ–‡ç« </div>';
      return;
    }

    // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
    filteredArticles.sort(function(a, b) {
      return new Date(b.date) - new Date(a.date);
    });

    filteredArticles.forEach(function(article) {
      const item = createArticleItem(article);
      filterContent.appendChild(item);
    });
  }
  
  // åŠ è½½æ–‡ç« ç›®å½•
  function loadArticleOutline(searchTerm = '') {
    // è·å–å½“å‰æ´»åŠ¨æ–‡ç« çš„å†…å®¹åŒºåŸŸ
    const activeArticle = document.querySelector('.article.active .article-content');

    if (!activeArticle) {
      filterContent.innerHTML = '<div class="filter-empty">è¯·å…ˆé€‰æ‹©ä¸€ç¯‡æ–‡ç« </div>';
      return;
    }

    // æå–æ‰€æœ‰h1-h6æ ‡é¢˜
    const headings = activeArticle.querySelectorAll('h1, h2, h3, h4, h5, h6');

    if (headings.length === 0) {
      filterContent.innerHTML = '<div class="filter-empty">æœ¬æ–‡æš‚æ— ç›®å½•</div>';
      return;
    }

    // ä¸ºæ ‡é¢˜æ·»åŠ IDï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
    headings.forEach((heading, index) => {
      if (!heading.id) {
        heading.id = `heading-${index}`;
      }
    });

    // æœç´¢è¿‡æ»¤
    let filteredHeadings = Array.from(headings);

    if (searchTerm) {
      filteredHeadings = filteredHeadings.filter(function(heading) {
        return heading.textContent.toLowerCase().includes(searchTerm.toLowerCase());
      });
    }

    if (filteredHeadings.length === 0) {
      filterContent.innerHTML = '<div class="filter-empty">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç›®å½•é¡¹</div>';
      return;
    }

    // ç”Ÿæˆç›®å½•é¡¹
    filteredHeadings.forEach(function(heading) {
      const item = createOutlineItem(heading);
      filterContent.appendChild(item);
    });
  }
  
  // åˆ›å»ºæ–‡ç« é¡¹
  function createArticleItem(article) {
    const item = document.createElement('div');
    item.className = 'article-filter-item';

    // æ ¹æ®æ–‡ç« çŠ¶æ€è®¾ç½®å›¾æ ‡
    const icon = document.createElement('div');
    icon.className = 'article-filter-item-icon';
    if (article.status !== 'published') {
      icon.textContent = 'ğŸ”’';
      icon.title = article.status === 'draft' ? 'è‰ç¨¿' : article.status === 'pending' ? 'å¾…å®¡æ ¸' : 'å®šæ—¶å‘å¸ƒ';
    } else {
      icon.textContent = 'ğŸ“„';
    }

    const info = document.createElement('div');
    info.className = 'article-filter-item-info';

    const title = document.createElement('div');
    title.className = 'article-filter-item-title';
    title.textContent = article.title;

    const meta = document.createElement('div');
    meta.className = 'article-filter-item-meta';
    meta.textContent = formatDate(article.date);

    info.appendChild(title);
    info.appendChild(meta);

    item.appendChild(icon);
    item.appendChild(info);

    item.addEventListener('click', function() {
      // å…³é—­æ¨¡æ€æ¡†
      closeModal();

      // åœ¨æ ‡ç­¾é¡µä¸­æ‰“å¼€æ–‡ç« 
      if (article.id) {
        openArticleInNewTab(article.id);
      }
    });

    return item;
  }
  
  // åˆ›å»ºç›®å½•é¡¹
  function createOutlineItem(heading) {
    const item = document.createElement('div');
    item.className = 'article-filter-item';

    const icon = document.createElement('div');
    icon.className = 'article-filter-item-icon';

    // æ ¹æ®æ ‡é¢˜çº§åˆ«è®¾ç½®ä¸åŒçš„å›¾æ ‡
    const level = parseInt(heading.tagName.substring(1));
    const icons = ['ğŸ“Œ', 'ğŸ“', 'ğŸ“', 'ğŸ”–', 'ğŸ·ï¸', 'ğŸ“'];
    icon.textContent = icons[level - 1] || 'ğŸ“Œ';

    const info = document.createElement('div');
    info.className = 'article-filter-item-info';

    const title = document.createElement('div');
    title.className = 'article-filter-item-title';
    title.textContent = heading.textContent.trim();

    // æ˜¾ç¤ºæ ‡é¢˜çº§åˆ«
    const meta = document.createElement('div');
    meta.className = 'article-filter-item-meta';
    meta.textContent = `H${level}`;

    info.appendChild(title);
    info.appendChild(meta);

    item.appendChild(icon);
    item.appendChild(info);

    item.addEventListener('click', function() {
      // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®
      heading.scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
      closeModal();
    });

    return item;
  }
  
  // æ ¼å¼åŒ–æ—¥æœŸ
  function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-CN');
  }
});
</script>

<!-- é£˜å­—æ•ˆæœ JS -->
{% if settings.floating_text_enabled %}
<script src="/js/floating-text.js" defer></script>
{% endif %}
</body>
</html>
